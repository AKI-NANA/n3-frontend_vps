# N3 フェーズ管理システム実装レポート

## 📋 実装概要

Gemini先生の設計アドバイスに基づき、商品データの完成度をフェーズごとに管理し、ユーザーが次に何をすべきか一目でわかる「ステータス・バッジ」機能と、それに基づいた「スマート一括処理」を実装しました。

---

## ✅ 実装完了ファイル

### 1. フェーズ管理ロジック
**ファイル**: `/lib/product/phase-status.ts`

5フェーズモデルを実装:
- 🔴 **TRANSLATE** (翻訳待ち): 英語タイトルが未設定
- 🟡 **SCOUT** (SM検索待ち): 英語タイトルあり、SM候補未取得
- 🔵 **SELECT_SM** (SM選択待ち): SM候補あり、未選択（人間の判断が必要）
- 🟣 **ENRICH** (補完待ち): SM選択済み、重量/HTS/価格計算が未完了
- 🟢 **READY** (出品OK): 全データ揃い、バリデーション通過

**主要関数**:
- `getProductPhase(product)`: 商品の現在フェーズを判定
- `getNextAction(product)`: 次に実行すべきアクションを取得
- `groupProductsByPhase(products)`: 商品リストをフェーズ別にグループ化
- `createSmartProcessPlan(products)`: スマート処理の計画を生成

---

### 2. フェーズバッジコンポーネント
**ファイル**: `/app/tools/editing-n3/components/phase-badge.tsx`

4種類のバッジを実装:
- `PhaseBadge`: テーブル行用のコンパクトバッジ（ホバーで不足項目表示）
- `PhaseDetailBadge`: カード表示用の詳細バッジ（プログレスバー付き）
- `PhaseSummaryBar`: ヘッダー用のフェーズ別件数サマリー
- `MiniPhaseBadge`: リスト内インライン用のミニアイコン

---

### 3. スマート一括処理フック
**ファイル**: `/app/tools/editing-n3/hooks/use-smart-process.ts`

**機能**:
- フェーズに応じた適切なAPIを自動選択
- 並列実行制御（同時5件まで、レートリミット対策）
- 進捗のリアルタイム更新
- 処理中止機能

**実行順序**:
1. Phase 1 (翻訳): Google翻訳API → 英語タイトル生成
2. Phase 2 (SM分析): SellerMirror API → 類似品検索
3. Phase 4 (AI補完): カテゴリ→配送→利益→HTML→スコア

---

### 4. スマート処理ボタン
**ファイル**: `/app/tools/editing-n3/components/smart-process-button.tsx`

**機能**:
- 選択された商品のフェーズを分析
- 自動処理可能な件数を表示
- 詳細パネルで処理計画を確認可能
- 進捗表示（プログレスバー+エラー件数）
- 結果サマリー表示

---

### 5. 既存ファイルの更新

#### `/app/tools/editing-n3/components/header/n3-sub-toolbar.tsx`
- スマート処理ボタンを追加
- フェーズサマリーバーを追加

#### `/app/tools/editing-n3/components/product-row.tsx`
- MiniPhaseBadge を商品行に追加
- フェーズ判定ロジックをインポート

#### `/lib/product/index.ts`
- phase-status モジュールをエクスポート

#### `/app/tools/editing-n3/hooks/index.ts`
- useSmartProcess フックをエクスポート

---

## 🎯 使い方

### 1. 全選択してボタン1回
バラバラのデータ（日本語、英語、未検索など）を全部選んで「スマート処理」を押す。
→ 勝手に「🔴」が「🟡」になり、「🟡」が「🔵」に変わっていきます。

### 2. 🔵（青）を潰すだけ
リストの中で「🔵 SM選択待ち」になっているものだけをクリックして、パッパッとSMを確定させる。

### 3. 最後に🟢（緑）をまとめて出品
すべてが緑（✨）になったら、全選択して「出品」ボタンを押す。

---

## 📊 処理フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                     スマート一括処理フロー                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  商品選択                                                        │
│     ↓                                                           │
│  getAutoProcessableProducts() でフェーズ別に分類                   │
│     ↓                                                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 🔴 翻訳待ち   │  │ 🟡 SM検索待ち │  │ 🟣 補完待ち  │              │
│  │ translate[] │  │ scout[]     │  │ enrich[]   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         ↓                ↓                ↓                    │
│  Google翻訳API    SellerMirror API   バッチ処理API               │
│  (並列5件)        (順次+1秒待機)     (一括実行)                    │
│         ↓                ↓                ↓                    │
│         └────────────────┴────────────────┘                    │
│                          ↓                                      │
│                    onRefresh() でデータ再取得                     │
│                          ↓                                      │
│                    結果サマリー表示                               │
│                                                                 │
│  ※ 🔵 SM選択待ち はスキップ（人間の判断が必要）                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚡ 期待される効果

| 指標           | 改善前       | 改善後       |
|---------------|-------------|-------------|
| 1件あたり処理時間 | 5-10分（手動） | 30秒以下    |
| 30件バッチ処理  | 15-30分     | 2-3分       |
| 「何をすべきか」の判断 | 目視確認   | バッジで一目瞭然 |

---

## 🔜 次のステップ

1. **SM選択UIの改善**: SM候補をクリックするとサイドパネルで即選択可能に
2. **事前バリデーション**: 出品前にカテゴリ/コンディションIDの有効性を自動チェック
3. **AIコスト最適化**: Gemini Flash/Pro の使い分けロジック実装
4. **Job Queue**: サーバーサイドでのバックグラウンド処理（BullMQ等）

---

**実装日**: 2026-01-13
**バージョン**: N3 v4.0
