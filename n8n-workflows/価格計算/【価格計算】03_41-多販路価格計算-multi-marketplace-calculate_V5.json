{
  "name": "„Äê‰æ°Ê†ºË®àÁÆó„Äë03_41-Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó-multi-marketplace-calculate_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "multi-marketplace-calculate",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: multi-marketplace-calculate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "multi-marketplace-calculate"
    },
    {
      "parameters": {
        "functionCode": "// ========================================\n// V5-MEDIA-BRIDGE: ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º + „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„Éà\n// ========================================\nconst body = items[0].json.body || items[0].json;\nconst headers = items[0].json.headers || {};\n\n// ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º\nconst internalToken = headers['x-n3-signature'] || headers['X-N3-Signature'];\nconst tokenTimestamp = headers['x-n3-token-timestamp'] || headers['X-N3-Token-Timestamp'];\n\nif (internalToken && tokenTimestamp) {\n  const crypto = require('crypto');\n  const secret = $env.N8N_INTERNAL_SECRET || {{$env.N8N_HMAC_SECRET}};\n  const userId = body.user_id || 'default';\n  const expected = crypto.createHmac('sha256', secret).update(`${userId}-${tokenTimestamp}`).digest('hex');\n  if (internalToken !== expected || (Date.now() - parseInt(tokenTimestamp)) >= 300000) {\n    return [{ json: { error: true, message: 'ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥„ÅåÁÑ°Âäπ„Åß„Åô', code: 'INVALID_TOKEN' } }];\n  }\n}\n\nconst productId = body.product_id;\nconst userId = body.user_id || 'default';\nconst targetMarketplaces = body.target_marketplaces || ['ebay_us', 'qoo10_jp', 'shopee_sg', 'amazon_us'];\nconst targetMargin = body.target_margin || 15;\nconst enableMediaQueue = body.enable_media_queue !== false; // „Éá„Éï„Ç©„É´„Éàtrue\n\nif (!productId) return [{ json: { error: true, message: 'product_id „ÅåÂøÖË¶Å„Åß„Åô' } }];\n\nreturn [{ json: { \n  product_id: productId, \n  user_id: userId, \n  target_marketplaces: targetMarketplaces, \n  target_margin: targetMargin,\n  enable_media_queue: enableMediaQueue,\n  request_timestamp: new Date().toISOString() \n} }];"
      },
      "id": "validate",
      "name": "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-error",
      "name": "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": "={{ $json.code === 'INVALID_TOKEN' ? 403 : 400 }}"
        }
      },
      "id": "respond-error",
      "name": "„Ç®„É©„ÉºÂøúÁ≠î",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.id, pm.sku, pm.title_en, pm.title_ja, pm.product_name, pm.description_en, pm.listing_price, pm.image_urls, pm.item_specifics, pm.updated_at, im.purchase_price, im.purchase_currency, im.weight_grams, im.dimension_cm_l, im.dimension_cm_w, im.dimension_cm_h, im.physical_quantity, COALESCE(im.packaging_cost, 200) as packaging_cost FROM products_master pm LEFT JOIN inventory_master im ON im.product_master_id = pm.id WHERE pm.id = '{{ $node['„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º'].json.product_id }}' AND (pm.user_id = '{{ $node['„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º'].json.user_id }}' OR pm.user_id IS NULL) LIMIT 1",
        "options": {}
      },
      "id": "get-product",
      "name": "ÂïÜÂìÅÊÉÖÂ†±ÂèñÂæóÔºà„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÔºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "notes": "\n[PATCHER] WARNING: „Åì„ÅÆ„ÇØ„Ç®„É™„ÅØqueryParamsÊñπÂºè„Å∏„ÅÆÁßªË°å„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÊâãÂãï„Åß‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT marketplace_id, platform_fee_percent, payment_fee_percent, vat_rate, currency FROM marketplace_fee_master",
        "options": {}
      },
      "id": "get-fees",
      "name": "ÊâãÊï∞Êñô„Éû„Çπ„ÇøÂèñÂæó",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT currency, rate, spread_percent FROM exchange_rates WHERE updated_at > NOW() - INTERVAL '2 hours'",
        "options": {}
      },
      "id": "get-exchange",
      "name": "ÁÇ∫Êõø„É¨„Éº„ÉàÂèñÂæó",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT destination_country, weight_min_grams, weight_max_grams, price_jpy, fuel_surcharge_rate FROM shipping_rate_master WHERE carrier = 'japan_post' ORDER BY destination_country, weight_min_grams",
        "options": {}
      },
      "id": "get-shipping",
      "name": "ÈÄÅÊñô„Éû„Çπ„ÇøÂèñÂæó",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// ========================================\n// V5-MEDIA-BRIDGE: Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥\n// ========================================\nconst request = $node['„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º'].json;\nconst productResult = $node['ÂïÜÂìÅÊÉÖÂ†±ÂèñÂæóÔºà„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÔºâ'].json;\nconst feesResult = $node['ÊâãÊï∞Êñô„Éû„Çπ„ÇøÂèñÂæó'].json;\nconst exchangeResult = $node['ÁÇ∫Êõø„É¨„Éº„ÉàÂèñÂæó'].json;\nconst shippingResult = $node['ÈÄÅÊñô„Éû„Çπ„ÇøÂèñÂæó'].json;\n\nconst product = Array.isArray(productResult) ? productResult[0] : productResult;\nconst fees = Array.isArray(feesResult) ? feesResult : [feesResult];\nconst rates = Array.isArray(exchangeResult) ? exchangeResult : [exchangeResult];\nconst shippingRates = Array.isArray(shippingResult) ? shippingResult : [shippingResult];\n\nif (!product || !product.id) {\n  return [{ json: { error: true, message: 'ÂïÜÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºà„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„ÇíÁ¢∫Ë™çÔºâ' } }];\n}\n\n// ÁÇ∫Êõø„É¨„Éº„ÉàÔºà2%„Éê„ÉÉ„Éï„Ç° + „Çπ„Éó„É¨„ÉÉ„ÉâÔºâ\nconst FX_BUFFER = 0.02;\nconst exchangeRates = {};\nrates.forEach(r => {\n  if (r && r.currency) {\n    const spread = parseFloat(r.spread_percent || 0) / 100;\n    exchangeRates[r.currency] = parseFloat(r.rate) * (1 + FX_BUFFER + spread);\n  }\n});\nexchangeRates['JPY'] = 1;\n\n// Ê±∫Ê∏àÂõ∫ÂÆöË≤ª\nconst PAYMENT_FIXED_FEES = {\n  'ebay_us': 45, 'ebay_uk': 57, 'ebay_de': 42, 'ebay_au': 30,\n  'amazon_us': 153, 'amazon_uk': 114,\n  'shopee_sg': 58, 'shopee_my': 35,\n  'lazada_sg': 50, 'lazada_my': 30,\n  'qoo10_jp': 0\n};\n\n// ÊâãÊï∞Êñô„Éû„ÉÉ„Éó\nconst feeMap = {};\nfees.forEach(f => {\n  if (f && f.marketplace_id) {\n    feeMap[f.marketplace_id] = {\n      platform: parseFloat(f.platform_fee_percent || 12) / 100,\n      payment: parseFloat(f.payment_fee_percent || 3) / 100,\n      vat: parseFloat(f.vat_rate || 0) / 100,\n      currency: f.currency || 'USD'\n    };\n  }\n});\n\n// ÂõΩ„Éû„ÉÉ„Éî„É≥„Ç∞\nconst marketplaceToCountry = {\n  'ebay_us': 'US', 'ebay_uk': 'GB', 'ebay_de': 'DE', 'ebay_au': 'AU',\n  'amazon_us': 'US', 'amazon_uk': 'GB',\n  'shopee_sg': 'SG', 'shopee_my': 'MY',\n  'lazada_sg': 'SG', 'lazada_my': 'MY',\n  'qoo10_jp': 'JP'\n};\n\n// ÈáçÈáèË®àÁÆó\nconst actualWeight = product.weight_grams || 500;\nconst L = product.dimension_cm_l || 20;\nconst W = product.dimension_cm_w || 15;\nconst H = product.dimension_cm_h || 10;\nconst volumetricWeight = Math.ceil((L * W * H) / 5000 * 1000);\nconst chargeableWeight = Math.max(actualWeight, volumetricWeight);\n\nfunction getShippingCost(country) {\n  const countryRates = shippingRates.filter(r => r && r.destination_country === country);\n  const applicable = countryRates.find(r => chargeableWeight >= r.weight_min_grams && chargeableWeight <= r.weight_max_grams);\n  if (!applicable) {\n    const maxRate = countryRates.sort((a, b) => b.weight_max_grams - a.weight_max_grams)[0];\n    if (maxRate) {\n      const surcharge = parseFloat(maxRate.fuel_surcharge_rate || 12) / 100;\n      return Math.ceil(maxRate.price_jpy * (1 + surcharge));\n    }\n    return 2500;\n  }\n  const surcharge = parseFloat(applicable.fuel_surcharge_rate || 12) / 100;\n  return Math.ceil(applicable.price_jpy * (1 + surcharge));\n}\n\n// Ë®àÁÆó\nconst purchasePrice = parseFloat(product.purchase_price || 0);\nconst packagingCost = parseFloat(product.packaging_cost || 200);\nconst targetMargin = request.target_margin / 100;\nconst physicalQuantity = product.physical_quantity || 0;\n\nconst calculations = [];\nlet hasProfitableItem = false;\n\nrequest.target_marketplaces.forEach(marketplace => {\n  const country = marketplaceToCountry[marketplace] || 'US';\n  const fee = feeMap[marketplace] || { platform: 0.12, payment: 0.03, vat: 0, currency: 'USD' };\n  const currency = fee.currency;\n  const exchangeRate = exchangeRates[currency] || 150;\n  \n  const shippingCostJPY = country === 'JP' ? 0 : getShippingCost(country);\n  const paymentFixedJPY = PAYMENT_FIXED_FEES[marketplace] || 0;\n  \n  const totalCostJPY = purchasePrice + shippingCostJPY + packagingCost + paymentFixedJPY;\n  const totalFeeRate = fee.platform + fee.payment + fee.vat;\n  const sellingPriceJPY = Math.ceil((totalCostJPY * (1 + targetMargin)) / (1 - totalFeeRate));\n  const sellingPriceForeign = Math.ceil((sellingPriceJPY / exchangeRate) * 100) / 100;\n  \n  const revenueJPY = sellingPriceForeign * exchangeRate;\n  const feeJPY = Math.ceil(revenueJPY * totalFeeRate);\n  const profitJPY = Math.floor(revenueJPY - totalCostJPY - feeJPY);\n  const profitRate = totalCostJPY > 0 ? Math.round((profitJPY / totalCostJPY) * 1000) / 10 : 0;\n  const isProfitable = profitJPY > 0 && profitRate >= 5;\n  \n  if (isProfitable) hasProfitableItem = true;\n  \n  calculations.push({\n    marketplace: marketplace,\n    selling_price: sellingPriceForeign,\n    selling_price_jpy: sellingPriceJPY,\n    currency: currency,\n    profit_jpy: profitJPY,\n    profit_rate: profitRate,\n    is_profitable: isProfitable ? 1 : 0,\n    exchange_rate: exchangeRate\n  });\n});\n\n// ÂúßÁ∏ÆÁâàÔºàDB‰øùÂ≠òÁî®„ÉªÁ¥Ñ85%ÂâäÊ∏õÔºâ\nconst compressed_for_db = calculations.map(c => ({\n  m: c.marketplace,\n  p: c.selling_price,\n  pj: c.selling_price_jpy,\n  c: c.currency,\n  pr: c.profit_jpy,\n  prc: c.profit_rate,\n  ok: c.is_profitable,\n  fx: Math.round(c.exchange_rate * 100) / 100\n}));\n\n// „É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºÁî®PropsÔºàÂà©Áõä„ÅÇ„ÇäÔºÜÂú®Â∫´„ÅÇ„ÇäÔºâ\nconst mediaProps = (hasProfitableItem && physicalQuantity > 0) ? {\n  product_id: product.id,\n  user_id: request.user_id,\n  title_en: product.title_en || product.product_name || '',\n  title_ja: product.title_ja || '',\n  listing_price: product.listing_price,\n  image_urls: (product.image_urls || []).slice(0, 5),\n  features_json: {\n    sku: product.sku,\n    profit_rates: calculations.filter(c => c.is_profitable).map(c => ({ mp: c.marketplace, rate: c.profit_rate })),\n    item_specifics: Object.entries(product.item_specifics || {}).slice(0, 5).map(([k, v]) => `${k}: ${v}`)\n  }\n} : null;\n\nreturn [{ json: {\n  product_id: product.id,\n  product_updated_at: product.updated_at,\n  sku: product.sku,\n  user_id: request.user_id,\n  target_margin: request.target_margin,\n  calculations: calculations,\n  compressed_for_db: compressed_for_db,\n  media_props: mediaProps,\n  enable_media_queue: request.enable_media_queue && mediaProps !== null,\n  calculated_at: new Date().toISOString()\n} }];"
      },
      "id": "calculate",
      "name": "Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-calc-error",
      "name": "Ë®àÁÆó„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-calc-error",
      "name": "Ë®àÁÆó„Ç®„É©„ÉºÂøúÁ≠î",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO marketplace_calc_history (product_master_id, user_id, calculation_data, target_margin, created_at) VALUES ('{{ $json.product_id }}', '{{ $json.user_id }}', '{{ JSON.stringify($json.compressed_for_db).replace(/'/g, \"''\") }}'::jsonb, {{ $json.target_margin }}, NOW()) ON CONFLICT (product_master_id, user_id) DO UPDATE SET calculation_data = EXCLUDED.calculation_data, target_margin = EXCLUDED.target_margin, created_at = NOW() WHERE marketplace_calc_history.created_at < NOW() - INTERVAL '1 minute' RETURNING id",
        "options": {}
      },
      "id": "save-calc",
      "name": "ÂúßÁ∏Æ„Éá„Éº„Çø‰øùÂ≠òÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "\n[PATCHER] WARNING: „Åì„ÅÆ„ÇØ„Ç®„É™„ÅØqueryParamsÊñπÂºè„Å∏„ÅÆÁßªË°å„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÊâãÂãï„Åß‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json.enable_media_queue }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-media",
      "name": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºË¶ÅÂê¶",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO media_queue (user_id, template_type, product_ids, props_json, status, created_at, updated_at) VALUES ('{{ $node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json.user_id }}', 'product_showcase', ARRAY['{{ $node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json.product_id }}']::uuid[], '{{ JSON.stringify($node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json.media_props).replace(/'/g, \"''\") }}'::jsonb, 'pending', NOW(), NOW()) ON CONFLICT DO NOTHING RETURNING id",
        "options": {}
      },
      "id": "queue-media",
      "name": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºÁôªÈå≤ÔºàÂ∏ùÂõΩOSÈÄ£Êê∫Ôºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "\n[PATCHER] WARNING: „Åì„ÅÆ„ÇØ„Ç®„É™„ÅØqueryParamsÊñπÂºè„Å∏„ÅÆÁßªË°å„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÊâãÂãï„Åß‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    },
    {
      "parameters": {
        "functionCode": "// „É°„Éá„Ç£„Ç¢„Ç≠„É•„Éº„Çπ„Ç≠„ÉÉ„Éó\nreturn items;"
      },
      "id": "skip-media",
      "name": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„Éº„Çπ„Ç≠„ÉÉ„Éó",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM marketplace_calc_history WHERE product_master_id = '{{ $node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json.product_id }}' AND created_at < NOW() - INTERVAL '7 days'",
        "options": {}
      },
      "id": "cleanup",
      "name": "Âè§„ÅÑ„Éá„Éº„ÇøËá™ÂãïÂâäÈô§Ôºà7Êó•Ôºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "\n[PATCHER] WARNING: „Åì„ÅÆ„ÇØ„Ç®„É™„ÅØqueryParamsÊñπÂºè„Å∏„ÅÆÁßªË°å„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÊâãÂãï„Åß‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    },
    {
      "parameters": {
        "functionCode": "const calcResult = $node['Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥'].json;\nconst mediaQueued = $node['„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºË¶ÅÂê¶'].json?.enable_media_queue || false;\n\nreturn [{ json: {\n  success: true,\n  product_id: calcResult.product_id,\n  sku: calcResult.sku,\n  target_margin: calcResult.target_margin,\n  calculations: calcResult.calculations,\n  media_queue_registered: mediaQueued,\n  calculated_at: calcResult.calculated_at\n} }];"
      },
      "id": "prepare-response",
      "name": "„É¨„Çπ„Éù„É≥„ÇπÊ∫ñÂÇô",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "ÊàêÂäüÂøúÁ≠î",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// üîê HMAC SHA256 ÁΩ≤ÂêçÊ§úË®º (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('üö´ N8N_HMAC_SECRET Áí∞Â¢ÉÂ§âÊï∞„ÅåÊú™Ë®≠ÂÆö„Åß„Åô');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('üö´ ÁΩ≤Âêç„Åæ„Åü„ÅØ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅåÊ¨†ËêΩ„Åó„Å¶„ÅÑ„Åæ„Åô');\n}\n\n// „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊúâÂäπÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ (5ÂàÜ)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('üö´ „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅåÊúüÈôêÂàá„Çå„Åæ„Åü„ÅØ‰∏çÊ≠£„Åß„Åô');\n}\n\n// HMACÊ§úË®º\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('üö´ HMACÁΩ≤ÂêçÊ§úË®ºÂ§±Êïó: ‰∏çÊ≠£„Å™„É™„ÇØ„Ç®„Çπ„Éà');\n}\n\n// Ê§úË®ºÊàêÂäü - ÂÖÉ„Éá„Éº„Çø„Çí„Åù„ÅÆ„Åæ„ÅæËøî„Åô\nreturn [{ json: $json }];"
      },
      "name": "üîê HMACÁΩ≤ÂêçÊ§úË®º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âà∂ÊåøÂÖ•"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "üìä ÂÆüË°å„É≠„Ç∞ÈÄÅ‰ø° (ÊàêÂäü)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ‰∏≠Â§ÆÁõ£Ë¶ñ„Éë„É´„Çπ\n[PATCHER] WARNING: „Åì„ÅÆ„Éé„Éº„Éâ„ÅØ„Å©„Åì„Å´„ÇÇÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂâäÈô§„Åæ„Åü„ÅØÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    }
  ],
  "connections": {
    "Webhook: multi-marketplace-calculate": {
      "main": [
        [
          {
            "node": "üîê HMACÁΩ≤ÂêçÊ§úË®º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º": {
      "main": [
        [
          {
            "node": "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ": {
      "main": [
        [
          {
            "node": "„Ç®„É©„ÉºÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÂïÜÂìÅÊÉÖÂ†±ÂèñÂæóÔºà„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÔºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÂïÜÂìÅÊÉÖÂ†±ÂèñÂæóÔºà„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÔºâ": {
      "main": [
        [
          {
            "node": "ÊâãÊï∞Êñô„Éû„Çπ„ÇøÂèñÂæó",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÊâãÊï∞Êñô„Éû„Çπ„ÇøÂèñÂæó": {
      "main": [
        [
          {
            "node": "ÁÇ∫Êõø„É¨„Éº„ÉàÂèñÂæó",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÁÇ∫Êõø„É¨„Éº„ÉàÂèñÂæó": {
      "main": [
        [
          {
            "node": "ÈÄÅÊñô„Éû„Çπ„ÇøÂèñÂæó",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÈÄÅÊñô„Éû„Çπ„ÇøÂèñÂæó": {
      "main": [
        [
          {
            "node": "Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â§öË≤©Ë∑Ø‰æ°Ê†ºË®àÁÆó„Ç®„É≥„Ç∏„É≥": {
      "main": [
        [
          {
            "node": "Ë®àÁÆó„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ë®àÁÆó„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ": {
      "main": [
        [
          {
            "node": "Ë®àÁÆó„Ç®„É©„ÉºÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÂúßÁ∏Æ„Éá„Éº„Çø‰øùÂ≠òÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÂúßÁ∏Æ„Éá„Éº„Çø‰øùÂ≠òÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ": {
      "main": [
        [
          {
            "node": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºË¶ÅÂê¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºË¶ÅÂê¶": {
      "main": [
        [
          {
            "node": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºÁôªÈå≤ÔºàÂ∏ùÂõΩOSÈÄ£Êê∫Ôºâ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "„É°„Éá„Ç£„Ç¢„Ç≠„É•„Éº„Çπ„Ç≠„ÉÉ„Éó",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É°„Éá„Ç£„Ç¢„Ç≠„É•„ÉºÁôªÈå≤ÔºàÂ∏ùÂõΩOSÈÄ£Êê∫Ôºâ": {
      "main": [
        [
          {
            "node": "Âè§„ÅÑ„Éá„Éº„ÇøËá™ÂãïÂâäÈô§Ôºà7Êó•Ôºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É°„Éá„Ç£„Ç¢„Ç≠„É•„Éº„Çπ„Ç≠„ÉÉ„Éó": {
      "main": [
        [
          {
            "node": "Âè§„ÅÑ„Éá„Éº„ÇøËá™ÂãïÂâäÈô§Ôºà7Êó•Ôºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Âè§„ÅÑ„Éá„Éº„ÇøËá™ÂãïÂâäÈô§Ôºà7Êó•Ôºâ": {
      "main": [
        [
          {
            "node": "„É¨„Çπ„Éù„É≥„ÇπÊ∫ñÂÇô",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É¨„Çπ„Éù„É≥„ÇπÊ∫ñÂÇô": {
      "main": [
        [
          {
            "node": "ÊàêÂäüÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê HMACÁΩ≤ÂêçÊ§úË®º": {
      "main": [
        [
          {
            "node": "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º + ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 120,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Pricing",
      "color": "#ffd700"
    },
    {
      "name": "V5-MEDIA-BRIDGE",
      "color": "#ff0000"
    },
    {
      "name": "Compressed-Storage",
      "color": "#32cd32"
    },
    {
      "name": "Media-Queue",
      "color": "#9b59b6"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}