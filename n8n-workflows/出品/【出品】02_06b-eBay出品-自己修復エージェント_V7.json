{
  "name": "ã€å‡ºå“ã€‘02_06b-eBayå‡ºå“-è‡ªå·±ä¿®å¾©ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ_V7",
  "description": "N3 Empire OS V7-27DIM: Self-Healing Agent - AIé§†å‹•ã®è‡ªå¾‹ã‚¨ãƒ©ãƒ¼ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ27æ¬¡å…ƒé˜²è¡›å®Œå…¨å¯¾å¿œï¼‰",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "v821-self-healing-agent",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook-v821",
      "name": "Webhook: Self-Healing Agent",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "v821-self-healing-agent"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ” V7-27æ¬¡å…ƒé˜²è¡›: JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ + HMACç½²åæ¤œè¨¼\n// æ¬¡å…ƒ3: Auth-Gateãƒã‚¤ãƒ‘ã‚¹æ’é™¤\n// ========================================\n\nconst crypto = require('crypto');\nconst headers = $input.first().json.headers || {};\nconst body = $input.first().json.body || $input.first().json;\n\n// JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼\nconst jitToken = headers['x-n3-jit-token'] || headers['X-N3-JIT-Token'];\nconst tokenExpiry = headers['x-n3-token-expiry'] || headers['X-N3-Token-Expiry'];\n\nif (jitToken && tokenExpiry) {\n  const expiryTs = parseInt(tokenExpiry, 10);\n  const now = Math.floor(Date.now() / 1000);\n  \n  if (now > expiryTs) {\n    return [{ json: { error: true, message: 'JITãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ', code: 'JIT_TOKEN_EXPIRED' } }];\n  }\n  \n  // JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼APIå‘¼ã³å‡ºã—\n  const apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n  try {\n    const verifyResponse = await fetch(`${apiUrl}/api/n8n-auth/verify-jit-token`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ token: jitToken, expiry: tokenExpiry })\n    });\n    const verifyResult = await verifyResponse.json();\n    if (!verifyResult.valid) {\n      return [{ json: { error: true, message: 'JITãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹: ' + (verifyResult.error || ''), code: 'INVALID_JIT_TOKEN' } }];\n    }\n  } catch (e) {\n    console.log('JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰: ' + e.message);\n  }\n}\n\n// HMACç½²åæ¤œè¨¼\nconst signature = headers['x-n3-signature'] || headers['X-N3-Signature'] || '';\nconst timestamp = headers['x-n3-timestamp'] || headers['X-N3-Timestamp'] || '';\n\nif (signature && timestamp) {\n  const secret = $env.N3_HMAC_SECRET || $env.N8N_HMAC_SECRET;\n  if (!secret) {\n    return [{ json: { error: true, message: 'HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š', code: 'CONFIG_ERROR' } }];\n  }\n  \n  const ts = parseInt(timestamp, 10);\n  const now = Date.now();\n  if (Math.abs(now - ts) > 300000) {\n    return [{ json: { error: true, message: 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœŸé™åˆ‡ã‚Œï¼ˆ5åˆ†è¶…éï¼‰', code: 'TIMESTAMP_EXPIRED' } }];\n  }\n  \n  const computedHmac = crypto.createHmac('sha256', secret)\n    .update(timestamp + '.' + JSON.stringify(body))\n    .digest('hex');\n  \n  if (signature !== computedHmac) {\n    return [{ json: { error: true, message: 'HMACç½²åæ¤œè¨¼å¤±æ•—', code: 'INVALID_SIGNATURE' } }];\n  }\n}\n\nreturn [{ json: { ...body, _auth_verified: true, _auth_timestamp: new Date().toISOString() } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "jit_hmac_verify_v7",
      "name": "ğŸ” JIT+HMACæ¤œè¨¼ (27æ¬¡å…ƒ-æ¬¡å…ƒ3)",
      "notes": "[V7-27DIM] JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ + HMACç½²åæ¤œè¨¼"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ”¥ V7-27æ¬¡å…ƒé˜²è¡›: ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (Burn-Limit)\n// æ¬¡å…ƒ22: çµŒæ¸ˆæ”»æ’ƒé˜²æ­¢\n// ========================================\n\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst userId = body.user_id || 'default';\n\n// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ä¸Šé™å–å¾—\nconst dailyLimit = parseInt($env.BURN_LIMIT_DAILY || '1000', 10);\nconst monthlyLimit = parseInt($env.BURN_LIMIT_MONTHLY || '10000', 10);\n\n// APIã‚³ã‚¹ãƒˆè¿½è·¡APIã‚’å‘¼ã³å‡ºã—\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n\ntry {\n  const usageResponse = await fetch(`${apiUrl}/api/cost-tracking/check-limit`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      user_id: userId, \n      operation: 'self_healing_agent',\n      estimated_cost: 0.08,  // AIè¨ºæ–­ã‚³ã‚¹ãƒˆ\n      daily_limit: dailyLimit,\n      monthly_limit: monthlyLimit\n    })\n  });\n  \n  const usageResult = await usageResponse.json();\n  \n  if (usageResult.limit_exceeded) {\n    return [{ json: { \n      error: true, \n      message: `ç‡ƒç„¼ä¸Šé™è¶…é: ${usageResult.exceeded_type} (${usageResult.current}/${usageResult.limit})`,\n      code: 'BURN_LIMIT_EXCEEDED',\n      usage: usageResult\n    } }];\n  }\n  \n  return [{ json: { ...body, _burn_limit_checked: true, _usage: usageResult } }];\n} catch (e) {\n  // ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã¯è­¦å‘Šä»˜ãã§ç¶šè¡Œ\n  console.log('ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰: ' + e.message);\n  return [{ json: { ...body, _burn_limit_checked: false, _burn_limit_error: e.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "burn_limit_check_v7",
      "name": "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (27æ¬¡å…ƒ-æ¬¡å…ƒ22)",
      "notes": "[V7-27DIM] çµŒæ¸ˆæ”»æ’ƒé˜²æ­¢ - Burn-Limit"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ“ˆ V7-ç‰¹åŒ–: ROIè¨ˆç®— + Exit Strategyåˆ¤å®š\n// ä¿®å¾©ã‚³ã‚¹ãƒˆãŒå•†å“ä¾¡å€¤ã‚’è¶…ãˆã‚‹å ´åˆã¯è‡ªå‹•æ’¤é€€\n// ========================================\n\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst productId = body.product_id;\nif (!productId) {\n  return [{ json: { error: true, message: 'product_idå¿…é ˆ', code: 'MISSING_PARAM' } }];\n}\n\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n\ntry {\n  // å•†å“ã®ROIæƒ…å ±ã‚’å–å¾—\n  const roiResponse = await fetch(`${apiUrl}/api/asset-score/roi-check`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      product_id: productId,\n      operation_type: 'self_healing',\n      estimated_operation_cost: 0.08  // AIè¨ºæ–­ã‚³ã‚¹ãƒˆ\n    })\n  });\n  \n  const roiResult = await roiResponse.json();\n  \n  // ROIãŒãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯æ’¤é€€æ¨å¥¨\n  if (roiResult.roi_negative || roiResult.exit_recommended) {\n    return [{ json: { \n      ...body,\n      _exit_strategy_triggered: true,\n      _exit_reason: roiResult.reason || 'ROI negative',\n      _roi_data: roiResult,\n      action: 'exit_recommended',\n      message: 'ä¿®å¾©ã‚³ã‚¹ãƒˆãŒå•†å“ä¾¡å€¤ã‚’è¶…ãˆã‚‹ãŸã‚æ’¤é€€ã‚’æ¨å¥¨'\n    } }];\n  }\n  \n  return [{ json: { ...body, _roi_checked: true, _roi_data: roiResult } }];\n} catch (e) {\n  console.log('ROIãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰: ' + e.message);\n  return [{ json: { ...body, _roi_check_error: e.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "roi_exit_strategy",
      "name": "ğŸ“ˆ ROIè¨ˆç®— + Exit Strategy",
      "notes": "[V7-SPECIAL] ä¿®å¾©ä¾¡å€¤åˆ¤å®š"
    },
    {
      "parameters": {
        "jsCode": "// V7-27DIM: Self-Healing Agent åˆæœŸåŒ–\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\n// Exit Strategyç™ºå‹•æ™‚ã¯æ—©æœŸçµ‚äº†\nif (body._exit_strategy_triggered) {\n  return [{ json: body }];\n}\n\nconst config = {\n  product_id: body.product_id,\n  user_id: body.user_id || 'default',\n  max_heal_attempts: body.max_attempts || 3,\n  use_local_llm: body.use_local_llm || false,\n  auto_retry: body.auto_retry !== false,\n  confidence_threshold: body.confidence_threshold || 0.7,\n  _auth_verified: body._auth_verified,\n  _burn_limit_checked: body._burn_limit_checked,\n  _roi_checked: body._roi_checked,\n  _roi_data: body._roi_data\n};\n\nreturn [{ json: { ...config, heal_loop_count: 0, timestamp: new Date().toISOString() } }];"
      },
      "id": "init_v7",
      "name": "âš™ï¸ Self-Healing åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7-27DIM] è‡ªå·±ä¿®å¾©è¨­å®š"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check_error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "error_response",
      "name": "âŒ ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "exit-check",
              "leftValue": "={{ $json._exit_strategy_triggered }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check_exit",
      "name": "Exit Strategyç™ºå‹•ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, action: 'exit_recommended', reason: $json._exit_reason, roi_data: $json._roi_data, product_id: $json.product_id }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "exit_response",
      "name": "ğŸšª Exit Strategyå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT p.id, p.sku, p.english_title, p.title, p.ebay_category_id, p.ddp_price_usd, p.condition, p.listing_data, p.ebay_account, p.user_id, p.updated_at, elh.error_code, elh.error_message, elh.raw_response, (SELECT COUNT(*) FROM self_healing_attempts sha WHERE sha.product_id = p.id AND sha.created_at > NOW() - INTERVAL '24 hours') as heal_attempts_24h FROM products_master p INNER JOIN ebay_listing_history elh ON p.id = elh.product_id WHERE p.id = $1 AND elh.result = 'error' ORDER BY elh.created_at DESC LIMIT 1",
        "options": {
          "queryParams": "={{ [$json.product_id] }}"
        }
      },
      "id": "get_error_product",
      "name": "ğŸ“¦ ã‚¨ãƒ©ãƒ¼å•†å“ï¼†å±¥æ­´å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-data",
              "leftValue": "={{ $json.id || $json[0]?.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "check_data_exists",
      "name": "ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: 'ã‚¨ãƒ©ãƒ¼å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', code: 'NOT_FOUND' }) }}",
        "options": {
          "responseCode": 404
        }
      },
      "id": "not_found_response",
      "name": "å•†å“ãªã—å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// V7-27DIM: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰\nconst config = $node['âš™ï¸ Self-Healing åˆæœŸåŒ–'].json;\nconst productRaw = $input.first().json;\nconst product = Array.isArray(productRaw) ? productRaw[0] : productRaw;\n\n// 24æ™‚é–“ä»¥å†…ã®ä¿®å¾©è©¦è¡Œå›æ•°ãƒã‚§ãƒƒã‚¯\nconst healAttempts = product.heal_attempts_24h || 0;\nif (healAttempts >= config.max_heal_attempts) {\n  return [{ json: { \n    success: false, \n    action: 'max_attempts_exceeded',\n    message: `24æ™‚é–“ä»¥å†…ã®ä¿®å¾©è©¦è¡Œä¸Šé™(${config.max_heal_attempts}å›)ã«é”ã—ã¾ã—ãŸ`,\n    product_id: product.id,\n    sku: product.sku\n  } }];\n}\n\n// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ\nconst errorContext = {\n  product_id: product.id,\n  sku: product.sku,\n  title: product.english_title || product.title,\n  category_id: product.ebay_category_id,\n  condition: product.condition,\n  price_usd: product.ddp_price_usd,\n  listing_data: typeof product.listing_data === 'string' ? JSON.parse(product.listing_data || '{}') : product.listing_data || {},\n  ebay_account: product.ebay_account,\n  user_id: product.user_id || config.user_id,\n  updated_at: product.updated_at,\n  error: {\n    code: product.error_code,\n    message: product.error_message,\n    raw_response: product.raw_response\n  },\n  heal_loop_count: config.heal_loop_count,\n  use_local_llm: config.use_local_llm,\n  confidence_threshold: config.confidence_threshold,\n  auto_retry: config.auto_retry,\n  _auth_verified: config._auth_verified,\n  _burn_limit_checked: config._burn_limit_checked,\n  _roi_checked: config._roi_checked\n};\n\nreturn [{ json: errorContext }];"
      },
      "id": "build_context",
      "name": "ğŸ” ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7-27DIM] ä¿®å¾©å¯¾è±¡ãƒ‡ãƒ¼ã‚¿æº–å‚™"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "max-exceeded",
              "leftValue": "={{ $json.action }}",
              "rightValue": "max_attempts_exceeded",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check_max_attempts",
      "name": "ä¸Šé™è¶…éï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 429
        }
      },
      "id": "max_attempts_response",
      "name": "â›” ä¸Šé™è¶…éå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "use-local",
              "leftValue": "={{ $json.use_local_llm }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check_local_llm",
      "name": "ãƒ­ãƒ¼ã‚«ãƒ«LLMä½¿ç”¨ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.OLLAMA_URL || 'http://localhost:11434' }}/api/generate",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $env.LOCAL_LLM_MODEL || 'deepseek-coder:6.7b', prompt: '## eBay Listing Error Analysis (Self-Healing Agent V7)\\n\\nAnalyze this error and provide a fix.\\n\\n### Error Context\\nSKU: ' + $json.sku + '\\nTitle: ' + ($json.title || '').substring(0, 100) + '\\nCategory: ' + $json.category_id + '\\nError Code: ' + $json.error.code + '\\nError Message: ' + ($json.error.message || '').substring(0, 500) + '\\n\\n### Current Item Specifics\\n' + JSON.stringify($json.listing_data?.item_specifics || {}, null, 2).substring(0, 1000) + '\\n\\n### Instructions\\n1. Diagnose the root cause\\n2. Propose specific data corrections\\n3. Rate your confidence (0-1)\\n\\n### Response Format (JSON only)\\n{\"diagnosis\": \"string\", \"corrections\": {\"field\": \"value\"}, \"confidence\": 0.8, \"reasoning\": \"string\", \"should_retry\": true}', stream: false, options: { temperature: 0.2 } }) }}",
        "options": {
          "timeout": 90000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "ollama_diagnose",
      "name": "ğŸ§  Ollama/DeepSeek è¨ºæ–­",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[V7-27DIM] ãƒ­ãƒ¼ã‚«ãƒ«LLMï¼ˆDeepSeek/Qwenï¼‰"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-goog-api-key",
              "value": "={{ $env.GEMINI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: 'You are a Self-Healing Agent for eBay listings (V7-27DIM). Analyze this error and provide a fix.\\n\\n## Error Context\\nSKU: ' + $json.sku + '\\nTitle: ' + ($json.title || '').substring(0, 100) + '\\nCategory: ' + $json.category_id + '\\nError Code: ' + $json.error.code + '\\nError Message: ' + ($json.error.message || '').substring(0, 500) + '\\n\\n## Current Item Specifics\\n' + JSON.stringify($json.listing_data?.item_specifics || {}, null, 2).substring(0, 1000) + '\\n\\n## Instructions\\n1. Diagnose root cause\\n2. Propose corrections\\n3. Rate confidence (0-1)\\n\\n## Response (JSON only, no markdown)\\n{\"diagnosis\": \"cause\", \"corrections\": {\"Brand\": \"value\", \"MPN\": \"value\"}, \"confidence\": 0.85, \"reasoning\": \"why\", \"should_retry\": true}' }] }], generationConfig: { temperature: 0.2, maxOutputTokens: 1024 } }) }}",
        "options": {
          "timeout": 60000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "gemini_diagnose",
      "name": "ğŸ§  Gemini è¨ºæ–­",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[V7-27DIM] ã‚¯ãƒ©ã‚¦ãƒ‰AIï¼ˆGeminiï¼‰"
    },
    {
      "parameters": {
        "jsCode": "// V7-27DIM: AIè¨ºæ–­çµæœãƒ‘ãƒ¼ã‚¹ï¼ˆçµ±åˆï¼‰\nconst context = $node['ğŸ” ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰'].json;\nconst aiResponse = $input.first().json;\n\nlet diagnosis = {\n  diagnosis: 'Unknown error',\n  corrections: {},\n  confidence: 0.5,\n  reasoning: 'AI response parse failed',\n  should_retry: false\n};\n\ntry {\n  // Ollamaå½¢å¼\n  if (aiResponse.response) {\n    const match = aiResponse.response.match(/\\{[\\s\\S]*\\}/);\n    if (match) diagnosis = JSON.parse(match[0]);\n  }\n  // Geminiå½¢å¼\n  else if (aiResponse.candidates) {\n    const text = aiResponse.candidates[0]?.content?.parts?.[0]?.text || '';\n    const match = text.match(/\\{[\\s\\S]*\\}/);\n    if (match) diagnosis = JSON.parse(match[0]);\n  }\n  // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹\n  else if (aiResponse.error) {\n    diagnosis.reasoning = 'AI API Error: ' + (aiResponse.error.message || JSON.stringify(aiResponse.error));\n  }\n} catch (e) {\n  diagnosis.reasoning = 'Parse error: ' + e.message;\n}\n\n// ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯\nconst confidence = parseFloat(diagnosis.confidence) || 0.5;\nconst meetsThreshold = confidence >= context.confidence_threshold;\n\nreturn [{ json: {\n  ...context,\n  ai_diagnosis: diagnosis,\n  confidence: confidence,\n  meets_threshold: meetsThreshold,\n  should_auto_fix: meetsThreshold && diagnosis.should_retry !== false,\n  ai_model: context.use_local_llm ? ($env.LOCAL_LLM_MODEL || 'deepseek') : 'gemini-1.5-flash'\n} }];"
      },
      "id": "parse_ai_response",
      "name": "ğŸ“‹ AIè¨ºæ–­çµæœãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7-27DIM] Ollama/Geminiçµ±åˆãƒ‘ãƒ¼ã‚µãƒ¼"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ai_decision_traces (user_id, workflow_name, node_name, input_data, output_data, model_used, reasoning, confidence_score, created_at) VALUES ($1, 'self-healing-agent-v7-27dim', 'ai-diagnosis', $2::jsonb, $3::jsonb, $4, $5, $6, NOW())",
        "options": {
          "queryParams": "={{ [$json.user_id || 'system', JSON.stringify({product_id: $json.product_id, error_code: $json.error?.code}).substring(0, 500), JSON.stringify($json.ai_diagnosis || {}).substring(0, 1000), $json.ai_model, ($json.ai_diagnosis?.reasoning || '').substring(0, 500), $json.confidence] }}"
        }
      },
      "id": "ai_trace_log",
      "name": "ğŸ“ AI Decision Trace",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "[V7-27DIM] AIåˆ¤æ–­ã®ç›£æŸ»ãƒ­ã‚°"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-fix",
              "leftValue": "={{ $json.should_auto_fix }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check_auto_fix",
      "name": "è‡ªå‹•ä¿®æ­£å®Ÿè¡Œï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// V7-27DIM: ãƒ‡ãƒ¼ã‚¿ä¿®æ­£é©ç”¨\nconst data = $input.first().json;\nconst listingData = { ...data.listing_data };\nconst itemSpecifics = { ...(listingData.item_specifics || {}) };\n\n// AIææ¡ˆã®ä¿®æ­£ã‚’é©ç”¨\nfor (const [key, value] of Object.entries(data.ai_diagnosis.corrections || {})) {\n  if (value && typeof value === 'string' && value.trim()) {\n    itemSpecifics[key] = value.trim();\n  }\n}\n\n// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰\nif (!itemSpecifics.MPN) itemSpecifics.MPN = 'Does Not Apply';\nif (!itemSpecifics.Brand) itemSpecifics.Brand = 'Unbranded';\n\nlistingData.item_specifics = itemSpecifics;\n\nreturn [{ json: {\n  ...data,\n  updated_listing_data: listingData,\n  applied_corrections: data.ai_diagnosis.corrections,\n  action: 'data_corrected'\n} }];"
      },
      "id": "apply_corrections",
      "name": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ä¿®æ­£é©ç”¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7-27DIM] AIææ¡ˆã‚’é©ç”¨"
    },
    {
      "parameters": {
        "jsCode": "// ä¿¡é ¼åº¦ä¸è¶³ â†’ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼\nconst data = $input.first().json;\nreturn [{ json: {\n  ...data,\n  action: 'needs_human_review',\n  reason: `ä¿¡é ¼åº¦ ${Math.round(data.confidence * 100)}% < é–¾å€¤ ${Math.round(data.confidence_threshold * 100)}%`\n} }];"
      },
      "id": "needs_human_review",
      "name": "âš ï¸ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE products_master SET listing_data = $1::jsonb, workflow_status = 'approved', updated_at = NOW() WHERE id = $2 RETURNING id",
        "options": {
          "queryParams": "={{ [JSON.stringify($json.updated_listing_data), $json.product_id] }}"
        }
      },
      "id": "save_corrections",
      "name": "ğŸ’¾ ä¿®æ­£ãƒ‡ãƒ¼ã‚¿ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO self_healing_attempts (product_id, user_id, sku, error_code, error_message, ai_model, diagnosis, corrections, confidence, action_taken, v7_features, created_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8::jsonb, $9, $10, $11::jsonb, NOW())",
        "options": {
          "queryParams": "={{ [$json.product_id, $json.user_id, $json.sku, $json.error?.code, ($json.error?.message || '').substring(0, 200), $json.ai_model, ($json.ai_diagnosis?.diagnosis || '').substring(0, 500), JSON.stringify($json.applied_corrections || $json.ai_diagnosis?.corrections || {}), $json.confidence, $json.action, JSON.stringify({auth_verified: $json._auth_verified, burn_limit_checked: $json._burn_limit_checked, roi_checked: $json._roi_checked})] }}"
        }
      },
      "id": "log_healing_attempt",
      "name": "ğŸ“ ä¿®å¾©ãƒ­ã‚°è¨˜éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-retry",
              "leftValue": "={{ $json.action }}",
              "rightValue": "data_corrected",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "auto-retry",
              "leftValue": "={{ $json.auto_retry }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check_auto_retry",
      "name": "è‡ªå‹•å†å‡ºå“ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || $env.N3_N8N_URL || 'http://localhost:5678' }}/webhook/v821-ebay-listing",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-n3-signature",
              "value": "={{ require('crypto').createHmac('sha256', $env.N3_HMAC_SECRET || $env.N8N_HMAC_SECRET || '').update(Date.now().toString() + '.' + JSON.stringify({ product_id: $json.product_id, action: 'relist', triggered_by: 'self_healing_agent_v7' })).digest('hex') }}"
            },
            {
              "name": "x-n3-timestamp",
              "value": "={{ Date.now().toString() }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ product_id: $json.product_id, action: 'relist', triggered_by: 'self_healing_agent_v7', _retry_count: ($json.heal_loop_count || 0) + 1 }) }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "trigger_relist",
      "name": "ğŸ”„ è‡ªå‹•å†å‡ºå“ãƒˆãƒªã‚¬ãƒ¼",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[V7-27DIM] ä¿®æ­£å¾Œã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤"
    },
    {
      "parameters": {
        "jsCode": "// V7-27DIM: æœ€çµ‚çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\nconst data = $input.first().json;\n\nreturn [{ json: {\n  success: data.action === 'data_corrected',\n  action: data.action,\n  product_id: data.product_id,\n  sku: data.sku,\n  diagnosis: data.ai_diagnosis?.diagnosis,\n  corrections: data.applied_corrections || data.ai_diagnosis?.corrections || {},\n  confidence: data.confidence,\n  ai_model: data.ai_model,\n  auto_retry_triggered: data.action === 'data_corrected' && data.auto_retry,\n  v7_features: {\n    auth_verified: data._auth_verified || false,\n    burn_limit_checked: data._burn_limit_checked || false,\n    roi_checked: data._roi_checked || false,\n    ai_decision_traced: true\n  },\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "format_result",
      "name": "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": "={{ $json.success ? 200 : 422 }}"
        }
      },
      "id": "success_response",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    }
  ],
  "connections": {
    "Webhook: Self-Healing Agent": {
      "main": [
        [
          {
            "node": "ğŸ” JIT+HMACæ¤œè¨¼ (27æ¬¡å…ƒ-æ¬¡å…ƒ3)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” JIT+HMACæ¤œè¨¼ (27æ¬¡å…ƒ-æ¬¡å…ƒ3)": {
      "main": [
        [
          {
            "node": "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (27æ¬¡å…ƒ-æ¬¡å…ƒ22)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (27æ¬¡å…ƒ-æ¬¡å…ƒ22)": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ ROIè¨ˆç®— + Exit Strategy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ROIè¨ˆç®— + Exit Strategy": {
      "main": [
        [
          {
            "node": "âš™ï¸ Self-Healing åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Self-Healing åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "âŒ ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Exit Strategyç™ºå‹•ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exit Strategyç™ºå‹•ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸšª Exit Strategyå¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¦ ã‚¨ãƒ©ãƒ¼å•†å“ï¼†å±¥æ­´å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ ã‚¨ãƒ©ãƒ¼å•†å“ï¼†å±¥æ­´å–å¾—": {
      "main": [
        [
          {
            "node": "ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ” ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å•†å“ãªã—å¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰": {
      "main": [
        [
          {
            "node": "ä¸Šé™è¶…éï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸Šé™è¶…éï¼Ÿ": {
      "main": [
        [
          {
            "node": "â›” ä¸Šé™è¶…éå¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ãƒ­ãƒ¼ã‚«ãƒ«LLMä½¿ç”¨ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ­ãƒ¼ã‚«ãƒ«LLMä½¿ç”¨ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ§  Ollama/DeepSeek è¨ºæ–­",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ§  Gemini è¨ºæ–­",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Ollama/DeepSeek è¨ºæ–­": {
      "main": [
        [
          {
            "node": "ğŸ“‹ AIè¨ºæ–­çµæœãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Gemini è¨ºæ–­": {
      "main": [
        [
          {
            "node": "ğŸ“‹ AIè¨ºæ–­çµæœãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ AIè¨ºæ–­çµæœãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ğŸ“ AI Decision Trace",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ AI Decision Trace": {
      "main": [
        [
          {
            "node": "è‡ªå‹•ä¿®æ­£å®Ÿè¡Œï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è‡ªå‹•ä¿®æ­£å®Ÿè¡Œï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ä¿®æ­£é©ç”¨",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âš ï¸ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ä¿®æ­£é©ç”¨": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ä¿®æ­£ãƒ‡ãƒ¼ã‚¿ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš ï¸ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦": {
      "main": [
        [
          {
            "node": "ğŸ“ ä¿®å¾©ãƒ­ã‚°è¨˜éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ä¿®æ­£ãƒ‡ãƒ¼ã‚¿ä¿å­˜": {
      "main": [
        [
          {
            "node": "ğŸ“ ä¿®å¾©ãƒ­ã‚°è¨˜éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ ä¿®å¾©ãƒ­ã‚°è¨˜éŒ²": {
      "main": [
        [
          {
            "node": "è‡ªå‹•å†å‡ºå“ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è‡ªå‹•å†å‡ºå“ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ”„ è‡ªå‹•å†å‡ºå“ãƒˆãƒªã‚¬ãƒ¼",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ è‡ªå‹•å†å‡ºå“ãƒˆãƒªã‚¬ãƒ¼": {
      "main": [
        [
          {
            "node": "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "27DIM-FORTRESS",
      "color": "#dc143c"
    },
    {
      "name": "V7-ENHANCED",
      "color": "#00ff00"
    },
    {
      "name": "JIT-AUTH",
      "color": "#ffd700"
    },
    {
      "name": "BURN-LIMIT",
      "color": "#ff6347"
    },
    {
      "name": "SELF-HEALING",
      "color": "#00ff7f"
    },
    {
      "name": "ROI-EXIT-STRATEGY",
      "color": "#9932cc"
    },
    {
      "name": "AI-DECISION-TRACE",
      "color": "#4169e1"
    }
  ],
  "active": false,
  "_27dim_converted": true,
  "_27dim_version": "1.0.0",
  "_27dim_timestamp": "2026-01-24T00:00:00.000Z",
  "_special_features": [
    "JIT_HMAC_Auth",
    "Burn_Limit",
    "ROI_Exit_Strategy",
    "AI_Decision_Trace",
    "Ollama_DeepSeek",
    "Gemini_Cloud",
    "Auto_Retry"
  ]
}