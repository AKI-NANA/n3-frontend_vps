{
  "name": "ã€é˜²è¡›ã€‘05_204-é˜²è¡›-GoogleEarthéŒ²ç”»-åº§æ¨™è‡ªå‹•æ—‹å›_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "earth-record",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: earth-record",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "earth-record"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ãƒ•ã‚§ãƒ¼ã‚º5: Google Earthè‡ªå‹•éŒ²ç”»ï¼ˆStyle D æ²¡å…¥å‹ï¼‰\n// åº§æ¨™ã‚’æ¸¡ã™ã¨è‡ªå‹•ã§æ—‹å›éŒ²ç”»\n// ============================================================================\n\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst latitude = body.latitude || body.lat;\nconst longitude = body.longitude || body.lng;\nconst altitude = body.altitude || body.alt || 1000; // ãƒ¡ãƒ¼ãƒˆãƒ«\nconst pitch = body.pitch || -45; // ã‚«ãƒ¡ãƒ©è§’åº¦ï¼ˆ-90=çœŸä¸‹ã€0=æ°´å¹³ï¼‰\nconst rotationDegrees = body.rotation_degrees || 360; // å›è»¢è§’åº¦\nconst rotationSpeedDps = body.rotation_speed || 2.0; // åº¦/ç§’\nconst durationSeconds = body.duration_seconds || 180; // éŒ²ç”»æ™‚é–“\nconst resolution = body.resolution || '1080p';\nconst channelId = body.channel_id;\nconst contentId = body.content_id;\n\nif (!latitude || !longitude) {\n  return [{ json: { error: true, message: 'latitude ã¨ longitude ã¯å¿…é ˆã§ã™', code: 'MISSING_COORDINATES' } }];\n}\n\n// Google Earth Webã®URLç”Ÿæˆ\nconst earthUrl = `https://earth.google.com/web/@${latitude},${longitude},${altitude}a,0d,${pitch}y,0h,0t,0r`;\n\nreturn [{\n  json: {\n    latitude: parseFloat(latitude),\n    longitude: parseFloat(longitude),\n    altitude: parseInt(altitude),\n    pitch: parseInt(pitch),\n    rotation_degrees: parseInt(rotationDegrees),\n    rotation_speed_dps: parseFloat(rotationSpeedDps),\n    duration_seconds: parseInt(durationSeconds),\n    resolution: resolution,\n    channel_id: channelId,\n    content_id: contentId,\n    earth_url: earthUrl,\n    job_id: `earth-${Date.now()}`,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸŒ åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO earth_recording_jobs (job_id, latitude, longitude, altitude_meters, pitch_degrees, rotation_degrees, rotation_speed_dps, duration_seconds, resolution, channel_id, content_id, status) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, 'pending') RETURNING id",
        "options": {
          "queryParams": "={{ [$json.job_id, $json.latitude, $json.longitude, $json.altitude, $json.pitch, $json.rotation_degrees, $json.rotation_speed_dps, $json.duration_seconds, $json.resolution, $json.channel_id, $json.content_id] }}"
        }
      },
      "id": "create-job",
      "name": "ğŸ’¾ ã‚¸ãƒ§ãƒ–ä½œæˆ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆï¼ˆVPSã§å®Ÿè¡Œç”¨ï¼‰\n// ============================================================================\n\nconst data = $node['ğŸŒ åˆæœŸåŒ–'].json;\n\nconst puppeteerScript = `\nconst puppeteer = require('puppeteer');\nconst { execSync } = require('child_process');\n\nasync function recordEarthRotation() {\n  const browser = await puppeteer.launch({\n    headless: false, // éŒ²ç”»ã«ã¯è¡¨ç¤ºãŒå¿…è¦\n    args: [\n      '--window-size=1920,1080',\n      '--disable-gpu',\n      '--no-sandbox',\n      '--disable-setuid-sandbox'\n    ]\n  });\n\n  const page = await browser.newPage();\n  await page.setViewport({ width: 1920, height: 1080 });\n\n  // Google Earth Webã«ã‚¢ã‚¯ã‚»ã‚¹\n  await page.goto('${data.earth_url}', { waitUntil: 'networkidle2', timeout: 60000 });\n\n  // ãƒ­ãƒ¼ãƒ‰å¾…æ©Ÿï¼ˆEarth 3Dè¡¨ç¤ºã®å®Œäº†ã‚’å¾…ã¤ï¼‰\n  await page.waitForTimeout(10000);\n\n  // FFmpegã§ç”»é¢éŒ²ç”»é–‹å§‹\n  const ffmpegProcess = execSync(\n    'ffmpeg -f x11grab -video_size 1920x1080 -framerate 30 -i :0 -c:v libx264 -preset ultrafast output_${data.job_id}.mp4 &',\n    { shell: true }\n  );\n\n  // æ—‹å›ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢ï¼‰\n  const totalRotation = ${data.rotation_degrees};\n  const rotationSpeed = ${data.rotation_speed_dps}; // åº¦/ç§’\n  const totalTime = totalRotation / rotationSpeed; // ç§’\n  const steps = Math.ceil(totalTime * 10); // 100msé–“éš”\n  const degreePerStep = totalRotation / steps;\n\n  for (let i = 0; i < steps; i++) {\n    // ä¸­å¿ƒã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å›è»¢\n    await page.mouse.move(960, 540);\n    await page.mouse.down();\n    await page.mouse.move(960 + (degreePerStep * 2), 540, { steps: 5 });\n    await page.mouse.up();\n    await page.waitForTimeout(100);\n  }\n\n  // è¿½åŠ å¾…æ©Ÿ\n  await page.waitForTimeout(2000);\n\n  // FFmpegåœæ­¢\n  execSync('pkill -f \"ffmpeg.*output_${data.job_id}\"', { shell: true });\n\n  await browser.close();\n  console.log('Recording completed: output_${data.job_id}.mp4');\n}\n\nrecordEarthRotation().catch(console.error);\n`;\n\nreturn [{\n  json: {\n    ...data,\n    puppeteer_script: puppeteerScript,\n    execution_instructions: [\n      '1. VPSã«SSHæ¥ç¶š',\n      '2. Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿å­˜: earth_record.js',\n      '3. ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤èµ·å‹•: Xvfb :0 -screen 0 1920x1080x24 &',\n      '4. ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ: DISPLAY=:0 node earth_record.js',\n      '5. å®Œäº†å¾Œã€å‹•ç”»ã‚’Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'\n    ]\n  }\n}];"
      },
      "id": "generate-script",
      "name": "ğŸ¤– Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE earth_recording_jobs SET status = 'script_ready' WHERE job_id = $1",
        "options": {
          "queryParams": "={{ [$node['ğŸŒ åˆæœŸåŒ–'].json.job_id] }}"
        }
      },
      "id": "update-status",
      "name": "ğŸ’¾ çŠ¶æ…‹æ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $node['ğŸ¤– Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ'].json;\nreturn [{ json: { success: true, action: 'earth_record', job_id: data.job_id, latitude: data.latitude, longitude: data.longitude, earth_url: data.earth_url, duration_seconds: data.duration_seconds, status: 'script_ready', message: 'Google EarthéŒ²ç”»ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¾ã—ãŸã€‚VPSã§Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', instructions: data.execution_instructions } }];"
      },
      "id": "format-response",
      "name": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ğŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ğŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ğŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ğŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ğŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ğŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹\n[PATCHER] WARNING: ã“ã®ãƒãƒ¼ãƒ‰ã¯ã©ã“ã«ã‚‚æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤ã¾ãŸã¯æ¥ç¶šã—ã¦ãã ã•ã„ã€‚"
    }
  ],
  "connections": {
    "Webhook: earth-record": {
      "main": [
        [
          {
            "node": "ğŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ’¾ ã‚¸ãƒ§ãƒ–ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ã‚¸ãƒ§ãƒ–ä½œæˆ": {
      "main": [
        [
          {
            "node": "ğŸ¤– Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Puppeteerã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ğŸ’¾ çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ çŠ¶æ…‹æ›´æ–°": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ğŸŒ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 60,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Media",
      "color": "#e74c3c"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "GoogleEarth",
      "color": "#3498db"
    },
    {
      "name": "Phase-5",
      "color": "#9b59b6"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}