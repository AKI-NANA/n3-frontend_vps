{
  "name": "ã€å¸ä»¤å¡”ã€‘07_57-ä»•å…¥ã‚Œ-ä¸€æ‹¬è³¼å…¥ç®¡ç†ãƒ¦ãƒ‹ãƒƒãƒˆ_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "purchase-cart",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: purchase-cart",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "purchase-cart"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json || {};\nconst action = body.action || 'list'; // list, add, approve, purchase, cancel\nconst cartIds = body.cart_ids || [];\nconst productId = body.product_id;\nconst sourceUrl = body.source_url;\nconst sourcePrice = body.source_price;\nconst sourceCurrency = body.source_currency || 'USD';\nreturn [{ json: { action, cart_ids: cartIds, product_id: productId, source_url: sourceUrl, source_price: sourcePrice, source_currency: sourceCurrency } }];"
      },
      "id": "init",
      "name": "ðŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "outputKey": "list",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "add",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "approve",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "approve",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "purchase",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "purchase",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ],
          "fallbackOutput": "list"
        }
      },
      "id": "switch-action",
      "name": "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pc.*, pm.title, pm.sku FROM purchase_carts pc LEFT JOIN products_master pm ON pc.product_id = pm.id WHERE pc.cart_status = 'pending' ORDER BY pc.priority DESC, pc.estimated_margin DESC LIMIT 100",
        "options": {}
      },
      "id": "list-carts",
      "name": "ðŸ“‹ ã‚«ãƒ¼ãƒˆä¸€è¦§",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT setting_key, setting_value FROM global_settings WHERE setting_key LIKE 'exchange_rate_%'",
        "options": {}
      },
      "id": "get-rates",
      "name": "ðŸ’± ç‚ºæ›¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $node['ðŸ” åˆæœŸåŒ–'].json;\nconst ratesRaw = $input.first().json;\nconst rates = {};\nconst ratesArray = Array.isArray(ratesRaw) ? ratesRaw : [ratesRaw];\nratesArray.forEach(r => { if (r && r.setting_key) rates[r.setting_key] = parseFloat(r.setting_value); });\n\nconst usdJpy = rates.exchange_rate_usd_jpy || 150;\nconst eurJpy = rates.exchange_rate_eur_jpy || 165;\nconst rateMap = { 'USD': usdJpy, 'EUR': eurJpy, 'JPY': 1 };\n\nconst sourcePrice = parseFloat(config.source_price) || 0;\nconst rate = rateMap[config.source_currency] || usdJpy;\nconst sourcePriceJpy = Math.round(sourcePrice * rate);\n\n// åˆ©ç›Šäºˆæ¸¬ï¼ˆç°¡æ˜“ï¼‰\nconst estimatedSellPrice = Math.round(sourcePriceJpy * 1.8);\nconst estimatedShipping = 2000;\nconst estimatedDuty = Math.round(sourcePriceJpy * 0.05);\nconst estimatedProfit = estimatedSellPrice - sourcePriceJpy - estimatedShipping - estimatedDuty;\nconst estimatedMargin = estimatedSellPrice > 0 ? estimatedProfit / estimatedSellPrice : 0;\n\nreturn [{ json: { product_id: config.product_id, source_url: config.source_url, source_price: sourcePrice, source_currency: config.source_currency, source_price_jpy: sourcePriceJpy, estimated_sell_price_jpy: estimatedSellPrice, estimated_shipping_cost: estimatedShipping, estimated_duty_tax: estimatedDuty, estimated_profit: estimatedProfit, estimated_margin: Math.round(estimatedMargin * 1000) / 1000 } }];"
      },
      "id": "calc-profit",
      "name": "ðŸ’° åˆ©ç›Šè¨ˆç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO purchase_carts (product_id, source_url, source_price, source_currency, source_price_jpy, estimated_sell_price_jpy, estimated_shipping_cost, estimated_duty_tax, estimated_profit, estimated_margin, cart_status, priority) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, 'pending', CASE WHEN $9 > 10000 THEN 'high' ELSE 'normal' END) RETURNING id",
        "options": {
          "queryParams": "={{ [$json.product_id, $json.source_url, $json.source_price, $json.source_currency, $json.source_price_jpy, $json.estimated_sell_price_jpy, $json.estimated_shipping_cost, $json.estimated_duty_tax, $json.estimated_profit, $json.estimated_margin] }}"
        }
      },
      "id": "add-cart",
      "name": "âž• ã‚«ãƒ¼ãƒˆè¿½åŠ ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE purchase_carts SET cart_status = 'approved', approved_at = NOW(), approved_by = 'owner' WHERE id = ANY($1::uuid[]) AND cart_status = 'pending' RETURNING id",
        "options": {
          "queryParams": "={{ [$node['ðŸ” åˆæœŸåŒ–'].json.cart_ids] }}"
        }
      },
      "id": "approve-carts",
      "name": "âœ… æ‰¿èª",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE purchase_carts SET cart_status = 'purchased', purchased_at = NOW(), purchase_order_id = 'PO-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || SUBSTR(MD5(RANDOM()::TEXT), 1, 6) WHERE id = ANY($1::uuid[]) AND cart_status = 'approved' RETURNING id, purchase_order_id",
        "options": {
          "queryParams": "={{ [$node['ðŸ” åˆæœŸåŒ–'].json.cart_ids] }}"
        }
      },
      "id": "execute-purchase",
      "name": "ðŸ›’ è³¼å…¥å®Ÿè¡Œ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const action = $node['ðŸ” åˆæœŸåŒ–'].json.action;\nlet result = { success: true, action };\n\nif (action === 'list') {\n  const carts = $node['ðŸ“‹ ã‚«ãƒ¼ãƒˆä¸€è¦§'].json;\n  result.carts = Array.isArray(carts) ? carts : (carts?.id ? [carts] : []);\n  result.count = result.carts.length;\n} else if (action === 'add') {\n  const added = $node['âž• ã‚«ãƒ¼ãƒˆè¿½åŠ '].json;\n  result.cart_id = added?.id;\n  result.estimated_profit = $node['ðŸ’° åˆ©ç›Šè¨ˆç®—'].json.estimated_profit;\n} else if (action === 'approve') {\n  const approved = $node['âœ… æ‰¿èª'].json;\n  result.approved = Array.isArray(approved) ? approved.length : (approved?.id ? 1 : 0);\n} else if (action === 'purchase') {\n  const purchased = $node['ðŸ›’ è³¼å…¥å®Ÿè¡Œ'].json;\n  result.purchased = Array.isArray(purchased) ? purchased : (purchased?.id ? [purchased] : []);\n}\n\nreturn [{ json: result }];"
      },
      "id": "format-response",
      "name": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹\n[PATCHER] WARNING: ã“ã®ãƒŽãƒ¼ãƒ‰ã¯ã©ã“ã«ã‚‚æŽ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤ã¾ãŸã¯æŽ¥ç¶šã—ã¦ãã ã•ã„ã€‚"
    }
  ],
  "connections": {
    "Webhook: purchase-cart": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ã‚«ãƒ¼ãƒˆä¸€è¦§",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ’± ç‚ºæ›¿å–å¾—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âœ… æ‰¿èª",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ›’ è³¼å…¥å®Ÿè¡Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ã‚«ãƒ¼ãƒˆä¸€è¦§": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’± ç‚ºæ›¿å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ’° åˆ©ç›Šè¨ˆç®—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’° åˆ©ç›Šè¨ˆç®—": {
      "main": [
        [
          {
            "node": "âž• ã‚«ãƒ¼ãƒˆè¿½åŠ ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âž• ã‚«ãƒ¼ãƒˆè¿½åŠ ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… æ‰¿èª": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ›’ è³¼å…¥å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 180,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Purchase",
      "color": "#e67e22"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}