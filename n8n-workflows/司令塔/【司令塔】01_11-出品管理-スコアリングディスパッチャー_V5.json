{
  "name": "ã€å¸ä»¤å¡”ã€‘01_11-å‡ºå“ç®¡ç†-ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "cron-hourly",
      "name": "1æ™‚é–“ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.id, pm.sku, pm.product_name, pm.title, pm.user_id, pm.updated_at, pm.ebay_site, pm.sm_views, pm.sm_watches, pm.sm_sold_count, pm.sm_confidence_score, pm.calculated_profit_margin, pm.image_urls, pm.listing_price FROM products_master pm LEFT JOIN inventory_master im ON im.product_master_id = pm.id WHERE pm.workflow_status = 'approved' AND pm.listing_status IN ('not_listed', 'pending') AND pm.user_id IS NOT NULL AND COALESCE(im.physical_quantity, 1) > 0 ORDER BY pm.sm_confidence_score DESC NULLS LAST LIMIT 500",
        "options": {}
      },
      "id": "get-pending",
      "name": "å‡ºå“å¾…ã¡å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ Array.isArray($json) ? $json.length : ($json.id ? 1 : 0) }}",
              "operation": "equal",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-empty",
      "name": "å¯¾è±¡æœ‰ç„¡",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { message: 'å‡ºå“å¾…ã¡ãªã—' } }];"
      },
      "id": "no-products",
      "name": "å¯¾è±¡ãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const products = Array.isArray($input.first().json) ? $input.first().json : [$input.first().json];\nconst results = products.map(p => {\n  let score = 0;\n  score += Math.min(30, (p.sm_views || 0) / 10);\n  score += Math.min(25, (p.sm_watches || 0) * 5);\n  score += Math.min(20, (p.sm_sold_count || 0) * 4);\n  score += Math.min(15, (p.calculated_profit_margin || 0) * 0.5);\n  score += (p.sm_confidence_score || 50) / 10;\n  let tier = score >= 70 ? 'immediate' : score >= 50 ? 'high' : score >= 30 ? 'medium' : 'low';\n  return { product_id: p.id, user_id: p.user_id, updated_at: p.updated_at, name: (p.product_name || p.title || '').substring(0, 60), sku: p.sku, score: Math.round(score * 10) / 10, tier, ebay_site: p.ebay_site || 'US', image_urls: p.image_urls, listing_price: p.listing_price };\n}).sort((a, b) => b.score - a.score);\nreturn results.map(r => ({ json: r }));"
      },
      "id": "calc-scores",
      "name": "ã‚¹ã‚³ã‚¢è¨ˆç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "const products = $input.all().map(i => i.json);\nconst immediate = products.filter(p => p.tier === 'immediate');\nconst high = products.filter(p => p.tier === 'high');\nconst summary = { total: products.length, immediate: immediate.length, high: high.length, medium: products.filter(p => p.tier === 'medium').length, low: products.filter(p => p.tier === 'low').length, top_5: immediate.slice(0, 5).map(p => ({ id: p.product_id, name: p.name, score: p.score })) };\nreturn [{ json: { summary, immediate, high, all: products } }];"
      },
      "id": "classify",
      "name": "Tieråˆ†é¡ž",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.summary.immediate }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "has-immediate",
      "name": "å³æ™‚å‡ºå“ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nreturn data.immediate.slice(0, 20).map(p => ({ json: p }));"
      },
      "id": "extract-immediate",
      "name": "å³æ™‚å‡ºå“æŠ½å‡º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "batch",
      "name": "ãƒãƒƒãƒåˆ†å‰²",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "notes": "\n[PATCHER] WARNING: SplitInBatchesç›´å¾Œã«WaitãƒŽãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚APIåˆ¶é™ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_WEBHOOK_URL || '={{ $vars.API_BASE_URL || $env.N8N_WEBHOOK_URL }}/webhook' }}/listing-execute",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-N3-Signature",
              "value": "={{ $env.N8N_INTERNAL_TOKEN || \"\" }}"
            },
            {
              "name": "X-N3-Token-Timestamp",
              "value": "={{ Date.now() }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ user_id: $json.user_id, product_id: $json.product_id, target: 'ebay', marketplace: 'EBAY_' + $json.ebay_site, priority: 'immediate', score: $json.score }) }}",
        "options": {
          "timeout": 120000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "dispatch-ebay",
      "name": "eBayå‡ºå“ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆå†…éƒ¨èªè¨¼ï¼‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": 3,
        "unit": "seconds"
      },
      "id": "wait",
      "name": "ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¾…æ©Ÿ",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE products_master SET listing_score = $1, listing_tier = $2, listing_dispatched_at = NOW(), updated_at = NOW() WHERE id = $3 AND user_id = $4 AND updated_at = $5",
        "options": {
          "queryParams": "={{ [{{ $node['ãƒãƒƒãƒåˆ†å‰²'].json.score }}, {{ $node['ãƒãƒƒãƒåˆ†å‰²'].json.tier }}, {{ $node['ãƒãƒƒãƒåˆ†å‰²'].json.product_id }}, {{ $node['ãƒãƒƒãƒåˆ†å‰²'].json.user_id }}, {{ $node['ãƒãƒƒãƒåˆ†å‰²'].json.updated_at }}] }}"
        }
      },
      "id": "update-score",
      "name": "ã‚¹ã‚³ã‚¢è¨˜éŒ²ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $node['Tieråˆ†é¡ž'].json.summary.immediate }}",
              "operation": "largerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "check-media",
      "name": "ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾è±¡ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO media_queue (user_id, template_type, product_ids, props_json, status, created_at) SELECT $1, 'product_showcase', ARRAY[$2]::uuid[], '{{ JSON.stringify({ products: $node['Tieråˆ†é¡ž'].json.immediate.slice(0, 5).map(p => ({ id: p.product_id, name: p.name, score: p.score, price: p.listing_price })) }).replace(/'/g, \"''\") }}'::jsonb, 'pending', NOW() WHERE NOT EXISTS (SELECT 1 FROM media_queue WHERE status = 'pending' AND created_at > NOW() - INTERVAL '1 hour')",
        "options": {
          "queryParams": "={{ [{{ $node['Tieråˆ†é¡ž'].json.immediate[0].user_id }}, {{ $node['Tieråˆ†é¡ž'].json.immediate.slice(0, 5).map(p => \"'\" + p.product_id + \"'\").join(',') }}] }}"
        }
      },
      "id": "queue-media",
      "name": "ðŸŽ¬ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚­ãƒ¥ãƒ¼ç™»éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ðŸ“Š å‡ºå“ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆ[/title]å¯¾è±¡: {{ $node['Tieråˆ†é¡ž'].json.summary.total }}ä»¶\\n\\nã€Tieråˆ†å¸ƒã€‘\\nðŸ”´å³æ™‚(70+): {{ $node['Tieråˆ†é¡ž'].json.summary.immediate }}ä»¶\\nðŸŸ é«˜(50-69): {{ $node['Tieråˆ†é¡ž'].json.summary.high }}ä»¶\\nðŸŸ¡ä¸­(30-49): {{ $node['Tieråˆ†é¡ž'].json.summary.medium }}ä»¶\\nâšªä½Ž(0-29): {{ $node['Tieråˆ†é¡ž'].json.summary.low }}ä»¶\\n\\nã€Top5ã€‘\\n{{ $node['Tieråˆ†é¡ž'].json.summary.top_5.map(p => p.score + 'ç‚¹: ' + p.name).join('\\n') }}[/info]"
            }
          ]
        },
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "id": "notify",
      "name": "ChatWorké€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM listing_history WHERE created_at < NOW() - INTERVAL '7 days'",
        "options": {}
      },
      "id": "purge",
      "name": "ðŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "1æ™‚é–“ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "å‡ºå“å¾…ã¡å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡ºå“å¾…ã¡å–å¾—": {
      "main": [
        [
          {
            "node": "å¯¾è±¡æœ‰ç„¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¯¾è±¡æœ‰ç„¡": {
      "main": [
        [
          {
            "node": "å¯¾è±¡ãªã—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ã‚¹ã‚³ã‚¢è¨ˆç®—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¹ã‚³ã‚¢è¨ˆç®—": {
      "main": [
        [
          {
            "node": "Tieråˆ†é¡ž",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tieråˆ†é¡ž": {
      "main": [
        [
          {
            "node": "å³æ™‚å‡ºå“ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å³æ™‚å‡ºå“ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "å³æ™‚å‡ºå“æŠ½å‡º",
            "type": "main",
            "index": 0
          },
          {
            "node": "ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾è±¡ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾è±¡ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å³æ™‚å‡ºå“æŠ½å‡º": {
      "main": [
        [
          {
            "node": "ãƒãƒƒãƒåˆ†å‰²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒãƒƒãƒåˆ†å‰²": {
      "main": [
        [
          {
            "node": "eBayå‡ºå“ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆå†…éƒ¨èªè¨¼ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "eBayå‡ºå“ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆå†…éƒ¨èªè¨¼ï¼‰": {
      "main": [
        [
          {
            "node": "ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¾…æ©Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¾…æ©Ÿ": {
      "main": [
        [
          {
            "node": "ã‚¹ã‚³ã‚¢è¨˜éŒ²ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾è±¡ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ðŸŽ¬ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚­ãƒ¥ãƒ¼ç™»éŒ²",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ChatWorké€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¬ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚­ãƒ¥ãƒ¼ç™»éŒ²": {
      "main": [
        [
          {
            "node": "ChatWorké€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatWorké€šçŸ¥": {
      "main": [
        [
          {
            "node": "ðŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¹ã‚³ã‚¢è¨˜éŒ²ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰": {
      "main": [
        [
          {
            "node": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸": {
      "main": [
        [
          {
            "node": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¯¾è±¡ãªã—": {
      "main": [
        [
          {
            "node": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 1800,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-Listing",
      "color": "#1e90ff"
    },
    {
      "name": "V4-PRODUCTION",
      "color": "#ff0000"
    },
    {
      "name": "Scoring",
      "color": "#ffd700"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "Media-Bridge",
      "color": "#9932cc"
    },
    {
      "name": "500MB-Safe",
      "color": "#32cd32"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}