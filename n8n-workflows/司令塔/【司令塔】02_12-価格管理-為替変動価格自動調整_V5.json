{
  "name": "ã€å¸ä»¤å¡”ã€‘02_12-ä¾¡æ ¼ç®¡ç†-ç‚ºæ›¿å¤‰å‹•ä¾¡æ ¼è‡ªå‹•èª¿æ•´_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 4
            }
          ]
        }
      },
      "id": "cron-4h",
      "name": "4æ™‚é–“ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "https://api.exchangerate-api.com/v4/latest/JPY",
        "options": {
          "timeout": 10000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "fetch-rates",
      "name": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT gs.user_id, gs.key, gs.value FROM global_settings gs WHERE gs.key LIKE 'exchange_rate_%' AND gs.user_id IS NOT NULL",
        "options": {}
      },
      "id": "get-saved-rates",
      "name": "ä¿å­˜ãƒ¬ãƒ¼ãƒˆå–å¾—ï¼ˆuser_idåˆ¥ï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// V4-PRODUCTION: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç‚ºæ›¿å¤‰å‹•ãƒã‚§ãƒƒã‚¯\n// ========================================\nconst newRates = $node['ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—'].json.rates || {};\nconst savedRatesRaw = $input.all().map(i => i.json);\n\nif (!newRates.USD) {\n  return [{ json: { error: true, message: 'ç‚ºæ›¿APIå–å¾—å¤±æ•—' } }];\n}\n\n// ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–\nconst userRates = {};\nsavedRatesRaw.forEach(r => {\n  if (!r.user_id) return;\n  if (!userRates[r.user_id]) userRates[r.user_id] = {};\n  const currency = r.key.replace('exchange_rate_', '').toUpperCase().replace('_JPY', '');\n  userRates[r.user_id][currency] = parseFloat(r.value);\n});\n\nconst currencies = ['USD', 'EUR', 'GBP', 'AUD'];\nconst threshold = 0.02; // 2%ä»¥ä¸Šã®å¤‰å‹•ã§èª¿æ•´\n\nconst results = [];\n\nObject.entries(userRates).forEach(([userId, savedRateMap]) => {\n  const rateChanges = [];\n  \n  currencies.forEach(currency => {\n    const newRate = 1 / (newRates[currency] || 1);\n    const savedRate = savedRateMap[currency] || 0;\n    \n    if (savedRate > 0) {\n      const change = (newRate - savedRate) / savedRate;\n      const changePercent = Math.round(change * 10000) / 100;\n      \n      if (Math.abs(change) >= threshold) {\n        rateChanges.push({\n          currency: currency,\n          old_rate: savedRate,\n          new_rate: newRate,\n          change_percent: changePercent,\n          direction: change > 0 ? 'up' : 'down'\n        });\n      }\n    }\n  });\n  \n  if (rateChanges.length > 0) {\n    results.push({ json: {\n      user_id: userId,\n      has_significant_change: true,\n      rate_changes: rateChanges,\n      timestamp: new Date().toISOString()\n    } });\n  }\n});\n\nif (results.length === 0) {\n  return [{ json: { no_changes: true, message: 'æœ‰æ„ãªç‚ºæ›¿å¤‰å‹•ãªã—', timestamp: new Date().toISOString() } }];\n}\n\nreturn results;"
      },
      "id": "check-changes",
      "name": "å¤‰å‹•ãƒã‚§ãƒƒã‚¯ï¼ˆuser_idåˆ¥ï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.no_changes || $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "has-changes",
      "name": "å¤‰å‹•ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { message: $input.first().json.message || 'å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—' } }];"
      },
      "id": "no-changes",
      "name": "å¤‰å‹•ãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ğŸ’± ç‚ºæ›¿å¤‰å‹•æ¤œçŸ¥[/title]User: {{ $json.user_id }}\\n\\n{{ $json.rate_changes.map(r => r.currency + ': ' + r.change_percent + '%' + (r.direction === 'up' ? 'â†‘å††å®‰' : 'â†“å††é«˜')).join('\\n') }}\\n\\nä¾¡æ ¼èª¿æ•´å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚[/info]"
            }
          ]
        },
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "id": "alert-change",
      "name": "ChatWork å¤‰å‹•é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N3_API_URL || '{{$env.GATEWAY_URL}}' }}/api/pricing/exchange-adjustment",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ user_id: $json.user_id, rate_changes: $json.rate_changes, timestamp: $json.timestamp }) }}",
        "options": {
          "timeout": 300000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "trigger-adjustment",
      "name": "ä¾¡æ ¼èª¿æ•´APIå‘¼å‡º",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst request = $node['ChatWork å¤‰å‹•é€šçŸ¥'].json;\n\nreturn [{ json: {\n  user_id: request.user_id,\n  adjusted_count: response.adjusted_count || 0,\n  warning_count: response.warning_count || 0,\n  error: response.error || null,\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "parse-result",
      "name": "çµæœè§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]âœ… ä¾¡æ ¼èª¿æ•´å®Œäº†[/title]User: {{ $json.user_id }}\\nèª¿æ•´ä»¶æ•°: {{ $json.adjusted_count }}ä»¶\\nè­¦å‘Šä»¶æ•°: {{ $json.warning_count }}ä»¶\\n\\n{{ $json.warning_count > 0 ? 'âš ï¸ åˆ©ç›Šç‡5%ä»¥ä¸‹ã®å•†å“ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'å…¨å•†å“ã®åˆ©ç›Šç‡ã‚’ç¢ºä¿ã—ã¾ã—ãŸã€‚' }}[/info]"
            }
          ]
        },
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "id": "notify-result",
      "name": "ChatWork çµæœé€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\nreturn [{ json: {\n  total_users: results.length,\n  total_adjusted: results.reduce((s, r) => s + (r.adjusted_count || 0), 0),\n  total_warnings: results.reduce((s, r) => s + (r.warning_count || 0), 0),\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "aggregate",
      "name": "çµæœé›†ç´„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM stock_sync_logs WHERE created_at < NOW() - INTERVAL '7 days'; DELETE FROM listing_history WHERE created_at < NOW() - INTERVAL '7 days';",
        "options": {}
      },
      "id": "purge-history",
      "name": "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "4æ™‚é–“ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ä¿å­˜ãƒ¬ãƒ¼ãƒˆå–å¾—ï¼ˆuser_idåˆ¥ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¿å­˜ãƒ¬ãƒ¼ãƒˆå–å¾—ï¼ˆuser_idåˆ¥ï¼‰": {
      "main": [
        [
          {
            "node": "å¤‰å‹•ãƒã‚§ãƒƒã‚¯ï¼ˆuser_idåˆ¥ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤‰å‹•ãƒã‚§ãƒƒã‚¯ï¼ˆuser_idåˆ¥ï¼‰": {
      "main": [
        [
          {
            "node": "å¤‰å‹•ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤‰å‹•ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "å¤‰å‹•ãªã—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ChatWork å¤‰å‹•é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatWork å¤‰å‹•é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ä¾¡æ ¼èª¿æ•´APIå‘¼å‡º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¾¡æ ¼èª¿æ•´APIå‘¼å‡º": {
      "main": [
        [
          {
            "node": "çµæœè§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµæœè§£æ": {
      "main": [
        [
          {
            "node": "ChatWork çµæœé€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatWork çµæœé€šçŸ¥": {
      "main": [
        [
          {
            "node": "çµæœé›†ç´„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµæœé›†ç´„": {
      "main": [
        [
          {
            "node": "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤‰å‹•ãªã—": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 600,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-Pricing",
      "color": "#32cd32"
    },
    {
      "name": "V4-PRODUCTION",
      "color": "#ff0000"
    },
    {
      "name": "Exchange",
      "color": "#ffd700"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "500MB-Safe",
      "color": "#32cd32"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}