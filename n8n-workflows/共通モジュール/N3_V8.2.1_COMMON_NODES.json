{
  "name": "ã€V8.2.1å…±é€šã€‘è‡ªå¾‹ã‚³ãƒãƒ¼ã‚¹æ‹¡å¼µãƒãƒ¼ãƒ‰é›†",
  "description": "N3 Empire OS V8.2.1: SMè‡ªå¾‹é¸æŠãƒ»æ æœ€é©åŒ–ãƒ»å†å¸°è£œå®Œãƒ»å¤šè²©è·¯åŒæœŸã®å…±é€šãƒ‘ãƒ¼ãƒ„",
  "_version": "8.2.1",
  "_created_at": "2026-01-24T00:00:00.000Z",
  
  "common_nodes": {
    
    "sm_strategy_selector": {
      "name": "ğŸ¯ SMæˆ¦ç•¥ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼",
      "description": "è¤‡æ•°ã®æˆ¦ç•¥ï¼ˆæœ€å®‰å€¤/é«˜åˆ©ç›Š/å›è»¢ç‡é‡è¦–ï¼‰ã‹ã‚‰åœ¨åº«çŠ¶æ³ã«å¿œã˜ãŸæœ€é©è§£ã‚’è‡ªå¾‹åˆ¤æ–­",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ¯ V8.2.1 SMæˆ¦ç•¥ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: å¤šè»¸ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹è‡ªå¾‹æˆ¦ç•¥é¸æŠ\n// ============================================================================\nconst data = $input.first().json;\nconst product = data.payload || data;\n\n// æˆ¦ç•¥å®šç¾©ãƒãƒˆãƒªãƒƒã‚¯ã‚¹\nconst STRATEGIES = {\n  aggressive_margin: {\n    name: 'aggressive_margin',\n    targetMargin: 0.30,\n    minTurnover: 5,\n    maxCompetitors: 50,\n    priceMultiplier: 1.15,\n    description: 'é«˜åˆ©ç›Šè¿½æ±‚å‹ï¼šä½ç«¶åˆãƒ»é«˜ãƒˆãƒ¬ãƒ³ãƒ‰å¸‚å ´å‘ã‘'\n  },\n  balanced: {\n    name: 'balanced',\n    targetMargin: 0.20,\n    minTurnover: 10,\n    maxCompetitors: 100,\n    priceMultiplier: 1.05,\n    description: 'ãƒãƒ©ãƒ³ã‚¹å‹ï¼šé€šå¸¸å¸‚å ´å‘ã‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'\n  },\n  volume_rotation: {\n    name: 'volume_rotation',\n    targetMargin: 0.12,\n    minTurnover: 30,\n    maxCompetitors: 200,\n    priceMultiplier: 0.95,\n    description: 'å›è»¢ç‡é‡è¦–å‹ï¼šåœ¨åº«åœ§åŠ›è§£æ¶ˆãƒ»ã‚·ã‚§ã‚¢ç²å¾—'\n  },\n  defensive: {\n    name: 'defensive',\n    targetMargin: 0.35,\n    minTurnover: 2,\n    maxCompetitors: 20,\n    priceMultiplier: 1.25,\n    description: 'é˜²å¾¡å‹ï¼šéç«¶äº‰å¸‚å ´ãƒ»ãƒªã‚¹ã‚¯å›é¿'\n  }\n};\n\n// å­£ç¯€æ€§ãƒãƒ«ãƒãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰\nconst getSeasonalMultiplier = (categoryId, date) => {\n  const month = date.getMonth();\n  const SEASONAL = {\n    '11450': { 11: 1.3, 0: 1.2 },  // Clothing: Nov-Jan\n    '293': { 10: 1.4, 11: 1.5, 0: 1.3 },  // Video Games: Holiday\n    '15032': { 3: 1.2, 4: 1.3 }  // Sports: Spring\n  };\n  return SEASONAL[categoryId]?.[month] || 1.0;\n};\n\n// å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\nconst competitionRatio = (product.active_listings || 100) / Math.max(product.sold_last_30d || 10, 1);\nconst trendScore = product.trend_score || product.sm_confidence_score || 50;\nconst inventoryPressure = (product.current_inventory || 1) / (product.target_inventory || 1);\nconst seasonalMultiplier = getSeasonalMultiplier(product.ebay_category_id || product.category_id, new Date());\n\n// æˆ¦ç•¥é¸æŠãƒ­ã‚¸ãƒƒã‚¯\nlet selected, reason;\n\nif (competitionRatio < 2 && trendScore > 70) {\n  selected = STRATEGIES.aggressive_margin;\n  reason = `ä½ç«¶åˆ(${competitionRatio.toFixed(1)}) Ã— é«˜ãƒˆãƒ¬ãƒ³ãƒ‰(${trendScore})ï¼šæ”»æ’ƒçš„ä¾¡æ ¼è¨­å®š`;\n} else if (inventoryPressure > 1.5) {\n  selected = STRATEGIES.volume_rotation;\n  reason = `åœ¨åº«åœ§åŠ›(${inventoryPressure.toFixed(1)}x)ï¼šå›è»¢ç‡å„ªå…ˆã§åœ¨åº«è§£æ¶ˆ`;\n} else if (seasonalMultiplier > 1.2) {\n  selected = STRATEGIES.aggressive_margin;\n  reason = `å­£ç¯€éœ€è¦(${(seasonalMultiplier * 100 - 100).toFixed(0)}%UP)ï¼šéœ€è¦æœŸã«é«˜ãƒãƒ¼ã‚¸ãƒ³ç¢ºä¿`;\n} else if (competitionRatio > 10) {\n  selected = STRATEGIES.defensive;\n  reason = `éç«¶äº‰(${competitionRatio.toFixed(1)})ï¼šå‚å…¥ãƒªã‚¹ã‚¯é«˜ã€é˜²å¾¡æˆ¦ç•¥`;\n} else {\n  selected = STRATEGIES.balanced;\n  reason = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥';\n}\n\n// çµæœè¿”å´\nreturn [{ json: {\n  ...data,\n  _sm_strategy: {\n    ...selected,\n    selectedAt: new Date().toISOString(),\n    reason: reason,\n    inputs: {\n      competitionRatio,\n      trendScore,\n      inventoryPressure,\n      seasonalMultiplier\n    }\n  }\n} }];"
      },
      "notes": "[V8.2.1] å‡ºå“åˆ¤æ–­å‰ã«æŒ¿å…¥ã€‚_sm_strategyã‚’ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã§å‚ç…§"
    },

    "slot_optimizer": {
      "name": "ğŸ“Š æ ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼",
      "description": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥å‡ºå“ä¸Šé™ãƒ»ã‚«ãƒ†ã‚´ãƒªæ ã‚’è€ƒæ…®ã—ãŸåˆ©ç›Šæœ€å¤§åŒ–å‰²ã‚Šå½“ã¦ï¼ˆãƒŠãƒƒãƒ—ã‚µãƒƒã‚¯è¿‘ä¼¼è§£æ³•ï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ“Š V8.2.1 æ ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼: æœ‰é™ãƒªã‚½ãƒ¼ã‚¹ã®æœ€å¤§åŠ¹ç‡æ´»ç”¨\n// ============================================================================\nconst data = $input.first().json;\nconst products = data.products || [];\nconst accountSlots = data.account_slots || [];\n\nif (products.length === 0) {\n  return [{ json: { error: true, message: 'å•†å“ãƒªã‚¹ãƒˆãŒç©ºã§ã™' } }];\n}\n\nif (accountSlots.length === 0) {\n  return [{ json: { error: true, message: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“' } }];\n}\n\n// åˆ©ç›ŠæœŸå¾…å€¤è¨ˆç®—\nconst enrichedProducts = products.map(p => ({\n  ...p,\n  expected_value: (\n    (p.profit_margin || 0.15) * \n    (p.sell_probability || 0.5) * \n    (p.price_usd || 50)\n  ),\n  category_id: p.ebay_category_id || p.category_id || 'default'\n}));\n\n// åˆ©ç›ŠæœŸå¾…å€¤é™é †ã‚½ãƒ¼ãƒˆ\nconst sorted = enrichedProducts.sort((a, b) => b.expected_value - a.expected_value);\n\n// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ ã®åˆæœŸåŒ–ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ï¼‰\nconst slots = accountSlots.map(acc => ({\n  account_id: acc.account_id,\n  remaining: parseInt(acc.remaining) || 0,\n  category_limits: { ...(acc.category_limits || {}) }\n}));\n\n// è²ªæ¬²æ³•ã«ã‚ˆã‚‹å‰²ã‚Šå½“ã¦\nconst assignments = [];\nconst unassigned = [];\nlet totalExpectedValue = 0;\n\nfor (const product of sorted) {\n  // åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿\n  const eligible = slots.filter(acc => {\n    if (acc.remaining <= 0) return false;\n    \n    // ã‚«ãƒ†ã‚´ãƒªæ ãƒã‚§ãƒƒã‚¯\n    const catLimit = acc.category_limits[product.category_id];\n    if (catLimit !== undefined && catLimit <= 0) return false;\n    \n    return true;\n  });\n\n  if (eligible.length === 0) {\n    unassigned.push({ product_id: product.id, reason: 'no_available_slot' });\n    continue;\n  }\n\n  // æœ€ã‚‚æ ã«ä½™è£•ã®ã‚ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠï¼ˆè² è·åˆ†æ•£ï¼‰\n  const best = eligible.reduce((a, b) => a.remaining > b.remaining ? a : b);\n\n  assignments.push({\n    product_id: product.id,\n    product_sku: product.sku,\n    account_id: best.account_id,\n    expected_value: Math.round(product.expected_value * 100) / 100,\n    priority: assignments.length + 1\n  });\n\n  totalExpectedValue += product.expected_value;\n\n  // æ æ¶ˆè²»\n  best.remaining--;\n  if (best.category_limits[product.category_id] !== undefined) {\n    best.category_limits[product.category_id]--;\n  }\n}\n\n// çµæœã‚µãƒãƒªãƒ¼\nreturn [{ json: {\n  success: true,\n  summary: {\n    total_products: products.length,\n    assigned: assignments.length,\n    unassigned: unassigned.length,\n    total_expected_value: Math.round(totalExpectedValue * 100) / 100,\n    utilization_rate: Math.round((assignments.length / products.length) * 100) + '%'\n  },\n  assignments: assignments,\n  unassigned: unassigned,\n  remaining_slots: slots.map(s => ({ account_id: s.account_id, remaining: s.remaining }))\n} }];"
      },
      "notes": "[V8.2.1] å‡ºå“ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå‰ã«æŒ¿å…¥ã€‚assignmentsã‚’1ä»¶ãšã¤å‡¦ç†"
    },

    "recursive_enricher": {
      "name": "ğŸ”„ å†å¸°ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼",
      "description": "ä¿¡é ¼åº¦é–¾å€¤ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰è‡ªå‹•è£œå®Œï¼ˆæœ€å¤§3å›å†å¸°ï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ”„ V8.2.1 å†å¸°ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼: ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•è£œå®Œ\n// ============================================================================\nconst data = $input.first().json;\nconst product = data.payload || data;\n\nconst CONFIDENCE_THRESHOLD = 75;\nconst MAX_DEPTH = 3;\nconst depth = product._enrichment_depth || 0;\n\n// ç¾åœ¨ã®ä¿¡é ¼åº¦è©•ä¾¡\nlet confidence = product.confidence_score || product.ai_confidence_score || 50;\n\n// æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯\nconst missingFields = [];\nif (!product.hts_code || product.hts_code === '9999.99.99') missingFields.push('hts_code');\nif (!product.weight_g || product.weight_g === 500) missingFields.push('weight_g');\nif (!product.origin_country) missingFields.push('origin_country');\nif (!product.item_specifics || Object.keys(product.item_specifics).length < 3) missingFields.push('item_specifics');\n\n// ä¿¡é ¼åº¦ãŒé–¾å€¤ä»¥ä¸Šã‹ã¤æ¬ æãªã—ãªã‚‰å®Œäº†\nif (confidence >= CONFIDENCE_THRESHOLD && missingFields.length === 0) {\n  return [{ json: {\n    ...data,\n    _enrichment: {\n      status: 'complete',\n      confidence: confidence,\n      depth: depth,\n      source: product._enrichment_source || 'original'\n    }\n  } }];\n}\n\n// æœ€å¤§æ·±åº¦åˆ°é”\nif (depth >= MAX_DEPTH) {\n  return [{ json: {\n    ...data,\n    _enrichment: {\n      status: 'max_depth_reached',\n      confidence: confidence,\n      depth: depth,\n      warning: `ä¿¡é ¼åº¦${confidence}%ã§å‡¦ç†ç¶šè¡Œï¼ˆé–¾å€¤${CONFIDENCE_THRESHOLD}%æœªé”ï¼‰`,\n      missing_fields: missingFields\n    }\n  } }];\n}\n\n// æ¬¡ã®è£œå®Œã‚½ãƒ¼ã‚¹ã‚’æ±ºå®š\nconst SOURCES = [\n  { name: 'eBay Browse API', priority: 1, endpoint: '/api/ebay/browse-enrich' },\n  { name: 'Amazon Catalog', priority: 2, endpoint: '/api/amazon/catalog-lookup' },\n  { name: 'Competitor Analysis', priority: 3, endpoint: '/api/research/competitor-specs' },\n  { name: 'AI Inference', priority: 4, endpoint: '/api/ai/deep-analyze' }\n];\n\nconst triedSources = product._tried_sources || [];\nconst nextSource = SOURCES.find(s => !triedSources.includes(s.name));\n\nif (!nextSource) {\n  return [{ json: {\n    ...data,\n    _enrichment: {\n      status: 'all_sources_exhausted',\n      confidence: confidence,\n      depth: depth,\n      tried_sources: triedSources,\n      missing_fields: missingFields\n    }\n  } }];\n}\n\n// è£œå®ŒãŒå¿…è¦ â†’ æ¬¡ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒˆãƒªã‚¬ãƒ¼\nreturn [{ json: {\n  ...data,\n  payload: {\n    ...product,\n    _enrichment_depth: depth + 1,\n    _tried_sources: [...triedSources, nextSource.name],\n    _current_source: nextSource\n  },\n  _enrichment: {\n    status: 'needs_enrichment',\n    next_source: nextSource.name,\n    next_endpoint: nextSource.endpoint,\n    confidence: confidence,\n    depth: depth + 1,\n    missing_fields: missingFields\n  }\n} }];"
      },
      "notes": "[V8.2.1] ãƒ‡ãƒ¼ã‚¿æº–å‚™å¾Œã«æŒ¿å…¥ã€‚_enrichment.status=needs_enrichmentãªã‚‰HTTP Requestã¸åˆ†å²"
    },

    "cross_marketplace_pricer": {
      "name": "ğŸ”— å¤šè²©è·¯ä¾¡æ ¼ã‚·ãƒ³ã‚¯ãƒ­ãƒŠã‚¤ã‚¶ãƒ¼",
      "description": "è²©è·¯åˆ¥ã®æ‰‹æ•°æ–™ãƒ»é€æ–™ãƒ»ç‚ºæ›¿ã‚’è€ƒæ…®ã—ãŸæ•´åˆæ€§ã®ã‚ã‚‹ä¾¡æ ¼è¨ˆç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ”— V8.2.1 å¤šè²©è·¯ä¾¡æ ¼ã‚·ãƒ³ã‚¯ãƒ­ãƒŠã‚¤ã‚¶ãƒ¼: ã‚¯ãƒ­ã‚¹ãƒãƒ¼ã‚±ãƒƒãƒˆæ•´åˆæ€§è¨ˆç®—\n// ============================================================================\nconst data = $input.first().json;\nconst product = data.payload || data;\nconst exchangeRates = data.exchange_rates || { USD: 1, JPY: 150, SGD: 0.74, EUR: 0.92 };\n\n// ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹è¨­å®š\nconst MARKETPLACE_CONFIG = {\n  'ebay_us': {\n    name: 'eBay US',\n    currency: 'USD',\n    fvf: 0.1295,\n    payment_fee: 0.029,\n    fixed_fee: 0.30,\n    shipping_base: 15,\n    min_margin: 0.10\n  },\n  'amazon_us': {\n    name: 'Amazon US',\n    currency: 'USD',\n    referral: 0.15,\n    fba_fee: 4.50,\n    closing_fee: 1.80,\n    shipping_base: 0,  // FBAè¾¼ã¿\n    min_margin: 0.12\n  },\n  'qoo10_jp': {\n    name: 'Qoo10 Japan',\n    currency: 'JPY',\n    fvf: 0.10,\n    payment_fee: 0.034,\n    fixed_fee: 0,\n    shipping_base: 800,\n    min_margin: 0.08\n  },\n  'shopee_sg': {\n    name: 'Shopee Singapore',\n    currency: 'SGD',\n    fvf: 0.06,\n    payment_fee: 0.02,\n    fixed_fee: 0,\n    shipping_base: 5,\n    min_margin: 0.08\n  }\n};\n\nconst targetMarketplaces = product.target_marketplaces || ['ebay_us', 'amazon_us', 'qoo10_jp'];\nconst baseCostJPY = product.purchase_price || product.cost_price || 0;\n\nif (baseCostJPY === 0) {\n  return [{ json: { error: true, message: 'åŸä¾¡(purchase_price)ãŒ0ã§ã™' } }];\n}\n\n// å„è²©è·¯ã®ä¾¡æ ¼è¨ˆç®—\nconst prices = targetMarketplaces.map(mpKey => {\n  const config = MARKETPLACE_CONFIG[mpKey];\n  if (!config) {\n    return { marketplace: mpKey, error: 'æœªå¯¾å¿œãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹' };\n  }\n\n  const rate = exchangeRates[config.currency] || 1;\n  const costLocal = baseCostJPY / (exchangeRates.JPY / rate);\n\n  // å¤‰å‹•è²»ç‡\n  const variableRate = (config.fvf || 0) + (config.payment_fee || 0) + (config.referral || 0);\n  \n  // å›ºå®šè²»\n  const fixedCosts = (config.fixed_fee || 0) + (config.fba_fee || 0) + (config.closing_fee || 0) + config.shipping_base;\n\n  // æœ€ä½ä¾¡æ ¼ = (åŸä¾¡ + å›ºå®šè²») / (1 - å¤‰å‹•è²»ç‡ - æœ€ä½åˆ©ç›Šç‡)\n  const minPrice = (costLocal + fixedCosts) / (1 - variableRate - config.min_margin);\n\n  // ç«¶åˆä¾¡æ ¼ã¨ã®èª¿æ•´\n  const competitorPrice = product.competitor_prices?.[mpKey];\n  let recommendedPrice;\n  if (competitorPrice) {\n    recommendedPrice = Math.max(minPrice, competitorPrice * 0.95);  // ç«¶åˆã®95%ã‚’ä¸‹é™\n    if (recommendedPrice > competitorPrice * 1.1) {\n      recommendedPrice = competitorPrice * 1.05;  // ç«¶åˆã®110%è¶…ãˆãŸã‚‰105%ã«æŠ‘åˆ¶\n    }\n  } else {\n    recommendedPrice = minPrice * 1.15;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€ä½ä¾¡æ ¼ã®115%\n  }\n\n  // æœŸå¾…åˆ©ç›Šç‡\n  const revenue = recommendedPrice + (mpKey.includes('amazon') ? 0 : config.shipping_base);\n  const fees = revenue * variableRate + fixedCosts;\n  const expectedMargin = ((revenue - costLocal - fees) / revenue) * 100;\n\n  return {\n    marketplace: mpKey,\n    marketplace_name: config.name,\n    currency: config.currency,\n    cost_local: Math.round(costLocal * 100) / 100,\n    min_price: Math.ceil(minPrice),\n    recommended_price: Math.ceil(recommendedPrice),\n    competitor_price: competitorPrice || null,\n    expected_margin: Math.round(expectedMargin * 10) / 10,\n    is_profitable: expectedMargin >= config.min_margin * 100\n  };\n});\n\n// æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯\nconst unprofitable = prices.filter(p => !p.error && !p.is_profitable);\nconst hasIssues = unprofitable.length > 0;\n\nreturn [{ json: {\n  ...data,\n  _marketplace_prices: {\n    success: !hasIssues,\n    base_cost_jpy: baseCostJPY,\n    prices: prices,\n    warnings: unprofitable.map(p => `${p.marketplace}: åˆ©ç›Šç‡${p.expected_margin}%ï¼ˆæœ€ä½${MARKETPLACE_CONFIG[p.marketplace]?.min_margin * 100}%æœªæº€ï¼‰`),\n    calculated_at: new Date().toISOString()\n  }\n} }];"
      },
      "notes": "[V8.2.1] å‡ºå“å‰ã«æŒ¿å…¥ã€‚_marketplace_prices.success=falseãªã‚‰HitLæ‰¿èªã¸"
    },

    "red_flag_guardian": {
      "name": "ğŸ›¡ï¸ èµ¤å­—çµ¶å¯¾å›é¿ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³",
      "description": "ç‚ºæ›¿æ€¥å¤‰ãƒ»é–¢ç¨ç‡å¤‰æ›´æ™‚ã®å‹•çš„å†è¨ˆç®—ã¨ç·Šæ€¥åœæ­¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ›¡ï¸ V8.2.1 èµ¤å­—çµ¶å¯¾å›é¿ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ©ç›Šç›£è¦–\n// ============================================================================\nconst data = $input.first().json;\nconst product = data.payload || data;\n\n// ç¾åœ¨ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯DBã‹ã‚‰å–å¾—ï¼‰\nconst currentRate = parseFloat($env.CURRENT_USD_JPY) || 150;\nconst listingRate = product.listing_exchange_rate || currentRate;\n\n// ç‚ºæ›¿å¤‰å‹•ãƒã‚§ãƒƒã‚¯\nconst rateChange = ((currentRate - listingRate) / listingRate) * 100;\nconst RATE_THRESHOLD = 3;  // 3%ä»¥ä¸Šã®å¤‰å‹•ã§è­¦å‘Š\n\n// ç¾åœ¨ä¾¡æ ¼ã§ã®åˆ©ç›Šå†è¨ˆç®—\nconst costJPY = product.purchase_price || 0;\nconst priceUSD = product.price_usd || product.ddp_price_usd || 0;\nconst shippingUSD = product.shipping_cost_usd || 15;\nconst fvfRate = 0.1295 + 0.029 + 0.03;  // eBayæ‰‹æ•°æ–™åˆè¨ˆ\n\nconst revenueUSD = priceUSD + shippingUSD;\nconst costUSD = costJPY / currentRate;\nconst feesUSD = revenueUSD * fvfRate + 0.35;\nconst ddpUSD = priceUSD * 0.06 + priceUSD * 0.08 + 15;  // é–¢ç¨+ç¨+DDPæ‰‹æ•°æ–™\n\nconst currentProfitUSD = revenueUSD - costUSD - feesUSD - ddpUSD;\nconst currentMargin = (currentProfitUSD / revenueUSD) * 100;\n\n// èµ¤å­—åˆ¤å®š\nconst isLoss = currentProfitUSD < 0;\nconst isLowMargin = currentMargin < 5;\nconst isRateAlert = Math.abs(rateChange) > RATE_THRESHOLD;\n\n// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š\nlet action = 'proceed';\nlet reason = '';\nlet recommendedPrice = priceUSD;\n\nif (isLoss) {\n  action = 'emergency_stop';\n  reason = `èµ¤å­—è»¢è½: ç¾åœ¨åˆ©ç›Š $${currentProfitUSD.toFixed(2)} (ç‚ºæ›¿${currentRate}å††)`;\n  // æœ€ä½åˆ©ç›Š5%ç¢ºä¿ã®ãŸã‚ã®æ¨å¥¨ä¾¡æ ¼\n  recommendedPrice = Math.ceil((costUSD + ddpUSD + feesUSD / (1 - fvfRate)) / (1 - 0.05 - fvfRate));\n} else if (isLowMargin) {\n  action = 'require_review';\n  reason = `ä½åˆ©ç›Šç‡è­¦å‘Š: ${currentMargin.toFixed(1)}% (é–¾å€¤5%)`;\n  recommendedPrice = Math.ceil(priceUSD * 1.1);\n} else if (isRateAlert) {\n  action = 'rate_alert';\n  reason = `ç‚ºæ›¿å¤‰å‹•è­¦å‘Š: ${rateChange > 0 ? '+' : ''}${rateChange.toFixed(1)}% (${listingRate}â†’${currentRate}å††)`;\n}\n\nreturn [{ json: {\n  ...data,\n  _red_flag_check: {\n    action: action,\n    reason: reason,\n    is_loss: isLoss,\n    is_low_margin: isLowMargin,\n    is_rate_alert: isRateAlert,\n    current_profit_usd: Math.round(currentProfitUSD * 100) / 100,\n    current_margin: Math.round(currentMargin * 10) / 10,\n    exchange_rate: {\n      listing: listingRate,\n      current: currentRate,\n      change_pct: Math.round(rateChange * 10) / 10\n    },\n    recommended_price: recommendedPrice,\n    checked_at: new Date().toISOString()\n  }\n} }];"
      },
      "notes": "[V8.2.1] å‡ºå“å®Ÿè¡Œç›´å‰ã«æŒ¿å…¥ã€‚action=emergency_stopãªã‚‰å³åº§ã«HitLã¸"
    }

  },

  "integration_template": {
    "description": "æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®çµ±åˆé †åº",
    "recommended_order": [
      "1. Auth-Gateï¼ˆæ—¢å­˜V6ã‹ã‚‰ç¶™æ‰¿ï¼‰",
      "2. Identity-Managerï¼ˆV8ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰è¿½åŠ ï¼‰",
      "3. ğŸ¯ SMæˆ¦ç•¥ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ â† NEW",
      "4. ğŸ“Š æ ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ â† NEW",
      "5. ğŸ”„ å†å¸°ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ â† NEW",
      "6. æ—¢å­˜ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯",
      "7. ğŸ”— å¤šè²©è·¯ä¾¡æ ¼ã‚·ãƒ³ã‚¯ãƒ­ãƒŠã‚¤ã‚¶ãƒ¼ â† NEW",
      "8. ğŸ›¡ï¸ èµ¤å­—çµ¶å¯¾å›é¿ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ â† NEW",
      "9. Policy-Validatorï¼ˆV8ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰è¿½åŠ ï¼‰",
      "10. HitLæ‰¿èªã‚­ãƒ¥ãƒ¼ï¼ˆV8ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰è¿½åŠ ï¼‰",
      "11. Audit-Logï¼ˆæ—¢å­˜V6ã‹ã‚‰ç¶™æ‰¿ï¼‰"
    ],
    "connection_pattern": {
      "if_strategy_defensive": "â†’ HitLæ‰¿èªã‚­ãƒ¥ãƒ¼ã¸åˆ†å²ï¼ˆé«˜ãƒªã‚¹ã‚¯å¸‚å ´ï¼‰",
      "if_no_available_slot": "â†’ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼ã¸ï¼ˆæ ç©ºãå¾…ã¡ï¼‰",
      "if_needs_enrichment": "â†’ å¤–éƒ¨APIè£œå®Œãƒ«ãƒ¼ãƒ—ã¸",
      "if_margin_below_threshold": "â†’ HitLæ‰¿èªã‚­ãƒ¥ãƒ¼ã¸",
      "if_emergency_stop": "â†’ å³åº§ã«å‡ºå“åœæ­¢ãƒ»ç®¡ç†è€…é€šçŸ¥"
    }
  }
}
