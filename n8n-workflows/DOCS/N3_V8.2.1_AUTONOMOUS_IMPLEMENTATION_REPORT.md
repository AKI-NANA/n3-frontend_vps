# N3 Empire OS V8.2.1-Autonomous 完全体実装レポート

## 📋 概要

27次元防衛指示書を100%遵守しながら、以下の自律知能を完全統合した「V8.2.1-Autonomous」を構築しました。

---

## 🏗️ 成果物一覧

### 1. SQLスキーマ
| ファイル | 内容 |
|---------|------|
| `N3_V8.2.1_AUTONOMOUS_SCHEMA.sql` | 27次元防衛 + AI判断証跡 + カテゴリ枠管理 |

### 2. n8nワークフロー
| ファイル | Webhook | 機能 |
|---------|---------|------|
| `N3_V8.2.1_AUTONOMOUS_LISTING_HUB.json` | `/v821-listing-hub` | 統合出品ハブ（価格計算強制統合） |
| `N3_V8.2.1_AUTONOMOUS_SM_AGENT.json` | `/sm-agent-judge` | SM AIエージェント（リファレンス判定） |
| `N3_V8.2.1_AUTONOMOUS_SELF_HEALING.json` | `/self-healing-enrich` | 再帰的データ補完 |

---

## 🛡️ 27次元防衛 実装詳細

### 次元3: Auth-Gateバイパス排除
```sql
-- JITトークン管理テーブル
CREATE TABLE jit_tokens (
    token_hash TEXT NOT NULL,  -- SHA256ハッシュ（生トークンは保存しない）
    expires_at TIMESTAMPTZ NOT NULL,  -- 最大15分
    CONSTRAINT jit_token_expiry CHECK (expires_at <= issued_at + INTERVAL '15 minutes')
);
```
- **JITトークン優先認証**: 15分有効の一時トークン
- **HMACフォールバック**: タイムスタンプ検証（5分以内）
- **使い捨て**: トークン使用後は即座に無効化

### 次元13: Decision Trace（AI判断証跡）
```sql
CREATE TABLE ai_decision_traces (
    trace_id UUID NOT NULL,
    decision_point TEXT NOT NULL,  -- 'sm_selection', 'pricing', 'listing_approval'
    ai_model TEXT NOT NULL,
    ai_prompt_hash TEXT NOT NULL,  -- 再現性確保
    reasoning TEXT NOT NULL,       -- 判断理由（必須）
    record_hash TEXT GENERATED ALWAYS AS (...)  -- 法廷耐性用署名
);
```
- **全AI判断をログ記録**: プロンプトハッシュ + 思考プロセス
- **法廷耐性**: タイムゾーン + ハッシュ署名付き
- **エスカレーション追跡**: HitL承認時の理由も記録

### 次元22: 燃焼上限（APIコストキャップ）
```sql
CREATE TABLE api_consumption_limits (
    daily_limit_usd NUMERIC(10, 2) NOT NULL DEFAULT 50.00,
    monthly_limit_usd NUMERIC(10, 2) NOT NULL DEFAULT 500.00,
    is_blocked BOOLEAN NOT NULL DEFAULT false
);
```
- **日次/月次ハードキャップ**: $50/日、$500/月（設定可変）
- **自動ブロック**: 上限到達時は即座に処理停止
- **プロバイダ別管理**: OpenAI、Gemini、eBay API等を個別追跡

### 次元5: 階層的HitL（人間承認）
```sql
CREATE TABLE hitl_approval_queue (
    risk_level TEXT NOT NULL,  -- 'low', 'medium', 'high', 'critical'
    ai_confidence INTEGER,
    auto_approve_at TIMESTAMPTZ,  -- 時刻ベース自動承認
    auto_approve_if_confidence_above INTEGER DEFAULT 95  -- 信頼度ベース自動承認
);
```
- **リスクベース判定**: 高額商品・低信頼度・低利益率でHitL発動
- **自動承認ルール**: 信頼度95点以上かつリスクlowなら自動承認
- **24時間期限**: 期限切れは自動expired処理

---

## 🧠 自律知能モジュール

### 1. SM(Selsimileer) AIエージェント
```
入力: 商品タイトル/SKU + eBay候補リスト
  ↓
🔍 eBay Browse API検索（候補なしの場合）
  ↓
🧠 Gemini Pro: タイトル・Specs照合
  - タイトル一致スコア (40%)
  - Item Specifics一致スコア (35%)
  - 画像比較スコア (25%) ← Gemini Vision
  ↓
📊 総合確信度 < 75点？
  ↓ YES           ↓ NO
📋 HitLキュー    ✅ 自動承認
```

**照合ポイント**:
- 型番・ブランド名・モデル名
- Item Specifics (Brand, MPN, Model, Color等)
- 価格帯の妥当性
- コンディション適合性

### 2. カテゴリ枠オプティマイザー
```sql
-- 利益期待値でソート → 貪欲法で枠割り当て
SELECT * FROM category_listing_quotas
WHERE monthly_used < monthly_quota
  AND (min_profit_margin IS NULL OR profit_margin >= min_profit_margin)
ORDER BY priority_weight DESC, (monthly_quota - monthly_used) DESC
```

**最適化ロジック**:
1. 商品を利益期待値（利益率 × 販売確率 × 価格）でソート
2. カテゴリ枠の残数・最低利益率をチェック
3. 枠に余裕のあるアカウントに優先割り当て
4. **枠なし → 夜間シフトキューへ自動登録**

### 3. 再帰的データ補完（Self-Healing）
```
📊 データ品質評価
  - hts_code: 20点
  - weight_grams: 15点
  - origin_country: 10点
  - item_specifics: 15点
  - title_en: 10点
  ↓
品質スコア < 75点？
  ↓ YES
🔄 ソース選択（優先度順）
  1. eBay Browse API
  2. Amazon Catalog API
  3. Gemini AI推論
  ↓
📊 結果マージ → まだ欠損あり？
  ↓ YES（最大3回まで）
🔄 再帰呼び出し
```

**信頼スコア管理（次元21）**:
- AI推論データは信頼度60点以上のみ採用
- 外部APIデータは即座に採用
- 全補完履歴を`enrichment_tracking`に記録

---

## 🔗 統合出品ハブ フロー

```
[Webhook] /v821-listing-hub
    ↓
🔐 Auth-Gate（JIT/HMAC）← 次元3
    ↓
💰 燃焼上限チェック ← 次元22
    ↓
📦 商品情報取得
    ↓
🔗 価格計算強制統合 ★ CRITICAL
    └→ /multi-marketplace-calculate 呼び出し
    └→ is_profitable=false の販路は自動スキップ
    ↓
📊 枠オプティマイザー
    └→ 枠なし → 🌙 夜間シフトキュー
    ↓
🧠 Gemini: タイトル最適化
    ↓
📝 Decision Trace記録 ← 次元13
    ↓
🛡️ リスク評価 + HitL判定 ← 次元5
    └→ 高リスク → 📋 HitLキュー
    ↓
🚀 販路分岐（eBay/Qoo10/Amazon）
    ↓
📊 結果集約 + 履歴記録
```

---

## 📊 データベース追加テーブル

| テーブル | 目的 | 27次元 |
|---------|------|--------|
| `jit_tokens` | JITトークン管理 | 次元3 |
| `ai_decision_traces` | AI判断証跡 | 次元13 |
| `api_consumption_limits` | API燃焼上限 | 次元22 |
| `sm_reference_judgments` | SM判定結果 | - |
| `category_listing_quotas` | カテゴリ枠管理 | - |
| `hitl_approval_queue` | 人間承認キュー | 次元5 |
| `async_task_queue` | 夜間シフトキュー | - |

---

## 🚀 デプロイ手順

### 1. SQLスキーマ適用
```bash
# Supabase SQL Editorで実行
psql $DATABASE_URL < N3_V8.2.1_AUTONOMOUS_SCHEMA.sql
```

### 2. n8nワークフローインポート
```bash
# n8n UI → Import from File
N3_V8.2.1_AUTONOMOUS_LISTING_HUB.json
N3_V8.2.1_AUTONOMOUS_SM_AGENT.json
N3_V8.2.1_AUTONOMOUS_SELF_HEALING.json
```

### 3. 環境変数設定
```env
# n8n Variables
N8N_HMAC_SECRET=your-secret-key
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
GEMINI_API_KEY=xxx
N3_API_URL=http://localhost:3000
N3_ADMIN_URL=https://your-admin.example.com
CHATWORK_API_KEY=xxx
CHATWORK_ROOM_ID=xxx
```

### 4. アクティベート
```
1. 各ワークフローを Active に切り替え
2. Webhook URLをフロントエンドに設定
3. テスト実行で動作確認
```

---

## ✅ 検証チェックリスト

| 項目 | 状態 |
|------|------|
| JITトークン認証 | ✅ 実装完了 |
| HMACフォールバック | ✅ 実装完了 |
| API燃焼上限 | ✅ 実装完了 |
| Decision Trace | ✅ 実装完了 |
| 価格計算強制統合 | ✅ 実装完了 |
| 利益フィルタ | ✅ 実装完了 |
| カテゴリ枠管理 | ✅ 実装完了 |
| 夜間シフトキュー | ✅ 実装完了 |
| SM AIエージェント | ✅ 実装完了 |
| Vision画像比較 | ✅ 実装完了（要画像データ注入） |
| HitL自動承認 | ✅ 実装完了 |
| 再帰的データ補完 | ✅ 実装完了 |
| 最大深度制限 | ✅ 3回 |

---

## 📈 期待される効果

1. **人間の作業**
   - 「承認ボタンを押すだけ」を実現
   - 高リスク案件のみHitL発動

2. **赤字防止**
   - 価格計算必須統合で利益確保
   - 為替変動時の自動再計算

3. **枠効率最大化**
   - 利益期待値による優先割り当て
   - カテゴリ別の細かな枠管理

4. **データ品質向上**
   - 欠損データの自動補完
   - AI推論の信頼度管理

5. **監査対応**
   - 全AI判断の証跡記録
   - 法廷耐性ログ

---

**人間は承認ボタンを押すだけ。それ以外の全ての判断と防衛を、このコードで完結させる。**
