# 🏰 N3 Empire OS v6 換装パッチ - 引き継ぎ書

## 📋 概要

全149件のPRODUCTION JSONファイルに「帝国OS v6換装パッチ」を適用する作業の引き継ぎ書です。

## 📂 対象ディレクトリ構成

```
02_DEV_LAB/n8n-workflows/PRODUCTION/
├── AI/                 (3件)
├── その他/             (14件)
├── システム/           (4件)
├── メディア/           (35件)
├── リサーチ/           (9件)
├── 価格計算/           (5件)
├── 出品/               (17件)
├── 出荷/               (3件)
├── 受注/               (3件)
├── 司令塔/             (11件)
├── 同期/               (2件)
├── 在庫/               (15件)
├── 外注/               (2件)
├── 帝国/               (6件)
├── 承認/               (1件)
├── 決済/               (1件)
├── 画像/               (3件)
├── 経理/               (4件)
├── 翻訳/               (3件)
├── 通知/               (1件)
├── 防衛/               (5件)
├── UI_CONFIG_MASTER.json
└── embedded_logic.json
```

## 🔧 パッチ内容

### 1. HMAC強制挿入
- Webhookノードの直後に`🔐 HMAC署名検証`ノードを挿入
- SHA256 HMAC検証
- タイムスタンプ有効期限チェック（5分）
- 環境変数: `$env.N8N_HMAC_SECRET`

### 2. 中央監視パルス注入
- 終端ノードに`📊 実行ログ送信 (成功)`ノードを追加
- `execution_logs`テーブルに実行データを送信
- 送信項目: workflow_id, status, execution_time_ms, error_message

### 3. 環境変数完全移行
置換パターン:
- `160.16.120.186:5678` → `{{$env.N8N_BASE_URL}}`
- `160.16.120.186` → `{{$env.VPS_HOST}}`
- `localhost:3000` → `{{$env.N3_API_URL}}`
- `https://zdzfpucdyxdlavkgrvil.supabase.co` → `{{$env.SUPABASE_URL}}`
- 古いトークン系 → `$env.N8N_HMAC_SECRET`

### 4. バージョンタグ追加
- `Empire-OS-V6`タグを追加

## 📁 作成済みファイル

1. **パッチスクリプト**: `02_DEV_LAB/scripts/empire_os_v6_patcher.py`
2. **DBスキーマ**: `02_DEV_LAB/database/migrations/20250123_execution_logs.sql`

## 🚀 実行方法

### 方法1: Pythonスクリプト実行（推奨）

```bash
cd ~/n3-frontend_new/02_DEV_LAB
python3 scripts/empire_os_v6_patcher.py
```

### 方法2: Claude MCPによる手動処理

文字数制限のため、カテゴリ別にバッチ処理:

1. 「続き」と入力して次のバッチを処理
2. 各バッチ完了後、処理結果をレポート
3. 全バッチ完了後、最終レポートを生成

## 📊 進捗状況

| カテゴリ | 件数 | 状態 |
|---------|------|------|
| AI | 3 | ⏳ 未処理 |
| その他 | 14 | ⏳ 未処理 |
| システム | 4 | ⏳ 未処理 |
| メディア | 35 | ⏳ 未処理 |
| リサーチ | 9 | ⏳ 未処理 |
| 価格計算 | 5 | ⏳ 未処理 |
| 出品 | 17 | ⏳ 未処理 |
| 出荷 | 3 | ⏳ 未処理 |
| 受注 | 3 | ⏳ 未処理 |
| 司令塔 | 11 | ⏳ 未処理 |
| 同期 | 2 | ⏳ 未処理 |
| 在庫 | 15 | ⏳ 未処理 |
| 外注 | 2 | ⏳ 未処理 |
| 帝国 | 6 | ⏳ 未処理 |
| 承認 | 1 | ⏳ 未処理 |
| 決済 | 1 | ⏳ 未処理 |
| 画像 | 3 | ⏳ 未処理 |
| 経理 | 4 | ⏳ 未処理 |
| 翻訳 | 3 | ⏳ 未処理 |
| 通知 | 1 | ⏳ 未処理 |
| 防衛 | 5 | ⏳ 未処理 |
| ルート | 2 | ⏳ 未処理 |

## ⚠️ 注意事項

1. **バックアップ推奨**: パッチ適用前にPRODUCTIONディレクトリをバックアップ
2. **n8n環境変数設定**: パッチ適用後、n8nに以下の環境変数を設定
   - `N8N_HMAC_SECRET`
   - `SUPABASE_URL`
   - `SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
3. **DBマイグレーション**: `execution_logs`テーブルをSupabaseで作成

## 📝 次のアクション

1. バックアップ作成
2. DBマイグレーション実行
3. パッチスクリプト実行 or Claude MCPバッチ処理
4. n8n環境変数設定
5. 動作テスト
