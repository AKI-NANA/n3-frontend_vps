# Phase G: æœ¬ç•ªèµ·å‹•ãƒ•ã‚§ãƒ¼ã‚º å®Ÿè£…å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ¯ ç›®çš„

N3 Empire OS ã‚’ã€Œå®‰å…¨ã«æœ¬ç•ªèµ·å‹•ã§ãã‚‹æ§‹æˆã€ã«ã™ã‚‹
- ãƒœã‚¿ãƒ³1ã¤ã§å®‰å…¨ã«æ­¢ã‚ã‚‰ã‚Œã‚‹
- ãƒœã‚¿ãƒ³1ã¤ã§å†èµ·å‹•ã§ãã‚‹
- è‡ªå‹•åŒ–ãŒå®‰å…¨ã«èµ°ã‚‹

---

## å®Ÿè£…æ¦‚è¦

### â‘  Control Center é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­è¨ˆ

**é‹ç”¨ãƒ¢ãƒ¼ãƒ‰**
| Mode    | Automation | Dispatch | ç”¨é€” |
|---------|------------|----------|------|
| DEV     | æ‰‹å‹•ã®ã¿   | Local    | é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚° |
| STAGING | åˆ¶é™ä»˜ã   | n8n (test) | ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ |
| PROD    | å…¨è‡ªå‹•     | n8n (live) | æœ¬ç•ªé‹ç”¨ |

**ãƒ•ã‚¡ã‚¤ãƒ«**
- `/lib/startup/operation-mode.ts`

---

### â‘¡ èµ·å‹•å‰ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆPre-flight Checkï¼‰

**ãƒã‚§ãƒƒã‚¯é …ç›®**
1. **Secrets Check** - ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨æ¤œè¨¼
2. **API Health** - Dispatch/Automation/Analysis API
3. **Database Integrity** - å¿…é ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
4. **n8n Status** - n8n ã‚µãƒ¼ãƒãƒ¼ãƒ˜ãƒ«ã‚¹
5. **Dispatch Ready** - Dispatch API æº–å‚™çŠ¶æ…‹

**ãƒ•ã‚¡ã‚¤ãƒ«**
- `/lib/startup/preflight-check.ts`
- `/api/system/preflight/route.ts`

---

### â‘¢ Kill Switch UI

**ãƒ¬ãƒ™ãƒ«**
| Level | åå‰ | å½±éŸ¿ç¯„å›² |
|-------|------|----------|
| 0 | Normal | ãªã— |
| 1 | Scheduler Pause | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼åœæ­¢ |
| 2 | Pipeline Pause | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åœæ­¢ |
| 3 | Dispatch Halt | å…¨Dispatchåœæ­¢ |
| 4 | Emergency Stop | å…¨ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ |

**ãƒ•ã‚¡ã‚¤ãƒ«**
- `/app/tools/control-n3/components/panels/kill-switch-panel.tsx`

---

### â‘£ èµ·å‹•ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

**èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹**
```
User Click â†’ Pre-flight Check â†’ Confirm â†’ Gradual Warmup
                                              â†“
                                        Step 1: Scheduler (5s)
                                              â†“
                                        Step 2: Pipeline (5s)
                                              â†“
                                        Step 3: Full Auto (3s)
                                              â†“
                                        Step 4: Monitoring (2s)
                                              â†“
                                           Running
```

**ãƒ•ã‚¡ã‚¤ãƒ«**
- `/lib/startup/startup-engine.ts`
- `/api/system/startup/route.ts`

---

### â‘¤ å®‰å…¨ã‚¬ãƒ¼ãƒ‰è¨­è¨ˆ

**åˆå›èµ·å‹•åˆ¶é™**
```typescript
{
  maxConcurrentJobs: 2,
  maxListingsPerHour: 10,
  allowedTools: ['inventory-sync', 'research-agent', 'stock-killer'],
  stableThreshold: {
    successRate: 95,
    minExecutions: 50,
    durationMinutes: 60,
  },
}
```

**Rate Limit è¡çªé˜²æ­¢**
```typescript
{
  ebay: { requestsPerMinute: 30, burst: 50 },
  amazon: { requestsPerMinute: 20, burst: 30 },
  collision: {
    sameToolIntervalMs: 5000,
    sameCategoryIntervalMs: 2000,
  },
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«**
- `/lib/startup/safety-guards.ts`

---

## æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### Library
```
lib/startup/
â”œâ”€â”€ index.ts
â”œâ”€â”€ operation-mode.ts      # é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
â”œâ”€â”€ preflight-check.ts     # Pre-flight Check
â”œâ”€â”€ startup-engine.ts      # èµ·å‹•ã‚¨ãƒ³ã‚¸ãƒ³
â””â”€â”€ safety-guards.ts       # å®‰å…¨ã‚¬ãƒ¼ãƒ‰
```

### API
```
app/api/system/
â”œâ”€â”€ preflight/
â”‚   â””â”€â”€ route.ts           # Pre-flight API
â”œâ”€â”€ startup/
â”‚   â””â”€â”€ route.ts           # èµ·å‹•/åœæ­¢ API
â””â”€â”€ mode/
    â””â”€â”€ route.ts           # ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ API
```

### UI
```
app/tools/control-n3/components/panels/
â”œâ”€â”€ startup-panel.tsx      # èµ·å‹•ãƒ‘ãƒãƒ«
â””â”€â”€ kill-switch-panel.tsx  # Kill Switch ãƒ‘ãƒãƒ«
```

### Migration
```
docs/migrations/
â””â”€â”€ phase-g-migration.sql  # DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

### Design Doc
```
docs/
â””â”€â”€ PHASE_G_DESIGN.md      # è¨­è¨ˆæ›¸
```

---

## API æ§‹æˆ

| Endpoint | Method | æ©Ÿèƒ½ |
|----------|--------|------|
| `/api/system/preflight` | GET | Pre-flight Check å®Ÿè¡Œ |
| `/api/system/startup` | GET | èµ·å‹•çŠ¶æ…‹å–å¾— |
| `/api/system/startup` | POST | ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• |
| `/api/system/startup` | DELETE | ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ |
| `/api/system/mode` | GET | ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰å–å¾— |
| `/api/system/mode` | POST | ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ |

---

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```sql
-- Supabase Dashboard > SQL Editor ã§å®Ÿè¡Œ
-- docs/migrations/phase-g-migration.sql
```

### 2. å‹•ä½œç¢ºèª

```bash
# Pre-flight Check
curl http://localhost:3000/api/system/preflight

# ãƒ¢ãƒ¼ãƒ‰ç¢ºèª
curl http://localhost:3000/api/system/mode

# èµ·å‹•çŠ¶æ…‹ç¢ºèª
curl http://localhost:3000/api/system/startup
```

### 3. æœ¬ç•ªèµ·å‹•

```bash
# PROD ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
curl -X POST http://localhost:3000/api/system/startup \
  -H "Content-Type: application/json" \
  -d '{"mode": "prod"}'
```

### 4. ç·Šæ€¥åœæ­¢

```bash
curl -X DELETE "http://localhost:3000/api/system/startup?emergency=true"
```

---

## UI é…ç½®

Control Center ã«ä»¥ä¸‹ã®ã‚¿ãƒ–ãŒè¿½åŠ ã•ã‚Œã¾ã™ï¼š

1. **Startup** - èµ·å‹•ãƒ»åœæ­¢ãƒ»ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
2. **Kill Switch** - ç·Šæ€¥åœæ­¢ãƒ»å€‹åˆ¥åˆ¶å¾¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  N3 Empire OS - Control Center                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Mode: [PROD â–¼]  â”‚ Status: ğŸŸ¢ Running â”‚ Score: 95/100     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Monitor â”‚ Health  â”‚Automate â”‚ Startup â”‚  Kill   â”‚Analysisâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚                    [Selected Tab Content]                 â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”´ EMERGENCY STOP â”‚ â¸ï¸ PAUSE ALL â”‚ ğŸ“Š Quick Stats        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æœ€çµ‚ã‚´ãƒ¼ãƒ«é”æˆçŠ¶æ…‹

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| ãƒœã‚¿ãƒ³1ã¤ã§å®‰å…¨ã«æ­¢ã‚ã‚‰ã‚Œã‚‹ | âœ… Kill Switch Panel |
| ãƒœã‚¿ãƒ³1ã¤ã§å†èµ·å‹•ã§ãã‚‹ | âœ… Startup Panel |
| è‡ªå‹•åŒ–ãŒå®‰å…¨ã«èµ°ã‚‹ | âœ… Safety Guards |
| é‹ç”¨ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ | âœ… DEV/STAGING/PROD |
| Pre-flight Check | âœ… 6é …ç›®ãƒã‚§ãƒƒã‚¯ |
| æ®µéšçš„èµ·å‹• | âœ… 5ã‚¹ãƒ†ãƒƒãƒ— warmup |
| åˆå›èµ·å‹•åˆ¶é™ | âœ… åˆ¶é™ä»˜ãå‹•ä½œ |
| Rate Limit è¡çªé˜²æ­¢ | âœ… Collision Guard |

---

## ãƒ•ãƒ­ãƒ¼ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ 

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Control Center    â”‚
                    â”‚   (Mode Selector)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   DEV   â”‚     â”‚ STAGING â”‚     â”‚  PROD   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â”‚               â”‚               â–¼
             â”‚               â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚               â”‚        â”‚  Pre-flight â”‚
             â”‚               â”‚        â”‚    Check    â”‚
             â”‚               â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Startup Engine â”‚
                    â”‚  (Gradual)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Running...    â”‚
                    â”‚                 â”‚
                    â”‚  [Kill Switch]  â”‚
                    â”‚  [Emergency]    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Phase G å®Ÿè£…å®Œäº†ã€‚ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œãƒœã‚¿ãƒ³1ã¤ã§å®‰å…¨ã«æ­¢ã‚ã‚‰ã‚Œã¦ã€å†èµ·å‹•ã§ãã¦ã€è‡ªå‹•åŒ–ãŒèµ°ã‚‹ã€çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚**
