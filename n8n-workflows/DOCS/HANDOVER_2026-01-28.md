# N3 Workspace リファクタリング 引き継ぎ書

**作成日**: 2026-01-28
**担当**: Claude AI
**目的**: データ編集タブのリファクタリングと出品安全設計の実装

---

## 📋 本日の作業内容

### 1. 設計書作成

| ドキュメント | パス | 内容 |
|--------------|------|------|
| リファクタリング設計書 | `/docs/WORKSPACE_REFACTORING_DESIGN_V1.md` | タブ表示問題の解析と解決策 |
| 出品安全設計書 | `/docs/LISTING_SAFETY_DESIGN_V1.md` | 誤出品防止・KillSwitch・スケジューラ設計 |

### 2. 実装完了コード

| ファイル | 内容 |
|----------|------|
| `/store/product/uiStore.ts` | workflowPhase (L4) をZustand永続化に追加 |
| `/lib/listing/state-machine.ts` | 出品状態遷移ステートマシン |
| `/lib/listing/guards.ts` | 誤出品防止ガード（VERO/赤字/在庫0チェック） |
| `/lib/listing/kill-switch.ts` | 緊急停止機能 |
| `/lib/listing/index.ts` | エクスポート |
| `editing-n3-page-layout.tsx` | useState→Zustand移行（L4フィルター永続化） |

---

## 🎯 完了した改善

### L4フィルター永続化
- **Before**: `useState<ProductPhase>` → リロードでリセット
- **After**: `useWorkflowPhaseSelector()` → localStorage永続化

### 出品安全機構
- 状態遷移バリデーション
- 人間承認必須チェック
- Kill Switch連動
- 監査ログ記録

---

## 🔄 残作業（次回以降）

### 優先度: 高
1. **React Query キー拡張**: `use-fetch-products.ts` に `workflowPhase` 追加
2. **API拡張**: `/api/products/route.ts` に `workflow_phase` パラメータ追加
3. **タブカウントSSoT**: `use-tab-counts.ts` の工程カウント統一

### 優先度: 中
4. **UI確認ダイアログ強化**: 承認・出品時の確認モーダル改善
5. **設定画面**: 自動出品ON/OFF UI実装

### 優先度: 低
6. **スケジューラAPI**: `/api/scheduler/listing/*` 実装
7. **n8nワークフロー更新**: ペイロード検証強化

---

## 📂 関連ファイルパス（クイックアクセス）

```
# 設計書
/docs/WORKSPACE_REFACTORING_DESIGN_V1.md
/docs/LISTING_SAFETY_DESIGN_V1.md

# 新規実装
/lib/listing/state-machine.ts
/lib/listing/guards.ts
/lib/listing/kill-switch.ts
/lib/listing/index.ts

# 修正済み
/store/product/uiStore.ts
/app/tools/editing-n3/components/layouts/editing-n3-page-layout.tsx

# 次回修正対象
/app/tools/editing/hooks/use-fetch-products.ts
/app/api/products/route.ts
/app/tools/editing-n3/hooks/use-tab-counts.ts
```

---

## ✅ 動作確認方法

```bash
# 開発サーバー起動
cd ~/n3-frontend_new
npm run dev

# ブラウザで確認
# http://localhost:3000/tools/workspace

# 確認項目:
# 1. L4タブ（翻訳/検索/選択/詳細/補完/承認）をクリック
# 2. リロードしてもL4タブが維持されることを確認
# 3. L3タブを切り替えるとL4がリセットされることを確認
```

---

## 🔧 トラブルシューティング

### localStorage の状態確認
```javascript
// ブラウザコンソールで実行
JSON.parse(localStorage.getItem('product-ui-store'))
```

### Zustand Store のリセット
```javascript
// ブラウザコンソールで実行
localStorage.removeItem('product-ui-store')
location.reload()
```

---

## 📞 連絡事項

- 設計書は `/docs/` に配置済み
- 出品安全ガードは `/lib/listing/` にモジュール化
- 次回は React Query のキー拡張から開始推奨
