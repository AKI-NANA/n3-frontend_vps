{
  "name": "ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€‘13_200-äººæ ¼-5ã‚¹ã‚¿ã‚¤ãƒ«å‹•ç”»ç”Ÿæˆ-UniversalTemplate_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "style-video-generate",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: style-video-generate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "style-video-generate"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ãƒ•ã‚§ãƒ¼ã‚º1: 5ã¤ã®äººæ ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–\n// Style A: ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯ï¼ˆç¤¾ä¼šéƒ¨éƒ¨é•·é¢¨ï¼‰\n// Style B: ã‚¨ãƒ³ã‚¿ãƒ¡è§£èª¬ï¼ˆãƒ¬ãƒãƒ‹ã‚­é¢¨ï¼‰\n// Style C: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï¼ˆã“ã«ã—é¢¨ï¼‰\n// Style D: æ²¡å…¥åž‹ãƒ„ã‚¢ãƒ¼ï¼ˆã ã„ã¾ã¤é¢¨ï¼‰\n// Style E: ã‚­ãƒƒã‚º/åˆå¿ƒè€…å‘ã‘\n// ============================================================================\n\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst productId = body.product_id;\nconst atomicDataId = body.atomic_data_id;\nconst styleId = body.style_id || 'B'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¨ãƒ³ã‚¿ãƒ¡\nconst channelId = body.channel_id;\nconst videoType = body.video_type || 'youtube_short';\nconst autoPublish = body.auto_publish || false;\nconst language = body.language || 'ja';\n\n// ã‚¹ã‚¿ã‚¤ãƒ«IDæ¤œè¨¼\nconst validStyles = ['A', 'B', 'C', 'D', 'E'];\nif (!validStyles.includes(styleId)) {\n  return [{ json: { error: true, message: `ç„¡åŠ¹ãªã‚¹ã‚¿ã‚¤ãƒ«ID: ${styleId}. æœ‰åŠ¹: A, B, C, D, E`, code: 'INVALID_STYLE' } }];\n}\n\nif (!productId && !atomicDataId) {\n  return [{ json: { error: true, message: 'product_id ã¾ãŸã¯ atomic_data_id ã¯å¿…é ˆã§ã™', code: 'MISSING_PARAM' } }];\n}\n\nreturn [{\n  json: {\n    product_id: productId,\n    atomic_data_id: atomicDataId,\n    style_id: styleId,\n    channel_id: channelId,\n    video_type: videoType,\n    auto_publish: autoPublish,\n    language: language,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ðŸŽ­ äººæ ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT sp.*, els.stability, els.similarity_boost, els.style_exaggeration, els.use_speaker_boost, els.breath_frequency, els.pause_frequency, els.default_voice_id, els.model_id, spt.system_prompt, spt.hook_instruction, spt.tone_instruction, spt.structure_instruction, spt.closing_instruction FROM style_profiles sp LEFT JOIN elevenlabs_style_settings els ON sp.style_id = els.style_id LEFT JOIN script_prompt_templates spt ON sp.style_id = spt.style_id AND spt.template_type = 'default' WHERE sp.style_id = $1",
        "options": {
          "queryParams": "={{ [$json.style_id] }}"
        }
      },
      "id": "get-style-profile",
      "name": "ðŸŽ¨ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.*, im.purchase_price, im.image_url AS inv_image_url, si.original_insight, si.insight_type, si.contributor_name FROM products_master pm LEFT JOIN inventory_master im ON pm.id = im.product_id LEFT JOIN supervisor_insights si ON pm.id = si.product_id AND si.is_active = TRUE WHERE pm.id = $1",
        "options": {
          "queryParams": "={{ [$node['ðŸŽ­ äººæ ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–'].json.product_id] }}"
        }
      },
      "id": "get-product",
      "name": "ðŸ“¦ å•†å“ï¼‹ã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥è„šæœ¬ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰\n// ============================================================================\n\nconst initData = $node['ðŸŽ­ äººæ ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–'].json;\nconst styleProfile = $node['ðŸŽ¨ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—'].json;\nconst productData = $input.first().json;\n\nconst style = Array.isArray(styleProfile) ? styleProfile[0] : styleProfile;\nconst product = Array.isArray(productData) ? productData[0] : productData;\n\nif (!style) {\n  return [{ json: { error: true, message: 'ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' } }];\n}\n\n// ç›£ä¿®è€…ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®çµ„ã¿è¾¼ã¿æŒ‡ç¤º\nlet insightInstruction = '';\nif (product?.original_insight) {\n  insightInstruction = `\\n\\nã€æœ€å„ªå…ˆã€‘ä»¥ä¸‹ã®ç›£ä¿®è€…ã®å®Ÿä½“é¨“ã‚’å¿…ãšè„šæœ¬ã®æœ€åˆã®15ç§’ä»¥å†…ã«ã€Œ${product.contributor_name || 'å°‚é–€å®¶'}ã«ã‚ˆã‚‹ã¨ã€ã¨ã„ã†å½¢ã§çµ„ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼š\\nã€Œ${product.original_insight}ã€`;\n}\n\n// ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ã®è¿½åŠ æŒ‡ç¤º\nconst styleSpecificInstructions = {\n  'A': 'ãƒ»äº‹å®Ÿé–¢ä¿‚ã®å‡ºå…¸ã‚’å¿…ãšæ˜Žç¤ºã—ã¦ãã ã•ã„\\nãƒ»æ„Ÿæƒ…çš„ãªè¡¨ç¾ã¯é¿ã‘ã€å®¢è¦³çš„ã«è¿°ã¹ã¦ãã ã•ã„\\nãƒ»å°‚é–€ç”¨èªžã¯æ­£ç¢ºã«ä½¿ç”¨ã—ã¦ãã ã•ã„',\n  'B': 'ãƒ»å†’é ­ã§è¦–è´è€…ã‚’ç…½ã‚‹ã‚ˆã†ãªéŽæ¿€ãªãƒ•ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„\\nãƒ»ã€Œã‚„ã°ã„ã€ã€Œãƒžã‚¸ã§ã€ãªã©ã®å¼·èª¿èªžã‚’ä½¿ã£ã¦ãã ã•ã„\\nãƒ»ãƒ†ãƒ³ãƒã‚ˆãã€æ¬¡ã€…ã¨æ–°æƒ…å ±ã‚’å‡ºã—ã¦ãã ã•ã„',\n  'C': 'ãƒ»æ“ä½œæ‰‹é †ã‚’ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§èª¬æ˜Žã—ã¦ãã ã•ã„\\nãƒ»ã€Œã¾ãšã€ã€Œæ¬¡ã«ã€ã€Œæœ€å¾Œã«ã€ãªã©ã®æŽ¥ç¶šè©žã‚’ä½¿ã£ã¦ãã ã•ã„\\nãƒ»å°‚é–€ç”¨èªžã¯å™›ã¿ç •ã„ã¦èª¬æ˜Žã—ã¦ãã ã•ã„',\n  'D': 'ãƒ»ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æœ€å°é™ã«ã—ã¦ãã ã•ã„\\nãƒ»æ˜ åƒã®ç¾Žã—ã•ã‚’å¼•ãç«‹ã¦ã‚‹è©©çš„ãªè¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„\\nãƒ»é™å¯‚ã‚„ç’°å¢ƒéŸ³ã‚’æ´»ã‹ã™ã€Œé–“ã€ã‚’æ„è­˜ã—ã¦ãã ã•ã„',\n  'E': 'ãƒ»å­ä¾›ã§ã‚‚åˆ†ã‹ã‚‹ç°¡å˜ãªè¨€è‘‰ã‚’ä½¿ã£ã¦ãã ã•ã„\\nãƒ»æ“¬éŸ³èªžã‚„æ“¬æ…‹èªžã‚’ç©æ¥µçš„ã«ä½¿ã£ã¦ãã ã•ã„\\nãƒ»æ¥½ã—ãã€é£½ãã•ã›ãªã„å·¥å¤«ã‚’ã—ã¦ãã ã•ã„'\n};\n\nconst fullPrompt = `${style.system_prompt}\\n\\n${style.hook_instruction}\\n\\n${style.tone_instruction}\\n\\nã€ã‚¹ã‚¿ã‚¤ãƒ«å›ºæœ‰ã®æŒ‡ç¤ºã€‘\\n${styleSpecificInstructions[initData.style_id]}${insightInstruction}\\n\\nã€å•†å“/ãƒ†ãƒ¼ãƒžæƒ…å ±ã€‘\\nã‚¿ã‚¤ãƒˆãƒ«: ${product?.title || 'æœªè¨­å®š'}\\nèª¬æ˜Ž: ${product?.description || 'æœªè¨­å®š'}\\n\\nã€å‡ºåŠ›å½¢å¼ã€‘\\nè„šæœ¬ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜Žã¯ä¸è¦ã§ã™ã€‚\\né•·ã•: ${initData.video_type === 'youtube_short' ? '60ç§’ä»¥å†…' : '3-5åˆ†'}`;\n\nreturn [{\n  json: {\n    ...initData,\n    style_profile: style,\n    product: product,\n    script_prompt: fullPrompt,\n    has_insight: !!product?.original_insight\n  }\n}];"
      },
      "id": "build-prompt",
      "name": "ðŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-goog-api-key",
              "value": "={{ $env.GEMINI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: $json.script_prompt }] }], generationConfig: { temperature: $json.style_id === 'B' ? 0.8 : ($json.style_id === 'D' ? 0.3 : 0.5), maxOutputTokens: 2048 } }) }}",
        "options": {
          "timeout": 60000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "gemini-script",
      "name": "ðŸ¤– Geminiè„šæœ¬ç”Ÿæˆ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// è„šæœ¬ãƒ‘ãƒ¼ã‚¹ï¼‹ElevenLabsè¨­å®šæº–å‚™\n// ============================================================================\n\nconst prevData = $node['ðŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰'].json;\nconst geminiResult = $input.first().json;\n\nlet script = '';\ntry {\n  script = geminiResult?.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  script = script.trim();\n} catch (e) {\n  script = `${prevData.product?.title || 'ã“ã®ãƒ†ãƒ¼ãƒž'}ã«ã¤ã„ã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚`;\n}\n\n// ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ElevenLabsè¨­å®šã‚’å–å¾—\nconst style = prevData.style_profile;\n\nreturn [{\n  json: {\n    ...prevData,\n    script: script,\n    elevenlabs_settings: {\n      voice_id: style.default_voice_id || 'EXAVITQu4vr4xnSDxMaL',\n      model_id: style.model_id || 'eleven_multilingual_v2',\n      stability: style.stability || 0.5,\n      similarity_boost: style.similarity_boost || 0.75,\n      style: style.style_exaggeration || 0.2,\n      use_speaker_boost: style.use_speaker_boost !== false,\n      breath_frequency: style.breath_frequency || 0.3,\n      pause_frequency: style.pause_frequency || 0.2\n    }\n  }\n}];"
      },
      "id": "parse-script",
      "name": "ðŸ“‹ è„šæœ¬ãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ãƒã‚¤ã‚ªãƒŽã‚¤ã‚ºæŒ¿å…¥ï¼ˆäººæ ¼åˆ¥èª¿æ•´ï¼‰\n// ============================================================================\n\nconst data = $input.first().json;\nlet text = data.script;\nconst settings = data.elevenlabs_settings;\n\n// æ¯ç¶™ãŽæŒ¿å…¥ï¼ˆç¢ºçŽ‡ãƒ™ãƒ¼ã‚¹ï¼‰\ntext = text.replace(/([ã€‚ï¼ï¼Ÿ])/g, (match) => {\n  if (Math.random() < settings.breath_frequency) {\n    return '...' + match;\n  }\n  return match;\n});\n\n// æºœã‚æŒ¿å…¥ï¼ˆç¢ºçŽ‡ãƒ™ãƒ¼ã‚¹ï¼‰\ntext = text.replace(/([ã€])/g, (match) => {\n  if (Math.random() < settings.pause_frequency) {\n    return match + '...';\n  }\n  return match;\n});\n\nreturn [{ json: { ...data, processed_script: text } }];"
      },
      "id": "add-breath",
      "name": "ðŸ« ãƒã‚¤ã‚ªãƒŽã‚¤ã‚ºæŒ¿å…¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.elevenlabs.io/v1/text-to-speech/{{ $json.elevenlabs_settings.voice_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "audio/mpeg"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ text: $json.processed_script, model_id: $json.elevenlabs_settings.model_id, voice_settings: { stability: $json.elevenlabs_settings.stability, similarity_boost: $json.elevenlabs_settings.similarity_boost, style: $json.elevenlabs_settings.style, use_speaker_boost: $json.elevenlabs_settings.use_speaker_boost } }) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          },
          "timeout": 180000,
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          }
        }
      },
      "id": "elevenlabs-api",
      "name": "ðŸŽ™ï¸ ElevenLabs API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "elevenlabs-auth",
          "name": "ElevenLabs API Key"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// Remotion Propsæ§‹ç¯‰ï¼ˆã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ï¼‰\n// ============================================================================\n\nconst prevData = $node['ðŸ« ãƒã‚¤ã‚ªãƒŽã‚¤ã‚ºæŒ¿å…¥'].json;\nconst voiceResult = $input.first();\nconst style = prevData.style_profile;\n\n// éŸ³å£°URLã‚’ä»®è¨­å®šï¼ˆå®Ÿéš›ã¯Supabase Storageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«æ›´æ–°ï¼‰\nconst audioUrl = voiceResult.binary?.data ? 'pending_upload' : null;\n\n// ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥Remotion Props\nconst remotionProps = {\n  compositionId: prevData.video_type === 'youtube_short' ? 'ShortVideo' : 'LongVideo',\n  inputProps: {\n    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„\n    title: prevData.product?.title || 'N3 Content',\n    script: prevData.script,\n    audioUrl: audioUrl,\n    \n    // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š\n    styleId: prevData.style_id,\n    fontFamily: style.font_family || 'Noto Sans JP',\n    colorPalette: typeof style.color_palette === 'string' ? JSON.parse(style.color_palette) : style.color_palette,\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š\n    spring: {\n      stiffness: style.spring_stiffness || 260,\n      damping: style.spring_damping || 20,\n      mass: parseFloat(style.spring_mass) || 1.0\n    },\n    \n    // ã‚¿ã‚¤ãƒŸãƒ³ã‚°\n    timing: {\n      sceneTransitionMs: style.scene_transition_ms || 400,\n      captionFadeMs: style.caption_fade_ms || 250,\n      emphasisPauseMs: style.emphasis_pause_ms || 600\n    },\n    \n    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    effects: {\n      shakeMagnitude: style.shake_magnitude || 8,\n      flashOpacity: parseFloat(style.flash_opacity) || 0.15,\n      zoomPulseScale: parseFloat(style.zoom_pulse_scale) || 1.03,\n      particleEnabled: style.particle_enabled || false\n    },\n    \n    // å­—å¹•\n    subtitle: {\n      opacity: parseFloat(style.subtitle_opacity) || 1.0,\n      position: style.subtitle_position || 'bottom',\n      style: style.subtitle_style || 'standard'\n    },\n    \n    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª\n    audio: {\n      bgmType: style.bgm_type || 'corporate',\n      bgmDuckDepth: parseFloat(style.bgm_duck_depth) || 0.25,\n      seVolume: parseFloat(style.se_volume_relative) || 1.0\n    },\n    \n    // ã‚·ãƒ¼ãƒ‰å€¤ï¼ˆåŒä¸€ã‚¹ã‚¿ã‚¤ãƒ«ã§ã‚‚ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ï¼‰\n    seed: prevData.product_id || Date.now()\n  },\n  codec: 'h264',\n  imageFormat: 'jpeg'\n};\n\nreturn [{\n  json: {\n    ...prevData,\n    audio_binary: voiceResult.binary?.data ? true : false,\n    remotion_props: remotionProps\n  },\n  binary: voiceResult.binary\n}];"
      },
      "id": "build-remotion-props",
      "name": "ðŸŽ¬ Remotion Propsæ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO media_content (product_id, content_type, title, script, style_id, channel_id, publish_status, render_status, remotion_props, metadata) VALUES ($1, $2, $3, $4, $5, $6, 'pending', 'queued', $7, $8) RETURNING id",
        "options": {
          "queryParams": "={{ [$json.product_id, $json.video_type, $json.product?.title || 'N3 Content', $json.script, $json.style_id, $json.channel_id, JSON.stringify($json.remotion_props), JSON.stringify({ style_name: $json.style_profile?.style_name, has_insight: $json.has_insight })] }}"
        }
      },
      "id": "save-content",
      "name": "ðŸ’¾ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const data = $node['ðŸŽ¬ Remotion Propsæ§‹ç¯‰'].json;\nconst saveResult = $input.first().json;\n\nreturn [{\n  json: {\n    success: true,\n    action: 'style_video_generate',\n    content_id: saveResult?.id || saveResult?.[0]?.id,\n    product_id: data.product_id,\n    style_id: data.style_id,\n    style_name: data.style_profile?.style_name,\n    video_type: data.video_type,\n    has_insight: data.has_insight,\n    audio_generated: data.audio_binary,\n    remotion_props: data.remotion_props\n  }\n}];"
      },
      "id": "format-response",
      "name": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}",
        "options": {
          "retry": {
            "attempts": 3,
            "delay": 1000,
            "backoff": "exponential"
          },
          "timeout": 30000
        }
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹\n[PATCHER] WARNING: ã“ã®ãƒŽãƒ¼ãƒ‰ã¯ã©ã“ã«ã‚‚æŽ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤ã¾ãŸã¯æŽ¥ç¶šã—ã¦ãã ã•ã„ã€‚"
    }
  ],
  "connections": {
    "Webhook: style-video-generate": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ­ äººæ ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸŽ¨ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¨ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“¦ å•†å“ï¼‹ã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¦ å•†å“ï¼‹ã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰": {
      "main": [
        [
          {
            "node": "ðŸ¤– Geminiè„šæœ¬ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– Geminiè„šæœ¬ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ è„šæœ¬ãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ è„šæœ¬ãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ðŸ« ãƒã‚¤ã‚ªãƒŽã‚¤ã‚ºæŒ¿å…¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ« ãƒã‚¤ã‚ªãƒŽã‚¤ã‚ºæŒ¿å…¥": {
      "main": [
        [
          {
            "node": "ðŸŽ™ï¸ ElevenLabs API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ™ï¸ ElevenLabs API": {
      "main": [
        [
          {
            "node": "ðŸŽ¬ Remotion Propsæ§‹ç¯‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¬ Remotion Propsæ§‹ç¯‰": {
      "main": [
        [
          {
            "node": "ðŸ’¾ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¿å­˜": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸŽ­ äººæ ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 600,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Media",
      "color": "#e74c3c"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "5-Personalities",
      "color": "#9b59b6"
    },
    {
      "name": "Phase-1",
      "color": "#3498db"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}