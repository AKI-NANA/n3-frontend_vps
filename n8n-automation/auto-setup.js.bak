#!/usr/bin/env node
/**
 * N3 n8n è‡ªå‹•è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * ã™ã¹ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨èªè¨¼æƒ…å ±ã‚’è‡ªå‹•çš„ã«è¨­å®š
 */

const fs = require('fs');
const path = require('path');
const axios = require('axios');
const dotenv = require('dotenv');

// ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
dotenv.config({ path: '.env.local' });
dotenv.config({ path: '.env.n8n' });

class N8nAutoConfigurator {
  constructor(config = {}) {
    this.baseUrl = config.baseUrl || 'http://localhost:5678';
    this.username = config.username || 'admin';
    this.password = config.password || process.env.N8N_PASSWORD || 'n3admin2024';
    this.apiToken = null;
    this.credentials = {};
    this.workflows = {};
  }

  /**
   * n8nã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
   */
  async authenticate() {
    try {
      console.log('ğŸ” n8nã«èªè¨¼ä¸­...');
      
      const response = await axios.post(`${this.baseUrl}/api/v1/auth/login`, {
        email: this.username,
        password: this.password
      });
      
      this.apiToken = response.data.data.token;
      console.log('âœ… èªè¨¼æˆåŠŸ');
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
      axios.defaults.headers.common['X-N8N-API-KEY'] = this.apiToken;
      
      return true;
    } catch (error) {
      console.error('âŒ èªè¨¼å¤±æ•—:', error.message);
      return false;
    }
  }

  /**
   * èªè¨¼æƒ…å ±ã‚’ä½œæˆ
   */
  async createCredentials() {
    const credentialsConfig = {
      supabase: {
        name: 'Supabase N3',
        type: 'supabaseApi',
        data: {
          host: process.env.NEXT_PUBLIC_SUPABASE_URL,
          serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY
        }
      },
      ebay: {
        name: 'eBay API',
        type: 'httpBasicAuth',
        data: {
          user: process.env.EBAY_APP_ID,
          password: process.env.EBAY_CERT_ID
        }
      },
      amazon: {
        name: 'Amazon SP-API',
        type: 'httpHeaderAuth',
        data: {
          name: 'x-amz-access-token',
          value: process.env.AMAZON_ACCESS_TOKEN || 'placeholder'
        }
      },
      keepa: {
        name: 'Keepa API',
        type: 'httpHeaderAuth',
        data: {
          name: 'key',
          value: process.env.KEEPA_API_KEY || 'placeholder'
        }
      },
      slack: {
        name: 'Slack N3',
        type: 'slackApi',
        data: {
          accessToken: process.env.SLACK_TOKEN,
          webhookUrl: process.env.SLACK_WEBHOOK_URL
        }
      }
    };

    console.log('ğŸ”‘ èªè¨¼æƒ…å ±ã‚’ä½œæˆä¸­...');
    
    for (const [key, config] of Object.entries(credentialsConfig)) {
      try {
        const response = await axios.post(`${this.baseUrl}/api/v1/credentials`, config);
        this.credentials[key] = response.data.data.id;
        console.log(`  âœ… ${key} èªè¨¼æƒ…å ±ä½œæˆ`);
      } catch (error) {
        console.error(`  âŒ ${key} èªè¨¼æƒ…å ±ä½œæˆå¤±æ•—:`, error.message);
      }
    }
  }

  /**
   * ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
   */
  async importWorkflows() {
    const workflowDir = path.join(__dirname, '../n8n-workflows');
    const files = fs.readdirSync(workflowDir).filter(f => f.endsWith('.json'));
    
    console.log('ğŸ“¦ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
    
    for (const file of files) {
      try {
        const workflowPath = path.join(workflowDir, file);
        const workflowData = JSON.parse(fs.readFileSync(workflowPath, 'utf8'));
        
        // èªè¨¼æƒ…å ±IDã‚’æ›´æ–°
        this.updateCredentialIds(workflowData);
        
        const response = await axios.post(`${this.baseUrl}/api/v1/workflows`, workflowData);
        this.workflows[workflowData.name] = response.data.data.id;
        
        console.log(`  âœ… ${file} ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†`);
      } catch (error) {
        console.error(`  âŒ ${file} ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—:`, error.message);
      }
    }
  }

  /**
   * ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã®èªè¨¼æƒ…å ±IDã‚’æ›´æ–°
   */
  updateCredentialIds(workflow) {
    if (!workflow.nodes) return;
    
    workflow.nodes.forEach(node => {
      if (node.credentials) {
        Object.keys(node.credentials).forEach(credType => {
          const credName = node.credentials[credType].name;
          
          // ä½œæˆã—ãŸèªè¨¼æƒ…å ±IDã«ç½®ãæ›ãˆ
          if (credName === 'Supabase N3' && this.credentials.supabase) {
            node.credentials[credType].id = this.credentials.supabase;
          } else if (credName === 'eBay API' && this.credentials.ebay) {
            node.credentials[credType].id = this.credentials.ebay;
          } else if (credName === 'Slack N3' && this.credentials.slack) {
            node.credentials[credType].id = this.credentials.slack;
          }
        });
      }
    });
  }

  /**
   * ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹åŒ–
   */
  async activateWorkflows() {
    console.log('ğŸš€ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹åŒ–ä¸­...');
    
    for (const [name, id] of Object.entries(this.workflows)) {
      try {
        await axios.patch(`${this.baseUrl}/api/v1/workflows/${id}`, {
          active: true
        });
        console.log(`  âœ… ${name} æœ‰åŠ¹åŒ–`);
      } catch (error) {
        console.error(`  âŒ ${name} æœ‰åŠ¹åŒ–å¤±æ•—:`, error.message);
      }
    }
  }

  /**
   * ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
   */
  async setEnvironmentVariables() {
    const variables = {
      N3_BASE_URL: 'http://localhost:3002',
      N3_API_TIMEOUT: '30000',
      N3_BATCH_SIZE: '10',
      N3_RETRY_ATTEMPTS: '3',
      EBAY_SANDBOX: 'false',
      AMAZON_MARKETPLACE: 'ATVPDKIKX0DER'
    };

    console.log('âš™ï¸ ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šä¸­...');
    
    try {
      await axios.post(`${this.baseUrl}/api/v1/variables`, {
        variables
      });
      console.log('  âœ… ç’°å¢ƒå¤‰æ•°è¨­å®šå®Œäº†');
    } catch (error) {
      console.error('  âŒ ç’°å¢ƒå¤‰æ•°è¨­å®šå¤±æ•—:', error.message);
    }
  }

  /**
   * ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
   */
  async testWorkflows() {
    console.log('ğŸ§ª ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
    
    // ãƒ†ã‚¹ãƒˆç”¨ã®Webhookã‚’å®Ÿè¡Œ
    const testData = {
      test: true,
      timestamp: new Date().toISOString()
    };
    
    try {
      // ãƒã‚¹ã‚¿ãƒ¼Webhookã‚’ãƒ†ã‚¹ãƒˆ
      const response = await axios.post(`${this.baseUrl}/webhook/n3-master`, testData);
      console.log('  âœ… ãƒã‚¹ã‚¿ãƒ¼Webhookãƒ†ã‚¹ãƒˆæˆåŠŸ');
    } catch (error) {
      console.error('  âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—:', error.message);
    }
  }

  /**
   * ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
   */
  async run() {
    console.log('');
    console.log('================================');
    console.log('N3 n8n è‡ªå‹•è¨­å®šé–‹å§‹');
    console.log('================================');
    console.log('');
    
    // èªè¨¼
    const authenticated = await this.authenticate();
    if (!authenticated) {
      console.error('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚n8nãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      process.exit(1);
    }
    
    // èªè¨¼æƒ…å ±ä½œæˆ
    await this.createCredentials();
    
    // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    await this.importWorkflows();
    
    // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æœ‰åŠ¹åŒ–
    await this.activateWorkflows();
    
    // ç’°å¢ƒå¤‰æ•°è¨­å®š
    await this.setEnvironmentVariables();
    
    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    await this.testWorkflows();
    
    console.log('');
    console.log('================================');
    console.log('âœ… è¨­å®šå®Œäº†ï¼');
    console.log('================================');
    console.log('');
    console.log('ğŸ“Œ n8nãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: http://localhost:5678');
    console.log('ğŸ“Œ N3ã‚¢ãƒ—ãƒª: http://localhost:3002/tools/workspace');
    console.log('');
  }
}

// å®Ÿè¡Œ
if (require.main === module) {
  const configurator = new N8nAutoConfigurator();
  configurator.run().catch(console.error);
}

module.exports = N8nAutoConfigurator;