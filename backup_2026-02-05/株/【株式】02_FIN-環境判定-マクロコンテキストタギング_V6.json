{
  "name": "ã€æ ªå¼ã€‘02_FIN-ç’°å¢ƒåˆ¤å®š-ãƒã‚¯ãƒ­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚®ãƒ³ã‚°_V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fin-context-judge",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: fin-context-judge",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "fin-context-judge"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-FIN-02 V6: ãƒã‚¯ãƒ­ç’°å¢ƒåˆ¤å®šï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ»ã‚¿ã‚®ãƒ³ã‚°ï¼‰\n// å½¹å‰²: ç‚ºæ›¿ãƒ»é‡‘åˆ©ãƒ»æŒ‡æ•°ã‹ã‚‰ã€Œä»Šæ—¥ã®ç›¸å ´ãƒ¢ãƒ¼ãƒ‰ã€ã‚’åˆ¤å®š\n// ============================================================================\n\nconst apiUrl = $env.N3_API_URL || $env.API_BASE_URL;\n\nconst body = $input.first().json.body || $input.first().json || {};\nconst targetDate = body.date || new Date().toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    target_date: targetDate,\n    api_url: apiUrl,\n    timestamp: new Date().toISOString(),\n    analysis_id: `ctx_${Date.now()}`\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT code, close, per, pbr, roe, margin_ratio, date FROM market_data WHERE date >= $1::date - INTERVAL '30 days' ORDER BY date DESC",
        "options": {
          "queryParams": "={{ [$json.target_date] }}"
        }
      },
      "id": "get-market-data",
      "name": "ğŸ“Š ç›´è¿‘30æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [650, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.exchangerate-api.com/v4/latest/USD",
        "options": {
          "timeout": 15000
        }
      },
      "id": "get-fx-rate",
      "name": "ğŸ’± ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆUSD/JPYï¼‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.stlouisfed.org/fred/series/observations?series_id=DGS10&api_key={{ $env.FRED_API_KEY }}&file_type=json&limit=5&sort_order=desc",
        "options": {
          "timeout": 15000
        }
      },
      "id": "get-us-yield",
      "name": "ğŸ“ˆ ç±³10å¹´å‚µåˆ©å›ã‚Šå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ãƒã‚¯ãƒ­ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼†ç’°å¢ƒã‚¿ã‚°ç”Ÿæˆ\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–'].json;\nconst marketData = $node['ğŸ“Š ç›´è¿‘30æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—'].json || [];\nconst fxData = $node['ğŸ’± ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆUSD/JPYï¼‰'].json || {};\nconst yieldData = $node['ğŸ“ˆ ç±³10å¹´å‚µåˆ©å›ã‚Šå–å¾—'].json || {};\n\n// ç‚ºæ›¿åˆ¤å®š\nconst usdJpy = fxData.rates?.JPY || 150;\nconst fxTag = usdJpy > 155 ? 'è¶…å††å®‰' : usdJpy > 145 ? 'å††å®‰é€²è¡Œ' : usdJpy > 135 ? 'å††å®‰' : usdJpy > 125 ? 'ä¸­ç«‹' : 'å††é«˜';\n\n// é‡‘åˆ©åˆ¤å®š\nconst us10y = parseFloat(yieldData.observations?.[0]?.value || '4.5');\nconst yieldTag = us10y > 5.0 ? 'é«˜é‡‘åˆ©ç¶™ç¶š' : us10y > 4.0 ? 'é‡‘åˆ©é«˜æ­¢ã¾ã‚Š' : us10y > 3.0 ? 'ä¸­ç«‹é‡‘åˆ©' : 'ä½é‡‘åˆ©ç’°å¢ƒ';\n\n// éœ€çµ¦åˆ¤å®šï¼ˆä¿¡ç”¨å€ç‡ã®å¹³å‡ï¼‰\nconst marginRatios = Array.isArray(marketData) ? marketData.filter(d => d.margin_ratio).map(d => d.margin_ratio) : [];\nconst avgMarginRatio = marginRatios.length > 0 ? marginRatios.reduce((a, b) => a + b, 0) / marginRatios.length : 2.0;\nconst marginTag = avgMarginRatio > 4.0 ? 'éç†±ï¼ˆä¿¡ç”¨è²·ã„éå¤šï¼‰' : avgMarginRatio > 2.5 ? 'å¼·æ°—' : avgMarginRatio > 1.5 ? 'ä¸­ç«‹' : 'å£²ã‚Šæ¯ã‚Œ';\n\n// å­£ç¯€æ€§ã‚¢ãƒãƒãƒªãƒ¼\nconst month = new Date(initData.target_date).getMonth() + 1;\nconst anomalyTags = [];\nif (month === 1) anomalyTags.push('æ–°æ˜¥ç›¸å ´');\nif (month === 2) anomalyTags.push('ç¯€åˆ†å¤©äº•è­¦æˆ’');\nif (month === 3) anomalyTags.push('å½¼å²¸åº•æœŸå¾…');\nif (month === 5) anomalyTags.push('ã‚»ãƒ«ã‚¤ãƒ³ãƒ¡ã‚¤è­¦æˆ’');\nif (month === 10) anomalyTags.push('ç§‹ã®åº•æ‹¾ã„');\nif (month === 12) anomalyTags.push('å¹´æœ«ãƒ©ãƒªãƒ¼æœŸå¾…');\n\n// ç·åˆã‚¿ã‚°ç”Ÿæˆ\nconst contextTags = [\n  `[${fxTag}]`,\n  `[${yieldTag}]`,\n  `[éœ€çµ¦:${marginTag}]`,\n  ...anomalyTags.map(a => `[${a}]`)\n];\n\n// ç›¸å ´ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š\nlet marketMode = 'NEUTRAL';\nlet modeScore = 50;\n\nif (fxTag.includes('å††å®‰') && yieldTag.includes('é«˜é‡‘åˆ©') && marginTag.includes('éç†±')) {\n  marketMode = 'CAUTION';\n  modeScore = 30;\n} else if (fxTag.includes('å††é«˜') || marginTag.includes('å£²ã‚Šæ¯ã‚Œ')) {\n  marketMode = 'OPPORTUNITY';\n  modeScore = 70;\n} else if (marginTag.includes('å¼·æ°—') && !yieldTag.includes('é«˜é‡‘åˆ©')) {\n  marketMode = 'BULLISH';\n  modeScore = 65;\n}\n\nreturn [{\n  json: {\n    analysis_id: initData.analysis_id,\n    target_date: initData.target_date,\n    \n    // ãƒã‚¯ãƒ­æŒ‡æ¨™\n    usd_jpy: usdJpy,\n    us_10y_yield: us10y,\n    avg_margin_ratio: Math.round(avgMarginRatio * 100) / 100,\n    \n    // ã‚¿ã‚°\n    context_tags: contextTags,\n    fx_tag: fxTag,\n    yield_tag: yieldTag,\n    margin_tag: marginTag,\n    anomaly_tags: anomalyTags,\n    \n    // åˆ¤å®šçµæœ\n    market_mode: marketMode,\n    mode_score: modeScore,\n    mode_description: {\n      'CAUTION': 'âš ï¸ è­¦æˆ’ãƒ¢ãƒ¼ãƒ‰ï¼šéç†±æ„Ÿã‚ã‚Šã€æ–°è¦è²·ã„ã¯æ…é‡ã«',\n      'OPPORTUNITY': 'ğŸ¯ æ©Ÿä¼šãƒ¢ãƒ¼ãƒ‰ï¼šåç™ºç‹™ã„ã®å¥½æ©Ÿ',\n      'BULLISH': 'ğŸ“ˆ å¼·æ°—ãƒ¢ãƒ¼ãƒ‰ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼æœ‰åŠ¹',\n      'NEUTRAL': 'â– ä¸­ç«‹ãƒ¢ãƒ¼ãƒ‰ï¼šé¸åˆ¥æŠ•è³‡'\n    }[marketMode],\n    \n    analyzed_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "generate-context-tags",
      "name": "ğŸ·ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚°ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 450],
      "notes": "[PYTHON_MIGRATION_CANDIDATE] è¤‡é›‘ãªæ¡ä»¶åˆ†å²"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO macro_context (analysis_id, target_date, usd_jpy, us_10y_yield, avg_margin_ratio, context_tags, market_mode, mode_score, analyzed_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) ON CONFLICT (target_date) DO UPDATE SET analysis_id = EXCLUDED.analysis_id, usd_jpy = EXCLUDED.usd_jpy, us_10y_yield = EXCLUDED.us_10y_yield, avg_margin_ratio = EXCLUDED.avg_margin_ratio, context_tags = EXCLUDED.context_tags, market_mode = EXCLUDED.market_mode, mode_score = EXCLUDED.mode_score, analyzed_at = EXCLUDED.analyzed_at",
        "options": {
          "queryParams": "={{ [$json.analysis_id, $json.target_date, $json.usd_jpy, $json.us_10y_yield, $json.avg_margin_ratio, JSON.stringify($json.context_tags), $json.market_mode, $json.mode_score, $json.analyzed_at] }}"
        }
      },
      "id": "save-context",
      "name": "ğŸ’¾ macro_context ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1150, 450],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, market_mode: $json.market_mode, mode_score: $json.mode_score, context_tags: $json.context_tags, description: $json.mode_description }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1400, 450]
    }
  ],
  "connections": {
    "Webhook: fin-context-judge": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ğŸ“Š ç›´è¿‘30æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ’± ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆUSD/JPYï¼‰",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“ˆ ç±³10å¹´å‚µåˆ©å›ã‚Šå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š ç›´è¿‘30æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ·ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚°ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’± ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆUSD/JPYï¼‰": {
      "main": [
        [
          {
            "node": "ğŸ·ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚°ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ç±³10å¹´å‚µåˆ©å›ã‚Šå–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ·ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚°ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ·ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚°ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ğŸ’¾ macro_context ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ macro_context ä¿å­˜": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n3-empire-os"
  },
  "pinData": {},
  "versionId": "v6-fin-02",
  "tags": [
    {
      "name": "æ ªå¼",
      "id": "fin"
    },
    {
      "name": "V6",
      "id": "v6"
    },
    {
      "name": "ç’°å¢ƒåˆ¤å®š",
      "id": "context"
    }
  ]
}
