{
  "name": "ã€æ ªå¼ã€‘05_FIN-æˆ¦è¡“æ›¸ç”Ÿæˆ-Entry-Exit-StopLoss_V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fin-tactical-plan",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: fin-tactical-plan",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "fin-tactical-plan"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-FIN-05 V6: æˆ¦è¡“æ›¸ç”Ÿæˆï¼ˆEntry/Half-Exit/Stop-Loss/Trailingï¼‰\n// å½¹å‰²: å…·ä½“çš„ãªå£²è²·ä¾¡æ ¼ã¨å‡ºå£æˆ¦ç•¥ã‚’ã‚»ãƒƒãƒˆã§ç”Ÿæˆ\n// ============================================================================\n\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst stockCode = body.stock_code;\nconst stockName = body.stock_name || '';\nconst currentPrice = body.current_price;\nconst strategyScore = body.strategy_score || 60;\nconst consensusSignal = body.consensus_signal || 'HOLD';\nconst volatility = body.volatility || 0;\nconst atr = body.atr || currentPrice * 0.02;\n\nif (!stockCode || !currentPrice) {\n  return [{ json: { error: true, message: 'stock_code ã¨ current_price ã¯å¿…é ˆ', code: 'MISSING_PARAM' } }];\n}\n\nreturn [{\n  json: {\n    stock_code: stockCode,\n    stock_name: stockName,\n    current_price: currentPrice,\n    strategy_score: strategyScore,\n    consensus_signal: consensusSignal,\n    volatility: volatility,\n    atr: atr,\n    plan_id: `plan_${Date.now()}`,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT close, high, low FROM market_data WHERE code = $1 ORDER BY date DESC LIMIT 20",
        "options": {
          "queryParams": "={{ [$json.stock_code] }}"
        }
      },
      "id": "get-recent-prices",
      "name": "ğŸ“Š ç›´è¿‘20æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// æˆ¦è¡“æ›¸ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆATRãƒ™ãƒ¼ã‚¹æåˆ‡ã‚Šãƒ»å¤šæ®µåˆ©ç¢ºï¼‰\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–'].json;\nconst recentData = $input.first().json || [];\n\nconst currentPrice = initData.current_price;\nconst strategyScore = initData.strategy_score;\nconst consensusSignal = initData.consensus_signal;\n\n// ATRè¨ˆç®—ï¼ˆTrue Range ã®å¹³å‡ï¼‰\nfunction calculateATR(data, period = 14) {\n  if (!Array.isArray(data) || data.length < 2) return currentPrice * 0.02;\n  \n  const trueRanges = [];\n  for (let i = 1; i < Math.min(data.length, period + 1); i++) {\n    const high = data[i].high || data[i].close;\n    const low = data[i].low || data[i].close;\n    const prevClose = data[i - 1].close;\n    const tr = Math.max(\n      high - low,\n      Math.abs(high - prevClose),\n      Math.abs(low - prevClose)\n    );\n    trueRanges.push(tr);\n  }\n  \n  return trueRanges.length > 0 \n    ? trueRanges.reduce((a, b) => a + b, 0) / trueRanges.length \n    : currentPrice * 0.02;\n}\n\nconst atr = calculateATR(recentData);\n\n// ============================================================================\n// ä¾¡æ ¼è¨ˆç®—\n// ============================================================================\n\n// Entry: ç¾åœ¨ä¾¡æ ¼ï¼ˆæŒ‡å€¤ã®å ´åˆã¯å°‘ã—ä¸‹ï¼‰\nconst entryPrice = Math.round(currentPrice);\nconst entryLimitPrice = Math.round(currentPrice * 0.995); // 0.5%ä¸‹ã§æŒ‡å€¤\n\n// Stop Loss: ATR Ã— 2å€ï¼ˆãƒã‚¤ã‚ºã§åˆˆã‚‰ã‚Œãªã„æ·±ã•ï¼‰\nconst stopLossDistance = atr * 2;\nconst stopLossPrice = Math.round(currentPrice - stopLossDistance);\nconst stopLossPercent = ((currentPrice - stopLossPrice) / currentPrice * 100).toFixed(2);\n\n// Take Profit 1ï¼ˆåŠåˆ†åˆ©ç¢ºï¼‰: ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰ 1:2\nconst takeProfit1Distance = stopLossDistance * 2;\nconst takeProfit1Price = Math.round(currentPrice + takeProfit1Distance);\nconst takeProfit1Percent = ((takeProfit1Price - currentPrice) / currentPrice * 100).toFixed(2);\n\n// Take Profit 2ï¼ˆå…¨åˆ©ç¢ºï¼‰: ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰ 1:3\nconst takeProfit2Distance = stopLossDistance * 3;\nconst takeProfit2Price = Math.round(currentPrice + takeProfit2Distance);\nconst takeProfit2Percent = ((takeProfit2Price - currentPrice) / currentPrice * 100).toFixed(2);\n\n// Trailing Stop: é«˜å€¤ã‹ã‚‰ ATR Ã— 1.5 ä¸‹\nconst trailingStopDistance = atr * 1.5;\n\n// å‹ç‡è¨ˆç®—ï¼ˆã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ï¼‰\nconst baseWinRate = 45; // ãƒ™ãƒ¼ã‚¹å‹ç‡\nconst scoreBonus = (strategyScore - 50) * 0.5; // ã‚¹ã‚³ã‚¢ã«ã‚ˆã‚‹è£œæ­£\nconst winRate = Math.min(85, Math.max(30, baseWinRate + scoreBonus));\n\n// æœŸå¾…å€¤è¨ˆç®—\nconst avgWin = (takeProfit1Distance + takeProfit2Distance) / 2;\nconst avgLoss = stopLossDistance;\nconst expectedValue = (winRate / 100 * avgWin) - ((100 - winRate) / 100 * avgLoss);\nconst expectedValuePercent = (expectedValue / currentPrice * 100).toFixed(2);\n\n// ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”\nconst riskRewardRatio = (avgWin / avgLoss).toFixed(2);\n\n// æ¨å¥¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºï¼ˆãƒªã‚¹ã‚¯2%ãƒ«ãƒ¼ãƒ«ï¼‰\nconst accountRisk = 0.02; // å£åº§ã®2%\nconst positionSizeRatio = accountRisk / (stopLossDistance / currentPrice);\n\n// æ™‚é–“åˆ¶é™ï¼ˆå¡©æ¼¬ã‘é˜²æ­¢ï¼‰\nconst timeLimitDays = strategyScore >= 70 ? 30 : strategyScore >= 50 ? 14 : 7;\n\nreturn [{\n  json: {\n    plan_id: initData.plan_id,\n    stock_code: initData.stock_code,\n    stock_name: initData.stock_name,\n    \n    // ç¾åœ¨ã®çŠ¶æ³\n    current_price: currentPrice,\n    atr: Math.round(atr),\n    strategy_score: strategyScore,\n    consensus_signal: consensusSignal,\n    \n    // Entryæˆ¦ç•¥\n    entry: {\n      type: 'limit', // æŒ‡å€¤æ¨å¥¨\n      price: entryLimitPrice,\n      market_price: entryPrice,\n      note: 'æŒ‡å€¤ã§0.5%ä¸‹ã‚’ç‹™ã†ã€‚å±Šã‹ãªã‘ã‚Œã°è¦‹é€ã‚Šã€‚'\n    },\n    \n    // Exitæˆ¦ç•¥ï¼ˆæåˆ‡ã‚Šï¼‰\n    stop_loss: {\n      price: stopLossPrice,\n      distance: Math.round(stopLossDistance),\n      percent: stopLossPercent,\n      type: 'é€†æŒ‡å€¤ï¼ˆæˆè¡Œï¼‰',\n      note: `ATRÃ—2å€ã€‚ãƒã‚¤ã‚ºã§åˆˆã‚‰ã‚Œã«ãã„æ·±ã•ã€‚æœ€å¤§æå¤±: -${stopLossPercent}%`\n    },\n    \n    // Exitæˆ¦ç•¥ï¼ˆåˆ©ç¢º1: åŠåˆ†ï¼‰\n    take_profit_1: {\n      price: takeProfit1Price,\n      percent: takeProfit1Percent,\n      action: 'ä¿æœ‰æ ªã®50%ã‚’åˆ©ç¢º',\n      note: 'ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰1:2é”æˆã§åŠåˆ†åˆ©ç¢º'\n    },\n    \n    // Exitæˆ¦ç•¥ï¼ˆåˆ©ç¢º2: æ®‹ã‚Šï¼‰\n    take_profit_2: {\n      price: takeProfit2Price,\n      percent: takeProfit2Percent,\n      action: 'æ®‹ã‚Š50%ã‚’åˆ©ç¢º or ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ç¶™ç¶š',\n      note: 'ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰1:3é”æˆã§å…¨åˆ©ç¢ºã€ã¾ãŸã¯é«˜å€¤è¿½å¾“'\n    },\n    \n    // ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—\n    trailing_stop: {\n      distance: Math.round(trailingStopDistance),\n      percent: (trailingStopDistance / currentPrice * 100).toFixed(2),\n      note: 'é«˜å€¤æ›´æ–°æ™‚ã€é«˜å€¤ã‹ã‚‰ATRÃ—1.5ä¸‹ã«é€†æŒ‡å€¤ã‚’ç§»å‹•'\n    },\n    \n    // æ™‚é–“åˆ¶é™ï¼ˆå¡©æ¼¬ã‘é˜²æ­¢ï¼‰\n    time_limit: {\n      days: timeLimitDays,\n      action: 'æœŸé™åˆ°é”ã§æˆè¡Œå£²å´',\n      note: `${timeLimitDays}æ—¥é–“å‹•ã‹ãªã‘ã‚Œã°è³‡é‡‘åŠ¹ç‡ã®ãŸã‚æ’¤é€€`\n    },\n    \n    // æœŸå¾…å€¤åˆ†æ\n    analysis: {\n      win_rate: winRate,\n      risk_reward_ratio: riskRewardRatio,\n      expected_value_percent: expectedValuePercent,\n      position_size_ratio: positionSizeRatio.toFixed(2),\n      is_profitable: expectedValue > 0\n    },\n    \n    // ç·åˆåˆ¤å®š\n    recommendation: consensusSignal === 'BUY' && strategyScore >= 60 && expectedValue > 0\n      ? 'âœ… ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¨å¥¨'\n      : consensusSignal === 'HOLD' || (strategyScore >= 40 && strategyScore < 60)\n      ? 'â¸ï¸ æ§˜å­è¦‹æ¨å¥¨'\n      : 'âŒ è¦‹é€ã‚Šæ¨å¥¨',\n    \n    generated_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "generate-tactical-plan",
      "name": "ğŸ“‹ æˆ¦è¡“æ›¸ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 400],
      "notes": "[CRITICAL] ATRãƒ™ãƒ¼ã‚¹å‡ºå£æˆ¦ç•¥"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO tactical_plans (plan_id, stock_code, stock_name, current_price, entry_price, stop_loss_price, take_profit_1_price, take_profit_2_price, trailing_stop_distance, time_limit_days, win_rate, risk_reward_ratio, expected_value_percent, recommendation, generated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)",
        "options": {
          "queryParams": "={{ [$json.plan_id, $json.stock_code, $json.stock_name, $json.current_price, $json.entry.price, $json.stop_loss.price, $json.take_profit_1.price, $json.take_profit_2.price, $json.trailing_stop.distance, $json.time_limit.days, $json.analysis.win_rate, $json.analysis.risk_reward_ratio, $json.analysis.expected_value_percent, $json.recommendation, $json.generated_at] }}"
        }
      },
      "id": "save-plan",
      "name": "ğŸ’¾ æˆ¦è¡“æ›¸ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1350, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, plan_id: $json.plan_id, stock_code: $json.stock_code, stock_name: $json.stock_name, entry: $json.entry, stop_loss: $json.stop_loss, take_profit_1: $json.take_profit_1, take_profit_2: $json.take_profit_2, trailing_stop: $json.trailing_stop, time_limit: $json.time_limit, analysis: $json.analysis, recommendation: $json.recommendation }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1600, 400]
    }
  ],
  "connections": {
    "Webhook: fin-tactical-plan": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š ç›´è¿‘20æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š ç›´è¿‘20æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“‹ æˆ¦è¡“æ›¸ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ æˆ¦è¡“æ›¸ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ğŸ’¾ æˆ¦è¡“æ›¸ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ æˆ¦è¡“æ›¸ä¿å­˜": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n3-empire-os"
  },
  "pinData": {},
  "versionId": "v6-fin-05",
  "tags": [
    {
      "name": "æ ªå¼",
      "id": "fin"
    },
    {
      "name": "V6",
      "id": "v6"
    },
    {
      "name": "æˆ¦è¡“æ›¸",
      "id": "tactical"
    }
  ]
}
