{
  "name": "ã€æ ªå¼ã€‘03_FIN-æˆ¦ç•¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼-å¤šç†è«–ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ_V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fin-strategy-sim",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: fin-strategy-sim",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "fin-strategy-sim"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-FIN-03 V6: æˆ¦ç•¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆFormula Tournamentï¼‰\n// å½¹å‰²: è¤‡æ•°ã®æŠ•è³‡ç†è«–ã‚’ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã—ã€ç¾ç’°å¢ƒã§ã®æœ€é©æˆ¦ç•¥ã‚’é¸å®š\n// ============================================================================\n\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst stockCode = body.stock_code;\nconst strategies = body.strategies || ['canslim', 'value', 'vcp', 'momentum', 'yield'];\nconst backtestDays = body.backtest_days || 90;\n\nif (!stockCode) {\n  return [{ json: { error: true, message: 'stock_code ã¯å¿…é ˆ', code: 'MISSING_PARAM' } }];\n}\n\nreturn [{\n  json: {\n    stock_code: stockCode,\n    strategies: strategies,\n    backtest_days: backtestDays,\n    sim_id: `sim_${Date.now()}`,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT code, date, open, high, low, close, volume, per, pbr, roe, margin_ratio FROM market_data WHERE code = $1 AND date >= CURRENT_DATE - INTERVAL '$2 days' ORDER BY date ASC",
        "options": {
          "queryParams": "={{ [$json.stock_code, $json.backtest_days] }}"
        }
      },
      "id": "get-historical-data",
      "name": "ğŸ“Š éå»ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT market_mode, mode_score, context_tags FROM macro_context ORDER BY target_date DESC LIMIT 1",
        "options": {}
      },
      "id": "get-current-context",
      "name": "ğŸ“ˆ ç¾åœ¨ã®ç’°å¢ƒå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 550],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// æŠ•è³‡ç†è«–åˆ¥ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼†ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ\n// 5ã¤ã®ç³»çµ±: å¹³å‡å›å¸°/ãƒˆãƒ¬ãƒ³ãƒ‰è¿½éš/éœ€çµ¦çµ±è¨ˆ/ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«/ã‚«ã‚ªã‚¹ç†è«–\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–'].json;\nconst historicalData = $node['ğŸ“Š éå»ãƒ‡ãƒ¼ã‚¿å–å¾—'].json || [];\nconst contextData = $node['ğŸ“ˆ ç¾åœ¨ã®ç’°å¢ƒå–å¾—'].json || {};\n\nif (!Array.isArray(historicalData) || historicalData.length < 10) {\n  return [{\n    json: {\n      error: true,\n      message: 'ãƒ‡ãƒ¼ã‚¿ä¸è¶³: æœ€ä½10æ—¥åˆ†ã®éå»ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦',\n      code: 'INSUFFICIENT_DATA'\n    }\n  }];\n}\n\nconst prices = historicalData.map(d => d.close);\nconst latestData = historicalData[historicalData.length - 1];\nconst marketMode = contextData.market_mode || 'NEUTRAL';\n\n// ============================================================================\n// æˆ¦ç•¥åˆ¥ã‚·ã‚°ãƒŠãƒ«è¨ˆç®—\n// ============================================================================\n\nfunction calculateSMA(data, period) {\n  if (data.length < period) return null;\n  const slice = data.slice(-period);\n  return slice.reduce((a, b) => a + b, 0) / period;\n}\n\nfunction calculateRSI(data, period = 14) {\n  if (data.length < period + 1) return 50;\n  let gains = 0, losses = 0;\n  for (let i = data.length - period; i < data.length; i++) {\n    const change = data[i] - data[i - 1];\n    if (change > 0) gains += change;\n    else losses -= change;\n  }\n  const rs = losses === 0 ? 100 : gains / losses;\n  return 100 - (100 / (1 + rs));\n}\n\nfunction calculateVolatility(data, period = 20) {\n  if (data.length < period) return 0;\n  const slice = data.slice(-period);\n  const mean = slice.reduce((a, b) => a + b, 0) / period;\n  const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;\n  return Math.sqrt(variance);\n}\n\nconst sma5 = calculateSMA(prices, 5);\nconst sma25 = calculateSMA(prices, 25);\nconst sma75 = calculateSMA(prices, 75);\nconst rsi = calculateRSI(prices);\nconst volatility = calculateVolatility(prices);\nconst currentPrice = prices[prices.length - 1];\n\nconst strategies = [];\n\n// 1. CAN-SLIMï¼ˆã‚ªãƒ‹ãƒ¼ãƒ«ï¼‰: æˆé•·æ ªãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ \nconst canslimScore = (() => {\n  let score = 50;\n  if (latestData.roe > 15) score += 15; // é«˜ROE\n  if (currentPrice > sma25 && sma25 > sma75) score += 20; // ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰\n  if (rsi > 50 && rsi < 70) score += 10; // é©åº¦ãªå¼·ã•\n  if (latestData.margin_ratio && latestData.margin_ratio < 3) score += 5; // éœ€çµ¦å¥å…¨\n  return Math.min(100, Math.max(0, score));\n})();\nstrategies.push({\n  name: 'CAN-SLIMï¼ˆã‚ªãƒ‹ãƒ¼ãƒ«ï¼‰',\n  score: canslimScore,\n  signal: canslimScore >= 70 ? 'BUY' : canslimScore >= 40 ? 'HOLD' : 'SELL',\n  confidence: Math.min(95, 60 + (canslimScore - 50) * 0.7),\n  reason: `ROE:${latestData.roe || '-'}%, ãƒˆãƒ¬ãƒ³ãƒ‰:${currentPrice > sma25 ? 'ä¸Šæ˜‡' : 'ä¸‹é™'}`\n});\n\n// 2. ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ï¼ˆãƒãƒ•ã‚§ãƒƒãƒˆï¼‰: å‰²å®‰æ ª\nconst valueScore = (() => {\n  let score = 50;\n  if (latestData.per && latestData.per < 15) score += 20;\n  if (latestData.pbr && latestData.pbr < 1.5) score += 20;\n  if (latestData.roe && latestData.roe > 10) score += 10;\n  if (latestData.dividend_yield && latestData.dividend_yield > 2) score += 5;\n  return Math.min(100, Math.max(0, score));\n})();\nstrategies.push({\n  name: 'ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ï¼ˆãƒãƒ•ã‚§ãƒƒãƒˆï¼‰',\n  score: valueScore,\n  signal: valueScore >= 70 ? 'BUY' : valueScore >= 40 ? 'HOLD' : 'SELL',\n  confidence: Math.min(95, 60 + (valueScore - 50) * 0.7),\n  reason: `PER:${latestData.per || '-'}, PBR:${latestData.pbr || '-'}`\n});\n\n// 3. VCPãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒŸãƒãƒ«ãƒ´ã‚£ãƒ‹ï¼‰: ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åç¸®\nconst vcpScore = (() => {\n  let score = 50;\n  const recentVol = calculateVolatility(prices.slice(-10), 10);\n  const prevVol = calculateVolatility(prices.slice(-20, -10), 10);\n  if (recentVol < prevVol * 0.8) score += 25; // ãƒœãƒ©åç¸®\n  if (currentPrice > sma25 * 0.95 && currentPrice < sma25 * 1.05) score += 15; // åæŸ\n  if (rsi > 40 && rsi < 60) score += 10;\n  return Math.min(100, Math.max(0, score));\n})();\nstrategies.push({\n  name: 'VCPãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒŸãƒãƒ«ãƒ´ã‚£ãƒ‹ï¼‰',\n  score: vcpScore,\n  signal: vcpScore >= 70 ? 'BUY' : vcpScore >= 40 ? 'HOLD' : 'SELL',\n  confidence: Math.min(95, 60 + (vcpScore - 50) * 0.7),\n  reason: `ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£: ${Math.round(volatility)}, RSI: ${Math.round(rsi)}`\n});\n\n// 4. éœ€çµ¦åˆ†æ: ä¿¡ç”¨æ®‹ãƒ™ãƒ¼ã‚¹\nconst supplyDemandScore = (() => {\n  let score = 50;\n  const mr = latestData.margin_ratio;\n  if (mr && mr < 1.5) score += 30; // å£²ã‚Šæ¯ã‚Œ = ä¸Šæ˜‡ä½™åœ°\n  else if (mr && mr > 4) score -= 20; // éç†±\n  else if (mr && mr < 2.5) score += 15;\n  return Math.min(100, Math.max(0, score));\n})();\nstrategies.push({\n  name: 'éœ€çµ¦åˆ†æï¼ˆãƒ†ã‚¹ã‚¿æµï¼‰',\n  score: supplyDemandScore,\n  signal: supplyDemandScore >= 70 ? 'BUY' : supplyDemandScore >= 40 ? 'HOLD' : 'SELL',\n  confidence: Math.min(95, 60 + (supplyDemandScore - 50) * 0.7),\n  reason: `ä¿¡ç”¨å€ç‡: ${latestData.margin_ratio || '-'}`\n});\n\n// 5. å¹³å‡å›å¸°ï¼ˆé€†å¼µã‚Šï¼‰: RSIãƒ™ãƒ¼ã‚¹\nconst meanReversionScore = (() => {\n  let score = 50;\n  if (rsi < 30) score += 30; // å£²ã‚‰ã‚Œã™ã = è²·ã„\n  else if (rsi > 70) score -= 20; // è²·ã‚ã‚Œã™ã\n  else if (rsi < 40) score += 15;\n  if (currentPrice < sma25 * 0.95) score += 10; // ä¸‹æ–¹ä¹–é›¢\n  return Math.min(100, Math.max(0, score));\n})();\nstrategies.push({\n  name: 'å¹³å‡å›å¸°ï¼ˆé€†å¼µã‚Šï¼‰',\n  score: meanReversionScore,\n  signal: meanReversionScore >= 70 ? 'BUY' : meanReversionScore >= 40 ? 'HOLD' : 'SELL',\n  confidence: Math.min(95, 60 + (meanReversionScore - 50) * 0.7),\n  reason: `RSI: ${Math.round(rsi)}, SMA25ä¹–é›¢: ${Math.round((currentPrice / sma25 - 1) * 100)}%`\n});\n\n// ============================================================================\n// ç’°å¢ƒåˆ¥ã®é‡ã¿ä»˜ã‘èª¿æ•´\n// ============================================================================\n\nconst weightAdjustments = {\n  'BULLISH': { 'CAN-SLIMï¼ˆã‚ªãƒ‹ãƒ¼ãƒ«ï¼‰': 1.3, 'VCPãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒŸãƒãƒ«ãƒ´ã‚£ãƒ‹ï¼‰': 1.2, 'å¹³å‡å›å¸°ï¼ˆé€†å¼µã‚Šï¼‰': 0.7 },\n  'CAUTION': { 'ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ï¼ˆãƒãƒ•ã‚§ãƒƒãƒˆï¼‰': 1.3, 'éœ€çµ¦åˆ†æï¼ˆãƒ†ã‚¹ã‚¿æµï¼‰': 1.2, 'CAN-SLIMï¼ˆã‚ªãƒ‹ãƒ¼ãƒ«ï¼‰': 0.8 },\n  'OPPORTUNITY': { 'å¹³å‡å›å¸°ï¼ˆé€†å¼µã‚Šï¼‰': 1.4, 'ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ï¼ˆãƒãƒ•ã‚§ãƒƒãƒˆï¼‰': 1.2 },\n  'NEUTRAL': {}\n};\n\nconst adjustments = weightAdjustments[marketMode] || {};\n\nconst adjustedStrategies = strategies.map(s => {\n  const weight = adjustments[s.name] || 1.0;\n  return {\n    ...s,\n    adjusted_score: Math.round(s.score * weight),\n    weight: weight,\n    is_recommended: weight > 1.0\n  };\n}).sort((a, b) => b.adjusted_score - a.adjusted_score);\n\n// æœ€é©æˆ¦ç•¥ã®é¸å®š\nconst bestStrategy = adjustedStrategies[0];\nconst consensusSignal = (() => {\n  const buyCount = adjustedStrategies.filter(s => s.signal === 'BUY').length;\n  const sellCount = adjustedStrategies.filter(s => s.signal === 'SELL').length;\n  if (buyCount >= 3) return 'BUY';\n  if (sellCount >= 3) return 'SELL';\n  return 'HOLD';\n})();\n\nreturn [{\n  json: {\n    sim_id: initData.sim_id,\n    stock_code: initData.stock_code,\n    current_price: currentPrice,\n    \n    // ç’°å¢ƒæƒ…å ±\n    market_mode: marketMode,\n    context_tags: contextData.context_tags,\n    \n    // å„æˆ¦ç•¥ã®ã‚¹ã‚³ã‚¢\n    strategies: adjustedStrategies,\n    \n    // æœ€çµ‚åˆ¤å®š\n    best_strategy: bestStrategy.name,\n    best_score: bestStrategy.adjusted_score,\n    consensus_signal: consensusSignal,\n    \n    // ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™\n    indicators: {\n      sma5: Math.round(sma5),\n      sma25: Math.round(sma25),\n      sma75: Math.round(sma75),\n      rsi: Math.round(rsi),\n      volatility: Math.round(volatility)\n    },\n    \n    analyzed_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "strategy-scoring",
      "name": "ğŸ§® æˆ¦ç•¥ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 450],
      "notes": "[PYTHON_MIGRATION_CANDIDATE] NumPy/Pandasä½¿ç”¨æ¨å¥¨"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO strategy_backtests (strategy_name, stock_code, score, signal, confidence, market_mode, sim_id, tested_at) SELECT unnest($1::text[]), $2, unnest($3::int[]), unnest($4::text[]), unnest($5::numeric[]), $6, $7, NOW()",
        "options": {
          "queryParams": "={{ [JSON.stringify($json.strategies.map(s => s.name)), $json.stock_code, JSON.stringify($json.strategies.map(s => s.adjusted_score)), JSON.stringify($json.strategies.map(s => s.signal)), JSON.stringify($json.strategies.map(s => s.confidence)), $json.market_mode, $json.sim_id] }}"
        }
      },
      "id": "save-backtest",
      "name": "ğŸ’¾ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1350, 450],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, stock_code: $json.stock_code, best_strategy: $json.best_strategy, best_score: $json.best_score, consensus_signal: $json.consensus_signal, market_mode: $json.market_mode, strategies: $json.strategies, indicators: $json.indicators }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1600, 450]
    }
  ],
  "connections": {
    "Webhook: fin-strategy-sim": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š éå»ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“ˆ ç¾åœ¨ã®ç’°å¢ƒå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š éå»ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§® æˆ¦ç•¥ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ç¾åœ¨ã®ç’°å¢ƒå–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§® æˆ¦ç•¥ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§® æˆ¦ç•¥ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœä¿å­˜": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n3-empire-os"
  },
  "pinData": {},
  "versionId": "v6-fin-03",
  "tags": [
    {
      "name": "æ ªå¼",
      "id": "fin"
    },
    {
      "name": "V6",
      "id": "v6"
    },
    {
      "name": "æˆ¦ç•¥",
      "id": "strategy"
    }
  ]
}
