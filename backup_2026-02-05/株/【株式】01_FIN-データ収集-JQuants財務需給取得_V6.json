{
  "name": "ã€æ ªå¼ã€‘01_FIN-ãƒ‡ãƒ¼ã‚¿åé›†-JQuantsè²¡å‹™éœ€çµ¦å–å¾—_V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fin-data-ingest",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: fin-data-ingest",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "fin-data-ingest"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-FIN-01 V6: J-Quants API ãƒ‡ãƒ¼ã‚¿åé›†ã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ãƒ¼\n// å½¹å‰²: éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€è²¡å‹™ãƒ»éœ€çµ¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\n// ============================================================================\n\nconst apiUrl = $env.N3_API_URL || $env.API_BASE_URL;\nconst jquantsApiKey = $env.JQUANTS_API_KEY;\nconst jquantsRefreshToken = $env.JQUANTS_REFRESH_TOKEN;\n\nif (!jquantsApiKey && !jquantsRefreshToken) {\n  return [{ json: { error: true, message: 'J-Quantsèªè¨¼æƒ…å ±ãŒæœªè¨­å®š', code: 'CONFIG_ERROR' } }];\n}\n\nconst body = $input.first().json.body || $input.first().json || {};\n\n// éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä¸»è¦éŠ˜æŸ„ï¼‰\nconst stockCodes = body.stock_codes || ['7203', '6758', '9984', '6861', '8306', '4502', '6501', '7267', '9432', '8035'];\nconst dataTypes = body.data_types || ['price', 'financial', 'margin'];\nconst dateFrom = body.date_from || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\nconst dateTo = body.date_to || new Date().toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    stock_codes: stockCodes,\n    data_types: dataTypes,\n    date_from: dateFrom,\n    date_to: dateTo,\n    api_url: apiUrl,\n    jquants_base_url: 'https://api.jquants.com/v1',\n    timestamp: new Date().toISOString(),\n    batch_id: `fin_${Date.now()}`\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–ï¼ˆJ-Quantsæº–å‚™ï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300],
      "notes": "[PYTHON_MIGRATION_CANDIDATE] J-Quantsèªè¨¼ãƒ•ãƒ­ãƒ¼"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.jquants.com/v1/token/auth_refresh",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ refreshtoken: $env.JQUANTS_REFRESH_TOKEN }) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "jquants-auth",
      "name": "ğŸ”‘ J-Quantsèªè¨¼",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// J-Quants ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—çµæœå‡¦ç†\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–ï¼ˆJ-Quantsæº–å‚™ï¼‰'].json;\nconst authResult = $input.first().json;\n\nif (!authResult.idToken) {\n  return [{\n    json: {\n      ...initData,\n      error: true,\n      message: 'J-Quantsèªè¨¼å¤±æ•—: ' + JSON.stringify(authResult),\n      code: 'AUTH_ERROR'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...initData,\n    id_token: authResult.idToken,\n    auth_status: 'authenticated'\n  }\n}];"
      },
      "id": "process-auth",
      "name": "ğŸ“‹ èªè¨¼çµæœå‡¦ç†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400],
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// éŠ˜æŸ„ã”ã¨ã«ãƒ«ãƒ¼ãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™\n// ============================================================================\n\nconst data = $input.first().json;\nconst stockCodes = data.stock_codes;\n\nreturn stockCodes.map(code => ({\n  json: {\n    ...data,\n    current_stock_code: code\n  }\n}));"
      },
      "id": "split-stocks",
      "name": "ğŸ”€ éŠ˜æŸ„åˆ†å‰²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "batch-stocks",
      "name": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†ï¼ˆ5éŠ˜æŸ„ï¼‰",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.jquants_base_url }}/prices/daily_quotes?code={{ $json.current_stock_code }}&from={{ $json.date_from }}&to={{ $json.date_to }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.id_token }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-price-data",
      "name": "ğŸ“ˆ æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.jquants_base_url }}/fins/statements?code={{ $json.current_stock_code }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $node['ğŸ“‹ èªè¨¼çµæœå‡¦ç†'].json.id_token }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-financial-data",
      "name": "ğŸ’° è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.jquants_base_url }}/markets/trades_spec?code={{ $json.current_stock_code }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $node['ğŸ“‹ èªè¨¼çµæœå‡¦ç†'].json.id_token }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-margin-data",
      "name": "ğŸ“Š ä¿¡ç”¨æ®‹ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// å–å¾—ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆï¼†æ­£è¦åŒ–\n// ============================================================================\n\nconst initData = $node['ğŸ“¦ ãƒãƒƒãƒå‡¦ç†ï¼ˆ5éŠ˜æŸ„ï¼‰'].json;\nconst priceData = $node['ğŸ“ˆ æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—'].json;\nconst financialData = $node['ğŸ’° è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—'].json;\nconst marginData = $node['ğŸ“Š ä¿¡ç”¨æ®‹ãƒ‡ãƒ¼ã‚¿å–å¾—'].json;\n\nconst stockCode = initData.current_stock_code;\n\n// æœ€æ–°ã®æ ªä¾¡æƒ…å ±\nconst latestPrice = priceData.daily_quotes?.[priceData.daily_quotes.length - 1] || {};\n\n// æœ€æ–°ã®è²¡å‹™æƒ…å ±\nconst latestFinancial = financialData.statements?.[0] || {};\n\n// ä¿¡ç”¨æ®‹æƒ…å ±\nconst latestMargin = marginData.trades_spec?.[0] || {};\n\n// PERè¨ˆç®—ï¼ˆæ™‚ä¾¡ç·é¡ / ç´”åˆ©ç›Šï¼‰\nconst per = latestPrice.Close && latestFinancial.NetIncome \n  ? (latestPrice.Close * (latestFinancial.NumberOfIssuedAndOutstandingSharesAtTheEndOfFiscalYearIncludingTreasuryStock || 1)) / latestFinancial.NetIncome \n  : null;\n\n// PBRè¨ˆç®—ï¼ˆæ ªä¾¡ / 1æ ªç´”è³‡ç”£ï¼‰\nconst pbr = latestPrice.Close && latestFinancial.BookValuePerShare \n  ? latestPrice.Close / latestFinancial.BookValuePerShare \n  : null;\n\n// ROEè¨ˆç®—\nconst roe = latestFinancial.NetIncome && latestFinancial.Equity \n  ? (latestFinancial.NetIncome / latestFinancial.Equity) * 100 \n  : null;\n\n// ä¿¡ç”¨å€ç‡ï¼ˆè²·ã„æ®‹ / å£²ã‚Šæ®‹ï¼‰\nconst marginRatio = latestMargin.MarginBuyingNew && latestMargin.MarginSellingNew \n  ? latestMargin.MarginBuyingNew / (latestMargin.MarginSellingNew || 1) \n  : null;\n\nreturn [{\n  json: {\n    stock_code: stockCode,\n    date: latestPrice.Date || new Date().toISOString().split('T')[0],\n    \n    // æ ªä¾¡æƒ…å ±\n    open: latestPrice.Open,\n    high: latestPrice.High,\n    low: latestPrice.Low,\n    close: latestPrice.Close,\n    volume: latestPrice.Volume,\n    turnover: latestPrice.TurnoverValue,\n    \n    // è²¡å‹™æƒ…å ±\n    per: per ? Math.round(per * 100) / 100 : null,\n    pbr: pbr ? Math.round(pbr * 100) / 100 : null,\n    roe: roe ? Math.round(roe * 100) / 100 : null,\n    eps: latestFinancial.EarningsPerShare,\n    bps: latestFinancial.BookValuePerShare,\n    dividend_yield: latestFinancial.DividendYield,\n    \n    // éœ€çµ¦æƒ…å ±\n    margin_buy: latestMargin.MarginBuyingNew,\n    margin_sell: latestMargin.MarginSellingNew,\n    margin_ratio: marginRatio ? Math.round(marginRatio * 100) / 100 : null,\n    \n    // ãƒ¡ã‚¿æƒ…å ±\n    batch_id: initData.batch_id,\n    fetched_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "normalize-data",
      "name": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1900, 450],
      "notes": "[PYTHON_MIGRATION_CANDIDATE] pandasä½¿ç”¨æ¨å¥¨"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO market_data (code, date, open, high, low, close, volume, turnover, per, pbr, roe, eps, bps, dividend_yield, margin_buy, margin_sell, margin_ratio, batch_id, fetched_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19) ON CONFLICT (code, date) DO UPDATE SET open = EXCLUDED.open, high = EXCLUDED.high, low = EXCLUDED.low, close = EXCLUDED.close, volume = EXCLUDED.volume, turnover = EXCLUDED.turnover, per = EXCLUDED.per, pbr = EXCLUDED.pbr, roe = EXCLUDED.roe, eps = EXCLUDED.eps, bps = EXCLUDED.bps, dividend_yield = EXCLUDED.dividend_yield, margin_buy = EXCLUDED.margin_buy, margin_sell = EXCLUDED.margin_sell, margin_ratio = EXCLUDED.margin_ratio, batch_id = EXCLUDED.batch_id, fetched_at = EXCLUDED.fetched_at",
        "options": {
          "queryParams": "={{ [$json.stock_code, $json.date, $json.open, $json.high, $json.low, $json.close, $json.volume, $json.turnover, $json.per, $json.pbr, $json.roe, $json.eps, $json.bps, $json.dividend_yield, $json.margin_buy, $json.margin_sell, $json.margin_ratio, $json.batch_id, $json.fetched_at] }}"
        }
      },
      "id": "upsert-market-data",
      "name": "ğŸ’¾ market_data UPSERT",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2150, 450],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-results",
      "name": "ğŸ”€ çµæœçµ±åˆ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2350, 450]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// æœ€çµ‚çµæœé›†è¨ˆ\n// ============================================================================\n\nconst allItems = $input.all();\nconst successCount = allItems.filter(item => !item.json.error).length;\nconst errorCount = allItems.filter(item => item.json.error).length;\n\nreturn [{\n  json: {\n    success: true,\n    message: `${successCount}éŠ˜æŸ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»ä¿å­˜ã—ã¾ã—ãŸ`,\n    total_processed: allItems.length,\n    success_count: successCount,\n    error_count: errorCount,\n    batch_id: allItems[0]?.json.batch_id,\n    completed_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "final-summary",
      "name": "ğŸ“Š æœ€çµ‚é›†è¨ˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2550, 450]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2750, 450]
    }
  ],
  "connections": {
    "Webhook: fin-data-ingest": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–ï¼ˆJ-Quantsæº–å‚™ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–ï¼ˆJ-Quantsæº–å‚™ï¼‰": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”‘ J-Quantsèªè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”‘ J-Quantsèªè¨¼": {
      "main": [
        [
          {
            "node": "ğŸ“‹ èªè¨¼çµæœå‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ èªè¨¼çµæœå‡¦ç†": {
      "main": [
        [
          {
            "node": "ğŸ”€ éŠ˜æŸ„åˆ†å‰²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ éŠ˜æŸ„åˆ†å‰²": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†ï¼ˆ5éŠ˜æŸ„ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†ï¼ˆ5éŠ˜æŸ„ï¼‰": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ’° è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“Š ä¿¡ç”¨æ®‹ãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’° è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š ä¿¡ç”¨æ®‹ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–": {
      "main": [
        [
          {
            "node": "ğŸ’¾ market_data UPSERT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ market_data UPSERT": {
      "main": [
        [
          {
            "node": "ğŸ”€ çµæœçµ±åˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ çµæœçµ±åˆ": {
      "main": [
        [
          {
            "node": "ğŸ“Š æœ€çµ‚é›†è¨ˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š æœ€çµ‚é›†è¨ˆ": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n3-empire-os"
  },
  "pinData": {},
  "versionId": "v6-fin-01",
  "tags": [
    {
      "name": "æ ªå¼",
      "id": "fin"
    },
    {
      "name": "V6",
      "id": "v6"
    },
    {
      "name": "ãƒ‡ãƒ¼ã‚¿åé›†",
      "id": "data-ingest"
    }
  ]
}
