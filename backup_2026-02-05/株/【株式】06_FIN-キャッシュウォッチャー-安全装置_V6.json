{
  "name": "ã€æ ªå¼ã€‘06_FIN-ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼-å®‰å…¨è£…ç½®_V6",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fin-cash-watcher",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: fin-cash-watcher",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "fin-cash-watcher"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-FIN-06 V6: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ï¼ˆå®‰å…¨è£…ç½®ï¼‰\n// å½¹å‰²: æŠ•è³‡å¯èƒ½é¡ã‚’ç®—å‡ºã—ã€ç”Ÿå­˜è³‡é‡‘ãƒ»ç´ç¨ãƒªã‚¶ãƒ¼ãƒ–ã‚’ç¢ºä¿\n// é‰„ã®æŸ: ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’é€šã•ãªã„é™ã‚Š1å††ã‚‚æŠ•è³‡ã«å›ã•ãªã„\n// ============================================================================\n\nconst body = $input.first().json.body || $input.first().json || {};\n\n// éŠ€è¡Œæ®‹é«˜ï¼ˆæ‰‹å‹•å…¥åŠ› or APIï¼‰\nconst totalBalanceJpy = body.total_balance_jpy || 0;\nconst totalBalanceUsd = body.total_balance_usd || 0;\n\n// è¨­å®šå€¤ï¼ˆDB or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰\nconst survivalFund = body.survival_fund || 2000000; // è–åŸŸè³‡é‡‘: 200ä¸‡å††\nconst monthlyOpCost = body.monthly_op_cost || 500000; // æœˆé–“é‹å–¶ã‚³ã‚¹ãƒˆ: 50ä¸‡å††\nconst taxReserveRate = body.tax_reserve_rate || 0.3; // ç´ç¨ãƒªã‚¶ãƒ¼ãƒ–ç‡: 30%\nconst maxSingleInvestRatio = body.max_single_invest_ratio || 0.1; // 1éŠ˜æŸ„æœ€å¤§10%\n\n// ä»ŠæœŸã®åˆ©ç›Šï¼ˆæ¦‚ç®—ï¼‰\nconst currentProfitYtd = body.current_profit_ytd || 0;\n\nreturn [{\n  json: {\n    total_balance_jpy: totalBalanceJpy,\n    total_balance_usd: totalBalanceUsd,\n    survival_fund: survivalFund,\n    monthly_op_cost: monthlyOpCost,\n    tax_reserve_rate: taxReserveRate,\n    max_single_invest_ratio: maxSingleInvestRatio,\n    current_profit_ytd: currentProfitYtd,\n    check_id: `cash_${Date.now()}`,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT survival_fund_jpy, tax_reserve_rate, max_investment_ratio, usd_reserve FROM safety_settings WHERE id = 1",
        "options": {}
      },
      "id": "get-safety-settings",
      "name": "âš™ï¸ å®‰å…¨è¨­å®šå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [650, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// æŠ•è³‡å¯èƒ½é¡ã®ç®—å‡ºï¼ˆé‰„ã®æŸï¼‰\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–'].json;\nconst dbSettings = $input.first().json || {};\n\n// DBè¨­å®šã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ\nconst survivalFund = dbSettings.survival_fund_jpy || initData.survival_fund;\nconst taxReserveRate = dbSettings.tax_reserve_rate || initData.tax_reserve_rate;\nconst maxInvestRatio = dbSettings.max_investment_ratio || initData.max_single_invest_ratio;\n\nconst totalBalanceJpy = initData.total_balance_jpy;\nconst totalBalanceUsd = initData.total_balance_usd;\nconst monthlyOpCost = initData.monthly_op_cost;\nconst currentProfitYtd = initData.current_profit_ytd;\n\n// ============================================================================\n// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯\n// ============================================================================\n\n// 1. é‹è»¢è³‡é‡‘ãƒªã‚¶ãƒ¼ãƒ–ï¼ˆ3ãƒ¶æœˆåˆ†ï¼‰\nconst operatingReserve = monthlyOpCost * 3;\n\n// 2. ç´ç¨ãƒªã‚¶ãƒ¼ãƒ–ï¼ˆä»ŠæœŸåˆ©ç›Šã®30%ï¼‰\nconst taxReserve = Math.max(0, currentProfitYtd * taxReserveRate);\n\n// 3. ç·ãƒªã‚¶ãƒ¼ãƒ–ï¼ˆçµ¶å¯¾ã«è§¦ã‚‰ãªã„é‡‘é¡ï¼‰\nconst totalReserve = survivalFund + operatingReserve + taxReserve;\n\n// 4. æŠ•è³‡å¯èƒ½é¡ï¼ˆJPYï¼‰\nlet investableJpy = totalBalanceJpy - totalReserve;\nif (investableJpy < 0) investableJpy = 0;\n\n// 5. 1éŠ˜æŸ„ã‚ãŸã‚Šæœ€å¤§æŠ•è³‡é¡\nconst maxPerStock = Math.round(investableJpy * maxInvestRatio);\n\n// 6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š\nlet status = 'DEFENSE';\nlet statusMessage = '';\n\nif (investableJpy <= 0) {\n  status = 'LOCKDOWN';\n  statusMessage = 'ğŸ”’ æŠ•è³‡ç¦æ­¢: ç”Ÿå­˜è³‡é‡‘ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚æ–°è¦æŠ•è³‡ã¯ä¸€åˆ‡ä¸å¯ã€‚';\n} else if (investableJpy < 500000) {\n  status = 'DEFENSE';\n  statusMessage = 'ğŸ›¡ï¸ é˜²å¾¡ãƒ¢ãƒ¼ãƒ‰: ä½™è£•è³‡é‡‘ãŒå°‘ãªã„ã€‚æ…é‡ãªæŠ•è³‡ã®ã¿ã€‚';\n} else if (investableJpy < 2000000) {\n  status = 'CAUTIOUS';\n  statusMessage = 'âš ï¸ æ…é‡ãƒ¢ãƒ¼ãƒ‰: æŠ•è³‡å¯èƒ½ã ãŒã€åˆ†æ•£ã‚’å¾¹åº•ã€‚';\n} else {\n  status = 'ATTACK';\n  statusMessage = 'âš”ï¸ æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰: ä½™è£•ã‚ã‚Šã€‚ç©æ¥µçš„ãªæŠ•è³‡å¯èƒ½ã€‚';\n}\n\n// 7. USDæŠ•è³‡å¯èƒ½é¡ï¼ˆæ—¥æœ¬æ ªä»¥å¤–ç”¨ï¼‰\nconst investableUsd = totalBalanceUsd * 0.7; // USDã¯70%ã¾ã§\n\nreturn [{\n  json: {\n    check_id: initData.check_id,\n    \n    // å…¥åŠ›å€¤\n    input: {\n      total_balance_jpy: totalBalanceJpy,\n      total_balance_usd: totalBalanceUsd,\n      current_profit_ytd: currentProfitYtd\n    },\n    \n    // ãƒªã‚¶ãƒ¼ãƒ–å†…è¨³\n    reserves: {\n      survival_fund: survivalFund,\n      operating_reserve: operatingReserve,\n      tax_reserve: Math.round(taxReserve),\n      total_reserve: Math.round(totalReserve)\n    },\n    \n    // æŠ•è³‡å¯èƒ½é¡\n    investable: {\n      jpy: Math.round(investableJpy),\n      usd: Math.round(investableUsd * 100) / 100,\n      max_per_stock_jpy: maxPerStock,\n      max_invest_ratio: maxInvestRatio\n    },\n    \n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\n    status: status,\n    status_message: statusMessage,\n    can_invest: investableJpy > 0,\n    \n    // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n    recommendations: investableJpy <= 0 \n      ? ['æ–°è¦æŠ•è³‡ã‚’åœæ­¢ã—ã¦ãã ã•ã„', 'ç”Ÿæ´»è²»ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„']\n      : investableJpy < 500000\n      ? ['åˆ†æ•£æŠ•è³‡ã‚’å¾¹åº•ã—ã¦ãã ã•ã„', 'æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ã‚’å³æ ¼ã«è¨­å®šã—ã¦ãã ã•ã„']\n      : ['é€šå¸¸ã®æŠ•è³‡ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„'],\n    \n    checked_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "calculate-investable",
      "name": "ğŸ§® æŠ•è³‡å¯èƒ½é¡ç®—å‡º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300],
      "notes": "[CRITICAL] é‰„ã®æŸ - å®‰å…¨è£…ç½®"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "lockdown-check",
              "leftValue": "={{ $json.status }}",
              "rightValue": "LOCKDOWN",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-lockdown",
      "name": "LOCKDOWN?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1150, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CHATWORK_WEBHOOK_URL || 'https://api.chatwork.com/v2/rooms/' + $env.CHATWORK_ROOM_ID + '/messages' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=ğŸš¨ã€N3 Finance ç·Šæ€¥è­¦å‘Šã€‘\n\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {{ $json.status }}\n{{ $json.status_message }}\n\nğŸ’° æ®‹é«˜: Â¥{{ $json.input.total_balance_jpy.toLocaleString() }}\nğŸ”’ å¿…è¦ãƒªã‚¶ãƒ¼ãƒ–: Â¥{{ $json.reserves.total_reserve.toLocaleString() }}\nğŸ“‰ æŠ•è³‡å¯èƒ½é¡: Â¥{{ $json.investable.jpy.toLocaleString() }}\n\nâš ï¸ æ–°è¦æŠ•è³‡ã‚’ç›´ã¡ã«åœæ­¢ã—ã¦ãã ã•ã„ã€‚"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "alert-lockdown",
      "name": "ğŸš¨ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO cash_checks (check_id, total_balance_jpy, total_balance_usd, survival_fund, operating_reserve, tax_reserve, total_reserve, investable_jpy, investable_usd, max_per_stock, status, checked_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)",
        "options": {
          "queryParams": "={{ [$json.check_id, $json.input.total_balance_jpy, $json.input.total_balance_usd, $json.reserves.survival_fund, $json.reserves.operating_reserve, $json.reserves.tax_reserve, $json.reserves.total_reserve, $json.investable.jpy, $json.investable.usd, $json.investable.max_per_stock_jpy, $json.status, $json.checked_at] }}"
        }
      },
      "id": "save-check",
      "name": "ğŸ’¾ ãƒã‚§ãƒƒã‚¯çµæœä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1400, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, check_id: $json.check_id, status: $json.status, status_message: $json.status_message, can_invest: $json.can_invest, investable: $json.investable, reserves: $json.reserves, recommendations: $json.recommendations }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "Webhook: fin-cash-watcher": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "âš™ï¸ å®‰å…¨è¨­å®šå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ å®‰å…¨è¨­å®šå–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§® æŠ•è³‡å¯èƒ½é¡ç®—å‡º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§® æŠ•è³‡å¯èƒ½é¡ç®—å‡º": {
      "main": [
        [
          {
            "node": "LOCKDOWN?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LOCKDOWN?": {
      "main": [
        [
          {
            "node": "ğŸš¨ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ’¾ ãƒã‚§ãƒƒã‚¯çµæœä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ãƒã‚§ãƒƒã‚¯çµæœä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ãƒã‚§ãƒƒã‚¯çµæœä¿å­˜": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n3-empire-os"
  },
  "pinData": {},
  "versionId": "v6-fin-06",
  "tags": [
    {
      "name": "æ ªå¼",
      "id": "fin"
    },
    {
      "name": "V6",
      "id": "v6"
    },
    {
      "name": "å®‰å…¨è£…ç½®",
      "id": "safety"
    }
  ]
}
