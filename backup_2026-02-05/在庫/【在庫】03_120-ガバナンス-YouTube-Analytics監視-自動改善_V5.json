{
  "name": "ã€åœ¨åº«ã€‘03_120-ã‚¬ãƒãƒŠãƒ³ã‚¹-YouTube-Analyticsç›£è¦–-è‡ªå‹•æ”¹å–„_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "cron",
      "name": "â° 6æ™‚é–“ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT channel_id FROM media_channels WHERE is_active = true AND youtube_channel_id IS NOT NULL LIMIT 100"
      },
      "id": "fetch-channels",
      "name": "ğŸ“¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’å‡¦ç†ç”¨ã«å¤‰æ›\nconst channels = $input.first().json || [];\nreturn channels.map(c => ({ json: c }));"
      },
      "id": "split-channels",
      "name": "ğŸ”€ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "batch-channels",
      "name": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT yt.access_token, yt.refresh_token, yt.expires_at, mc.youtube_channel_id FROM youtube_tokens yt JOIN media_channels mc ON yt.channel_id = mc.channel_id WHERE mc.channel_id = $1",
        "options": {
          "queryParams": "={{ [$json.channel_id] }}"
        }
      },
      "id": "fetch-token",
      "name": "ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥åˆ¤å®š\nconst tokenData = $input.first().json[0];\nif (!tokenData) return [{ json: { skip: true, reason: 'ãƒˆãƒ¼ã‚¯ãƒ³ãªã—' } }];\n\nconst expiresAt = new Date(tokenData.expires_at);\nconst now = new Date();\nconst needsRefresh = expiresAt <= now;\n\nreturn [{ json: { ...tokenData, needs_refresh: needsRefresh, channel_id: $node['ğŸ“¦ ãƒãƒƒãƒå‡¦ç†'].json.channel_id } }];"
      },
      "id": "check-token",
      "name": "ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://youtubeanalytics.googleapis.com/v2/reports",
        "authentication": "oAuth2Api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "ids",
              "value": "={{ 'channel==' + $json.youtube_channel_id }}"
            },
            {
              "name": "startDate",
              "value": "={{ new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] }}"
            },
            {
              "name": "endDate",
              "value": "={{ new Date().toISOString().split('T')[0] }}"
            },
            {
              "name": "metrics",
              "value": "views,estimatedMinutesWatched,averageViewDuration,averageViewPercentage,subscribersGained,subscribersLost"
            },
            {
              "name": "dimensions",
              "value": "video"
            },
            {
              "name": "sort",
              "value": "-views"
            },
            {
              "name": "maxResults",
              "value": "50"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-analytics",
      "name": "ğŸ“Š Analyticså–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "oAuth2Api": {
          "id": "youtube-oauth",
          "name": "YouTube OAuth"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Analyticsçµæœã‚’è§£æã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¤å®š\nconst channelId = $node['ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª'].json.channel_id;\nconst analyticsData = $input.first().json;\n\nif (!analyticsData.rows || analyticsData.rows.length === 0) {\n  return [{ json: { channel_id: channelId, videos: [], error: 'ãƒ‡ãƒ¼ã‚¿ãªã—' } }];\n}\n\nconst videos = analyticsData.rows.map(row => {\n  const [videoId, views, watchTime, avgDuration, avgPercentage, subsGained, subsLost] = row;\n  \n  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¤å®š\n  let tier = 'average';\n  if (avgPercentage >= 50 && views >= 1000) tier = 'excellent';\n  else if (avgPercentage >= 40 && views >= 500) tier = 'good';\n  else if (avgPercentage < 25 || views < 100) tier = 'poor';\n  if (avgPercentage < 15) tier = 'critical';\n  \n  // æ”¹å–„ææ¡ˆã®ç”Ÿæˆ\n  const suggestions = [];\n  if (avgPercentage < 30) suggestions.push({ type: 'hook', suggestion: 'å†’é ­5ç§’ã®ãƒ•ãƒƒã‚¯å¼·åŒ–' });\n  if (avgPercentage < 40) suggestions.push({ type: 'pacing', suggestion: 'ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—ã€é–“å»¶ã³ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤' });\n  if (views < 100) suggestions.push({ type: 'thumbnail', suggestion: 'ã‚µãƒ ãƒã‚¤ãƒ«æ”¹å–„ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿ï¼‰' });\n  if (subsLost > subsGained) suggestions.push({ type: 'content', suggestion: 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ–¹é‡ã®è¦‹ç›´ã—' });\n  \n  return {\n    video_id: videoId,\n    views: views,\n    watch_time_minutes: watchTime,\n    average_view_duration_seconds: avgDuration,\n    average_view_percentage: avgPercentage,\n    subscribers_gained: subsGained,\n    subscribers_lost: subsLost,\n    performance_tier: tier,\n    improvement_suggestions: suggestions\n  };\n});\n\n// critical/poorã®å‹•ç”»ã‚’å„ªå…ˆ\nconst criticalVideos = videos.filter(v => v.performance_tier === 'critical' || v.performance_tier === 'poor');\n\nreturn [{ json: { channel_id: channelId, videos: videos, critical_videos: criticalVideos, snapshot_date: new Date().toISOString().split('T')[0] } }];"
      },
      "id": "analyze-performance",
      "name": "ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "// DBä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™\nconst data = $input.first().json;\n\nreturn data.videos.map(v => ({\n  json: {\n    channel_id: data.channel_id,\n    video_id: v.video_id,\n    views: v.views,\n    watch_time_minutes: v.watch_time_minutes,\n    average_view_duration_seconds: v.average_view_duration_seconds,\n    average_view_percentage: v.average_view_percentage,\n    subscribers_gained: v.subscribers_gained,\n    subscribers_lost: v.subscribers_lost,\n    performance_tier: v.performance_tier,\n    improvement_suggestions: JSON.stringify(v.improvement_suggestions),\n    snapshot_date: data.snapshot_date\n  }\n}));"
      },
      "id": "prepare-save",
      "name": "ğŸ“¦ ä¿å­˜æº–å‚™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO youtube_analytics_snapshots (id, channel_id, video_id, views, watch_time_minutes, average_view_duration_seconds, average_view_percentage, subscribers_gained, subscribers_lost, performance_tier, improvement_suggestions, snapshot_date) VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) ON CONFLICT (channel_id, video_id, snapshot_date) DO UPDATE SET views = EXCLUDED.views, watch_time_minutes = EXCLUDED.watch_time_minutes, average_view_percentage = EXCLUDED.average_view_percentage, performance_tier = EXCLUDED.performance_tier, improvement_suggestions = EXCLUDED.improvement_suggestions, updated_at = NOW()",
        "options": {
          "queryParams": "={{ [$json.channel_id, $json.video_id, $json.views, $json.watch_time_minutes, $json.average_view_duration_seconds, $json.average_view_percentage, $json.subscribers_gained, $json.subscribers_lost, $json.performance_tier, $json.improvement_suggestions, $json.snapshot_date] }}"
        }
      },
      "id": "save-snapshot",
      "name": "ğŸ’¾ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-critical",
              "leftValue": "={{ $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.critical_videos.length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-critical",
      "name": "æ”¹å–„å¿…è¦ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "={{ process.env.N8N_WEBHOOK_URL || '{{$env.N8N_BASE_URL}}' }}/webhook/chatwork-notify",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ message: 'âš ï¸ YouTubeæ”¹å–„ã‚¢ãƒ©ãƒ¼ãƒˆ\\n\\nãƒãƒ£ãƒ³ãƒãƒ«: ' + $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.channel_id + '\\nè¦æ”¹å–„å‹•ç”»æ•°: ' + $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.critical_videos.length + 'æœ¬\\n\\n' + $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.critical_videos.slice(0, 3).map(v => 'ãƒ»' + v.video_id + ' (ç¶­æŒç‡' + v.average_view_percentage + '%)').join('\\n'), room_id: process.env.CHATWORK_ROOM_ID }) }}"
      },
      "id": "notify-critical",
      "name": "ğŸ“± æ”¹å–„ã‚¢ãƒ©ãƒ¼ãƒˆ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// è‡ªå‹•æ”¹å–„ãƒˆãƒªã‚¬ãƒ¼ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«å†ç”Ÿæˆã‚­ãƒ¥ãƒ¼ã¸æŠ•å…¥ï¼‰\nconst criticalVideos = $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.critical_videos || [];\n\nconst improvementTasks = criticalVideos.slice(0, 5).map(v => ({\n  video_id: v.video_id,\n  channel_id: $node['ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ'].json.channel_id,\n  improvement_type: v.improvement_suggestions[0]?.type || 'thumbnail',\n  current_metrics: {\n    views: v.views,\n    avg_percentage: v.average_view_percentage\n  }\n}));\n\nreturn improvementTasks.map(t => ({ json: t }));"
      },
      "id": "create-improvement-tasks",
      "name": "ğŸ”§ æ”¹å–„ã‚¿ã‚¹ã‚¯ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO improvement_queue (id, video_id, channel_id, improvement_type, current_metrics, status, created_at) VALUES (gen_random_uuid(), $1, $2, $3, $4, 'pending', NOW())",
        "options": {
          "queryParams": "={{ [$json.video_id, $json.channel_id, $json.improvement_type, JSON.stringify($json.current_metrics)] }}"
        }
      },
      "id": "queue-improvement",
      "name": "ğŸ“¥ æ”¹å–„ã‚­ãƒ¥ãƒ¼æŠ•å…¥",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 6æ™‚é–“ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ğŸ“¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ”€ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†": {
      "main": [
        [
          {
            "node": "ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª": {
      "main": [
        [
          {
            "node": "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š Analyticså–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Analyticså–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ä¿å­˜æº–å‚™",
            "type": "main",
            "index": 0
          },
          {
            "node": "æ”¹å–„å¿…è¦ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ ä¿å­˜æº–å‚™": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ãƒãƒƒãƒå‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ”¹å–„å¿…è¦ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ“± æ”¹å–„ã‚¢ãƒ©ãƒ¼ãƒˆ",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ğŸ“± æ”¹å–„ã‚¢ãƒ©ãƒ¼ãƒˆ": {
      "main": [
        [
          {
            "node": "ğŸ”§ æ”¹å–„ã‚¿ã‚¹ã‚¯ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ æ”¹å–„ã‚¿ã‚¹ã‚¯ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ğŸ“¥ æ”¹å–„ã‚­ãƒ¥ãƒ¼æŠ•å…¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ æ”¹å–„ã‚­ãƒ¥ãƒ¼æŠ•å…¥": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ã‚¬ãƒãƒŠãƒ³ã‚¹"
    },
    {
      "name": "V5"
    },
    {
      "name": "YouTube"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ]
}