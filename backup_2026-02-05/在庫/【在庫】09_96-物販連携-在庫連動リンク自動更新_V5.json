{
  "name": "ã€åœ¨åº«ã€‘09_96-ç‰©è²©é€£æº-åœ¨åº«é€£å‹•ãƒªãƒ³ã‚¯è‡ªå‹•æ›´æ–°_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "schedule",
      "name": "â° 15åˆ†ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stock-link-sync",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: stock-link-sync",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "stock-link-sync"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json || {};\nreturn [{ json: { product_id: body.product_id, action: body.action || 'sync_all', timestamp: new Date().toISOString() } }];"
      },
      "id": "init",
      "name": "ðŸ”§ åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT dlr.*, im.quantity as current_stock, im.price as current_price, im.status as product_status FROM dynamic_link_registry dlr LEFT JOIN inventory_master im ON dlr.product_id = im.id WHERE dlr.auto_update_enabled = TRUE AND dlr.link_status = 'active' AND ($1 IS NULL OR dlr.product_id = $1) LIMIT 100",
        "options": {
          "queryParams": "={{ [$json.product_id] }}"
        }
      },
      "id": "get-active-links",
      "name": "ðŸ”— ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªãƒ³ã‚¯å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const links = $input.first().json || [];\nconst linkList = Array.isArray(links) ? links : [links].filter(l => l && l.id);\n\nconst updates = [];\nconst notifications = [];\n\nfor (const link of linkList) {\n  const currentStock = link.current_stock || 0;\n  const threshold = link.stock_threshold || 0;\n  const needsUpdate = currentStock <= threshold && link.link_status === 'active';\n  \n  if (needsUpdate) {\n    const newUrl = link.fallback_url || link.original_url + '?oos=1';\n    updates.push({\n      link_id: link.id,\n      product_id: link.product_id,\n      platform: link.platform,\n      old_url: link.current_url,\n      new_url: newUrl,\n      new_status: 'stock_out',\n      reason: `åœ¨åº« ${currentStock} â‰¤ é–¾å€¤ ${threshold}`\n    });\n    notifications.push(`å•†å“ID ${link.product_id}: åœ¨åº«åˆ‡ã‚Œã®ãŸã‚ãƒªãƒ³ã‚¯æ›´æ–°`);\n  }\n}\n\nreturn [{ json: { total_checked: linkList.length, updates_needed: updates.length, updates, notifications } }];"
      },
      "id": "check-stock",
      "name": "ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.updates_needed }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        }
      },
      "id": "check-updates",
      "name": "æ›´æ–°ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const data = $node['ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯'].json;\nreturn data.updates.map(u => ({ json: u }));"
      },
      "id": "split-updates",
      "name": "ðŸ“‹ æ›´æ–°åˆ†å‰²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE dynamic_link_registry SET current_url = $2, link_status = $3, stock_quantity = (SELECT quantity FROM inventory_master WHERE id = product_id), last_stock_check = NOW(), updated_at = NOW() WHERE id = $1 RETURNING id",
        "options": {
          "queryParams": "={{ [$json.link_id, $json.new_url, $json.new_status] }}"
        }
      },
      "id": "update-link",
      "name": "ðŸ’¾ ãƒªãƒ³ã‚¯æ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO link_update_history (link_id, previous_url, new_url, update_reason, triggered_by) VALUES ($1, $2, $3, $4, 'system')",
        "options": {
          "queryParams": "={{ [$json.link_id, $json.old_url, $json.new_url, $json.reason] }}"
        }
      },
      "id": "log-update",
      "name": "ðŸ“ å±¥æ­´è¨˜éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $env.CHATWORK_WEBHOOK_URL || 'https://api.chatwork.com/v2/rooms/' + $env.CHATWORK_ROOM_ID + '/messages' }}",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "ðŸ“¦ ã€åœ¨åº«é€£å‹•ãƒªãƒ³ã‚¯æ›´æ–°ã€‘\n\n{{ $node['ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯'].json.notifications.join('\\n') }}\n\næ›´æ–°æ•°: {{ $node['ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯'].json.updates_needed }}ä»¶"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify",
      "name": "ðŸ“¢ é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const data = $node['ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯'].json;\nreturn [{ json: { success: true, action: 'stock_link_sync', total_checked: data.total_checked, updates_applied: data.updates_needed, message: data.updates_needed > 0 ? `${data.updates_needed}ä»¶ã®ãƒªãƒ³ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ` : 'æ›´æ–°å¯¾è±¡ãªã—' } }];"
      },
      "id": "format-response",
      "name": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 15åˆ†ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ðŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: stock-link-sync": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ðŸ”— ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªãƒ³ã‚¯å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”— ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªãƒ³ã‚¯å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "æ›´æ–°ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ æ›´æ–°åˆ†å‰²",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ æ›´æ–°åˆ†å‰²": {
      "main": [
        [
          {
            "node": "ðŸ’¾ ãƒªãƒ³ã‚¯æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ ãƒªãƒ³ã‚¯æ›´æ–°": {
      "main": [
        [
          {
            "node": "ðŸ“ å±¥æ­´è¨˜éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ å±¥æ­´è¨˜éŒ²": {
      "main": [
        [
          {
            "node": "ðŸ“¢ é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¢ é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 180
  },
  "tags": [
    {
      "name": "N3-Sync",
      "color": "#2ecc71"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Stock",
      "color": "#e67e22"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}