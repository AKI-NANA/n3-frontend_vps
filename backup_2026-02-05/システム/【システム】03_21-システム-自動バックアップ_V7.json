{
  "name": "ã€ã‚·ã‚¹ãƒ†ãƒ ã€‘03_21-ã‚·ã‚¹ãƒ†ãƒ -è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_V7",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 4 * * 0"
            }
          ]
        }
      },
      "id": "schedule",
      "name": "æ¯é€±æ—¥æ›œAM4æ™‚",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "backup-trigger",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: backup-trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "backup-trigger"
    },
    {
      "parameters": {
        "jsCode": "// V7å•†ç”¨åŸºæº–: ãƒ†ãƒŠãƒ³ãƒˆéš”é›¢ + Secret Vaultå‚ç…§\nconst headers = $input.first().json.headers || {};\nconst body = $input.first().json.body || $input.first().json || {};\n\n// ç½²åæ¤œè¨¼ï¼ˆSecret Vaultå‚ç…§ï¼‰\nconst signature = headers['x-n3-signature'] || headers['X-N3-Signature'] || '';\nconst timestamp = headers['x-n3-timestamp'] || headers['X-N3-Timestamp'] || '';\n\nif (signature && timestamp) {\n  const ts = parseInt(timestamp, 10);\n  const now = Math.floor(Date.now() / 1000);\n  if (Math.abs(now - ts) > 300) {\n    return [{ json: { error: true, message: 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœŸé™åˆ‡ã‚Œ', code: 'TIMESTAMP_EXPIRED' } }];\n  }\n  \n  // VaultçµŒç”±ã§æ¤œè¨¼\n  try {\n    const vaultUrl = $env.SECRET_VAULT_URL || 'http://localhost:8080';\n    const vaultResponse = await fetch(`${vaultUrl}/decrypt`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'X-Vault-Token': $env.VAULT_TOKEN || '' },\n      body: JSON.stringify({ ref_id: 'hmac-secret-001', payload: JSON.stringify(body), signature, timestamp })\n    });\n    if (vaultResponse.ok) {\n      const result = await vaultResponse.json();\n      if (!result.valid) {\n        return [{ json: { error: true, message: 'ç½²åæ¤œè¨¼å¤±æ•—', code: 'INVALID_SIGNATURE' } }];\n      }\n    }\n  } catch (e) {\n    console.log('Vaultæ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ—: ' + e.message);\n  }\n}\n\n// ãƒ†ãƒŠãƒ³ãƒˆIDæŠ½å‡ºï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ or å˜ä¸€ãƒ†ãƒŠãƒ³ãƒˆï¼‰\nconst tenantId = body.tenant_id || headers['x-tenant-id'] || headers['X-Tenant-Id'] || $env.DEFAULT_TENANT_ID || 'all';\n\nconst now = new Date();\nconst timestamp_str = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);\nconst backupName = `n3-backup-${tenantId}-${timestamp_str}`;\n\nreturn [{ json: { \n  tenant_id: tenantId,\n  backup_name: backupName, \n  timestamp: now.toISOString(), \n  tables: ['products_master', 'inventory_master', 'orders_unified', 'research_results', 'admin_tasks', 'global_settings', 'logistics_providers', 'performance_snapshots'],\n  request_id: `bkp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\n} }];"
      },
      "id": "init",
      "name": "ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7_COMMERCIAL] ãƒ†ãƒŠãƒ³ãƒˆéš”é›¢ + Secret Vaultå‚ç…§"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT table_name, pg_size_pretty(pg_total_relation_size(quote_ident(table_name))) as size, (SELECT count(*) FROM information_schema.columns WHERE table_name = t.table_name) as columns FROM information_schema.tables t WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY pg_total_relation_size(quote_ident(table_name)) DESC LIMIT 20",
        "options": {}
      },
      "id": "get-table-stats",
      "name": "ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as products_count FROM products_master WHERE ($1 = 'all' OR tenant_id = $1)",
        "options": {
          "queryParams": "={{ [$node['ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)'].json.tenant_id] }}"
        }
      },
      "id": "count-products",
      "name": "ğŸ“¦ å•†å“æ•°ã‚«ã‚¦ãƒ³ãƒˆ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "notes": "[V7] ãƒ†ãƒŠãƒ³ãƒˆéš”é›¢å¯¾å¿œ"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as orders_count FROM orders_unified WHERE ($1 = 'all' OR tenant_id = $1)",
        "options": {
          "queryParams": "={{ [$node['ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)'].json.tenant_id] }}"
        }
      },
      "id": "count-orders",
      "name": "ğŸ›’ å—æ³¨æ•°ã‚«ã‚¦ãƒ³ãƒˆ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "notes": "[V7] ãƒ†ãƒŠãƒ³ãƒˆéš”é›¢å¯¾å¿œ"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT backup_name, status, record_counts, created_at FROM backup_history WHERE ($1 = 'all' OR tenant_id = $1) ORDER BY created_at DESC LIMIT 10",
        "options": {
          "queryParams": "={{ [$node['ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)'].json.tenant_id] }}"
        }
      },
      "id": "get-backup-history",
      "name": "ğŸ“œ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "[V7] å±¥æ­´ã‚¿ãƒ–ç”¨ãƒ‡ãƒ¼ã‚¿"
    },
    {
      "parameters": {
        "jsCode": "const config = $node['ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)'].json;\nconst tableStats = $node['ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆå–å¾—'].json;\nconst productsCount = $node['ğŸ“¦ å•†å“æ•°ã‚«ã‚¦ãƒ³ãƒˆ'].json?.products_count || 0;\nconst ordersCount = $node['ğŸ›’ å—æ³¨æ•°ã‚«ã‚¦ãƒ³ãƒˆ'].json?.orders_count || 0;\nconst backupHistory = $node['ğŸ“œ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´å–å¾—'].json;\n\nconst backupSummary = {\n  tenant_id: config.tenant_id,\n  backup_name: config.backup_name,\n  timestamp: config.timestamp,\n  request_id: config.request_id,\n  stats: {\n    products: parseInt(productsCount),\n    orders: parseInt(ordersCount),\n    tables: Array.isArray(tableStats) ? tableStats.length : 1\n  },\n  table_details: tableStats,\n  history: Array.isArray(backupHistory) ? backupHistory : (backupHistory?.backup_name ? [backupHistory] : [])\n};\n\nreturn [{ json: backupSummary }];"
      },
      "id": "compile-stats",
      "name": "ğŸ“‹ çµ±è¨ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7] å±¥æ­´ãƒ‡ãƒ¼ã‚¿çµ±åˆ"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO backup_history (tenant_id, backup_name, status, record_counts, table_details, created_at) VALUES ($1, $2, 'completed', $3::jsonb, $4::jsonb, NOW()) RETURNING id",
        "options": {
          "queryParams": "={{ [$json.tenant_id, $json.backup_name, JSON.stringify($json.stats), JSON.stringify($json.table_details || [])] }}"
        }
      },
      "id": "save-backup-history",
      "name": "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "[V7] ãƒ†ãƒŠãƒ³ãƒˆåˆ¥å±¥æ­´"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO performance_snapshots (tenant_id, snapshot_date, sales_data, inventory_data, tasks_data, listings_data) VALUES ($1, CURRENT_DATE, $2::jsonb, '{}'::jsonb, '{}'::jsonb, '{}'::jsonb) ON CONFLICT (tenant_id, snapshot_date) DO UPDATE SET sales_data = EXCLUDED.sales_data, updated_at = NOW()",
        "options": {
          "queryParams": "={{ [$json.tenant_id, JSON.stringify({ backup_info: { backup_name: $json.backup_name, stats: $json.stats } })] }}"
        }
      },
      "id": "log-backup",
      "name": "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true,
      "notes": "[V7] ãƒ†ãƒŠãƒ³ãƒˆéš”é›¢"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CHATWORK_API_URL || 'https://api.chatwork.com' }}/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ğŸ’¾ é€±æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†[/title]ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å: {{ $json.backup_name }}\\nãƒ†ãƒŠãƒ³ãƒˆ: {{ $json.tenant_id }}\\n\\nã€çµ±è¨ˆã€‘\\nå•†å“æ•°: {{ $json.stats.products }}ä»¶\\nå—æ³¨æ•°: {{ $json.stats.orders }}ä»¶\\nãƒ†ãƒ¼ãƒ–ãƒ«æ•°: {{ $json.stats.tables }}\\n\\nâ€»Supabaseè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨é€£æº[/info]"
            }
          ]
        }
      },
      "id": "notify",
      "name": "ğŸ“¢ å®Œäº†é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const backup = $input.first().json;\n\n// V7: UI Config for DynamicRendererï¼ˆå±¥æ­´ã‚¿ãƒ–ä»˜ãï¼‰\nconst uiConfig = {\n  renderer: 'DynamicRenderer',\n  layout: 'tabs',\n  tabs: [\n    {\n      id: 'status',\n      label: 'ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',\n      icon: 'CheckCircle',\n      components: [\n        {\n          type: 'StatusCard',\n          props: {\n            title: 'æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',\n            status: 'success',\n            value: backup.backup_name,\n            timestamp: backup.timestamp\n          }\n        },\n        {\n          type: 'StatCard',\n          props: {\n            title: 'å•†å“æ•°',\n            value: backup.stats.products,\n            suffix: 'ä»¶'\n          }\n        },\n        {\n          type: 'StatCard',\n          props: {\n            title: 'å—æ³¨æ•°',\n            value: backup.stats.orders,\n            suffix: 'ä»¶'\n          }\n        },\n        {\n          type: 'StatCard',\n          props: {\n            title: 'ãƒ†ãƒ¼ãƒ–ãƒ«æ•°',\n            value: backup.stats.tables,\n            suffix: 'å€‹'\n          }\n        }\n      ]\n    },\n    {\n      id: 'history',\n      label: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´',\n      icon: 'History',\n      components: [\n        {\n          type: 'DataTable',\n          props: {\n            columns: [\n              { key: 'backup_name', label: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å' },\n              { key: 'status', label: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹' },\n              { key: 'created_at', label: 'å®Ÿè¡Œæ—¥æ™‚', format: 'datetime' }\n            ],\n            data: backup.history || [],\n            emptyMessage: 'å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“'\n          }\n        }\n      ]\n    },\n    {\n      id: 'tables',\n      label: 'ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°',\n      icon: 'Database',\n      components: [\n        {\n          type: 'DataTable',\n          props: {\n            columns: [\n              { key: 'table_name', label: 'ãƒ†ãƒ¼ãƒ–ãƒ«å' },\n              { key: 'size', label: 'ã‚µã‚¤ã‚º' },\n              { key: 'columns', label: 'ã‚«ãƒ©ãƒ æ•°' }\n            ],\n            data: Array.isArray(backup.table_details) ? backup.table_details : [backup.table_details].filter(Boolean)\n          }\n        }\n      ]\n    }\n  ]\n};\n\nreturn [{ json: { \n  success: true, \n  tenant_id: backup.tenant_id,\n  backup: {\n    name: backup.backup_name,\n    timestamp: backup.timestamp,\n    stats: backup.stats\n  },\n  ui_config: uiConfig\n} }];"
      },
      "id": "prepare-response",
      "name": "ğŸ“¤ V7ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (UI Configä»˜)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7_COMMERCIAL] å±¥æ­´ã‚¿ãƒ– + DynamicRenderer"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    }
  ],
  "connections": {
    "æ¯é€±æ—¥æ›œAM4æ™‚": {
      "main": [
        [
          {
            "node": "ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: backup-trigger": {
      "main": [
        [
          {
            "node": "ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” V7åˆæœŸåŒ– (ãƒ†ãƒŠãƒ³ãƒˆ+Vault)": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆå–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“¦ å•†å“æ•°ã‚«ã‚¦ãƒ³ãƒˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ å•†å“æ•°ã‚«ã‚¦ãƒ³ãƒˆ": {
      "main": [
        [
          {
            "node": "ğŸ›’ å—æ³¨æ•°ã‚«ã‚¦ãƒ³ãƒˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ å—æ³¨æ•°ã‚«ã‚¦ãƒ³ãƒˆ": {
      "main": [
        [
          {
            "node": "ğŸ“œ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“œ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“‹ çµ±è¨ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ çµ±è¨ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ä¿å­˜": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚°": {
      "main": [
        [
          {
            "node": "ğŸ“¢ å®Œäº†é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¢ å®Œäº†é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“¤ V7ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (UI Configä»˜)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ V7ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (UI Configä»˜)": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-System",
      "color": "#2e8b57"
    },
    {
      "name": "V7-COMMERCIAL",
      "color": "#ff6b00"
    },
    {
      "name": "Backup",
      "color": "#4682b4"
    },
    {
      "name": "TENANT-ISOLATED",
      "color": "#8b0000"
    },
    {
      "name": "UI-CONFIG",
      "color": "#00ced1"
    },
    {
      "name": "HISTORY-TAB",
      "color": "#9370db"
    }
  ],
  "active": false,
  "_v7_commercial": true,
  "_v7_version": "7.0.0",
  "_v7_features": ["tenant_isolation", "secret_vault_ref", "ui_config", "history_tab"],
  "_v7_timestamp": "2026-01-23T00:00:00.000Z"
}
