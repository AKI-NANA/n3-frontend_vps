{
  "name": "„ÄêÊâøË™ç„Äë01_05-ÊâøË™ç-ÂïÜÂìÅÊâøË™çÂá¶ÁêÜ_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "approve-batch",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: ÊâøË™ç‰æùÈ†º",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "approve-batch"
    },
    {
      "parameters": {
        "jsCode": "// V5-PRODUCTION: ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥Ê§úË®ºÔºàcrypto‰æùÂ≠òÊéíÈô§ÁâàÔºâ\n// ========================================\nconst body = $input.first().json.body || $input.first().json;\nconst headers = $input.first().json.headers || {};\n\n// Áí∞Â¢ÉÂ§âÊï∞ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ\nconst apiUrl = $env.N3_API_URL;\nconst secret = $env.N8N_INTERNAL_SECRET;\nif (!apiUrl) {\n  return [{ json: { error: true, message: 'N3_API_URL Áí∞Â¢ÉÂ§âÊï∞„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', code: 'CONFIG_ERROR' } }];\n}\nif (!secret) {\n  return [{ json: { error: true, message: 'N8N_INTERNAL_SECRET Áí∞Â¢ÉÂ§âÊï∞„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', code: 'CONFIG_ERROR' } }];\n}\n\nconst internalToken = headers['x-n3-signature'] || headers['X-N3-Signature'];\nconst tokenTimestamp = headers['x-n3-token-timestamp'] || headers['X-N3-Token-Timestamp'];\nconst userId = body.user_id || 'default';\n\n// „Éà„Éº„ÇØ„É≥Ê§úË®ºÔºàÂ§ñÈÉ®API„Å∏ÂßîË≠≤Ôºâ\nif (internalToken && tokenTimestamp) {\n  try {\n    const verifyResponse = await fetch(`${apiUrl}/api/n8n-auth/verify-internal-token`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ userId, timestamp: tokenTimestamp, token: internalToken })\n    });\n    const verifyResult = await verifyResponse.json();\n    \n    if (!verifyResult.valid) {\n      return [{ json: { error: true, message: 'ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥„ÅåÁÑ°Âäπ„Åß„Åô', code: 'INVALID_TOKEN' } }];\n    }\n  } catch (e) {\n    return [{ json: { error: true, message: '„Éà„Éº„ÇØ„É≥Ê§úË®ºAPI„Ç®„É©„Éº: ' + e.message, code: 'VERIFY_API_ERROR' } }];\n  }\n}\n\n// ÂÖ•ÂäõÊ§úË®º\nconst productId = body.product_id;\nconst marketplace = body.marketplace || 'ebay_us';\nconst limit = body.limit || 10;\nconst force = body.force || false;\n\nreturn [{ json: { \n  product_id: productId, \n  marketplace: marketplace, \n  user_id: userId,\n  limit: limit,\n  force: force,\n  request_timestamp: new Date().toISOString()\n} }];"
      },
      "id": "validate",
      "name": "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-error",
      "name": "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "respond-error",
      "name": "„Ç®„É©„ÉºÂøúÁ≠î",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT p.id, p.sku, p.english_title, p.title, p.ddp_price_usd, p.price_usd, p.shipping_cost_usd, p.profit_usd, p.profit_margin, p.profit_jpy, p.hts_code, p.origin_country, p.weight_g, p.ai_confidence_score, p.workflow_status, p.user_id, p.updated_at FROM products_master p WHERE p.workflow_status = 'ready' AND p.user_id = $1 AND p.profit_margin >= $2 AND p.ai_confidence_score >= 80 ORDER BY p.profit_margin DESC, p.ai_confidence_score DESC LIMIT $3",
        "options": {
          "queryParams": "={{ [$json.user_id, $json.min_margin, $json.limit] }}"
        }
      },
      "id": "get-ready",
      "name": "ÊâøË™çÂæÖ„Å°ÂèñÂæóÔºàuser_idÊ§úË®ºÔºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ Array.isArray($json) ? $json.length : ($json.id ? 1 : 0) }}",
              "operation": "equal",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-empty",
      "name": "ÂØæË±°ÊúâÁÑ°",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, approved: 0, rejected: 0, message: 'ÊâøË™çÂæÖ„Å°ÂïÜÂìÅ„Å™„Åó' } }];"
      },
      "id": "no-items",
      "name": "ÂØæË±°„Å™„Åó",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// V4-PRODUCTION: ÊâøË™çÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºà5%„Ç¨„Éº„Éâ„É¨„Éº„É´Ôºâ\nconst products = $input.first().json;\nconst productArr = Array.isArray(products) ? products : [products];\nconst config = $node['„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º'].json;\n\nconst MIN_MARGIN = config.min_margin || 5;\nconst MIN_MARGIN_TARIFF = 10; // Èñ¢Á®é„ÅÇ„ÇäÂïÜÂìÅ„ÅØ10%ÂøÖÈ†à\n\nreturn productArr.filter(p => p.id).map(p => {\n  const profitMargin = p.profit_margin || 0;\n  const hasTariff = p.origin_country === 'CN' || (p.hts_code && !p.hts_code.startsWith('9504'));\n  const requiredMargin = hasTariff ? MIN_MARGIN_TARIFF : MIN_MARGIN;\n  \n  let decision = 'approved', reason = '';\n  \n  // Ëµ§Â≠ó„ÉÅ„Çß„ÉÉ„ÇØ\n  if (p.profit_usd < 0) { decision = 'rejected'; reason = 'Ëµ§Â≠óÂïÜÂìÅ: $' + p.profit_usd; }\n  // Âà©ÁõäÁéá„ÉÅ„Çß„ÉÉ„ÇØ\n  else if (profitMargin < requiredMargin) { decision = 'rejected'; reason = 'Âà©ÁõäÁéá‰∏çË∂≥: ' + profitMargin.toFixed(1) + '% < ' + requiredMargin + '%'; }\n  // ‰ø°È†ºÂ∫¶„ÉÅ„Çß„ÉÉ„ÇØ\n  else if ((p.ai_confidence_score || 0) < 80) { decision = 'rejected'; reason = '‰ø°È†ºÂ∫¶‰∏çË∂≥: ' + (p.ai_confidence_score || 0) + 'ÁÇπ'; }\n  // HTS„Ç≥„Éº„ÉâÊú™Ë®≠ÂÆö\n  else if (!p.hts_code) { decision = 'rejected'; reason = 'HTS„Ç≥„Éº„ÉâÊú™Ë®≠ÂÆö'; }\n  // ÈáçÈáèÊú™Ë®≠ÂÆö\n  else if (!p.weight_g || p.weight_g < 1) { decision = 'rejected'; reason = 'ÈáçÈáèÊú™Ë®≠ÂÆö'; }\n  // ‰æ°Ê†ºÁï∞Â∏∏\n  else if ((p.ddp_price_usd || p.price_usd || 0) < 10) { decision = 'rejected'; reason = '‰æ°Ê†º„Åå‰Ωé„Åô„Åé„Çã: $' + (p.ddp_price_usd || p.price_usd); }\n  \n  return { json: {\n    user_id: p.user_id, product_id: p.id, sku: p.sku, updated_at: p.updated_at,\n    title: (p.english_title || p.title || '').substring(0, 80),\n    price_usd: p.ddp_price_usd || p.price_usd, profit_margin: profitMargin,\n    confidence: p.ai_confidence_score || 0,\n    decision, reason,\n    new_status: decision === 'approved' ? 'approved' : 'review'\n  } };\n});"
      },
      "id": "approve-logic",
      "name": "ÊâøË™çÂà§ÂÆöÔºà5%„Ç¨„Éº„Éâ„É¨„Éº„É´Ôºâ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "id": "batch",
      "name": "10‰ª∂„Åö„Å§Âá¶ÁêÜ",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE products_master SET workflow_status = $1, approved_at = $2, approval_reason = $3, updated_at = NOW() WHERE id = $4 AND user_id = $5 AND updated_at = $6 RETURNING id, sku, workflow_status",
        "options": {
          "queryParams": "={{ [$json.new_status, $json.decision === 'approved' ? 'NOW()' : null, ($json.reason || 'Ëá™ÂãïÊâøË™ç').replace(/'/g, \"''\").substring(0, 200), $json.product_id, $json.user_id, $json.updated_at] }}"
        }
      },
      "id": "update-status",
      "name": "„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\nconst approved = results.filter(r => r.workflow_status === 'approved').length;\nconst rejected = results.filter(r => r.workflow_status === 'review').length;\nreturn [{ json: { success: true, approved, rejected, total: results.length, ts: new Date().toISOString() } }];"
      },
      "id": "aggregate",
      "name": "ÁµêÊûúÈõÜÁ¥Ñ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM approval_logs WHERE created_at < NOW() - INTERVAL '30 days'",
        "options": {}
      },
      "id": "purge",
      "name": "üóëÔ∏è Â±•Ê≠¥„Éë„Éº„Ç∏Ôºà30Êó•Ôºâ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.approved }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-notify",
      "name": "ÊâøË™ç„ÅÇ„ÇäÔºü",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]‚úÖ N3-05 V4 ÊâøË™çÂá¶ÁêÜÂÆå‰∫Ü[/title]‚úÖÊâøË™ç: {{ $node['ÁµêÊûúÈõÜÁ¥Ñ'].json.approved }}‰ª∂\\n‚ùåÂç¥‰∏ã: {{ $node['ÁµêÊûúÈõÜÁ¥Ñ'].json.rejected }}‰ª∂[/info]"
            }
          ]
        }
      },
      "id": "notify",
      "name": "ChatWorkÈÄöÁü•",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($node['ÁµêÊûúÈõÜÁ¥Ñ'].json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond",
      "name": "ÂøúÁ≠î",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// üîê HMAC SHA256 ÁΩ≤ÂêçÊ§úË®º (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('üö´ N8N_HMAC_SECRET Áí∞Â¢ÉÂ§âÊï∞„ÅåÊú™Ë®≠ÂÆö„Åß„Åô');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('üö´ ÁΩ≤Âêç„Åæ„Åü„ÅØ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅåÊ¨†ËêΩ„Åó„Å¶„ÅÑ„Åæ„Åô');\n}\n\n// „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊúâÂäπÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØ (5ÂàÜ)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('üö´ „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅåÊúüÈôêÂàá„Çå„Åæ„Åü„ÅØ‰∏çÊ≠£„Åß„Åô');\n}\n\n// HMACÊ§úË®º\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('üö´ HMACÁΩ≤ÂêçÊ§úË®ºÂ§±Êïó: ‰∏çÊ≠£„Å™„É™„ÇØ„Ç®„Çπ„Éà');\n}\n\n// Ê§úË®ºÊàêÂäü - ÂÖÉ„Éá„Éº„Çø„Çí„Åù„ÅÆ„Åæ„ÅæËøî„Åô\nreturn [{ json: $json }];"
      },
      "name": "üîê HMACÁΩ≤ÂêçÊ§úË®º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âà∂ÊåøÂÖ•"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "üìä ÂÆüË°å„É≠„Ç∞ÈÄÅ‰ø° (ÊàêÂäü)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ‰∏≠Â§ÆÁõ£Ë¶ñ„Éë„É´„Çπ"
    }
  ],
  "connections": {
    "Webhook: ÊâøË™ç‰æùÈ†º": {
      "main": [
        [
          {
            "node": "üîê HMACÁΩ≤ÂêçÊ§úË®º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º": {
      "main": [
        [
          {
            "node": "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ": {
      "main": [
        [
          {
            "node": "„Ç®„É©„ÉºÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÊâøË™çÂæÖ„Å°ÂèñÂæóÔºàuser_idÊ§úË®ºÔºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÊâøË™çÂæÖ„Å°ÂèñÂæóÔºàuser_idÊ§úË®ºÔºâ": {
      "main": [
        [
          {
            "node": "ÂØæË±°ÊúâÁÑ°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÂØæË±°ÊúâÁÑ°": {
      "main": [
        [
          {
            "node": "ÂØæË±°„Å™„Åó",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÊâøË™çÂà§ÂÆöÔºà5%„Ç¨„Éº„Éâ„É¨„Éº„É´Ôºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÂØæË±°„Å™„Åó": {
      "main": [
        [
          {
            "node": "ÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÊâøË™çÂà§ÂÆöÔºà5%„Ç¨„Éº„Éâ„É¨„Éº„É´Ôºâ": {
      "main": [
        [
          {
            "node": "10‰ª∂„Åö„Å§Âá¶ÁêÜ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10‰ª∂„Åö„Å§Âá¶ÁêÜ": {
      "main": [
        [
          {
            "node": "„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÁµêÊûúÈõÜÁ¥Ñ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÔºàÊ•ΩË¶≥ÁöÑ„É≠„ÉÉ„ÇØÔºâ": {
      "main": [
        [
          {
            "node": "10‰ª∂„Åö„Å§Âá¶ÁêÜ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÁµêÊûúÈõÜÁ¥Ñ": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Â±•Ê≠¥„Éë„Éº„Ç∏Ôºà30Êó•Ôºâ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Â±•Ê≠¥„Éë„Éº„Ç∏Ôºà30Êó•Ôºâ": {
      "main": [
        [
          {
            "node": "ÊâøË™ç„ÅÇ„ÇäÔºü",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÊâøË™ç„ÅÇ„ÇäÔºü": {
      "main": [
        [
          {
            "node": "ChatWorkÈÄöÁü•",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatWorkÈÄöÁü•": {
      "main": [
        [
          {
            "node": "ÂøúÁ≠î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê HMACÁΩ≤ÂêçÊ§úË®º": {
      "main": [
        [
          {
            "node": "„É™„ÇØ„Ç®„Çπ„ÉàÊ§úË®º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-Approve",
      "color": "#228b22"
    },
    {
      "name": "V4-PRODUCTION",
      "color": "#ff0000"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "Internal-Auth",
      "color": "#dc143c"
    },
    {
      "name": "500MB-Safe",
      "color": "#32cd32"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}