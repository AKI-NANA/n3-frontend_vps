{
  "name": "ã€å‡ºå“ã€‘07_29-eBayå‡ºå“-ebay-listing_V7",
  "description": "N3 Empire OS V7-27DIM: eBayå‡ºå“å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ27æ¬¡å…ƒé˜²è¡›å®Œå…¨å¯¾å¿œï¼‰",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "v821-ebay-listing",
        "options": {"responseMode": "responseNode"}
      },
      "id": "webhook-v821",
      "name": "Webhook: ebay-listing",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "v821-ebay-listing"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ” V7-27æ¬¡å…ƒé˜²è¡›: JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ + HMACç½²åæ¤œè¨¼\n// æ¬¡å…ƒ3: Auth-Gateãƒã‚¤ãƒ‘ã‚¹æ’é™¤\n// ========================================\n\nconst crypto = require('crypto');\nconst headers = $input.first().json.headers || {};\nconst body = $input.first().json.body || $input.first().json;\n\n// JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼\nconst jitToken = headers['x-n3-jit-token'] || headers['X-N3-JIT-Token'];\nconst tokenExpiry = headers['x-n3-token-expiry'] || headers['X-N3-Token-Expiry'];\n\nif (jitToken && tokenExpiry) {\n  const expiryTs = parseInt(tokenExpiry, 10);\n  const now = Math.floor(Date.now() / 1000);\n  \n  if (now > expiryTs) {\n    return [{ json: { error: true, message: 'JITãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ', code: 'JIT_TOKEN_EXPIRED' } }];\n  }\n  \n  // JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼APIå‘¼ã³å‡ºã—\n  const apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n  try {\n    const verifyResponse = await fetch(`${apiUrl}/api/n8n-auth/verify-jit-token`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ token: jitToken, expiry: tokenExpiry })\n    });\n    const verifyResult = await verifyResponse.json();\n    if (!verifyResult.valid) {\n      return [{ json: { error: true, message: 'JITãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹: ' + (verifyResult.error || ''), code: 'INVALID_JIT_TOKEN' } }];\n    }\n  } catch (e) {\n    console.log('JITãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰: ' + e.message);\n  }\n}\n\n// HMAC SHA256ç½²åæ¤œè¨¼ï¼ˆæ¬¡å…ƒ3å®Œå…¨å®Ÿè£…ï¼‰\nconst signature = headers['x-n3-signature'] || headers['X-N3-Signature'] || '';\nconst timestamp = headers['x-n3-timestamp'] || headers['X-N3-Timestamp'] || '';\n\nif (signature && timestamp) {\n  const secret = $env.N3_HMAC_SECRET || $env.N8N_HMAC_SECRET;\n  if (!secret) {\n    return [{ json: { error: true, message: 'HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š', code: 'CONFIG_ERROR' } }];\n  }\n  \n  const ts = parseInt(timestamp, 10);\n  const now = Date.now();\n  // 5åˆ†ä»¥å†…ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿è¨±å¯\n  if (Math.abs(now - ts) > 300000) {\n    return [{ json: { error: true, message: 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœŸé™åˆ‡ã‚Œï¼ˆ5åˆ†è¶…éï¼‰', code: 'TIMESTAMP_EXPIRED' } }];\n  }\n  \n  // HMAC SHA256è¨ˆç®—\n  const computedHmac = crypto.createHmac('sha256', secret)\n    .update(timestamp + '.' + JSON.stringify(body))\n    .digest('hex');\n  \n  if (signature !== computedHmac) {\n    return [{ json: { error: true, message: 'HMACç½²åæ¤œè¨¼å¤±æ•—', code: 'INVALID_SIGNATURE' } }];\n  }\n}\n\nreturn [{ json: { ...body, _auth_verified: true, _auth_method: 'jit_hmac', _auth_timestamp: new Date().toISOString() } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "jit_hmac_verify_v7",
      "name": "ğŸ” JIT+HMACæ¤œè¨¼ (æ¬¡å…ƒ3)",
      "notes": "[V7-27DIM] æ¬¡å…ƒ3: Auth-Gateãƒã‚¤ãƒ‘ã‚¹æ’é™¤ - JIT+HMAC SHA256å®Œå…¨å®Ÿè£…"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ”¥ V7-27æ¬¡å…ƒé˜²è¡›: ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (Burn-Limit)\n// æ¬¡å…ƒ22: çµŒæ¸ˆæ”»æ’ƒé˜²æ­¢ - æ—¥æ¬¡/æœˆæ¬¡ãƒãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒãƒ—\n// ========================================\n\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst userId = body.user_id || 'default';\n\n// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ä¸Šé™å–å¾—ï¼ˆæ—¥æ¬¡ãƒ»æœˆæ¬¡ä¸¡æ–¹ï¼‰\nconst dailyLimit = parseInt($env.BURN_LIMIT_DAILY || '1000', 10);\nconst monthlyLimit = parseInt($env.BURN_LIMIT_MONTHLY || '10000', 10);\nconst estimatedCost = 0.02; // eBay APIå‘¼ã³å‡ºã—ã‚³ã‚¹ãƒˆ\n\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n\ntry {\n  const usageResponse = await fetch(`${apiUrl}/api/cost-tracking/check-limit`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      user_id: userId, \n      operation: 'ebay_listing',\n      estimated_cost: estimatedCost,\n      daily_limit: dailyLimit,\n      monthly_limit: monthlyLimit,\n      strict_mode: true  // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼šä¸Šé™è¶…éæ™‚ã¯å³åº§ã«åœæ­¢\n    })\n  });\n  \n  const usageResult = await usageResponse.json();\n  \n  if (usageResult.limit_exceeded) {\n    return [{ json: { \n      error: true, \n      message: `ç‡ƒç„¼ä¸Šé™è¶…é: ${usageResult.exceeded_type} (ç¾åœ¨: ${usageResult.current} / ä¸Šé™: ${usageResult.limit})`,\n      code: 'BURN_LIMIT_EXCEEDED',\n      exceeded_type: usageResult.exceeded_type,\n      usage: usageResult\n    } }];\n  }\n  \n  return [{ json: { \n    ...body, \n    _burn_limit_checked: true, \n    _burn_limit_mode: 'strict',\n    _usage: usageResult \n  } }];\n} catch (e) {\n  // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼šãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã‚‚åœæ­¢ï¼ˆå®‰å…¨å´ã«å€’ã™ï¼‰\n  console.log('ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ' + e.message);\n  return [{ json: { \n    error: true, \n    message: 'ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆå®‰å…¨åœæ­¢ï¼‰: ' + e.message, \n    code: 'BURN_LIMIT_CHECK_FAILED' \n  } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "burn_limit_check_v7",
      "name": "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (æ¬¡å…ƒ22)",
      "notes": "[V7-27DIM] æ¬¡å…ƒ22: çµŒæ¸ˆæ”»æ’ƒé˜²æ­¢ - æ—¥æ¬¡/æœˆæ¬¡ãƒãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒãƒ—ãƒ»å³æ ¼ãƒ¢ãƒ¼ãƒ‰"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// âš–ï¸ V7-27æ¬¡å…ƒé˜²è¡›: Policyæ¤œé–²ï¼ˆToSäº‹å‰ãƒã‚§ãƒƒã‚¯ï¼‰\n// æ¬¡å…ƒ7: å®Ÿè¡Œå‰Policyæ¤œé–²\n// ========================================\n\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst productId = body.product_id;\nif (!productId) {\n  return [{ json: { error: true, message: 'product_idå¿…é ˆ', code: 'MISSING_PARAM' } }];\n}\n\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\n\ntry {\n  // eBay ToS / VeRO / ç¦æ­¢å•†å“ãƒã‚§ãƒƒã‚¯\n  const policyResponse = await fetch(`${apiUrl}/api/compliance/check-ebay-policy`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      product_id: productId,\n      checks: ['ebay_tos', 'vero', 'prohibited_items', 'category_restrictions']\n    })\n  });\n  \n  const policyResult = await policyResponse.json();\n  \n  if (policyResult.blocked) {\n    return [{ json: { \n      error: true, \n      message: `Policyé•åæ¤œå‡º: ${policyResult.violation_type} - ${policyResult.reason}`,\n      code: 'POLICY_VIOLATION',\n      violation_type: policyResult.violation_type,\n      policy_result: policyResult\n    } }];\n  }\n  \n  return [{ json: { \n    ...body, \n    _policy_checked: true, \n    _policy_result: policyResult \n  } }];\n} catch (e) {\n  // Policy APIãŒåˆ©ç”¨ä¸å¯ã®å ´åˆã¯è­¦å‘Šä»˜ãã§ç¶šè¡Œï¼ˆãŸã ã—ãƒ­ã‚°è¨˜éŒ²ï¼‰\n  console.log('Policyæ¤œé–²ã‚¨ãƒ©ãƒ¼ï¼ˆè­¦å‘Šä»˜ãç¶šè¡Œï¼‰: ' + e.message);\n  return [{ json: { \n    ...body, \n    _policy_checked: false, \n    _policy_warning: 'Policyæ¤œé–²ã‚¹ã‚­ãƒƒãƒ—: ' + e.message \n  } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "policy_check_v7",
      "name": "âš–ï¸ Policyæ¤œé–² (æ¬¡å…ƒ7)",
      "notes": "[V7-27DIM] æ¬¡å…ƒ7: eBay ToS/VeRO/ç¦æ­¢å•†å“äº‹å‰ãƒã‚§ãƒƒã‚¯"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ” V7-27æ¬¡å…ƒé˜²è¡›: æœ€å°æ¨©é™ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—\n// æ¬¡å…ƒ17: èª­ã¿å–ã‚Šå°‚ç”¨ vs æ›¸ãè¾¼ã¿æ¨©é™ã®åˆ†é›¢\n// ========================================\n\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\nconst marketplace = body.marketplace || 'ebay_us';\n\n// å¿…è¦ãªæ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®šã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆæ¬¡å…ƒ17ï¼‰\nconst requiredScope = 'write_listing'; // å‡ºå“ã«ã¯æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦\n\ntry {\n  const tokenResponse = await fetch(`${apiUrl}/api/ebay/get-scoped-token`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ \n      marketplace: marketplace,\n      required_scope: requiredScope,\n      jit_expiry_seconds: 300  // 5åˆ†é–“ã®ã¿æœ‰åŠ¹\n    })\n  });\n  \n  const tokenResult = await tokenResponse.json();\n  \n  if (!tokenResult.access_token) {\n    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—\n    return [{ json: { ...body, _use_legacy_token: true } }];\n  }\n  \n  return [{ json: { \n    ...body, \n    _scoped_token: tokenResult.access_token,\n    _token_scope: requiredScope,\n    _token_expiry: tokenResult.expires_at,\n    _minimum_privilege: true\n  } }];\n} catch (e) {\n  console.log('ã‚¹ã‚³ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: ' + e.message);\n  return [{ json: { ...body, _use_legacy_token: true, _token_error: e.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "minimum_privilege_token",
      "name": "ğŸ”‘ æœ€å°æ¨©é™ãƒˆãƒ¼ã‚¯ãƒ³ (æ¬¡å…ƒ17)",
      "notes": "[V7-27DIM] æ¬¡å…ƒ17: JITç™ºè¡Œãƒ»ã‚¹ã‚³ãƒ¼ãƒ—é™å®šãƒˆãƒ¼ã‚¯ãƒ³"
    },
    {
      "parameters": {
        "jsCode": "// å…¥åŠ›æ¤œè¨¼ãƒ»å¤‰æ•°è¨­å®š\nconst body = $input.first().json;\nif (body.error) return [{ json: body }];\n\nconst apiUrl = $env.N3_API_URL || 'http://localhost:3000';\nconst productId = body.product_id;\nconst marketplace = body.marketplace || 'ebay_us';\n\nconst SITE_ID_MAP = { 'ebay_us': 0, 'ebay_uk': 3, 'ebay_de': 77, 'ebay_au': 15, 'ebay_fr': 71, 'ebay_it': 101, 'ebay_es': 186, 'ebay_ca': 2 };\nconst siteId = SITE_ID_MAP[marketplace] || 0;\n\nreturn [{ json: { \n  ...body,\n  product_id: productId, \n  marketplace, \n  site_id: siteId, \n  api_url: apiUrl, \n  _retry_count: body._retry_count || 0, \n  _max_retries: 3 \n} }];"
      },
      "id": "validate_input",
      "name": "ğŸ” å…¥åŠ›æ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{"id": "error-check", "leftValue": "={{ $json.error }}", "rightValue": true, "operator": {"type": "boolean", "operation": "equals"}}]
        }
      },
      "id": "check_error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code, details: $json }) }}",
        "options": {"responseCode": 400}
      },
      "id": "error_response",
      "name": "âŒ ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{"id": "use-legacy", "leftValue": "={{ $json._use_legacy_token }}", "rightValue": true, "operator": {"type": "boolean", "operation": "equals"}}]
        }
      },
      "id": "check_token_type",
      "name": "ãƒˆãƒ¼ã‚¯ãƒ³ç¨®åˆ¥ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT access_token, expires_at FROM ebay_tokens WHERE environment = 'production' AND expires_at > NOW() ORDER BY expires_at DESC LIMIT 1",
        "options": {}
      },
      "id": "get_legacy_token",
      "name": "ğŸ“¦ ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {"postgres": {"id": "postgres-supabase", "name": "Supabase Postgres"}}
    },
    {
      "parameters": {
        "jsCode": "const request = $node['ğŸ” å…¥åŠ›æ¤œè¨¼'].json;\nconst tokenResult = $input.first().json;\nconst token = Array.isArray(tokenResult) ? tokenResult[0] : tokenResult;\n\nif (!token || !token.access_token) {\n  return [{ json: { error: true, message: 'eBayãƒˆãƒ¼ã‚¯ãƒ³æœªå–å¾—ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ', code: 'TOKEN_NOT_FOUND' } }];\n}\n\nreturn [{ json: { ...request, access_token: token.access_token, _token_type: 'legacy' } }];"
      },
      "id": "merge_legacy_token",
      "name": "ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const request = $node['ğŸ” å…¥åŠ›æ¤œè¨¼'].json;\nreturn [{ json: { ...request, access_token: request._scoped_token, _token_type: 'scoped_jit' } }];"
      },
      "id": "use_scoped_token",
      "name": "ã‚¹ã‚³ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "output": "single"
      },
      "id": "merge_tokens",
      "name": "ãƒˆãƒ¼ã‚¯ãƒ³çµ±åˆ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.id, pm.sku, pm.english_title, pm.title, pm.product_name, pm.ebay_category_id, pm.listing_price, pm.ddp_price_usd, pm.condition, pm.listing_data, pm.ebay_account, im.quantity FROM products_master pm LEFT JOIN inventory_master im ON pm.id = im.product_id WHERE pm.id = $1",
        "options": {"queryParams": "={{ [$json.product_id] }}"}
      },
      "id": "get_product",
      "name": "ğŸ“¦ å•†å“å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {"postgres": {"id": "postgres-supabase", "name": "Supabase Postgres"}}
    },
    {
      "parameters": {
        "jsCode": "// XMLæ§‹ç¯‰ï¼ˆXSS/ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–è¾¼ã¿ï¼‰\nfunction escapeXml(str) { \n  if (!str) return ''; \n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&apos;');\n}\n\nconst request = $node['ãƒˆãƒ¼ã‚¯ãƒ³çµ±åˆ'].json;\nconst productResult = $input.first().json;\nconst product = Array.isArray(productResult) ? productResult[0] : productResult;\n\nif (!product || !product.id) {\n  return [{ json: { error: true, message: 'å•†å“æœªå–å¾—', code: 'PRODUCT_NOT_FOUND' } }];\n}\n\n// ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ80æ–‡å­—åˆ¶é™ï¼‰\nconst title = escapeXml((product.english_title || product.title || product.product_name || '').substring(0, 80));\n\n// ä¾¡æ ¼ï¼ˆæ¤œè¨¼ä»˜ãï¼‰\nlet price = parseFloat(product.listing_price || product.ddp_price_usd || 0);\nif (price <= 0 || isNaN(price)) {\n  return [{ json: { error: true, message: 'ç„¡åŠ¹ãªä¾¡æ ¼: ' + price, code: 'INVALID_PRICE' } }];\n}\nprice = Math.round(price * 100) / 100; // å°æ•°ç‚¹2æ¡ã«ä¸¸ã‚\n\n// æ•°é‡ï¼ˆ1-5ã®ç¯„å›²ï¼‰\nconst quantity = Math.max(1, Math.min(product.quantity || 1, 5));\n\n// ã‚«ãƒ†ã‚´ãƒªID\nconst categoryId = product.ebay_category_id || '888';\n\n// ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³\nconst conditionId = product.condition === 'new' ? '1000' : '3000';\n\nconst xml = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<AddFixedPriceItemRequest xmlns=\"urn:ebay:apis:eBLBaseComponents\">\n  <RequesterCredentials>\n    <eBayAuthToken>${request.access_token}</eBayAuthToken>\n  </RequesterCredentials>\n  <ErrorLanguage>en_US</ErrorLanguage>\n  <WarningLevel>High</WarningLevel>\n  <Item>\n    <Title>${title}</Title>\n    <PrimaryCategory>\n      <CategoryID>${categoryId}</CategoryID>\n    </PrimaryCategory>\n    <StartPrice currencyID=\"USD\">${price}</StartPrice>\n    <ConditionID>${conditionId}</ConditionID>\n    <Country>JP</Country>\n    <Currency>USD</Currency>\n    <DispatchTimeMax>3</DispatchTimeMax>\n    <ListingDuration>GTC</ListingDuration>\n    <ListingType>FixedPriceItem</ListingType>\n    <Location>Japan</Location>\n    <Quantity>${quantity}</Quantity>\n  </Item>\n</AddFixedPriceItemRequest>`;\n\nreturn [{ json: { \n  ...request, \n  product, \n  xml_request: xml,\n  _xml_built_at: new Date().toISOString()\n} }];"
      },
      "id": "build_xml",
      "name": "ğŸ“ XMLæ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.ebay.com/ws/api.dll",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-EBAY-API-SITEID", "value": "={{ $json.site_id }}"},
            {"name": "X-EBAY-API-COMPATIBILITY-LEVEL", "value": "1225"},
            {"name": "X-EBAY-API-CALL-NAME", "value": "AddFixedPriceItem"},
            {"name": "Content-Type", "value": "text/xml; charset=utf-8"}
          ]
        },
        "sendBody": true,
        "specifyBody": "string",
        "body": "={{ $json.xml_request }}",
        "options": {"timeout": 60000, "response": {"response": {"fullResponse": true}}}
      },
      "id": "call_ebay_api",
      "name": "ğŸ“¤ eBay APIå‘¼å‡º",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ğŸ”„ V7-27æ¬¡å…ƒ: çµæœè§£æ + è‡ªå·±ä¿®å¾©åˆ¤å®š + ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼\n// æ¬¡å…ƒ12: ä»£æ›¿ã‚¨ãƒ³ã‚¸ãƒ³å†—é•·åŒ–å¯¾å¿œ\n// ========================================\n\nconst prevData = $node['ğŸ“ XMLæ§‹ç¯‰'].json;\nconst response = $input.first().json;\nconst body = response.body || response.data || JSON.stringify(response);\n\nlet itemId = null;\nlet hasError = false;\nlet errorCode = null;\nlet errorMessage = null;\nlet errorSeverity = null;\n\nif (typeof body === 'string') {\n  // ItemIDæŠ½å‡º\n  const itemIdMatch = body.match(/<ItemID>(\\d+)<\\/ItemID>/);\n  if (itemIdMatch) itemId = itemIdMatch[1];\n  \n  // Ackç¢ºèª\n  const ackMatch = body.match(/<Ack>(\\w+)<\\/Ack>/);\n  if (ackMatch && (ackMatch[1] === 'Failure' || ackMatch[1] === 'Warning')) {\n    hasError = ackMatch[1] === 'Failure';\n    \n    // ã‚¨ãƒ©ãƒ¼è©³ç´°æŠ½å‡º\n    const errorCodeMatch = body.match(/<ErrorCode>(\\d+)<\\/ErrorCode>/);\n    const errorMsgMatch = body.match(/<ShortMessage>([^<]+)<\\/ShortMessage>/);\n    const severityMatch = body.match(/<SeverityCode>(\\w+)<\\/SeverityCode>/);\n    \n    errorCode = errorCodeMatch ? errorCodeMatch[1] : null;\n    errorMessage = errorMsgMatch ? errorMsgMatch[1] : null;\n    errorSeverity = severityMatch ? severityMatch[1] : null;\n  }\n}\n\n// å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°\nconst RECOVERABLE_ERRORS = { \n  '21916587': 'title_length', \n  '21916607': 'category_invalid', \n  '21916293': 'duplicate_listing', \n  '240': 'token_expired', \n  '932': 'auth_error',\n  '21916635': 'item_specifics_missing',\n  '21916664': 'invalid_condition'\n};\n\nconst retryCount = prevData._retry_count || 0;\nconst maxRetries = prevData._max_retries || 3;\n\n// ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼åˆ¤å®šï¼ˆæ¬¡å…ƒ12ï¼‰\nconst CRITICAL_ERRORS = ['240', '932', '17']; // ãƒˆãƒ¼ã‚¯ãƒ³/èªè¨¼/ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢\nif (hasError && errorCode && CRITICAL_ERRORS.includes(errorCode)) {\n  return [{ json: { \n    ...prevData, \n    _circuit_breaker_triggered: true,\n    _critical_error: true,\n    error_code: errorCode,\n    error_message: errorMessage,\n    action: 'circuit_breaker_stop'\n  } }];\n}\n\n// è‡ªå·±ä¿®å¾©åˆ¤å®š\nif (hasError && errorCode && RECOVERABLE_ERRORS[errorCode] && retryCount < maxRetries) {\n  return [{ json: { \n    ...prevData, \n    _self_repair_needed: true, \n    _repair_type: RECOVERABLE_ERRORS[errorCode], \n    _error_code: errorCode, \n    _error_message: errorMessage,\n    _error_severity: errorSeverity,\n    _retry_count: retryCount + 1 \n  } }];\n}\n\n// æœ€çµ‚çµæœ\nif (hasError) {\n  return [{ json: { \n    success: false, \n    product_id: prevData.product_id, \n    error_code: errorCode, \n    error_message: errorMessage,\n    error_severity: errorSeverity,\n    retries_exhausted: retryCount >= maxRetries \n  } }];\n}\n\nreturn [{ json: { \n  success: true, \n  product_id: prevData.product_id, \n  item_id: itemId, \n  marketplace: prevData.marketplace,\n  _token_type: prevData._token_type\n} }];"
      },
      "id": "parse_response",
      "name": "ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[V7-27DIM] æ¬¡å…ƒ12: ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãƒ»è‡ªå·±ä¿®å¾©åˆ¤å®š"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{"id": "circuit-breaker", "leftValue": "={{ $json._circuit_breaker_triggered }}", "rightValue": true, "operator": {"type": "boolean", "operation": "equals"}}]
        }
      },
      "id": "check_circuit_breaker",
      "name": "ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {"parameters": [{"name": "X-ChatWorkToken", "value": "={{ $env.CHATWORK_API_KEY }}"}]},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ body: 'ğŸš¨ [ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹•] eBayå‡ºå“åœæ­¢\\nã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + $json.error_code + '\\nã‚¨ãƒ©ãƒ¼å†…å®¹: ' + $json.error_message + '\\nå•†å“ID: ' + $json.product_id }) }}",
        "options": {}
      },
      "id": "notify_circuit_breaker",
      "name": "ğŸš¨ ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{"id": "self-repair", "leftValue": "={{ $json._self_repair_needed }}", "rightValue": true, "operator": {"type": "boolean", "operation": "equals"}}]
        }
      },
      "id": "check_self_repair",
      "name": "è‡ªå·±ä¿®å¾©è¦ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N3_API_URL }}/api/ai/analyze-ebay-error",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ error_code: $json._error_code, error_message: $json._error_message, repair_type: $json._repair_type, product_id: $json.product_id, product_data: $json.product }) }}",
        "options": {"timeout": 30000}
      },
      "id": "ai_analyze_error",
      "name": "ğŸ¤– AIã‚¨ãƒ©ãƒ¼åˆ†æ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ai_decision_traces (user_id, workflow_name, node_name, input_data, output_data, model_used, reasoning, confidence_score, created_at) VALUES ($1, 'ebay-listing-v7-27dim', 'ai-error-analysis', $2::jsonb, $3::jsonb, 'gemini-1.5-flash', 'è‡ªå·±ä¿®å¾©ã‚¨ãƒ©ãƒ¼åˆ†æ', $4, NOW())",
        "options": {"queryParams": "={{ [$json.user_id || 'system', JSON.stringify({error_code: $node['ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)'].json._error_code, product_id: $node['ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)'].json.product_id}).substring(0, 1000), JSON.stringify($input.first().json).substring(0, 1000), $input.first().json.confidence || 0.5] }}"}
      },
      "id": "ai_decision_trace",
      "name": "ğŸ“ AI Decision Trace (æ¬¡å…ƒ13)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {"postgres": {"id": "postgres-supabase", "name": "Supabase Postgres"}},
      "continueOnFail": true,
      "notes": "[V7-27DIM] æ¬¡å…ƒ13: AIåˆ¤æ–­ã®è¨¼è·¡è¨˜éŒ²"
    },
    {
      "parameters": {
        "jsCode": "// è‡ªå·±ä¿®å¾©é©ç”¨\nconst repairData = $node['ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)'].json;\nconst aiResult = $node['ğŸ¤– AIã‚¨ãƒ©ãƒ¼åˆ†æ'].json || {};\nlet fixedData = { ...repairData };\n\nswitch (repairData._repair_type) {\n  case 'title_length':\n    if (fixedData.product && fixedData.product.english_title) {\n      fixedData.product.english_title = fixedData.product.english_title.substring(0, 75) + '...';\n    }\n    break;\n  case 'category_invalid':\n    if (fixedData.product) {\n      fixedData.product.ebay_category_id = aiResult.suggested_category || '888';\n    }\n    break;\n  case 'item_specifics_missing':\n    if (fixedData.product) {\n      const listingData = typeof fixedData.product.listing_data === 'string' \n        ? JSON.parse(fixedData.product.listing_data || '{}') \n        : fixedData.product.listing_data || {};\n      listingData.item_specifics = { ...listingData.item_specifics, MPN: 'Does Not Apply', Brand: 'Unbranded' };\n      fixedData.product.listing_data = listingData;\n    }\n    break;\n  case 'token_expired':\n  case 'auth_error':\n    fixedData._need_token_refresh = true;\n    break;\n}\n\nreturn [{ json: fixedData }];"
      },
      "id": "apply_repair",
      "name": "ğŸ”§ ä¿®å¾©é©ç”¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO listing_logs (product_id, marketplace, action, success, item_id, error_code, error_message, execution_context, log_hash, created_at, timezone) VALUES ($1, $2, 'add_item', $3, $4, $5, $6, $7::jsonb, $8, NOW(), 'Asia/Tokyo')",
        "options": {"queryParams": "={{ [$json.product_id, $json.marketplace || 'ebay_us', $json.success || false, $json.item_id, $json.error_code, $json.error_message, JSON.stringify({auth_verified: $json._auth_verified, burn_limit_checked: $json._burn_limit_checked, policy_checked: $json._policy_checked, token_type: $json._token_type}), require('crypto').createHash('sha256').update(JSON.stringify($json) + new Date().toISOString()).digest('hex')] }}"}
      },
      "id": "log_result_forensic",
      "name": "ğŸ“ æ³•å»·è€æ€§ãƒ­ã‚° (æ¬¡å…ƒ26)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {"postgres": {"id": "postgres-supabase", "name": "Supabase Postgres"}},
      "continueOnFail": true,
      "notes": "[V7-27DIM] æ¬¡å…ƒ26: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³+ãƒãƒƒã‚·ãƒ¥ç½²åä»˜ããƒ­ã‚°"
    },
    {
      "parameters": {
        "jsCode": "// æœ€çµ‚çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\nconst data = $input.first().json;\n\nreturn [{ json: {\n  success: data.success || false,\n  product_id: data.product_id,\n  item_id: data.item_id,\n  marketplace: data.marketplace,\n  error_code: data.error_code,\n  error_message: data.error_message,\n  v7_27dim_features: {\n    auth_verified: data._auth_verified || false,\n    burn_limit_checked: data._burn_limit_checked || false,\n    policy_checked: data._policy_checked || false,\n    minimum_privilege_token: data._minimum_privilege || false,\n    circuit_breaker_active: true,\n    forensic_logging: true,\n    ai_decision_traced: true\n  },\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "format_result",
      "name": "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {"responseCode": "={{ $json.success ? 200 : ($json._circuit_breaker_triggered ? 503 : 500) }}"}
      },
      "id": "success_response",
      "name": "ğŸ“¤ å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    }
  ],
  "connections": {
    "Webhook: ebay-listing": {"main": [[{"node": "ğŸ” JIT+HMACæ¤œè¨¼ (æ¬¡å…ƒ3)", "type": "main", "index": 0}]]},
    "ğŸ” JIT+HMACæ¤œè¨¼ (æ¬¡å…ƒ3)": {"main": [[{"node": "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (æ¬¡å…ƒ22)", "type": "main", "index": 0}]]},
    "ğŸ”¥ ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ (æ¬¡å…ƒ22)": {"main": [[{"node": "âš–ï¸ Policyæ¤œé–² (æ¬¡å…ƒ7)", "type": "main", "index": 0}]]},
    "âš–ï¸ Policyæ¤œé–² (æ¬¡å…ƒ7)": {"main": [[{"node": "ğŸ”‘ æœ€å°æ¨©é™ãƒˆãƒ¼ã‚¯ãƒ³ (æ¬¡å…ƒ17)", "type": "main", "index": 0}]]},
    "ğŸ”‘ æœ€å°æ¨©é™ãƒˆãƒ¼ã‚¯ãƒ³ (æ¬¡å…ƒ17)": {"main": [[{"node": "ğŸ” å…¥åŠ›æ¤œè¨¼", "type": "main", "index": 0}]]},
    "ğŸ” å…¥åŠ›æ¤œè¨¼": {"main": [[{"node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯", "type": "main", "index": 0}]]},
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {"main": [[{"node": "âŒ ã‚¨ãƒ©ãƒ¼å¿œç­”", "type": "main", "index": 0}], [{"node": "ãƒˆãƒ¼ã‚¯ãƒ³ç¨®åˆ¥ï¼Ÿ", "type": "main", "index": 0}]]},
    "ãƒˆãƒ¼ã‚¯ãƒ³ç¨®åˆ¥ï¼Ÿ": {"main": [[{"node": "ğŸ“¦ ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—", "type": "main", "index": 0}], [{"node": "ã‚¹ã‚³ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨", "type": "main", "index": 0}]]},
    "ğŸ“¦ ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—": {"main": [[{"node": "ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ¼ã‚¸", "type": "main", "index": 0}]]},
    "ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ¼ã‚¸": {"main": [[{"node": "ãƒˆãƒ¼ã‚¯ãƒ³çµ±åˆ", "type": "main", "index": 0}]]},
    "ã‚¹ã‚³ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨": {"main": [[{"node": "ãƒˆãƒ¼ã‚¯ãƒ³çµ±åˆ", "type": "main", "index": 1}]]},
    "ãƒˆãƒ¼ã‚¯ãƒ³çµ±åˆ": {"main": [[{"node": "ğŸ“¦ å•†å“å–å¾—", "type": "main", "index": 0}]]},
    "ğŸ“¦ å•†å“å–å¾—": {"main": [[{"node": "ğŸ“ XMLæ§‹ç¯‰", "type": "main", "index": 0}]]},
    "ğŸ“ XMLæ§‹ç¯‰": {"main": [[{"node": "ğŸ“¤ eBay APIå‘¼å‡º", "type": "main", "index": 0}]]},
    "ğŸ“¤ eBay APIå‘¼å‡º": {"main": [[{"node": "ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)", "type": "main", "index": 0}]]},
    "ğŸ”„ çµæœè§£æï¼‹è‡ªå·±ä¿®å¾©åˆ¤å®š (æ¬¡å…ƒ12)": {"main": [[{"node": "ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ï¼Ÿ", "type": "main", "index": 0}]]},
    "ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ï¼Ÿ": {"main": [[{"node": "ğŸš¨ ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é€šçŸ¥", "type": "main", "index": 0}], [{"node": "è‡ªå·±ä¿®å¾©è¦ï¼Ÿ", "type": "main", "index": 0}]]},
    "ğŸš¨ ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é€šçŸ¥": {"main": [[{"node": "ğŸ“ æ³•å»·è€æ€§ãƒ­ã‚° (æ¬¡å…ƒ26)", "type": "main", "index": 0}]]},
    "è‡ªå·±ä¿®å¾©è¦ï¼Ÿ": {"main": [[{"node": "ğŸ¤– AIã‚¨ãƒ©ãƒ¼åˆ†æ", "type": "main", "index": 0}], [{"node": "ğŸ“ æ³•å»·è€æ€§ãƒ­ã‚° (æ¬¡å…ƒ26)", "type": "main", "index": 0}]]},
    "ğŸ¤– AIã‚¨ãƒ©ãƒ¼åˆ†æ": {"main": [[{"node": "ğŸ“ AI Decision Trace (æ¬¡å…ƒ13)", "type": "main", "index": 0}]]},
    "ğŸ“ AI Decision Trace (æ¬¡å…ƒ13)": {"main": [[{"node": "ğŸ”§ ä¿®å¾©é©ç”¨", "type": "main", "index": 0}]]},
    "ğŸ”§ ä¿®å¾©é©ç”¨": {"main": [[{"node": "ğŸ“ XMLæ§‹ç¯‰", "type": "main", "index": 0}]]},
    "ğŸ“ æ³•å»·è€æ€§ãƒ­ã‚° (æ¬¡å…ƒ26)": {"main": [[{"node": "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ", "type": "main", "index": 0}]]},
    "ğŸ“Š çµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ": {"main": [[{"node": "ğŸ“¤ å¿œç­”", "type": "main", "index": 0}]]}
  },
  "settings": {
    "executionOrder": "v1",
    "executionTimeout": 180,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {"name": "27DIM-FORTRESS", "color": "#dc143c"},
    {"name": "V7-ENHANCED", "color": "#00ff00"},
    {"name": "JIT-AUTH", "color": "#ffd700"},
    {"name": "BURN-LIMIT", "color": "#ff6347"},
    {"name": "POLICY-CHECK", "color": "#4169e1"},
    {"name": "MIN-PRIVILEGE", "color": "#9932cc"},
    {"name": "CIRCUIT-BREAKER", "color": "#ff4500"},
    {"name": "FORENSIC-LOG", "color": "#2f4f4f"}
  ],
  "active": false,
  "_27dim_converted": true,
  "_27dim_version": "1.0.0",
  "_27dim_timestamp": "2026-01-24T00:00:00.000Z",
  "_27dim_dimensions_implemented": [3, 7, 12, 13, 17, 22, 26],
  "_special_features": [
    "JIT_HMAC_Auth_Dim3",
    "Burn_Limit_Strict_Dim22", 
    "Policy_Check_Dim7",
    "Minimum_Privilege_Token_Dim17",
    "Circuit_Breaker_Dim12",
    "AI_Decision_Trace_Dim13",
    "Forensic_Logging_Dim26",
    "Recursive_Self_Repair"
  ]
}
