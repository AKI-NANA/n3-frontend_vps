{
  "name": "ã€V8.2.1ã€‘API Watcher - å…¨è»åœæ­¢ Kill-Switch",
  "description": "N3 Empire OS V8.2.1: 152ãƒ„ãƒ¼ãƒ«ã®å¤–éƒ¨é€šä¿¡ã‚¨ãƒ©ãƒ¼ç‡ã‚’ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«è©²å½“ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å…¨å®Ÿè¡Œã‚’å¼·åˆ¶åœæ­¢",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "minutes", "minutesInterval": 5 }] }
      },
      "id": "cron-trigger",
      "name": "â° 5åˆ†æ¯ç›£è¦–",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [220, 400]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api-watcher",
        "options": { "responseMode": "responseNode" }
      },
      "id": "webhook-manual",
      "name": "ğŸšª æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [220, 600]
    },
    {
      "parameters": {
        "jsCode": "// ç›£è¦–è¨­å®šã®åˆæœŸåŒ–\nconst now = new Date();\nconst windowMinutes = 15; // ç›´è¿‘15åˆ†ã®ã‚¨ãƒ©ãƒ¼ã‚’é›†è¨ˆ\nconst windowStart = new Date(now.getTime() - windowMinutes * 60 * 1000);\n\nreturn [{ json: {\n  _request_id: `watch-${Date.now()}`,\n  _timestamp: now.toISOString(),\n  _window: {\n    start: windowStart.toISOString(),\n    end: now.toISOString(),\n    minutes: windowMinutes\n  },\n  _thresholds: {\n    error_rate_percent: 30,      // ã‚¨ãƒ©ãƒ¼ç‡30%ã§è­¦å‘Š\n    error_rate_critical: 50,     // ã‚¨ãƒ©ãƒ¼ç‡50%ã§åœæ­¢\n    min_requests: 10,            // æœ€ä½ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼ˆå°‘ãªã™ãã‚‹ã¨èª¤åˆ¤å®šï¼‰\n    consecutive_errors: 5        // é€£ç¶šã‚¨ãƒ©ãƒ¼æ•°\n  },\n  _platforms: ['ebay', 'amazon', 'yahoo', 'qoo10', 'paypal', 'stripe', 'chatwork', 'openai']\n} }];"
      },
      "id": "init-config",
      "name": "âš™ï¸ ç›£è¦–è¨­å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH error_stats AS (\n  SELECT \n    COALESCE(metadata->>'platform', 'unknown') as platform,\n    COUNT(*) as total_requests,\n    COUNT(*) FILTER (WHERE status = 'error') as error_count,\n    COUNT(*) FILTER (WHERE status = 'success') as success_count,\n    ROUND(COUNT(*) FILTER (WHERE status = 'error') * 100.0 / NULLIF(COUNT(*), 0), 2) as error_rate,\n    MAX(executed_at) as last_request_at,\n    MAX(executed_at) FILTER (WHERE status = 'error') as last_error_at,\n    array_agg(DISTINCT error_message) FILTER (WHERE error_message IS NOT NULL) as error_types\n  FROM audit.logs\n  WHERE executed_at >= $1::timestamptz\n    AND executed_at <= $2::timestamptz\n    AND metadata->>'platform' IS NOT NULL\n  GROUP BY COALESCE(metadata->>'platform', 'unknown')\n),\nconsecutive AS (\n  SELECT \n    metadata->>'platform' as platform,\n    COUNT(*) as consecutive_errors\n  FROM (\n    SELECT \n      metadata->>'platform' as platform,\n      status,\n      ROW_NUMBER() OVER (PARTITION BY metadata->>'platform' ORDER BY executed_at DESC) as rn\n    FROM audit.logs\n    WHERE executed_at >= $1::timestamptz\n      AND metadata->>'platform' IS NOT NULL\n  ) sub\n  WHERE rn <= 10 AND status = 'error'\n  GROUP BY metadata->>'platform'\n)\nSELECT \n  e.*,\n  COALESCE(c.consecutive_errors, 0) as consecutive_errors\nFROM error_stats e\nLEFT JOIN consecutive c ON e.platform = c.platform\nORDER BY e.error_rate DESC NULLS LAST",
        "options": { "queryParams": "={{ [$json._window.start, $json._window.end] }}" }
      },
      "id": "get-error-stats",
      "name": "ğŸ“Š ã‚¨ãƒ©ãƒ¼çµ±è¨ˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "supabase", "name": "Supabase" } },
      "position": [660, 500]
    },
    {
      "parameters": {
        "jsCode": "// ã‚¨ãƒ©ãƒ¼åˆ†æã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š\nconst config = $('âš™ï¸ ç›£è¦–è¨­å®š').first().json;\nconst stats = $input.all().map(i => i.json);\nconst thresholds = config._thresholds;\n\nconst analysis = {\n  timestamp: new Date().toISOString(),\n  window: config._window,\n  platforms: [],\n  actions: [],\n  summary: {\n    total_platforms: 0,\n    healthy: 0,\n    warning: 0,\n    critical: 0,\n    stopped: 0\n  }\n};\n\nfor (const stat of stats) {\n  const platform = {\n    name: stat.platform,\n    total_requests: stat.total_requests || 0,\n    error_count: stat.error_count || 0,\n    success_count: stat.success_count || 0,\n    error_rate: parseFloat(stat.error_rate) || 0,\n    consecutive_errors: stat.consecutive_errors || 0,\n    last_request_at: stat.last_request_at,\n    last_error_at: stat.last_error_at,\n    error_types: stat.error_types || [],\n    status: 'healthy',\n    action: 'none'\n  };\n  \n  // æœ€ä½ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãƒã‚§ãƒƒã‚¯\n  if (platform.total_requests < thresholds.min_requests) {\n    platform.status = 'insufficient_data';\n    platform.action = 'monitor';\n  }\n  // é€£ç¶šã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯\n  else if (platform.consecutive_errors >= thresholds.consecutive_errors) {\n    platform.status = 'critical';\n    platform.action = 'kill_switch';\n    analysis.actions.push({\n      platform: platform.name,\n      action: 'KILL_SWITCH',\n      reason: `é€£ç¶šã‚¨ãƒ©ãƒ¼ ${platform.consecutive_errors}å›`,\n      severity: 'CRITICAL'\n    });\n  }\n  // ã‚¨ãƒ©ãƒ¼ç‡ CRITICAL ãƒã‚§ãƒƒã‚¯\n  else if (platform.error_rate >= thresholds.error_rate_critical) {\n    platform.status = 'critical';\n    platform.action = 'kill_switch';\n    analysis.actions.push({\n      platform: platform.name,\n      action: 'KILL_SWITCH',\n      reason: `ã‚¨ãƒ©ãƒ¼ç‡ ${platform.error_rate}%`,\n      severity: 'CRITICAL'\n    });\n  }\n  // ã‚¨ãƒ©ãƒ¼ç‡ WARNING ãƒã‚§ãƒƒã‚¯\n  else if (platform.error_rate >= thresholds.error_rate_percent) {\n    platform.status = 'warning';\n    platform.action = 'alert';\n    analysis.actions.push({\n      platform: platform.name,\n      action: 'ALERT',\n      reason: `ã‚¨ãƒ©ãƒ¼ç‡ ${platform.error_rate}%`,\n      severity: 'WARNING'\n    });\n  }\n  \n  analysis.platforms.push(platform);\n  analysis.summary.total_platforms++;\n  \n  switch (platform.status) {\n    case 'healthy': analysis.summary.healthy++; break;\n    case 'warning': analysis.summary.warning++; break;\n    case 'critical': analysis.summary.critical++; break;\n  }\n}\n\nreturn [{ json: { ...config, _analysis: analysis } }];"
      },
      "id": "analyze-errors",
      "name": "ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true },
          "conditions": [{ "leftValue": "={{ $json._analysis.actions.length }}", "rightValue": 0, "operator": { "type": "number", "operation": "gt" } }]
        }
      },
      "id": "action-check",
      "name": "âš ï¸ è¦å¯¾å¿œ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 500]
    },
    {
      "parameters": {
        "jsCode": "// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦æ™‚ã®ã‚µãƒãƒªãƒ¼\nconst data = $input.first().json;\nreturn [{ json: {\n  status: 'healthy',\n  message: 'å…¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ­£å¸¸ç¨¼åƒä¸­',\n  summary: data._analysis.summary,\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "healthy-response",
      "name": "âœ… æ­£å¸¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 400]
    },
    {
      "parameters": {
        "jsCode": "// Kill-Switchå¯¾è±¡ã®æŠ½å‡º\nconst data = $input.first().json;\nconst killTargets = data._analysis.actions.filter(a => a.action === 'KILL_SWITCH');\nconst alertTargets = data._analysis.actions.filter(a => a.action === 'ALERT');\n\nreturn [{ json: {\n  ...data,\n  _kill_targets: killTargets,\n  _alert_targets: alertTargets,\n  _has_kills: killTargets.length > 0\n} }];"
      },
      "id": "extract-targets",
      "name": "ğŸ¯ å¯¾è±¡æŠ½å‡º",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 600]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true },
          "conditions": [{ "leftValue": "={{ $json._has_kills }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }]
        }
      },
      "id": "kill-check",
      "name": "ğŸ›‘ Kill?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1540, 600]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO core.platform_circuit_breaker (platform, status, triggered_at, triggered_by, reason, auto_recovery_at)\nSELECT \n  unnest($1::text[]),\n  'stopped',\n  NOW(),\n  'api_watcher_v821',\n  unnest($2::text[]),\n  NOW() + INTERVAL '30 minutes'\nON CONFLICT (platform) DO UPDATE SET\n  status = 'stopped',\n  triggered_at = NOW(),\n  triggered_by = 'api_watcher_v821',\n  reason = EXCLUDED.reason,\n  auto_recovery_at = NOW() + INTERVAL '30 minutes'\nRETURNING platform, status",
        "options": { "queryParams": "={{ [$json._kill_targets.map(k => k.platform), $json._kill_targets.map(k => k.reason)] }}" }
      },
      "id": "execute-kill",
      "name": "ğŸ›‘ KILLå®Ÿè¡Œ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "supabase", "name": "Supabase" } },
      "position": [1760, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "X-ChatWorkToken", "value": "={{ $env.CHATWORK_API_KEY }}" }] },
        "sendBody": true,
        "bodyParameters": { "parameters": [{ "name": "body", "value": "[info][title]ğŸš¨ V8.2.1 å…¨è»åœæ­¢ - KILL SWITCH ç™ºå‹•[/title]{{ $json._kill_targets.map(k => `âŒ ${k.platform}: ${k.reason}`).join('\\n') }}\\n\\nè‡ªå‹•å¾©æ—§: 30åˆ†å¾Œ\\næ‰‹å‹•å¾©æ—§: /api-watcher/recover\\n\\nç›£è¦–æœŸé–“: {{ $json._window.minutes }}åˆ†[/info]" }] }
      },
      "id": "kill-notify",
      "name": "ğŸš¨ ç·Šæ€¥é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1980, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "X-ChatWorkToken", "value": "={{ $env.CHATWORK_API_KEY }}" }] },
        "sendBody": true,
        "bodyParameters": { "parameters": [{ "name": "body", "value": "[info][title]âš ï¸ V8.2.1 APIç›£è¦– - è­¦å‘Š[/title]{{ $json._alert_targets.map(a => `âš ï¸ ${a.platform}: ${a.reason}`).join('\\n') }}\\n\\nå¯¾å¿œæ¨å¥¨: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„[/info]" }] }
      },
      "id": "alert-notify",
      "name": "âš ï¸ è­¦å‘Šé€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 700],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO audit.logs (tenant_id, workflow_name, request_id, action, risk_level, payload_masked, status, executed_at)\nVALUES (NULL, 'api-watcher', $1, 'monitor', 'LOW', $2::jsonb, 'success', NOW())",
        "options": { "queryParams": "={{ [$json._request_id, JSON.stringify({summary: $json._analysis.summary, actions: $json._analysis.actions.length})] }}" }
      },
      "id": "log-result",
      "name": "ğŸ“ ãƒ­ã‚°è¨˜éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "supabase", "name": "Supabase" } },
      "position": [2200, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// æœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹\nconst data = $input.first().json;\nreturn [{ json: {\n  status: data._has_kills ? 'kill_switch_activated' : 'warning_issued',\n  request_id: data._request_id,\n  summary: data._analysis.summary,\n  actions_taken: data._analysis.actions,\n  platforms: data._analysis.platforms.map(p => ({\n    name: p.name,\n    status: p.status,\n    error_rate: p.error_rate,\n    action: p.action\n  })),\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "final-response",
      "name": "ğŸ“Š å¿œç­”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2420, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": { "responseCode": "={{ $json.status === 'kill_switch_activated' ? 503 : 200 }}" }
      },
      "id": "respond",
      "name": "âœ… Send",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2640, 600]
    }
  ],
  "connections": {
    "â° 5åˆ†æ¯ç›£è¦–": { "main": [[{ "node": "âš™ï¸ ç›£è¦–è¨­å®š", "type": "main", "index": 0 }]] },
    "ğŸšª æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼": { "main": [[{ "node": "âš™ï¸ ç›£è¦–è¨­å®š", "type": "main", "index": 0 }]] },
    "âš™ï¸ ç›£è¦–è¨­å®š": { "main": [[{ "node": "ğŸ“Š ã‚¨ãƒ©ãƒ¼çµ±è¨ˆå–å¾—", "type": "main", "index": 0 }]] },
    "ğŸ“Š ã‚¨ãƒ©ãƒ¼çµ±è¨ˆå–å¾—": { "main": [[{ "node": "ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ", "type": "main", "index": 0 }]] },
    "ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ": { "main": [[{ "node": "âš ï¸ è¦å¯¾å¿œ?", "type": "main", "index": 0 }]] },
    "âš ï¸ è¦å¯¾å¿œ?": { "main": [[{ "node": "âœ… æ­£å¸¸", "type": "main", "index": 0 }], [{ "node": "ğŸ¯ å¯¾è±¡æŠ½å‡º", "type": "main", "index": 0 }]] },
    "ğŸ¯ å¯¾è±¡æŠ½å‡º": { "main": [[{ "node": "ğŸ›‘ Kill?", "type": "main", "index": 0 }]] },
    "ğŸ›‘ Kill?": { "main": [[{ "node": "ğŸ›‘ KILLå®Ÿè¡Œ", "type": "main", "index": 0 }], [{ "node": "âš ï¸ è­¦å‘Šé€šçŸ¥", "type": "main", "index": 0 }]] },
    "ğŸ›‘ KILLå®Ÿè¡Œ": { "main": [[{ "node": "ğŸš¨ ç·Šæ€¥é€šçŸ¥", "type": "main", "index": 0 }]] },
    "ğŸš¨ ç·Šæ€¥é€šçŸ¥": { "main": [[{ "node": "ğŸ“ ãƒ­ã‚°è¨˜éŒ²", "type": "main", "index": 0 }]] },
    "âš ï¸ è­¦å‘Šé€šçŸ¥": { "main": [[{ "node": "ğŸ“ ãƒ­ã‚°è¨˜éŒ²", "type": "main", "index": 0 }]] },
    "ğŸ“ ãƒ­ã‚°è¨˜éŒ²": { "main": [[{ "node": "ğŸ“Š å¿œç­”", "type": "main", "index": 0 }]] },
    "ğŸ“Š å¿œç­”": { "main": [[{ "node": "âœ… Send", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionTimeout": 120, "saveDataErrorExecution": "all" },
  "tags": [{ "name": "V8.2.1-FINAL" }, { "name": "KILL-SWITCH" }, { "name": "MONITORING" }],
  "active": true,
  "_v8_version": "8.2.1"
}
