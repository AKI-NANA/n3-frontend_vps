{
  "name": "ã€å¸ä»¤å¡”ã€‘09_72-Sentinel-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–-è‡ªå‹•æ”¹å–„_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 4
            }
          ]
        }
      },
      "id": "schedule",
      "name": "â° 4æ™‚é–“ã”ã¨",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "jsCode": "// Sentinel ç›£è¦–è¨­å®š\nconst config = {\n  min_views_for_evaluation: 100,\n  time_window_hours: 72,\n  max_tasks_per_run: 20,\n  auto_approve_threshold: 0.90,\n  human_review_threshold: 0.65\n};\n\nreturn [{ json: config }];"
      },
      "id": "init",
      "name": "ğŸ”§ åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM performance_rules WHERE is_active = TRUE ORDER BY id",
        "options": {}
      },
      "id": "get-rules",
      "name": "ğŸ“‹ ãƒ«ãƒ¼ãƒ«å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  rm.render_id as video_id,\n  rm.channel_id,\n  ya.ctr,\n  ya.retention_rate,\n  (ya.likes + ya.comments * 2) / NULLIF(ya.views, 0) as engagement_rate,\n  ya.views,\n  rm.created_at as published_at\nFROM render_metadata rm\nJOIN youtube_analytics ya ON rm.youtube_video_id = ya.video_id\nWHERE ya.recorded_at > NOW() - INTERVAL '{{ $node[\"ğŸ”§ åˆæœŸåŒ–\"].json.time_window_hours }} hours'\n  AND ya.views >= {{ $node[\"ğŸ”§ åˆæœŸåŒ–\"].json.min_views_for_evaluation }}\n  AND NOT EXISTS (\n    SELECT 1 FROM sentinel_tasks st \n    WHERE st.video_id = rm.render_id \n    AND st.status IN ('pending', 'processing')\n    AND st.created_at > NOW() - INTERVAL '24 hours'\n  )\nORDER BY ya.ctr ASC\nLIMIT 100",
        "options": {}
      },
      "id": "get-videos",
      "name": "ğŸ“Š å‹•ç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT channel_id, AVG(ctr) as ctr, AVG(retention_rate) as retention_rate, AVG((likes + comments * 2) / NULLIF(views, 0)) as engagement_rate FROM youtube_analytics WHERE recorded_at > NOW() - INTERVAL '30 days' GROUP BY channel_id",
        "options": {}
      },
      "id": "get-channel-averages",
      "name": "ğŸ“ˆ ãƒãƒ£ãƒ³ãƒãƒ«å¹³å‡å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $node['ğŸ”§ åˆæœŸåŒ–'].json;\nconst rules = $node['ğŸ“‹ ãƒ«ãƒ¼ãƒ«å–å¾—'].json || [];\nconst videos = $node['ğŸ“Š å‹•ç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å–å¾—'].json || [];\nconst channelAvgsRaw = $node['ğŸ“ˆ ãƒãƒ£ãƒ³ãƒãƒ«å¹³å‡å–å¾—'].json || [];\n\nif (!Array.isArray(videos) || videos.length === 0) {\n  return [{ json: { skip: true, reason: 'è©•ä¾¡å¯¾è±¡ã®å‹•ç”»ãªã—' } }];\n}\n\n// ãƒãƒ£ãƒ³ãƒãƒ«å¹³å‡ã‚’Mapã«å¤‰æ›\nconst channelAvgs = new Map();\nfor (const avg of (Array.isArray(channelAvgsRaw) ? channelAvgsRaw : [channelAvgsRaw])) {\n  if (avg?.channel_id) {\n    channelAvgs.set(avg.channel_id, avg);\n  }\n}\n\n// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹³å‡\nconst defaultAvg = { ctr: 0.05, retention_rate: 0.4, engagement_rate: 0.05 };\n\n// ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦è©•ä¾¡\nconst tasks = [];\nconst rulesArray = Array.isArray(rules) ? rules : [rules];\nconst videosArray = Array.isArray(videos) ? videos : [videos];\n\nfor (const video of videosArray) {\n  const chAvg = channelAvgs.get(video.channel_id) || defaultAvg;\n  \n  for (const rule of rulesArray) {\n    if (!rule?.conditions) continue;\n    \n    const conditions = typeof rule.conditions === 'string' ? JSON.parse(rule.conditions) : rule.conditions;\n    const metric = video[conditions.metric];\n    if (metric === undefined || metric === null) continue;\n    \n    // é–¾å€¤è¨ˆç®—\n    let threshold = conditions.threshold;\n    if (conditions.comparison === 'channel_average') {\n      threshold = (chAvg[conditions.metric] || defaultAvg[conditions.metric]) * conditions.threshold;\n    }\n    \n    // æ¡ä»¶ãƒã‚§ãƒƒã‚¯\n    let triggered = false;\n    if (conditions.operator === 'lt' && metric < threshold) triggered = true;\n    if (conditions.operator === 'gt' && metric > threshold) triggered = true;\n    \n    if (triggered && video.views >= conditions.min_views) {\n      // è‡ªä¿¡åº¦è¨ˆç®—\n      const diff = Math.abs(metric - threshold);\n      const confidence = Math.min(0.5 + (diff / Math.max(threshold, 0.01)) * 2, 0.99);\n      \n      tasks.push({\n        task_type: rule.action_type,\n        channel_id: video.channel_id,\n        video_id: video.video_id,\n        task_data: {\n          rule_id: rule.id,\n          rule_name: rule.rule_name,\n          metric_name: conditions.metric,\n          metric_value: metric,\n          threshold: threshold\n        },\n        ai_decision: {\n          action: rule.action_type,\n          confidence: confidence,\n          reasoning: `${conditions.metric}ãŒ${(metric * 100).toFixed(2)}%ã§é–¾å€¤${(threshold * 100).toFixed(2)}%ã‚’ä¸‹å›ã‚Š`,\n          parameters: typeof rule.action_params === 'string' ? JSON.parse(rule.action_params) : rule.action_params\n        },\n        priority: confidence > 0.85 ? 3 : confidence > 0.7 ? 5 : 7,\n        requires_human_review: confidence < config.human_review_threshold\n      });\n    }\n  }\n}\n\n// å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šé™ã¾ã§\ntasks.sort((a, b) => a.priority - b.priority);\nconst selectedTasks = tasks.slice(0, config.max_tasks_per_run);\n\nreturn selectedTasks.length > 0 \n  ? selectedTasks.map(t => ({ json: t }))\n  : [{ json: { skip: true, reason: 'å¯¾è±¡ã‚¿ã‚¹ã‚¯ãªã—' } }];"
      },
      "id": "evaluate",
      "name": "ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip-check",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO sentinel_tasks (\n  task_type,\n  channel_id,\n  video_id,\n  task_data,\n  ai_decision,\n  priority,\n  status,\n  requires_human_review,\n  created_at\n) VALUES (\n  $1, $2, $3, $4::jsonb, $5::jsonb, $6,\n  CASE WHEN $7 THEN 'human_review' ELSE 'pending' END,\n  $7, NOW()\n) RETURNING id",
        "options": {
          "queryParams": "={{ [$json.task_type, $json.channel_id, $json.video_id, JSON.stringify($json.task_data), JSON.stringify($json.ai_decision), $json.priority, $json.requires_human_review] }}"
        }
      },
      "id": "create-task",
      "name": "ğŸ’¾ ã‚¿ã‚¹ã‚¯ä½œæˆ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "auto-approve",
              "leftValue": "={{ !$node['ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡'].json.requires_human_review }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-auto-approve",
      "name": "è‡ªå‹•æ‰¿èªï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL }}/webhook/execute-sentinel-task",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ task_id: $node['ğŸ’¾ ã‚¿ã‚¹ã‚¯ä½œæˆ'].json[0]?.id || $node['ğŸ’¾ ã‚¿ã‚¹ã‚¯ä½œæˆ'].json.id, action: $node['ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡'].json.ai_decision.action, parameters: $node['ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡'].json.ai_decision.parameters }) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "execute-task",
      "name": "ğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡ã®é€šçŸ¥\nconst task = $node['ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡'].json;\nreturn [{ json: { ...task, status: 'awaiting_human_review' } }];"
      },
      "id": "await-human",
      "name": "â³ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst summary = {\n  total_tasks: items.length,\n  auto_approved: items.filter(i => !i.json.requires_human_review && !i.json.skip).length,\n  human_review: items.filter(i => i.json.requires_human_review).length,\n  skipped: items.filter(i => i.json.skip).length,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: summary }];"
      },
      "id": "summarize",
      "name": "ğŸ“Š çµæœé›†è¨ˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "string",
        "body": "=[info][title]ğŸ¤– Sentinel AI ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ[/title]æ¤œå‡ºã‚¿ã‚¹ã‚¯: {{ $json.total_tasks }}ä»¶\n\nâœ… è‡ªå‹•å®Ÿè¡Œ: {{ $json.auto_approved }}ä»¶\nğŸ‘¤ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡: {{ $json.human_review }}ä»¶\nâ­ï¸ ã‚¹ã‚­ãƒƒãƒ—: {{ $json.skipped }}ä»¶\n\næ¬¡å›å®Ÿè¡Œ: 4æ™‚é–“å¾Œ[/info]",
        "options": {}
      },
      "id": "notify",
      "name": "ğŸ“¢ ChatWorké€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "chatwork-api",
          "name": "ChatWork API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 4æ™‚é–“ã”ã¨": {
      "main": [
        [
          {
            "node": "ğŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒ«ãƒ¼ãƒ«å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“Š å‹•ç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“ˆ ãƒãƒ£ãƒ³ãƒãƒ«å¹³å‡å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ãƒ«ãƒ¼ãƒ«å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š å‹•ç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ãƒãƒ£ãƒ³ãƒãƒ«å¹³å‡å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡": {
      "main": [
        [
          {
            "node": "ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ã‚¿ã‚¹ã‚¯ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“Š çµæœé›†è¨ˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ã‚¿ã‚¹ã‚¯ä½œæˆ": {
      "main": [
        [
          {
            "node": "è‡ªå‹•æ‰¿èªï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è‡ªå‹•æ‰¿èªï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â³ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ğŸ“Š çµæœé›†è¨ˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡": {
      "main": [
        [
          {
            "node": "ğŸ“Š çµæœé›†è¨ˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š çµæœé›†è¨ˆ": {
      "main": [
        [
          {
            "node": "ğŸ“¢ ChatWorké€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¢ ChatWorké€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "meta": {
    "instanceId": "n3-empire-os"
  },
  "tags": [
    {
      "id": "sentinel",
      "name": "Sentinel AI"
    },
    {
      "id": "media",
      "name": "ãƒ¡ãƒ‡ã‚£ã‚¢"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ]
}