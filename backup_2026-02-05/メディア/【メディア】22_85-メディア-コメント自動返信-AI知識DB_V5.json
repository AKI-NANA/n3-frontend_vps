{
  "name": "ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€‘22_85-ãƒ¡ãƒ‡ã‚£ã‚¢-ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•è¿”ä¿¡-AIçŸ¥è­˜DB_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      },
      "id": "schedule",
      "name": "â° 2æ™‚é–“ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "comment-reply",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: comment-reply",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "comment-reply"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT yt.channel_id, yt.access_token, yt.refresh_token, mc.channel_name FROM youtube_tokens yt JOIN media_channels mc ON yt.channel_id = mc.channel_id WHERE yt.is_active = TRUE AND mc.is_active = TRUE",
        "options": {}
      },
      "id": "get-channels",
      "name": "ðŸ“º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const channels = $input.first().json || [];\nconst channelList = Array.isArray(channels) ? channels : [channels].filter(c => c && c.channel_id);\nreturn channelList.map(c => ({ json: c }));"
      },
      "id": "split-channels",
      "name": "ðŸ“‹ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.googleapis.com/youtube/v3/commentThreads",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "part",
              "value": "snippet"
            },
            {
              "name": "allThreadsRelatedToChannelId",
              "value": "={{ $json.channel_id }}"
            },
            {
              "name": "maxResults",
              "value": "50"
            },
            {
              "name": "moderationStatus",
              "value": "published"
            },
            {
              "name": "order",
              "value": "time"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-comments",
      "name": "ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const channelData = $node['ðŸ“‹ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²'].json;\nconst commentsResult = $input.first().json;\nconst items = commentsResult?.items || [];\n\nconst comments = items.map(item => {\n  const snippet = item.snippet?.topLevelComment?.snippet || {};\n  return {\n    comment_id: item.id,\n    video_id: snippet.videoId,\n    channel_id: channelData.channel_id,\n    author_name: snippet.authorDisplayName,\n    author_channel_id: snippet.authorChannelId?.value,\n    comment_text: snippet.textDisplay,\n    published_at: snippet.publishedAt\n  };\n});\n\n// è³ªå•ã£ã½ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿\nconst questionKeywords = ['?', 'ï¼Ÿ', 'ã©ã†', 'ãªãœ', 'ã©ã“', 'æ•™ãˆã¦', 'ã‚ã‹ã‚‰ãªã„', 'é•ã„', 'æ¯”è¼ƒ'];\nconst questions = comments.filter(c => \n  questionKeywords.some(k => c.comment_text.includes(k))\n);\n\nreturn questions.map(q => ({ json: q }));"
      },
      "id": "parse-comments",
      "name": "ðŸ“‹ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM comment_automation WHERE comment_id = $1",
        "options": {
          "queryParams": "={{ [$json.comment_id] }}"
        }
      },
      "id": "check-existing",
      "name": "ðŸ” æ—¢å­˜ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const comment = $node['ðŸ“‹ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ãƒ¼ã‚¹'].json;\nconst existing = $input.first().json;\nconst exists = Array.isArray(existing) ? existing.length > 0 : !!existing?.id;\n\nif (exists) {\n  return [{ json: { skip: true, reason: 'æ—¢ã«å‡¦ç†æ¸ˆã¿' } }];\n}\n\nreturn [{ json: { ...comment, skip: false } }];"
      },
      "id": "filter-new",
      "name": "ðŸ“‹ æ–°è¦ãƒ•ã‚£ãƒ«ã‚¿",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM knowledge_blocks WHERE fact_check_status = 'verified' AND $1 ILIKE ANY(keywords) ORDER BY gemini_confidence DESC LIMIT 3",
        "options": {
          "queryParams": "={{ ['%' + $json.comment_text.split(' ').slice(0, 3).join('%') + '%'] }}"
        }
      },
      "id": "search-knowledge",
      "name": "ðŸ§  çŸ¥è­˜DBæ¤œç´¢",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-goog-api-key",
              "value": "={{ $env.GEMINI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: `YouTubeã‚³ãƒ¡ãƒ³ãƒˆã¸ã®è¿”ä¿¡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\nã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘\n${$node['ðŸ“‹ æ–°è¦ãƒ•ã‚£ãƒ«ã‚¿'].json.comment_text}\n\nã€å‚è€ƒçŸ¥è­˜ã€‘\n${($input.first().json || []).slice(0, 2).map(k => k.layer1_summary || '').join('\\n')}\n\nã€æ¡ä»¶ã€‘\n- ä¸å¯§ã§è¦ªåˆ‡ãªå£èª¿\n- 100æ–‡å­—ä»¥å†…\n- çµµæ–‡å­—ã¯1ã¤ã¾ã§\n- ã€Œãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ã€ã®æŠ¼ã—å£²ã‚Šã¯ã—ãªã„\n\nè¿”ä¿¡æ–‡ã®ã¿å‡ºåŠ›:` }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 256 } }) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "generate-reply",
      "name": "âœ¨ AIè¿”ä¿¡ç”Ÿæˆ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const comment = $node['ðŸ“‹ æ–°è¦ãƒ•ã‚£ãƒ«ã‚¿'].json;\nconst geminiResult = $input.first().json;\n\nlet reply = '';\ntry {\n  reply = geminiResult?.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  reply = reply.trim().substring(0, 500);\n} catch (e) {\n  reply = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ ðŸ˜Š';\n}\n\nreturn [{\n  json: {\n    ...comment,\n    ai_response: reply,\n    confidence_score: reply.length > 20 ? 0.8 : 0.5,\n    requires_approval: true  // æœ¬ç•ªã§ã¯æ‰¿èªãƒ•ãƒ­ãƒ¼\n  }\n}];"
      },
      "id": "parse-reply",
      "name": "ðŸ“‹ è¿”ä¿¡ãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO comment_automation (platform, video_id, comment_id, author_name, author_channel_id, comment_text, published_at, intent, ai_response, confidence_score, requires_approval, response_status) VALUES ('youtube', $1, $2, $3, $4, $5, $6, 'question', $7, $8, $9, 'pending') ON CONFLICT (comment_id) DO NOTHING RETURNING id",
        "options": {
          "queryParams": "={{ [$json.video_id, $json.comment_id, $json.author_name, $json.author_channel_id, $json.comment_text, $json.published_at, $json.ai_response, $json.confidence_score, $json.requires_approval] }}"
        }
      },
      "id": "save-reply",
      "name": "ðŸ’¾ è¿”ä¿¡ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, action: 'comment_reply', message: 'ã‚³ãƒ¡ãƒ³ãƒˆè¿”ä¿¡å‡¦ç†å®Œäº†' } }];"
      },
      "id": "format-response",
      "name": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 2æ™‚é–“ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ðŸ“º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: comment-reply": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒãƒ£ãƒ³ãƒãƒ«åˆ†å‰²": {
      "main": [
        [
          {
            "node": "ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ðŸ” æ—¢å­˜ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” æ—¢å­˜ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ðŸ“‹ æ–°è¦ãƒ•ã‚£ãƒ«ã‚¿",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ æ–°è¦ãƒ•ã‚£ãƒ«ã‚¿": {
      "main": [
        [
          {
            "node": "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ§  çŸ¥è­˜DBæ¤œç´¢",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ§  çŸ¥è­˜DBæ¤œç´¢": {
      "main": [
        [
          {
            "node": "âœ¨ AIè¿”ä¿¡ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ¨ AIè¿”ä¿¡ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ è¿”ä¿¡ãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ è¿”ä¿¡ãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ðŸ’¾ è¿”ä¿¡ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ è¿”ä¿¡ä¿å­˜": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ“º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Media",
      "color": "#e74c3c"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Comment",
      "color": "#1abc9c"
    },
    {
      "name": "Auto",
      "color": "#27ae60"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}