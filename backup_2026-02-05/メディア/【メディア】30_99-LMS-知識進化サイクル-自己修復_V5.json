{
  "name": "ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€‘30_99-LMS-çŸ¥è­˜é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«-è‡ªå·±ä¿®å¾©_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "schedule",
      "name": "â° 12æ™‚é–“ã”ã¨å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "knowledge-evolution",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: knowledge-evolution",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "knowledge-evolution"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json || {};\nreturn [{ json: { topic_code: body.topic_code, accuracy_threshold: body.accuracy_threshold || 0.4, min_attempts: body.min_attempts || 20, timestamp: new Date().toISOString() } }];"
      },
      "id": "init",
      "name": "ğŸ”§ åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT q.id as question_id, q.question_code, q.category, q.subcategory, q.global_accuracy_rate, q.total_attempts, q.keywords, kb.id as knowledge_id, kb.core_fact, kb.detailed_explanation FROM questions q LEFT JOIN knowledge_blocks kb ON q.category = kb.category AND q.subcategory = kb.topic WHERE q.is_active = TRUE AND q.global_accuracy_rate < $1 AND q.total_attempts >= $2 AND q.needs_improvement = FALSE AND NOT EXISTS (SELECT 1 FROM knowledge_evolution_history keh WHERE keh.topic_code = q.question_code AND keh.evolution_status IN ('pending', 'processing')) AND ($3 IS NULL OR q.question_code = $3) ORDER BY q.global_accuracy_rate ASC LIMIT 10",
        "options": {
          "queryParams": "={{ [$json.accuracy_threshold, $json.min_attempts, $json.topic_code] }}"
        }
      },
      "id": "get-low-accuracy",
      "name": "ğŸ“Š ä½æ­£ç­”ç‡ãƒˆãƒ”ãƒƒã‚¯å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const topics = $input.first().json || [];\nconst topicList = Array.isArray(topics) ? topics : [topics].filter(t => t && t.question_id);\nif (topicList.length === 0) return [{ json: { skip: true, reason: 'é€²åŒ–å¯¾è±¡ãªã—' } }];\nreturn topicList.map(t => ({ json: { ...t, skip: false } }));"
      },
      "id": "filter-topics",
      "name": "ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "å‡¦ç†ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-api-key",
              "value": "={{ $env.ANTHROPIC_API_KEY }}"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'claude-3-5-sonnet-20241022', max_tokens: 2048, messages: [{ role: 'user', content: `ã‚ãªãŸã¯æ•™è‚²ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ”¹å–„å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒˆãƒ”ãƒƒã‚¯ã¯æ­£ç­”ç‡ãŒä½ãã€è§£èª¬ã®æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚\n\nã€å•é¡Œã‚³ãƒ¼ãƒ‰ã€‘${$json.question_code}\nã€ã‚«ãƒ†ã‚´ãƒªã€‘${$json.category} / ${$json.subcategory || ''}\nã€ç¾åœ¨ã®æ­£ç­”ç‡ã€‘${($json.global_accuracy_rate * 100).toFixed(1)}%ï¼ˆ${$json.total_attempts}å›è©¦è¡Œï¼‰\n\nã€ç¾åœ¨ã®è§£èª¬ã€‘\n${$json.detailed_explanation || 'è§£èª¬ãªã—'}\n\nã€æ”¹å–„æŒ‡ç¤ºã€‘\n1. ã‚ˆã‚Šå™›ã¿ç •ã„ãŸè¡¨ç¾ã«æ›¸ãæ›ãˆã‚‹\n2. å…·ä½“ä¾‹ã‚’2ã¤ä»¥ä¸Šè¿½åŠ \n3. ã‚ˆãã‚ã‚‹èª¤è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ˜ç¤º\n4. å›³è§£ã®ææ¡ˆï¼ˆãƒ•ãƒ­ãƒ¼å›³ã¾ãŸã¯æ¯”è¼ƒè¡¨ï¼‰\n5. è¨˜æ†¶ã«æ®‹ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¿½åŠ \n\nã€å‡ºåŠ›å½¢å¼ã€‘JSONã®ã¿\n{\n  \"evolved_explanation\": \"æ”¹å–„ã•ã‚ŒãŸè§£èª¬æ–‡\",\n  \"key_examples\": [\"ä¾‹1\", \"ä¾‹2\"],\n  \"common_mistakes\": [\"ã‚ˆãã‚ã‚‹èª¤è§£1\"],\n  \"suggested_diagram\": {\"type\": \"flowchart\", \"elements\": []},\n  \"memorable_phrase\": \"è¦šãˆã‚„ã™ã„ãƒ•ãƒ¬ãƒ¼ã‚º\",\n  \"evolution_summary\": \"æ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆ\"\n}` }] }) }}",
        "options": {
          "timeout": 90000
        }
      },
      "id": "ai-evolve",
      "name": "ğŸ§  AIé€²åŒ–",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const topic = $node['ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿'].json;\nconst claudeResult = $input.first().json;\n\nlet evolvedData = { evolved_explanation: '', evolution_summary: 'AIç”Ÿæˆå¤±æ•—' };\n\ntry {\n  const content = claudeResult?.content?.[0]?.text || '';\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) evolvedData = JSON.parse(jsonMatch[0]);\n} catch (e) {}\n\nreturn [{ json: { ...topic, ...evolvedData } }];"
      },
      "id": "parse-evolution",
      "name": "ğŸ“‹ é€²åŒ–ãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO knowledge_evolution_history (topic_code, category, trigger_type, trigger_accuracy_rate, trigger_sample_size, original_content, evolved_content, evolution_type, ai_model_used, evolution_status) VALUES ($1, $2, 'low_accuracy', $3, $4, $5, $6, 'simplify', 'claude-3.5-sonnet', 'completed') RETURNING id, evolution_id",
        "options": {
          "queryParams": "={{ [$json.question_code, $json.category, $json.global_accuracy_rate, $json.total_attempts, $json.detailed_explanation || '', $json.evolved_explanation] }}"
        }
      },
      "id": "save-evolution",
      "name": "ğŸ’¾ é€²åŒ–å±¥æ­´ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE questions SET needs_improvement = TRUE, updated_at = NOW() WHERE question_code = $1",
        "options": {
          "queryParams": "={{ [$json.question_code] }}"
        }
      },
      "id": "flag-question",
      "name": "ğŸš© ãƒ•ãƒ©ã‚°æ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $env.CHATWORK_WEBHOOK_URL || 'https://api.chatwork.com/v2/rooms/' + $env.CHATWORK_ROOM_ID + '/messages' }}",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "ğŸ“š ã€çŸ¥è­˜é€²åŒ–å®Œäº†ã€‘\n\nãƒˆãƒ”ãƒƒã‚¯: {{ $json.question_code }}\nå…ƒã®æ­£ç­”ç‡: {{ ($json.global_accuracy_rate * 100).toFixed(1) }}%\n\næ”¹å–„ãƒã‚¤ãƒ³ãƒˆ: {{ $json.evolution_summary }}\n\nå‹•ç”»å†ç”Ÿæˆã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸã€‚"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify",
      "name": "ğŸ“¢ é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, action: 'knowledge_evolution', message: 'çŸ¥è­˜é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«å®Œäº†' } }];"
      },
      "id": "format-response",
      "name": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ğŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ğŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ğŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ğŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ğŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ğŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 12æ™‚é–“ã”ã¨å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ğŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: knowledge-evolution": {
      "main": [
        [
          {
            "node": "ğŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ğŸ“Š ä½æ­£ç­”ç‡ãƒˆãƒ”ãƒƒã‚¯å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š ä½æ­£ç­”ç‡ãƒˆãƒ”ãƒƒã‚¯å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿": {
      "main": [
        [
          {
            "node": "å‡¦ç†ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡¦ç†ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ§  AIé€²åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  AIé€²åŒ–": {
      "main": [
        [
          {
            "node": "ğŸ“‹ é€²åŒ–ãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ é€²åŒ–ãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ğŸ’¾ é€²åŒ–å±¥æ­´ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ é€²åŒ–å±¥æ­´ä¿å­˜": {
      "main": [
        [
          {
            "node": "ğŸš© ãƒ•ãƒ©ã‚°æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš© ãƒ•ãƒ©ã‚°æ›´æ–°": {
      "main": [
        [
          {
            "node": "ğŸ“¢ é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¢ é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ğŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300
  },
  "tags": [
    {
      "name": "N3-LMS",
      "color": "#3498db"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Evolution",
      "color": "#9b59b6"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}