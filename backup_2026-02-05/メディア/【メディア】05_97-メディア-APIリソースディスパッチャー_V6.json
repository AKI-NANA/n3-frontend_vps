{
  "name": "ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€‘05_97-ãƒ¡ãƒ‡ã‚£ã‚¢-APIãƒªã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼_V6",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "schedule",
      "name": "â° 6æ™‚é–“æ¯å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api-resource-dispatch-v6",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: dispatch-v6",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "api-resource-dispatch-v6"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N3-97 V6: APIãƒªã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ - ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ã‚¿ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼\n// GeminiæŒ‡ç¤º: api_quota_usageãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã—ã€æœ€ã‚‚ä½™è£•ã®ã‚ã‚‹APIã‚­ãƒ¼ã‚’å‹•çš„é¸æŠ\n// ============================================================================\n\nconst apiUrl = $env.N3_API_URL || $env.API_BASE_URL;\n\nif (!apiUrl) {\n  return [{ json: { error: true, message: 'N3_API_URLç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š', code: 'CONFIG_ERROR' } }];\n}\n\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst channelId = body.channel_id;\nconst serviceName = body.service_name; // elevenlabs, openai, gemini, anthropic, etc.\nconst requestType = body.request_type || 'voice_generation'; // voice_generation, video_render, ai_audit, etc.\nconst estimatedTokens = body.estimated_tokens || 1000;\nconst priority = body.priority || 'normal'; // low, normal, high, critical\nconst forceReevaluate = body.force_reevaluate || false;\n\nreturn [{\n  json: {\n    channel_id: channelId,\n    service_name: serviceName,\n    request_type: requestType,\n    estimated_tokens: estimatedTokens,\n    priority: priority,\n    force_reevaluate: forceReevaluate,\n    api_url: apiUrl,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT project_id, service_name, api_key_id, quota_limit, current_usage, (quota_limit - current_usage) as remaining_quota, ROUND(((quota_limit - current_usage)::numeric / NULLIF(quota_limit, 0)) * 100, 2) as remaining_percent, cost_per_unit, reset_at, priority_tier, CASE WHEN reset_at <= NOW() THEN 'reset_needed' WHEN (quota_limit - current_usage) < quota_limit * 0.1 THEN 'low' WHEN (quota_limit - current_usage) < quota_limit * 0.3 THEN 'medium' ELSE 'high' END as availability_status FROM api_quota_usage WHERE ($1::text IS NULL OR service_name = $1) AND (quota_limit - current_usage) > $2 ORDER BY CASE WHEN $3 = 'critical' THEN priority_tier ELSE remaining_percent END DESC, cost_per_unit ASC LIMIT 10",
        "options": {
          "queryParams": "={{ [$json.service_name || null, $json.estimated_tokens, $json.priority] }}"
        }
      },
      "id": "get-available-quotas",
      "name": "ğŸ“Š åˆ©ç”¨å¯èƒ½ã‚¯ã‚©ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ã‚¹ãƒãƒ¼ãƒˆAPIã‚­ãƒ¼é¸æŠãƒ­ã‚¸ãƒƒã‚¯\n// - æœ€ã‚‚ä½™è£•ã®ã‚ã‚‹ã‚­ãƒ¼ã‚’å„ªå…ˆ\n// - ã‚³ã‚¹ãƒˆåŠ¹ç‡ã‚‚è€ƒæ…®\n// - å„ªå…ˆåº¦ã«å¿œã˜ãŸé¸æŠ\n// ============================================================================\n\nconst initData = $node['ğŸ” åˆæœŸåŒ–'].json;\nconst quotas = $input.all().map(item => item.json);\n\nif (!quotas || quotas.length === 0) {\n  return [{\n    json: {\n      ...initData,\n      selected_key: null,\n      selection_status: 'no_available_quota',\n      message: 'åˆ©ç”¨å¯èƒ½ãªAPIã‚¯ã‚©ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',\n      fallback_action: 'queue_for_later'\n    }\n  }];\n}\n\n// é¸æŠåŸºæº–\n// 1. criticalå„ªå…ˆåº¦: æœ€ã‚‚å®¹é‡ã®å¤šã„ã‚­ãƒ¼\n// 2. highå„ªå…ˆåº¦: å®¹é‡ã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹\n// 3. normal/lowå„ªå…ˆåº¦: ã‚³ã‚¹ãƒˆå„ªå…ˆ\n\nlet selectedQuota;\n\nswitch (initData.priority) {\n  case 'critical':\n    // æœ€ã‚‚æ®‹é‡ã®å¤šã„ã‚­ãƒ¼ï¼ˆä¿¡é ¼æ€§é‡è¦–ï¼‰\n    selectedQuota = quotas[0];\n    break;\n  case 'high':\n    // æ®‹é‡30%ä»¥ä¸Šã§æœ€ã‚‚ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ã‚­ãƒ¼\n    selectedQuota = quotas.find(q => q.remaining_percent >= 30) || quotas[0];\n    break;\n  case 'normal':\n  case 'low':\n  default:\n    // æ®‹é‡10%ä»¥ä¸Šã§æœ€ã‚‚ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ã‚­ãƒ¼\n    selectedQuota = quotas.find(q => q.remaining_percent >= 10 && q.cost_per_unit) || quotas[0];\n    break;\n}\n\n// é¸æŠç†ç”±ã®è¨˜éŒ²\nconst selectionReason = {\n  priority: initData.priority,\n  selected_by: initData.priority === 'critical' ? 'max_remaining' : 'cost_efficiency',\n  alternatives_count: quotas.length - 1,\n  total_remaining_across_keys: quotas.reduce((sum, q) => sum + (q.remaining_quota || 0), 0)\n};\n\nreturn [{\n  json: {\n    ...initData,\n    selected_key: {\n      project_id: selectedQuota.project_id,\n      service_name: selectedQuota.service_name,\n      api_key_id: selectedQuota.api_key_id,\n      remaining_quota: selectedQuota.remaining_quota,\n      remaining_percent: selectedQuota.remaining_percent,\n      cost_per_unit: selectedQuota.cost_per_unit,\n      availability_status: selectedQuota.availability_status\n    },\n    selection_status: 'success',\n    selection_reason: selectionReason,\n    all_available_quotas: quotas.length\n  }\n}];"
      },
      "id": "smart-select",
      "name": "ğŸ¯ ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼é¸æŠ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-key",
              "leftValue": "={{ $json.selected_key }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "check-selection",
      "name": "é¸æŠæˆåŠŸï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE api_quota_usage SET current_usage = current_usage + $1, last_used_at = NOW(), usage_count = usage_count + 1 WHERE api_key_id = $2 AND service_name = $3 RETURNING api_key_id, current_usage, (quota_limit - current_usage) as new_remaining",
        "options": {
          "queryParams": "={{ [$json.estimated_tokens, $json.selected_key.api_key_id, $json.selected_key.service_name] }}"
        }
      },
      "id": "update-usage",
      "name": "ğŸ“ˆ ä½¿ç”¨é‡æ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO api_dispatch_logs (channel_id, service_name, api_key_id, request_type, estimated_tokens, priority, selection_reason, selected_at) VALUES ($1, $2, $3, $4, $5, $6, $7::jsonb, NOW()) RETURNING log_id",
        "options": {
          "queryParams": "={{ [$json.channel_id || null, $json.selected_key.service_name, $json.selected_key.api_key_id, $json.request_type, $json.estimated_tokens, $json.priority, JSON.stringify($json.selection_reason)] }}"
        }
      },
      "id": "log-dispatch",
      "name": "ğŸ“ ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ­ã‚°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst updateResult = $node['ğŸ“ˆ ä½¿ç”¨é‡æ›´æ–°'].json;\n\nreturn [{\n  json: {\n    success: true,\n    action: 'api_key_dispatched',\n    channel_id: data.channel_id,\n    service_name: data.selected_key.service_name,\n    dispatched_key: {\n      api_key_id: data.selected_key.api_key_id,\n      project_id: data.selected_key.project_id,\n      remaining_after_use: updateResult?.new_remaining || data.selected_key.remaining_quota - data.estimated_tokens\n    },\n    request_info: {\n      type: data.request_type,\n      estimated_tokens: data.estimated_tokens,\n      priority: data.priority\n    },\n    selection_reason: data.selection_reason,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "format-success",
      "name": "ğŸ“‹ æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// ã‚¯ã‚©ãƒ¼ã‚¿ä¸è¶³æ™‚ã®å¯¾å¿œç­–\nconst fallbackActions = {\n  queue_for_later: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã€ã‚¯ã‚©ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå¾Œã«å‡¦ç†',\n  downgrade_service: 'ä»£æ›¿ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹: ElevenLabsâ†’OpenAI TTSï¼‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n  alert_admin: 'ç®¡ç†è€…ã«ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡',\n  reject: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦'\n};\n\nreturn [{\n  json: {\n    success: false,\n    action: 'no_quota_available',\n    channel_id: data.channel_id,\n    service_name: data.service_name,\n    request_type: data.request_type,\n    estimated_tokens: data.estimated_tokens,\n    fallback_action: data.fallback_action || 'queue_for_later',\n    fallback_description: fallbackActions[data.fallback_action || 'queue_for_later'],\n    recommendation: 'Consider adding more API keys or waiting for quota reset',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "format-failure",
      "name": "âš ï¸ å¤±æ•—ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "output": "single"
      },
      "id": "merge-responses",
      "name": "ğŸ”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµ±åˆ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": "={{ $json.success ? 200 : 503 }}"
        }
      },
      "id": "respond",
      "name": "ğŸ“¤ å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ğŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ğŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ğŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ğŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ğŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ğŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "â° 6æ™‚é–“æ¯å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: dispatch-v6": {
      "main": [
        [
          {
            "node": "ğŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ğŸ“Š åˆ©ç”¨å¯èƒ½ã‚¯ã‚©ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š åˆ©ç”¨å¯èƒ½ã‚¯ã‚©ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ¯ ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼é¸æŠ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¯ ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼é¸æŠ": {
      "main": [
        [
          {
            "node": "é¸æŠæˆåŠŸï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é¸æŠæˆåŠŸï¼Ÿ": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ ä½¿ç”¨é‡æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âš ï¸ å¤±æ•—ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ ä½¿ç”¨é‡æ›´æ–°": {
      "main": [
        [
          {
            "node": "ğŸ“ ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ­ã‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ­ã‚°": {
      "main": [
        [
          {
            "node": "ğŸ“‹ æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "ğŸ”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµ±åˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš ï¸ å¤±æ•—ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "ğŸ”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµ±åˆ",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµ±åˆ": {
      "main": [
        [
          {
            "node": "ğŸ“¤ å¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 120,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Media",
      "color": "#9b59b6"
    },
    {
      "name": "V6-SmartQuota",
      "color": "#00ff00"
    },
    {
      "name": "API-Management",
      "color": "#e67e22"
    },
    {
      "name": "IronRule",
      "color": "#e74c3c"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false,
  "meta": {
    "description": "N3-97 V6 APIãƒªã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ - api_quota_usageãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ã§ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼é¸æŠ",
    "version": "6.0",
    "changelog": "2026-01-20: GeminiæŒ‡ç¤ºå®Ÿè£… - æœ€ã‚‚ä½™è£•ã®ã‚ã‚‹APIã‚­ãƒ¼ã‚’å‹•çš„é¸æŠ",
    "iron_rules_compliant": [
      "no_hardcoded_urls",
      "query_params_only",
      "no_crypto_require"
    ],
    "gemini_instructions": [
      "api_quota_dynamic_selection",
      "cost_efficiency_balance",
      "priority_based_routing"
    ]
  }
}