{
  "name": "ã€åŒæœŸã€‘02_å°‚ç”¨-å¿ƒè‡“éƒ¨-ç‚ºæ›¿è¨­å®šè‡ªå‹•åŒæœŸ_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "id": "gs-trigger",
      "name": "æ¯æ—¥AM9æ™‚ã«å®Ÿè¡Œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "https://open.er-api.com/v6/latest/USD",
        "options": {
          "timeout": 15000
        }
      },
      "id": "fetch-rates",
      "name": "API: æœ€æ–°ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// V4-PRODUCTION: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç‚ºæ›¿åŒæœŸ\n// ========================================\nconst response = $input.first().json;\n\nif (!response.rates || !response.rates.JPY) {\n  return [{ json: { error: true, message: 'ç‚ºæ›¿APIå–å¾—å¤±æ•—' } }];\n}\n\nconst usdJpy = response.rates.JPY;\nconst eurJpy = response.rates.JPY / response.rates.EUR;\nconst gbpJpy = response.rates.JPY / response.rates.GBP;\nconst audJpy = response.rates.JPY / response.rates.AUD;\n\nreturn [{ json: {\n  usd_jpy: Math.round(usdJpy * 100) / 100,\n  eur_jpy: Math.round(eurJpy * 100) / 100,\n  gbp_jpy: Math.round(gbpJpy * 100) / 100,\n  aud_jpy: Math.round(audJpy * 100) / 100,\n  timestamp: new Date().toISOString(),\n  source: 'open.er-api.com'\n} }];"
      },
      "id": "parse-rates",
      "name": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]âŒ ç‚ºæ›¿APIå–å¾—å¤±æ•—[/title]ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã®è‡ªå‹•åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚[/info]"
            }
          ]
        }
      },
      "id": "alert-error",
      "name": "ã‚¨ãƒ©ãƒ¼é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT DISTINCT user_id FROM products_master WHERE user_id IS NOT NULL AND workflow_status IN ('approved', 'listed')",
        "options": {}
      },
      "id": "get-active-users",
      "name": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ç‚ºæ›¿è¨­å®šã‚’å±•é–‹\nconst rates = $node['ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè§£æ'].json;\nconst users = $input.all().map(i => i.json);\n\nif (!users || users.length === 0) {\n  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å‡¦ç†\n  return [{ json: { user_id: 'default', ...rates } }];\n}\n\nreturn users.map(u => ({ json: {\n  user_id: u.user_id || 'default',\n  usd_jpy: rates.usd_jpy,\n  eur_jpy: rates.eur_jpy,\n  gbp_jpy: rates.gbp_jpy,\n  aud_jpy: rates.aud_jpy,\n  timestamp: rates.timestamp\n} }));"
      },
      "id": "expand-users",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å±•é–‹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO global_settings (user_id, key, value, updated_at) VALUES ($1, 'exchange_rate_usd_jpy', $2, NOW()) ON CONFLICT (user_id, key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW(); INSERT INTO global_settings (user_id, key, value, updated_at) VALUES ($3, 'exchange_rate_eur_jpy', $4, NOW()) ON CONFLICT (user_id, key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW(); INSERT INTO global_settings (user_id, key, value, updated_at) VALUES ($5, 'exchange_rate_gbp_jpy', $6, NOW()) ON CONFLICT (user_id, key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW(); INSERT INTO global_settings (user_id, key, value, updated_at) VALUES ($7, 'exchange_rate_aud_jpy', $8, NOW()) ON CONFLICT (user_id, key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW();",
        "options": {
          "queryParams": "={{ [{{ $json.user_id }}, {{ $json.usd_jpy }}, {{ $json.user_id }}, {{ $json.eur_jpy }}, {{ $json.user_id }}, {{ $json.gbp_jpy }}, {{ $json.user_id }}, {{ $json.aud_jpy }}] }}"
        }
      },
      "id": "upsert-rates",
      "name": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆä¿å­˜ï¼ˆUPSERTï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\nconst rates = $node['ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè§£æ'].json;\n\nreturn [{ json: {\n  success: true,\n  updated_users: results.length,\n  rates: {\n    usd_jpy: rates.usd_jpy,\n    eur_jpy: rates.eur_jpy,\n    gbp_jpy: rates.gbp_jpy,\n    aud_jpy: rates.aud_jpy\n  },\n  timestamp: new Date().toISOString()\n} }];"
      },
      "id": "aggregate",
      "name": "çµæœé›†ç´„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM stock_sync_logs WHERE created_at < NOW() - INTERVAL '7 days'; DELETE FROM listing_history WHERE created_at < NOW() - INTERVAL '7 days'; DELETE FROM performance_snapshots WHERE snapshot_time < NOW() - INTERVAL '7 days';",
        "options": {}
      },
      "id": "purge-history",
      "name": "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè‡ªå‹•æ›´æ–°å®Œäº†[/title]USD/JPY: {{ $node['çµæœé›†ç´„'].json.rates.usd_jpy }}å††\\nEUR/JPY: {{ $node['çµæœé›†ç´„'].json.rates.eur_jpy }}å††\\nGBP/JPY: {{ $node['çµæœé›†ç´„'].json.rates.gbp_jpy }}å††\\nAUD/JPY: {{ $node['çµæœé›†ç´„'].json.rates.aud_jpy }}å††\\n\\næ›´æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: {{ $node['çµæœé›†ç´„'].json.updated_users }}[/info]"
            }
          ]
        }
      },
      "id": "notify-success",
      "name": "å®Œäº†é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "æ¯æ—¥AM9æ™‚ã«å®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "API: æœ€æ–°ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: æœ€æ–°ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆè§£æ": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å±•é–‹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å±•é–‹": {
      "main": [
        [
          {
            "node": "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆä¿å­˜ï¼ˆUPSERTï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆä¿å­˜ï¼ˆUPSERTï¼‰": {
      "main": [
        [
          {
            "node": "çµæœé›†ç´„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµæœé›†ç´„": {
      "main": [
        [
          {
            "node": "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—‘ï¸ å±¥æ­´ãƒ‘ãƒ¼ã‚¸ï¼ˆ7æ—¥è¶…ï¼‰": {
      "main": [
        [
          {
            "node": "å®Œäº†é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å®Œäº†é€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 180,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-Core",
      "color": "#ff0000"
    },
    {
      "name": "V4-PRODUCTION",
      "color": "#ff0000"
    },
    {
      "name": "Exchange",
      "color": "#ffd700"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "500MB-Safe",
      "color": "#32cd32"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}