{
  "name": "ã€çµŒç†ã€‘02_58-æ³•å‹™-å¤ç‰©å°å¸³è‡ªå‹•ç”Ÿæˆ_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "kobutsu-ledger",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: kobutsu-ledger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "kobutsu-ledger"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json || {};\nconst action = body.action || 'list'; // list, record_purchase, record_sale, export_pdf\nconst transactionType = body.transaction_type; // 'purchase', 'sale'\nconst productId = body.product_id;\nconst orderId = body.order_id;\nconst itemData = body.item_data || {};\nconst counterpartyData = body.counterparty_data || {};\nconst dateRange = body.date_range || {};\nreturn [{ json: { action, transaction_type: transactionType, product_id: productId, order_id: orderId, item_data: itemData, counterparty_data: counterpartyData, date_range: dateRange } }];"
      },
      "id": "init",
      "name": "ðŸ” åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "outputKey": "list",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "record",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "record_purchase",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "record",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "record_sale",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "export",
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ],
          "fallbackOutput": "list"
        }
      },
      "id": "switch-action",
      "name": "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM kobutsu_ledger WHERE ($1::date IS NULL OR transaction_date >= $1::date) AND ($2::date IS NULL OR transaction_date <= $2::date) ORDER BY ledger_number DESC LIMIT 200",
        "options": {
          "queryParams": "={{ [$node['ðŸ” åˆæœŸåŒ–'].json.date_range.start || null, $node['ðŸ” åˆæœŸåŒ–'].json.date_range.end || null] }}"
        }
      },
      "id": "list-ledger",
      "name": "ðŸ“‹ å°å¸³ä¸€è¦§",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.*, im.purchase_price FROM products_master pm LEFT JOIN inventory_master im ON pm.id = im.product_id WHERE pm.id = $1",
        "options": {
          "queryParams": "={{ [$node['ðŸ” åˆæœŸåŒ–'].json.product_id] }}"
        }
      },
      "id": "get-product",
      "name": "ðŸ“¦ å•†å“å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $node['ðŸ” åˆæœŸåŒ–'].json;\nconst productRaw = $input.first().json;\nconst product = Array.isArray(productRaw) ? productRaw[0] : productRaw;\n\nconst item = config.item_data;\nconst counterparty = config.counterparty_data;\nconst transactionType = config.action === 'record_purchase' ? 'purchase' : 'sale';\n\nconst ledgerEntry = {\n  transaction_type: transactionType,\n  item_category: item.category || product?.category_primary || 'é›‘è²¨',\n  item_name: item.name || product?.title || '',\n  item_brand: item.brand || product?.brand || '',\n  item_model: item.model || '',\n  item_serial_number: item.serial_number || '',\n  item_characteristics: item.characteristics || product?.condition_description || '',\n  quantity: item.quantity || 1,\n  unit_price: item.unit_price || product?.purchase_price || 0,\n  total_amount: (item.quantity || 1) * (item.unit_price || product?.purchase_price || 0),\n  counterparty_type: counterparty.type || 'business',\n  counterparty_name: counterparty.name || '',\n  counterparty_address: counterparty.address || '',\n  counterparty_phone: counterparty.phone || '',\n  counterparty_id_type: counterparty.id_type || '',\n  counterparty_id_number: counterparty.id_number || '',\n  product_id: config.product_id,\n  order_id: config.order_id\n};\n\nreturn [{ json: ledgerEntry }];"
      },
      "id": "prepare-entry",
      "name": "ðŸ“ å°å¸³ã‚¨ãƒ³ãƒˆãƒªæº–å‚™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO kobutsu_ledger (transaction_type, item_category, item_name, item_brand, item_model, item_serial_number, item_characteristics, quantity, unit_price, total_amount, counterparty_type, counterparty_name, counterparty_address, counterparty_phone, counterparty_id_type, counterparty_id_number, product_id, order_id) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18::uuid) RETURNING id, ledger_number",
        "options": {
          "queryParams": "={{ [$json.transaction_type, $json.item_category, $json.item_name, $json.item_brand, $json.item_model, $json.item_serial_number, $json.item_characteristics, $json.quantity, $json.unit_price, $json.total_amount, $json.counterparty_type, $json.counterparty_name, $json.counterparty_address, $json.counterparty_phone, $json.counterparty_id_type, $json.counterparty_id_number, $json.product_id, $json.order_id] }}"
        }
      },
      "id": "insert-ledger",
      "name": "ðŸ’¾ å°å¸³è¨˜éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT kl.*, gs_lic.setting_value as license_number, gs_auth.setting_value as license_authority FROM kobutsu_ledger kl CROSS JOIN (SELECT setting_value FROM global_settings WHERE setting_key = 'kobutsu_license_number') gs_lic CROSS JOIN (SELECT setting_value FROM global_settings WHERE setting_key = 'kobutsu_license_authority') gs_auth WHERE ($1::date IS NULL OR kl.transaction_date >= $1::date) AND ($2::date IS NULL OR kl.transaction_date <= $2::date) ORDER BY kl.ledger_number ASC",
        "options": {
          "queryParams": "={{ [$node['ðŸ” åˆæœŸåŒ–'].json.date_range.start || null, $node['ðŸ” åˆæœŸåŒ–'].json.date_range.end || null] }}"
        }
      },
      "id": "export-data",
      "name": "ðŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst entries = Array.isArray(data) ? data : (data?.id ? [data] : []);\n\nif (entries.length === 0) return [{ json: { error: true, message: 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ãªã—' } }];\n\nconst licenseNumber = entries[0]?.license_number || '';\nconst licenseAuthority = entries[0]?.license_authority || '';\n\n// CSVå½¢å¼ã§å‡ºåŠ›\nconst headers = ['å°å¸³ç•ªå·', 'å–å¼•æ—¥', 'å–å¼•åŒºåˆ†', 'å“ç›®', 'å“å', 'ãƒ–ãƒ©ãƒ³ãƒ‰', 'åž‹ç•ª', 'è£½é€ ç•ªå·', 'ç‰¹å¾´', 'æ•°é‡', 'å˜ä¾¡', 'é‡‘é¡', 'å–å¼•ç›¸æ‰‹åŒºåˆ†', 'å–å¼•ç›¸æ‰‹å', 'ä½æ‰€', 'é›»è©±', 'æœ¬äººç¢ºèªç¨®é¡ž', 'æœ¬äººç¢ºèªç•ªå·'];\nconst rows = entries.map(e => [\n  e.ledger_number,\n  e.transaction_date,\n  e.transaction_type === 'purchase' ? 'ä»•å…¥' : 'å£²å´',\n  e.item_category,\n  e.item_name,\n  e.item_brand || '',\n  e.item_model || '',\n  e.item_serial_number || '',\n  e.item_characteristics || '',\n  e.quantity,\n  e.unit_price,\n  e.total_amount,\n  e.counterparty_type === 'individual' ? 'å€‹äºº' : 'æ³•äºº',\n  e.counterparty_name || '',\n  e.counterparty_address || '',\n  e.counterparty_phone || '',\n  e.counterparty_id_type || '',\n  e.counterparty_id_number || ''\n].join(','));\n\nconst csv = [headers.join(','), ...rows].join('\\n');\n\nreturn [{ json: { success: true, license_number: licenseNumber, license_authority: licenseAuthority, entry_count: entries.length, csv_data: csv } }];"
      },
      "id": "generate-export",
      "name": "ðŸ“„ CSVç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "const action = $node['ðŸ” åˆæœŸåŒ–'].json.action;\nlet result = { success: true, action };\n\nif (action === 'list') {\n  const entries = $node['ðŸ“‹ å°å¸³ä¸€è¦§'].json;\n  result.entries = Array.isArray(entries) ? entries : (entries?.id ? [entries] : []);\n  result.count = result.entries.length;\n} else if (action === 'record_purchase' || action === 'record_sale') {\n  const inserted = $node['ðŸ’¾ å°å¸³è¨˜éŒ²'].json;\n  result.ledger_id = inserted?.id;\n  result.ledger_number = inserted?.ledger_number;\n} else if (action === 'export_pdf') {\n  const exported = $node['ðŸ“„ CSVç”Ÿæˆ'].json;\n  result = exported;\n}\n\nreturn [{ json: result }];"
      },
      "id": "format-response",
      "name": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "Webhook: kobutsu-ledger": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²": {
      "main": [
        [
          {
            "node": "ðŸ“‹ å°å¸³ä¸€è¦§",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¦ å•†å“å–å¾—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ å°å¸³ä¸€è¦§": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¦ å•†å“å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“ å°å¸³ã‚¨ãƒ³ãƒˆãƒªæº–å‚™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ å°å¸³ã‚¨ãƒ³ãƒˆãƒªæº–å‚™": {
      "main": [
        [
          {
            "node": "ðŸ’¾ å°å¸³è¨˜éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ å°å¸³è¨˜éŒ²": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“„ CSVç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“„ CSVç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ” åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 120,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Legal",
      "color": "#8e44ad"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Kobutsu",
      "color": "#2c3e50"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}