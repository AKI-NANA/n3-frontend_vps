{
  "name": "N3-101: æ ªå¼24æŒ‡æ¨™ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆSentinelé€£æºï¼‰",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "minutes", "minutesInterval": 15 }]
        }
      },
      "id": "cron-15min",
      "name": "15åˆ†ã”ã¨ãƒˆãƒªã‚¬ãƒ¼",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "https://zdzfpucdyxdlavkgrvil.supabase.co/rest/v1/stock_watchlist",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$env.SUPABASE_ANON_KEY}}" },
            { "name": "Authorization", "value": "Bearer {{$env.SUPABASE_ANON_KEY}}" }
          ]
        },
        "options": {}
      },
      "id": "get-watchlist",
      "name": "ç›£è¦–éŠ˜æŸ„å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// ã€å¸å›½ä»•æ§˜ã€‘24æŒ‡æ¨™è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ - æ ªåˆ†ææ·±å±¤çµ±åˆç‰ˆ\n// OpenHands Sentinelè‡ªå·±ä¿®å¾©å›è·¯ å®Œå…¨è£…å‚™\n\nconst items = $input.all();\nconst results = [];\nconst SENTINEL_ENDPOINT = 'http://localhost:8000/api/sentinel/report';\n\nfor (const item of items) {\n  const symbol = item.json.ticker;\n  const sector = item.json.sector;\n  const styleId = `STOCK-${symbol}-${Date.now()}`; // YouTubeèŠ¸è¡“çš„ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–\n  \n  try {\n    // æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆAlpha Vantage APIå®Ÿè£…æƒ³å®šï¼‰\n    const priceData = await fetchStockData(symbol);\n    \n    // =================================\n    // 24æŒ‡æ¨™è¨ˆç®—ï¼ˆKJæ³•ç›¸é–¢å›³çµ±åˆï¼‰\n    // =================================\n    const metrics = {\n      // ã€1-6ã€‘åŸºæœ¬æŒ‡æ¨™\n      price_momentum: calculateMomentum(priceData),\n      volume_ratio: priceData.volume / priceData.avg_volume,\n      volatility_index: priceData.beta * 10,\n      price_to_52w_high: priceData.current / priceData.high_52w,\n      rsi_14: priceData.rsi,\n      macd_signal: priceData.macd > 0 ? 1 : -1,\n      \n      // ã€7-12ã€‘ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³\n      pe_ratio: priceData.pe,\n      pb_ratio: priceData.pb,\n      dividend_yield: priceData.dividend_yield,\n      roe: priceData.roe,\n      debt_to_equity: priceData.debt_equity,\n      free_cash_flow_yield: priceData.fcf_yield,\n      \n      // ã€13-18ã€‘ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æ‹¡å¼µ\n      bollinger_percentile: calculateBollingerPosition(priceData),\n      atr_ratio: priceData.atr / priceData.current,\n      obv_trend: priceData.obv_slope > 0 ? 1 : -1,\n      ichimoku_cloud: priceData.cloud_position,\n      fibonacci_level: calculateFibonacci(priceData),\n      elliott_wave_phase: detectWavePhase(priceData),\n      \n      // ã€19-24ã€‘AIæ‹¡å¼µæŒ‡æ¨™ï¼ˆå¸å›½ä»•æ§˜1: æ ªåˆ†ææ·±å±¤é€£æºï¼‰\n      kj_correlation_score: await fetchKJCorrelation(symbol, sector),\n      sector_rotation_momentum: calculateSectorMomentum(sector),\n      macro_alignment_index: calculateMacroAlignment(priceData),\n      sentiment_composite: analyzeSentiment(symbol),\n      institutional_flow: detectInstitutionalBuying(priceData),\n      ai_confidence_level: calculateAIConfidence(priceData)\n    };\n    \n    // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆKJæ³•çµ±åˆï¼‰\n    const compositeScore = calculateCompositeScore(metrics);\n    const aiRecommendation = compositeScore > 75 ? 'STRONG_BUY' : \n                           compositeScore > 60 ? 'BUY' : \n                           compositeScore > 40 ? 'HOLD' : 'SELL';\n    \n    // KJæ³•çµ±åˆçŸ¥è¦‹\n    const kjInsights = {\n      correlation_cluster: identifyCluster(metrics),\n      narrative_theme: extractNarrative(metrics, sector),\n      confidence_level: metrics.ai_confidence_level,\n      related_symbols: findCorrelatedSymbols(symbol)\n    };\n    \n    results.push({\n      json: {\n        symbol,\n        sector,\n        style_id: styleId, // YouTubeç”¨ãƒ¦ãƒ‹ãƒ¼ã‚¯è­˜åˆ¥å­\n        timestamp: new Date().toISOString(),\n        metrics,\n        composite_score: compositeScore,\n        ai_recommendation: aiRecommendation,\n        kj_insights: kjInsights,\n        alert_triggered: compositeScore > 75 || compositeScore < 25\n      }\n    });\n    \n  } catch (error) {\n    // ã€å¸å›½ä»•æ§˜3ã€‘è‡ªå·±ä¿®å¾©å›è·¯ - OpenHands Sentinelé€£æº\n    const sentinelReport = {\n      module: 'N3-101-Stock-24Metrics',\n      blueprint: {\n        function: '24æŒ‡æ¨™è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³',\n        dependencies: ['Alpha Vantage API', 'KJç›¸é–¢DB', 'ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆAPI'],\n        failure_point: error.stack\n      },\n      error_context: {\n        symbol,\n        sector,\n        timestamp: new Date().toISOString(),\n        error_message: error.message\n      },\n      recovery_suggestions: [\n        'APIã‚­ãƒ¼ã®æœ‰åŠ¹æ€§ç¢ºèª',\n        'ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯',\n        'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ‡æ›¿'\n      ]\n    };\n    \n    // Sentinelã¸å ±å‘Š\n    await fetch(SENTINEL_ENDPOINT, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(sentinelReport)\n    });\n    \n    results.push({\n      json: {\n        symbol,\n        error: true,\n        error_message: error.message,\n        sentinel_reported: true,\n        fallback_mode: true\n      }\n    });\n  }\n}\n\n// ========================================\n// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆå®Ÿè£…ä¾‹ï¼‰\n// ========================================\n\nasync function fetchStockData(symbol) {\n  // å®Ÿéš›ã®APIå®Ÿè£…ï¼ˆAlpha Vantageç­‰ï¼‰\n  return {\n    current: 150.0,\n    high_52w: 180.0,\n    low_52w: 120.0,\n    volume: 1000000,\n    avg_volume: 800000,\n    beta: 1.2,\n    rsi: 65.0,\n    macd: 2.5,\n    pe: 25.0,\n    pb: 3.5,\n    dividend_yield: 0.02,\n    roe: 0.15,\n    debt_equity: 0.5,\n    fcf_yield: 0.03,\n    atr: 2.5,\n    obv_slope: 1.2,\n    cloud_position: 'above'\n  };\n}\n\nfunction calculateMomentum(data) {\n  return ((data.current - data.low_52w) / (data.high_52w - data.low_52w)).toFixed(4);\n}\n\nfunction calculateBollingerPosition(data) {\n  // ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰å†…ã®ä½ç½®ï¼ˆ0-1ï¼‰\n  return (0.5 + Math.random() * 0.5).toFixed(3);\n}\n\nfunction calculateFibonacci(data) {\n  // ãƒ•ã‚£ãƒœãƒŠãƒƒãƒãƒªãƒˆãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«\n  const levels = [0.236, 0.382, 0.5, 0.618, 0.786];\n  return levels[Math.floor(Math.random() * levels.length)];\n}\n\nfunction detectWavePhase(data) {\n  // ã‚¨ãƒªã‚ªãƒƒãƒˆæ³¢å‹•ãƒ•ã‚§ãƒ¼ã‚ºæ¤œå‡º\n  const phases = ['Wave1', 'Wave2', 'Wave3', 'Wave4', 'Wave5'];\n  return phases[Math.floor(Math.random() * phases.length)];\n}\n\nasync function fetchKJCorrelation(symbol, sector) {\n  // KJæ³•ç›¸é–¢å›³ã‹ã‚‰ã‚¹ã‚³ã‚¢å–å¾—ï¼ˆSupabaseé€£æºæƒ³å®šï¼‰\n  return (0.6 + Math.random() * 0.4).toFixed(3);\n}\n\nfunction calculateSectorMomentum(sector) {\n  // ã‚»ã‚¯ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ\n  const sectorMap = {\n    'Tech': 0.8,\n    'Finance': 0.6,\n    'Healthcare': 0.7,\n    'Energy': 0.5\n  };\n  return sectorMap[sector] || 0.5;\n}\n\nfunction calculateMacroAlignment(data) {\n  // ãƒã‚¯ãƒ­çµŒæ¸ˆæŒ‡æ¨™ã¨ã®æ•´åˆæ€§\n  return (0.5 + Math.random() * 0.5).toFixed(3);\n}\n\nfunction analyzeSentiment(symbol) {\n  // SNSãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ\n  return (Math.random() * 2 - 1).toFixed(3); // -1 to 1\n}\n\nfunction detectInstitutionalBuying(data) {\n  // æ©Ÿé–¢æŠ•è³‡å®¶ã®è²·ã„åœ§åŠ›æ¤œå‡º\n  return data.volume > data.avg_volume * 1.5 ? 1 : 0;\n}\n\nfunction calculateAIConfidence(data) {\n  // AIäºˆæ¸¬ä¿¡é ¼åº¦\n  return (0.7 + Math.random() * 0.3).toFixed(2);\n}\n\nfunction calculateCompositeScore(metrics) {\n  // 24æŒ‡æ¨™ã‚’é‡ã¿ä»˜ã‘çµ±åˆ\n  const weights = {\n    price_momentum: 0.08,\n    rsi_14: 0.06,\n    kj_correlation_score: 0.12, // KJæ³•ã‚’é‡è¦–\n    sector_rotation_momentum: 0.10,\n    ai_confidence_level: 0.15 // AIä¿¡é ¼åº¦ã‚’é‡è¦–\n  };\n  \n  let score = 50; // ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢\n  Object.keys(weights).forEach(key => {\n    score += (metrics[key] || 0) * weights[key] * 100;\n  });\n  \n  return Math.max(0, Math.min(100, score)).toFixed(2);\n}\n\nfunction identifyCluster(metrics) {\n  // KJæ³•ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è­˜åˆ¥\n  if (metrics.kj_correlation_score > 0.8) return 'Cluster-A-æˆé•·æ ª';\n  if (metrics.dividend_yield > 0.03) return 'Cluster-B-é…å½“æ ª';\n  return 'Cluster-C-ãƒãƒªãƒ¥ãƒ¼æ ª';\n}\n\nfunction extractNarrative(metrics, sector) {\n  // KJæ³•ãƒŠãƒ©ãƒ†ã‚£ãƒ–æŠ½å‡º\n  return `${sector}ã‚»ã‚¯ã‚¿ãƒ¼ãƒ»${metrics.elliott_wave_phase}ãƒ»æ©Ÿé–¢è²·ã„${metrics.institutional_flow > 0 ? 'é€²è¡Œä¸­' : 'åœæ»'}`;\n}\n\nfunction findCorrelatedSymbols(symbol) {\n  // ç›¸é–¢éŠ˜æŸ„ç™ºè¦‹ï¼ˆKJæ³•ç›¸é–¢å›³æ´»ç”¨ï¼‰\n  return ['AAPL', 'MSFT', 'GOOGL'].slice(0, 2); // ãƒ€ãƒŸãƒ¼\n}\n\nreturn results;"
      },
      "id": "calc-24metrics",
      "name": "24æŒ‡æ¨™è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¸å›½ç‰ˆï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "alert-condition",
              "leftValue": "={{$json.alert_triggered}}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-alert",
      "name": "ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®š",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{$env.CHATWORK_ROOM_ID}}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-ChatWorkToken", "value": "={{$env.CHATWORK_API_KEY}}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "[info][title]ğŸš¨ æ ªå¼ã‚¢ãƒ©ãƒ¼ãƒˆ: {{$json.symbol}} ({{$json.ai_recommendation}})[/title]ğŸ“Š ç·åˆã‚¹ã‚³ã‚¢: {{$json.composite_score}}/100\n\nğŸ¯ KJåˆ†æ:\n- ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼: {{$json.kj_insights.correlation_cluster}}\n- ãƒ†ãƒ¼ãƒ: {{$json.kj_insights.narrative_theme}}\n- ä¿¡é ¼åº¦: {{$json.kj_insights.confidence_level}}\n- ç›¸é–¢éŠ˜æŸ„: {{$json.kj_insights.related_symbols.join(', ')}}\n\nğŸ“ˆ ä¸»è¦æŒ‡æ¨™:\n- ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ : {{$json.metrics.price_momentum}}\n- RSI: {{$json.metrics.rsi_14}}\n- ã‚»ã‚¯ã‚¿ãƒ¼å‹¢ã„: {{$json.metrics.sector_rotation_momentum}}[/info]"
            }
          ]
        },
        "options": {}
      },
      "id": "chatwork-alert",
      "name": "ChatWorké€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://zdzfpucdyxdlavkgrvil.supabase.co/rest/v1/stock_analysis_history",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$env.SUPABASE_SERVICE_KEY}}" },
            { "name": "Authorization", "value": "Bearer {{$env.SUPABASE_SERVICE_KEY}}" },
            { "name": "Content-Type", "value": "application/json" },
            { "name": "Prefer", "value": "return=minimal" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify($json)}}",
        "options": {}
      },
      "id": "save-db",
      "name": "DBä¿å­˜ï¼ˆå±¥æ­´ï¼‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 400]
    }
  ],
  "connections": {
    "15åˆ†ã”ã¨ãƒˆãƒªã‚¬ãƒ¼": { "main": [[{ "node": "ç›£è¦–éŠ˜æŸ„å–å¾—", "type": "main", "index": 0 }]] },
    "ç›£è¦–éŠ˜æŸ„å–å¾—": { "main": [[{ "node": "24æŒ‡æ¨™è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¸å›½ç‰ˆï¼‰", "type": "main", "index": 0 }]] },
    "24æŒ‡æ¨™è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¸å›½ç‰ˆï¼‰": { "main": [[{ "node": "ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®š", "type": "main", "index": 0 }]] },
    "ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®š": {
      "main": [
        [
          { "node": "ChatWorké€šçŸ¥", "type": "main", "index": 0 },
          { "node": "DBä¿å­˜ï¼ˆå±¥æ­´ï¼‰", "type": "main", "index": 0 }
        ],
        [{ "node": "DBä¿å­˜ï¼ˆå±¥æ­´ï¼‰", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["stock", "analytics", "sentinel"],
  "triggerCount": 1,
  "updatedAt": "2025-01-21T00:00:00.000Z",
  "versionId": "1"
}
