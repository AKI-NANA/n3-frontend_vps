{
  "name": "ã€ãã®ä»–ã€‘07_161-ä»£è¡Œ-è‡ªå‹•ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚¹-BGM-ãƒ†ãƒ­ãƒƒãƒ—-æ¼”å‡ºæ³¨å…¥_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "partner-auto-produce",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: auto-produce",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "partner-auto-produce"
    },
    {
      "parameters": {
        "jsCode": "// é‰„ã®æŸæº–æ‹ ï¼šç’°å¢ƒå¤‰æ•°å¿…é ˆãƒã‚§ãƒƒã‚¯\nconst apiUrl = $env.N3_API_URL || $env.API_BASE_URL;\nconst remotionUrl = $env.REMOTION_API_URL;\n\nif (!apiUrl) {\n  return [{ json: { error: true, message: 'N3_API_URLç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®š', code: 'CONFIG_ERROR' } }];\n}\n\nconst body = $input.first().json.body || $input.first().json || {};\nconst uploadId = body.upload_id;\n\nif (!uploadId) {\n  return [{ json: { error: true, message: 'upload_id ã¯å¿…é ˆ', code: 'MISSING_PARAM' } }];\n}\n\nreturn [{\n  json: {\n    upload_id: uploadId,\n    api_url: apiUrl,\n    remotion_url: remotionUrl,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "init",
      "name": "ğŸ” åˆæœŸåŒ–ï¼ˆé‰„ã®æŸæº–æ‹ ï¼‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pu.upload_id, pu.partner_id, pu.video_url, pu.video_key, pu.analysis_result, pp.partner_name, pp.default_style, pp.channel_id, mc.persona_dna FROM partner_uploads pu JOIN partner_profiles pp ON pu.partner_id = pp.partner_id LEFT JOIN media_channels mc ON pp.channel_id = mc.channel_id WHERE pu.upload_id = $1 AND pu.status = 'pending_production'",
        "options": {
          "queryParams": "={{ [$json.upload_id] }}"
        }
      },
      "id": "get-upload",
      "name": "ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æƒ…å ±å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆè§£æçµæœã«åŸºã¥ãï¼‰\nconst initData = $node['ğŸ” åˆæœŸåŒ–ï¼ˆé‰„ã®æŸæº–æ‹ ï¼‰'].json;\nconst uploadData = $input.first().json;\n\nif (!uploadData || !uploadData.upload_id) {\n  return [{ json: { error: true, message: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', code: 'UPLOAD_NOT_FOUND' } }];\n}\n\nconst analysis = typeof uploadData.analysis_result === 'string' \n  ? JSON.parse(uploadData.analysis_result) \n  : uploadData.analysis_result || {};\n\nconst personaDna = typeof uploadData.persona_dna === 'string'\n  ? JSON.parse(uploadData.persona_dna)\n  : uploadData.persona_dna || {};\n\n// BGMé¸æŠãƒ­ã‚¸ãƒƒã‚¯\nconst bgmMap = {\n  'energetic': 'upbeat_pop',\n  'calm': 'ambient_chill',\n  'educational': 'light_corporate',\n  'entertaining': 'fun_quirky',\n  'neutral': 'soft_background'\n};\nconst recommendedBgm = bgmMap[analysis.recommended_bgm] || 'soft_background';\n\n// ãƒ†ãƒ­ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ\nconst styleMap = {\n  'professional': { font: 'NotoSansJP-Bold', color: '#333333', bg: '#FFFFFF' },\n  'casual': { font: 'RoundedMplus1c', color: '#FF6B6B', bg: '#FFF5F5' },\n  'tech': { font: 'SourceCodePro', color: '#00D4FF', bg: '#1A1A2E' },\n  'standard': { font: 'NotoSansJP-Medium', color: '#222222', bg: '#F5F5F5' }\n};\nconst telopStyle = styleMap[analysis.recommended_style] || styleMap['standard'];\n\n// æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰\nconst productionParams = {\n  bgm: {\n    track_id: recommendedBgm,\n    volume: 0.15,\n    ducking_enabled: true,\n    ducking_threshold: -20\n  },\n  telop: {\n    ...telopStyle,\n    animation: 'fade_slide',\n    duration_multiplier: 1.0\n  },\n  effects: {\n    intro_animation: true,\n    outro_animation: true,\n    transition_style: 'smooth_fade',\n    color_correction: analysis.quality_score < 7 ? 'enhance' : 'none'\n  },\n  persona: personaDna\n};\n\nreturn [{\n  json: {\n    ...initData,\n    ...uploadData,\n    analysis: analysis,\n    production_params: productionParams\n  }\n}];"
      },
      "id": "build-production",
      "name": "ğŸ¬ æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "url": "={{ $json.remotion_url || $env.REMOTION_API_URL }}/api/render",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.REMOTION_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"composition\": \"PartnerVideoProduction\",\n  \"inputProps\": {\n    \"sourceVideoUrl\": \"{{ $json.video_url }}\",\n    \"bgm\": {{ JSON.stringify($json.production_params.bgm) }},\n    \"telop\": {{ JSON.stringify($json.production_params.telop) }},\n    \"effects\": {{ JSON.stringify($json.production_params.effects) }},\n    \"persona\": {{ JSON.stringify($json.production_params.persona) }}\n  },\n  \"codec\": \"h264\",\n  \"imageFormat\": \"jpeg\"\n}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "remotion-render",
      "name": "ğŸ¥ Remotionãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE partner_uploads SET status = 'produced', production_params = $2::jsonb, produced_video_url = $3, produced_at = NOW(), updated_at = NOW() WHERE upload_id = $1",
        "options": {
          "queryParams": "={{ [$json.upload_id, JSON.stringify($node['ğŸ¬ æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰'].json.production_params), $json.outputUrl || ''] }}"
        }
      },
      "id": "update-status",
      "name": "ğŸ’¾ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const buildData = $node['ğŸ¬ æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰'].json;\nconst renderResult = $node['ğŸ¥ Remotionãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°'].json;\n\nreturn [{\n  json: {\n    success: true,\n    action: 'partner_video_produced',\n    upload_id: buildData.upload_id,\n    partner_id: buildData.partner_id,\n    partner_name: buildData.partner_name,\n    produced_video_url: renderResult.outputUrl || null,\n    production_params: buildData.production_params,\n    next_step: 'revenue_share_calculate',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "format-response",
      "name": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ğŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ğŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ğŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ğŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ğŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ğŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "Webhook: auto-produce": {
      "main": [
        [
          {
            "node": "ğŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” åˆæœŸåŒ–ï¼ˆé‰„ã®æŸæº–æ‹ ï¼‰": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æƒ…å ±å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æƒ…å ±å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ¬ æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¬ æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹ç¯‰": {
      "main": [
        [
          {
            "node": "ğŸ¥ Remotionãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¥ Remotionãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°": {
      "main": [
        [
          {
            "node": "ğŸ’¾ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°": {
      "main": [
        [
          {
            "node": "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ğŸ” åˆæœŸåŒ–ï¼ˆé‰„ã®æŸæº–æ‹ ï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 900,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Partner",
      "color": "#3498db"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "Remotion",
      "color": "#9b59b6"
    },
    {
      "name": "IronRule",
      "color": "#e74c3c"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false,
  "meta": {
    "description": "N3-161 è‡ªå‹•ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚¹ V5-PRODUCTION - BGM/ãƒ†ãƒ­ãƒƒãƒ—/æ¼”å‡ºã‚’è‡ªå‹•æ³¨å…¥â†’Remotionãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°",
    "version": "5.0",
    "changelog": "2026-01-20: é‰„ã®æŸæº–æ‹  - ç’°å¢ƒå¤‰æ•°å¿…é ˆåŒ–ã€è§£æçµæœã«åŸºã¥ãå‹•çš„æ¼”å‡ºé¸æŠ",
    "iron_rules_compliant": [
      "no_hardcoded_urls",
      "query_params_only",
      "no_crypto_require"
    ]
  }
}