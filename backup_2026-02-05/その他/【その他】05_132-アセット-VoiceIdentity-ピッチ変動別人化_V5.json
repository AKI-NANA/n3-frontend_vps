{
  "name": "ã€ãã®ä»–ã€‘05_132-ã‚¢ã‚»ãƒƒãƒˆ-VoiceIdentity-ãƒ”ãƒƒãƒå¤‰å‹•åˆ¥äººåŒ–_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "voice-identity-variation",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: voice-identity-variation",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "voice-identity-variation"
    },
    {
      "parameters": {
        "jsCode": "// Voice Identity Variation åˆæœŸåŒ–\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst channelId = body.channel_id;\nconst baseVoiceId = body.base_voice_id;\nconst text = body.text;\nconst useFixedSeed = body.use_fixed_seed !== false;\nconst customSeed = body.seed;\n\n// å¤‰å‹•ç¯„å›²è¨­å®š\nconst pitchRange = body.pitch_range || { min: -0.1, max: 0.1 }; // -10% ~ +10%\nconst speedRange = body.speed_range || { min: -0.05, max: 0.05 }; // -5% ~ +5%\nconst stabilityRange = body.stability_range || { min: -0.1, max: 0.1 };\n\nif (!text) {\n  return [{ json: { error: true, message: 'text ã¯å¿…é ˆã§ã™' } }];\n}\n\nif (!channelId && !baseVoiceId) {\n  return [{ json: { error: true, message: 'channel_id ã¾ãŸã¯ base_voice_id ãŒå¿…é ˆã§ã™' } }];\n}\n\nconst requestId = 'voice_' + Date.now();\n\nreturn [{\n  json: {\n    request_id: requestId,\n    channel_id: channelId,\n    base_voice_id: baseVoiceId,\n    text: text,\n    use_fixed_seed: useFixedSeed,\n    seed: customSeed,\n    pitch_range: pitchRange,\n    speed_range: speedRange,\n    stability_range: stabilityRange\n  }\n}];"
      },
      "id": "init",
      "name": "ðŸ”§ åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT vip.*, ev.voice_id as elevenlabs_voice_id FROM voice_identity_presets vip LEFT JOIN elevenlabs_voices ev ON vip.base_voice_id = ev.voice_id WHERE vip.channel_id = $1 AND vip.is_active = true LIMIT 1",
        "options": {
          "queryParams": "={{ [$json.channel_id] }}"
        }
      },
      "id": "fetch-preset",
      "name": "ðŸ“¥ ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å¤‰å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—\nconst request = $node['ðŸ”§ åˆæœŸåŒ–'].json;\nconst presetResult = $input.first().json;\nconst preset = presetResult[0];\n\nlet voiceId = request.base_voice_id;\nlet pitchRange = request.pitch_range;\nlet speedRange = request.speed_range;\nlet stabilityRange = request.stability_range;\nlet seed = request.seed;\n\n// DBãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Œã°ä¸Šæ›¸ã\nif (preset) {\n  voiceId = preset.base_voice_id || voiceId;\n  pitchRange = preset.pitch_variation_range ? JSON.parse(preset.pitch_variation_range) : pitchRange;\n  speedRange = preset.speed_variation_range ? JSON.parse(preset.speed_variation_range) : speedRange;\n  stabilityRange = preset.stability_variation_range ? JSON.parse(preset.stability_variation_range) : stabilityRange;\n  seed = preset.seed_value || seed;\n}\n\n// ã‚·ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå›ºå®šã‚·ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼‰\nconst effectiveSeed = seed || (request.use_fixed_seed ? (request.channel_id ? request.channel_id.charCodeAt(0) * 12345 : Date.now()) : Math.floor(Math.random() * 2147483647));\n\n// ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ãæ±ºå®šè«–çš„ä¹±æ•°ç”Ÿæˆ\nfunction seededRandom(seed) {\n  const x = Math.sin(seed) * 10000;\n  return x - Math.floor(x);\n}\n\n// å¤‰å‹•å€¤è¨ˆç®—\nconst pitchVariation = pitchRange.min + seededRandom(effectiveSeed) * (pitchRange.max - pitchRange.min);\nconst speedVariation = speedRange.min + seededRandom(effectiveSeed + 1) * (speedRange.max - speedRange.min);\nconst stabilityVariation = stabilityRange.min + seededRandom(effectiveSeed + 2) * (stabilityRange.max - stabilityRange.min);\n\n// ElevenLabsãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—\nconst baseStability = 0.5;\nconst baseSimilarityBoost = 0.75;\nconst baseStyle = 0.3;\n\nconst effectiveParams = {\n  stability: Math.max(0, Math.min(1, baseStability + stabilityVariation)),\n  similarity_boost: baseSimilarityBoost,\n  style: baseStyle,\n  use_speaker_boost: true\n};\n\n// ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ç”¨ã®FFmpegãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\nconst ffmpegParams = {\n  pitch_shift: pitchVariation * 100, // ã‚»ãƒ³ãƒˆå˜ä½\n  tempo_change: 1 + speedVariation // å€çŽ‡\n};\n\nreturn [{\n  json: {\n    request_id: request.request_id,\n    text: request.text,\n    voice_id: voiceId,\n    effective_seed: effectiveSeed,\n    voice_settings: effectiveParams,\n    ffmpeg_params: ffmpegParams,\n    variations_applied: {\n      pitch: pitchVariation,\n      speed: speedVariation,\n      stability: stabilityVariation\n    },\n    channel_id: request.channel_id\n  }\n}];"
      },
      "id": "calculate-variation",
      "name": "ðŸ”¢ å¤‰å‹•è¨ˆç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://api.elevenlabs.io/v1/text-to-speech/' + $json.voice_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ text: $json.text, model_id: 'eleven_multilingual_v2', voice_settings: $json.voice_settings }) }}",
        "options": {
          "timeout": 60000,
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "call-elevenlabs",
      "name": "ðŸ”Š ElevenLabs TTS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "elevenlabs-api",
          "name": "ElevenLabs API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// éŸ³å£°ãƒ‡ãƒ¼ã‚¿å‡¦ç†\nconst config = $node['ðŸ”¢ å¤‰å‹•è¨ˆç®—'].json;\nconst apiResult = $input.first().json;\n\nlet audioData = null;\nlet success = false;\n\nif (apiResult.body) {\n  // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿\n  audioData = apiResult.body;\n  success = true;\n}\n\nreturn [{\n  json: {\n    ...config,\n    audio_data: audioData ? 'base64_audio_present' : null,\n    success: success,\n    error: success ? null : 'ElevenLabs API ã‚¨ãƒ©ãƒ¼'\n  }\n}];"
      },
      "id": "process-audio",
      "name": "ðŸ”Š éŸ³å£°å‡¦ç†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-ffmpeg",
              "leftValue": "={{ $json.success && (Math.abs($json.ffmpeg_params.pitch_shift) > 1 || Math.abs($json.ffmpeg_params.tempo_change - 1) > 0.01) }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-ffmpeg",
      "name": "FFmpegå¿…è¦ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "command": "={{ 'ffmpeg -i pipe:0 -af \"asetrate=44100*' + $json.ffmpeg_params.tempo_change + ',aresample=44100,rubberband=pitch=' + (1 + $json.ffmpeg_params.pitch_shift/100) + '\" -f mp3 pipe:1' }}",
        "options": {}
      },
      "id": "apply-ffmpeg",
      "name": "ðŸ”§ FFmpegå¤‰æ›",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// æœ€çµ‚çµæžœ\nconst config = $node['ðŸ”¢ å¤‰å‹•è¨ˆç®—'].json;\nconst success = $node['ðŸ”Š éŸ³å£°å‡¦ç†'].json.success;\n\n// Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‘ã‚¹\nconst storagePath = `voices/${config.channel_id || 'default'}/${config.request_id}.mp3`;\n\nreturn [{\n  json: {\n    request_id: config.request_id,\n    success: success,\n    voice_id: config.voice_id,\n    seed: config.effective_seed,\n    variations: config.variations_applied,\n    storage_path: storagePath,\n    channel_id: config.channel_id\n  }\n}];"
      },
      "id": "finalize",
      "name": "ðŸ“‹ å®Œäº†å‡¦ç†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: $json.success, request_id: $json.request_id, seed: $json.seed, variations: $json.variations, storage_path: $json.storage_path }) }}",
        "options": {}
      },
      "id": "respond-result",
      "name": "å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "Webhook: voice-identity-variation": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ åˆæœŸåŒ–": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¥ ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¥ ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ”¢ å¤‰å‹•è¨ˆç®—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”¢ å¤‰å‹•è¨ˆç®—": {
      "main": [
        [
          {
            "node": "ðŸ”Š ElevenLabs TTS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”Š ElevenLabs TTS": {
      "main": [
        [
          {
            "node": "ðŸ”Š éŸ³å£°å‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”Š éŸ³å£°å‡¦ç†": {
      "main": [
        [
          {
            "node": "FFmpegå¿…è¦ï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FFmpegå¿…è¦ï¼Ÿ": {
      "main": [
        [
          {
            "node": "ðŸ”§ FFmpegå¤‰æ›",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“‹ å®Œäº†å‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ FFmpegå¤‰æ›": {
      "main": [
        [
          {
            "node": "ðŸ“‹ å®Œäº†å‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ å®Œäº†å‡¦ç†": {
      "main": [
        [
          {
            "node": "å¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ”§ åˆæœŸåŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ã‚¢ã‚»ãƒƒãƒˆ"
    },
    {
      "name": "V5"
    },
    {
      "name": "Voice"
    },
    {
      "name": "åˆ¥äººåŒ–"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ]
}