{
  "name": "ã€å—æ³¨ã€‘03_å°‚ç”¨-å—æ³¨-ãƒ¡ãƒ¼ãƒ«ä»•åˆ†ã‘å—æ³¨ãƒãƒ–_V5",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "trigger",
      "name": "15åˆ†ã”ã¨ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT ma.id, ma.user_id, ma.platform, ma.email_address, ma.imap_server, ma.imap_port, ma.api_key_encrypted FROM marketplace_accounts ma WHERE ma.email_enabled = true AND ma.user_id IS NOT NULL ORDER BY ma.last_email_check_at ASC NULLS FIRST LIMIT 10",
        "options": {}
      },
      "id": "get-accounts",
      "name": "ãƒ¡ãƒ¼ãƒ«ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ Array.isArray($json) ? $json.length : ($json.id ? 1 : 0) }}",
              "operation": "equal",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-empty",
      "name": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { message: 'ãƒ¡ãƒ¼ãƒ«ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—' } }];"
      },
      "id": "no-accounts",
      "name": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const accounts = Array.isArray($input.first().json) ? $input.first().json : [$input.first().json];\nreturn accounts.map(a => ({ json: a }));"
      },
      "id": "expand",
      "name": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå±•é–‹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// V5-PRODUCTION: APIã‚­ãƒ¼å¾©å·ï¼ˆcryptoä¾å­˜æ’é™¤ç‰ˆï¼‰\n// ========================================\nconst request = $node['ğŸ” å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼'].json || $input.first().json;\nconst accountResult = $input.first().json;\nconst account = Array.isArray(accountResult) ? accountResult[0] : accountResult;\n\nif (!account || !account.api_key_encrypted) {\n  return [{ json: { ...request, need_legacy_token: true } }];\n}\n\n// å¤–éƒ¨APIã§å¾©å·\nconst apiUrl = $env.N3_API_URL;\nconst secret = $env.N8N_INTERNAL_SECRET;\n\nif (!apiUrl || !secret) {\n  return [{ json: { ...request, need_legacy_token: true, error: 'ç’°å¢ƒå¤‰æ•°æœªè¨­å®š' } }];\n}\n\ntry {\n  const ts = Date.now();\n  // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ\n  const tokenResponse = await fetch(`${apiUrl}/api/n8n-auth/generate-internal-token`, {\n    method: 'POST',\n    headers: { \n      'Content-Type': 'application/json',\n      'X-N8N-Secret': secret\n    },\n    body: JSON.stringify({ userId: request.user_id, timestamp: ts })\n  });\n  const { token: newToken } = await tokenResponse.json();\n  \n  // å¾©å·APIå‘¼ã³å‡ºã—\n  const decryptResponse = await fetch(`${apiUrl}/api/n8n-auth/decrypt-key`, {\n    method: 'POST',\n    headers: { \n      'Content-Type': 'application/json',\n      'X-N3-Signature': newToken,\n      'X-N3-Token-Timestamp': String(ts)\n    },\n    body: JSON.stringify({ \n      encryptedValue: account.api_key_encrypted,\n      userId: request.user_id\n    })\n  });\n  const { decrypted } = await decryptResponse.json();\n  \n  return [{ json: { ...request, access_token: decrypted, account: account, need_legacy_token: false } }];\n} catch (e) {\n  // å¾©å·å¤±æ•—æ™‚ã¯ãƒ¬ã‚¬ã‚·ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯\n  return [{ json: { ...request, need_legacy_token: true, decrypt_error: e.message } }];\n}"
      },
      "id": "decrypt-key",
      "name": "APIã‚­ãƒ¼å¾©å·",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.N3_API_URL || '{{$env.GATEWAY_URL}}' }}/api/email/fetch-unread",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $json.email_address }}"
            },
            {
              "name": "platform",
              "value": "={{ $json.platform }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Email-Token",
              "value": "={{ $json.api_key }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "fetch-emails",
      "name": "æœªèª­ãƒ¡ãƒ¼ãƒ«å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ãƒ¡ãƒ¼ãƒ«å±•é–‹\nconst emails = $input.first().json.emails || $input.first().json || [];\nconst account = $node['APIã‚­ãƒ¼å¾©å·'].json;\n\nif (!Array.isArray(emails) || emails.length === 0) {\n  return [{ json: { no_emails: true, user_id: account.user_id } }];\n}\n\nreturn emails.slice(0, 20).map(email => ({ json: {\n  user_id: account.user_id,\n  platform: account.platform,\n  email_id: email.id || email.messageId,\n  subject: email.subject || '',\n  snippet: email.snippet || email.body?.substring(0, 500) || '',\n  from: email.from || '',\n  received_at: email.date || email.receivedAt\n} }));"
      },
      "id": "expand-emails",
      "name": "ãƒ¡ãƒ¼ãƒ«å±•é–‹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.no_emails }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-no-emails",
      "name": "ãƒ¡ãƒ¼ãƒ«æœ‰ç„¡",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return items;"
      },
      "id": "skip-no-emails",
      "name": "ã‚¹ã‚­ãƒƒãƒ—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N3_API_URL || '{{$env.GATEWAY_URL}}' }}/api/ai/analyze",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gemini-1.5-flash', prompt: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’åˆ†æã—ã¦JSONã§è¿”ã—ã¦ã€‚\\n1. type: inquiry/order/claim/spam/other\\n2. priority: high/medium/low\\n3. action_required: è¿”ä¿¡ãŒå¿…è¦ãªã‚‰true\\n4. draft_reply: è¿”ä¿¡æ¡ˆï¼ˆæ—¥æœ¬èªã€50æ–‡å­—ä»¥å†…ï¼‰\\nå½¢å¼: {\"type\":\"order\",\"priority\":\"high\",\"action_required\":true,\"draft_reply\":\"...\"}\\n\\nä»¶å: ' + $json.subject + '\\nå†…å®¹: ' + $json.snippet.substring(0, 1000) }) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-analyze",
      "name": "Gemini: å„ªå…ˆåº¦åˆ¤å®š&ä¸‹æ›¸ã",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// AIçµæœãƒ‘ãƒ¼ã‚¹\nlet ai = {};\ntry {\n  const text = $input.first().json.text || $input.first().json.response || '{}';\n  ai = JSON.parse(text.replace(/```json\\n?|```/g, ''));\n} catch (e) { ai = { type: 'other', priority: 'low', action_required: false }; }\n\nconst email = $node['ãƒ¡ãƒ¼ãƒ«å±•é–‹'].json;\n\nreturn [{ json: {\n  user_id: email.user_id,\n  platform: email.platform,\n  email_id: email.email_id,\n  subject: email.subject.substring(0, 100),\n  type: ai.type || 'other',\n  priority: ai.priority || 'low',\n  action_required: ai.action_required || false,\n  draft_reply: ai.draft_reply || '',\n  received_at: email.received_at\n} }];"
      },
      "id": "parse-ai",
      "name": "AIçµæœãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO admin_tasks (user_id, platform, email_id, subject, task_type, priority, action_required, draft_reply, status, created_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, 'pending', NOW()) ON CONFLICT (email_id) DO NOTHING",
        "options": {
          "queryParams": "={{ [{{ $json.user_id }}, {{ $json.platform }}, {{ $json.email_id }}, {{ $json.subject.replace(/'/g, \"''\") }}, {{ $json.type }}, {{ $json.priority }}, {{ $json.action_required }}, {{ ($json.draft_reply || '').replace(/'/g, \"''\") }}] }}"
        }
      },
      "id": "save-task",
      "name": "ã‚¿ã‚¹ã‚¯ç™»éŒ²ï¼ˆuser_idä»˜ãï¼‰",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\nconst high = results.filter(r => r.priority === 'high').length;\nconst actionRequired = results.filter(r => r.action_required).length;\nreturn [{ json: { total: results.length, high, actionRequired, ts: new Date().toISOString() } }];"
      },
      "id": "aggregate",
      "name": "çµæœé›†ç´„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.high }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-alert",
      "name": "ç·Šæ€¥ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ğŸ“§ å—æ³¨ãƒ¡ãƒ¼ãƒ«ãƒãƒ–[/title]å‡¦ç†: {{ $json.total }}ä»¶\\nğŸ”´ç·Šæ€¥: {{ $json.high }}ä»¶\\nâš ï¸è¦å¯¾å¿œ: {{ $json.actionRequired }}ä»¶[/info]"
            }
          ]
        }
      },
      "id": "notify",
      "name": "ChatWorké€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "15åˆ†ã”ã¨ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ãƒ¡ãƒ¼ãƒ«ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¡ãƒ¼ãƒ«ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡": {
      "main": [
        [
          {
            "node": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå±•é–‹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå±•é–‹": {
      "main": [
        [
          {
            "node": "APIã‚­ãƒ¼å¾©å·",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "APIã‚­ãƒ¼å¾©å·": {
      "main": [
        [
          {
            "node": "æœªèª­ãƒ¡ãƒ¼ãƒ«å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœªèª­ãƒ¡ãƒ¼ãƒ«å–å¾—": {
      "main": [
        [
          {
            "node": "ãƒ¡ãƒ¼ãƒ«å±•é–‹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¡ãƒ¼ãƒ«å±•é–‹": {
      "main": [
        [
          {
            "node": "ãƒ¡ãƒ¼ãƒ«æœ‰ç„¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¡ãƒ¼ãƒ«æœ‰ç„¡": {
      "main": [
        [
          {
            "node": "ã‚¹ã‚­ãƒƒãƒ—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Gemini: å„ªå…ˆåº¦åˆ¤å®š&ä¸‹æ›¸ã",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini: å„ªå…ˆåº¦åˆ¤å®š&ä¸‹æ›¸ã": {
      "main": [
        [
          {
            "node": "AIçµæœãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIçµæœãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ã‚¿ã‚¹ã‚¯ç™»éŒ²ï¼ˆuser_idä»˜ãï¼‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¿ã‚¹ã‚¯ç™»éŒ²ï¼ˆuser_idä»˜ãï¼‰": {
      "main": [
        [
          {
            "node": "çµæœé›†ç´„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¹ã‚­ãƒƒãƒ—": {
      "main": [
        [
          {
            "node": "çµæœé›†ç´„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµæœé›†ç´„": {
      "main": [
        [
          {
            "node": "ç·Šæ€¥ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç·Šæ€¥ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ChatWorké€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ChatWorké€šçŸ¥": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—": {
      "main": [
        [
          {
            "node": "ğŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none"
  },
  "tags": [
    {
      "name": "N3-Order",
      "color": "#228b22"
    },
    {
      "name": "V4-PRODUCTION",
      "color": "#ff0000"
    },
    {
      "name": "AI-Powered",
      "color": "#9932cc"
    },
    {
      "name": "Multi-Tenant",
      "color": "#00bfff"
    },
    {
      "name": "Dynamic-Decrypt",
      "color": "#ff1493"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}