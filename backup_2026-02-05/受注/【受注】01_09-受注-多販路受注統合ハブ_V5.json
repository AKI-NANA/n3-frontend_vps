{
  "name": "ã€å—æ³¨ã€‘01_09-å—æ³¨-å¤šè²©è·¯å—æ³¨çµ±åˆãƒãƒ–_V5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "order-unified",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook",
      "name": "Webhook: order-unified",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "order-unified"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "schedule",
      "name": "15åˆ†ã”ã¨å—æ³¨ç¢ºèª",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "jsCode": "// V5-PRODUCTION: å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆcryptoä¾å­˜æŽ’é™¤ç‰ˆï¼‰\nconst body = $input.first().json.body || $input.first().json || {};\nconst headers = $input.first().json.headers || {};\n\nconst apiUrl = $env.N3_API_URL;\nconst secret = $env.N8N_INTERNAL_SECRET;\nif (!apiUrl) return [{ json: { error: true, message: 'N3_API_URLç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™', code: 'CONFIG_ERROR' } }];\nif (!secret) return [{ json: { error: true, message: 'N8N_INTERNAL_SECRETç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™', code: 'CONFIG_ERROR' } }];\n\nconst internalToken = headers['x-n3-signature'] || headers['X-N3-Signature'];\nconst tokenTimestamp = headers['x-n3-token-timestamp'] || headers['X-N3-Token-Timestamp'];\nconst userId = body.user_id || 'default';\n\nif (internalToken && tokenTimestamp) {\n  try {\n    const r = await fetch(`${apiUrl}/api/n8n-auth/verify-internal-token`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ userId, timestamp: tokenTimestamp, token: internalToken })\n    });\n    if (!(await r.json()).valid) return [{ json: { error: true, message: 'å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™', code: 'INVALID_TOKEN' } }];\n  } catch (e) {\n    return [{ json: { error: true, message: 'ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼APIã‚¨ãƒ©ãƒ¼: ' + e.message, code: 'VERIFY_API_ERROR' } }];\n  }\n}\n\n// å—æ³¨ãƒ‡ãƒ¼ã‚¿å—ä¿¡ï¼ˆç›´æŽ¥WebhookçµŒç”±ã®å ´åˆï¼‰\nconst orderData = body.order_data || null;\nconst platform = body.platform || 'unknown';\nconst isScheduled = !$input.first().json.body;\n\nreturn [{ json: {\n  user_id: userId,\n  order_data: orderData,\n  platform: platform,\n  is_scheduled: isScheduled,\n  request_timestamp: new Date().toISOString()\n} }];"
      },
      "id": "init",
      "name": "ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-error",
      "name": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": {
          "responseCode": "={{ $json.code === 'INVALID_TOKEN' ? 403 : ($json.code === 'CONFIG_ERROR' ? 500 : 400) }}"
        }
      },
      "id": "respond-error",
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-direct-order",
              "leftValue": "={{ $json.order_data !== null }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-direct-order",
      "name": "ç›´æŽ¥å—æ³¨ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ç›´æŽ¥WebhookçµŒç”±ã®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–\nconst config = $node['ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼'].json;\nconst rawOrder = config.order_data;\nconst platform = config.platform;\n\n// N3æ¨™æº–å—æ³¨ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã«å¤‰æ›\nlet normalizedOrder = {\n  order_id: '',\n  buyer_id: '',\n  buyer_name: '',\n  buyer_email: '',\n  total_amount: 0,\n  currency: 'USD',\n  items: [],\n  shipping_address: {},\n  platform: platform,\n  raw_data: rawOrder,\n  user_id: config.user_id\n};\n\n// ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥ã®æ­£è¦åŒ–\nswitch (platform) {\n  case 'ebay':\n    normalizedOrder.order_id = rawOrder.OrderID || rawOrder.orderId || '';\n    normalizedOrder.buyer_id = rawOrder.BuyerUserID || rawOrder.buyerId || '';\n    normalizedOrder.buyer_name = rawOrder.ShippingAddress?.Name || '';\n    normalizedOrder.buyer_email = rawOrder.BuyerEmail || '';\n    normalizedOrder.total_amount = parseFloat(rawOrder.Total?.value || rawOrder.total || 0);\n    normalizedOrder.currency = rawOrder.Total?.currencyId || 'USD';\n    normalizedOrder.items = (rawOrder.TransactionArray?.Transaction || rawOrder.lineItems || []).map(item => ({\n      item_id: item.ItemID || item.itemId || '',\n      title: item.Item?.Title || item.title || '',\n      quantity: parseInt(item.QuantityPurchased || item.quantity || 1),\n      price: parseFloat(item.TransactionPrice?.value || item.price || 0)\n    }));\n    normalizedOrder.shipping_address = {\n      name: rawOrder.ShippingAddress?.Name || '',\n      street1: rawOrder.ShippingAddress?.Street1 || '',\n      street2: rawOrder.ShippingAddress?.Street2 || '',\n      city: rawOrder.ShippingAddress?.CityName || '',\n      state: rawOrder.ShippingAddress?.StateOrProvince || '',\n      postal_code: rawOrder.ShippingAddress?.PostalCode || '',\n      country: rawOrder.ShippingAddress?.CountryName || rawOrder.ShippingAddress?.Country || ''\n    };\n    break;\n  \n  case 'qoo10':\n    normalizedOrder.order_id = rawOrder.orderNo || '';\n    normalizedOrder.buyer_id = rawOrder.buyerId || '';\n    normalizedOrder.buyer_name = rawOrder.receiverName || '';\n    normalizedOrder.total_amount = parseFloat(rawOrder.orderPrice || 0);\n    normalizedOrder.currency = 'JPY';\n    normalizedOrder.items = [{\n      item_id: rawOrder.itemCode || '',\n      title: rawOrder.itemTitle || '',\n      quantity: parseInt(rawOrder.orderQty || 1),\n      price: parseFloat(rawOrder.itemPrice || 0)\n    }];\n    normalizedOrder.shipping_address = {\n      name: rawOrder.receiverName || '',\n      street1: rawOrder.receiverAddr || '',\n      city: '',\n      state: '',\n      postal_code: rawOrder.receiverZipCode || '',\n      country: 'Japan'\n    };\n    break;\n  \n  case 'shopify':\n    normalizedOrder.order_id = rawOrder.id?.toString() || rawOrder.order_number?.toString() || '';\n    normalizedOrder.buyer_id = rawOrder.customer?.id?.toString() || '';\n    normalizedOrder.buyer_name = rawOrder.shipping_address?.name || '';\n    normalizedOrder.buyer_email = rawOrder.email || '';\n    normalizedOrder.total_amount = parseFloat(rawOrder.total_price || 0);\n    normalizedOrder.currency = rawOrder.currency || 'USD';\n    normalizedOrder.items = (rawOrder.line_items || []).map(item => ({\n      item_id: item.id?.toString() || '',\n      title: item.title || '',\n      quantity: parseInt(item.quantity || 1),\n      price: parseFloat(item.price || 0)\n    }));\n    normalizedOrder.shipping_address = {\n      name: rawOrder.shipping_address?.name || '',\n      street1: rawOrder.shipping_address?.address1 || '',\n      street2: rawOrder.shipping_address?.address2 || '',\n      city: rawOrder.shipping_address?.city || '',\n      state: rawOrder.shipping_address?.province || '',\n      postal_code: rawOrder.shipping_address?.zip || '',\n      country: rawOrder.shipping_address?.country || ''\n    };\n    break;\n  \n  default:\n    // æ±Žç”¨ãƒ‘ãƒ¼ã‚µãƒ¼\n    normalizedOrder.order_id = rawOrder.order_id || rawOrder.orderId || rawOrder.id || '';\n    normalizedOrder.buyer_id = rawOrder.buyer_id || rawOrder.buyerId || rawOrder.customer_id || '';\n    normalizedOrder.total_amount = parseFloat(rawOrder.total_amount || rawOrder.total || 0);\n}\n\nreturn [{ json: normalizedOrder }];"
      },
      "id": "normalize-direct",
      "name": "ðŸ“‹ ç›´æŽ¥å—æ³¨æ­£è¦åŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT ma.id, ma.user_id, ma.platform, ma.seller_id, ma.account_name, ma.api_credentials FROM marketplace_accounts ma WHERE ma.is_active = true AND ma.user_id = $1 ORDER BY ma.platform",
        "options": {
          "queryParams": "={{ [$json.user_id] }}"
        }
      },
      "id": "get-accounts",
      "name": "ðŸ“¦ è²©è·¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "no-accounts",
              "leftValue": "={{ Array.isArray($json) ? $json.length : ($json && $json.id ? 1 : 0) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-accounts",
      "name": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, message: 'æœ‰åŠ¹ãªè²©è·¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—', orders_found: 0 } }];"
      },
      "id": "no-accounts",
      "name": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// å„è²©è·¯ã‹ã‚‰å—æ³¨ã‚’å–å¾—ï¼ˆæ¨¡æ“¬å®Ÿè£…ï¼‰\n// å®Ÿéš›ã¯ã“ã“ã§eBay GetOrders API, Qoo10 APIç­‰ã‚’å‘¼ã³å‡ºã™\nconst accounts = $input.all().map(item => item.json);\nconst flatAccounts = accounts.flat().filter(a => a && a.id);\nconst config = $node['ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼'].json;\n\nconst allOrders = [];\n\nfor (const account of flatAccounts) {\n  // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã”ã¨ã®å—æ³¨å–å¾—ãƒ­ã‚¸ãƒƒã‚¯\n  // ã“ã“ã§ã¯ç©ºé…åˆ—ã‚’è¿”ã™ï¼ˆå®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ã¯åˆ¥é€”å®Ÿè£…ï¼‰\n  // å®Ÿé‹ç”¨æ™‚ã¯ HTTP Request ãƒŽãƒ¼ãƒ‰ã§å„APIã‚’å‘¼ã³å‡ºã™\n}\n\nreturn [{ json: {\n  orders: allOrders,\n  accounts_checked: flatAccounts.length,\n  user_id: config.user_id\n} }];"
      },
      "id": "fetch-orders",
      "name": "ðŸ“¥ å„è²©è·¯ã‹ã‚‰å—æ³¨å–å¾—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "jsCode": "// å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒžãƒ¼ã‚¸\nconst directOrder = $node['ðŸ“‹ ç›´æŽ¥å—æ³¨æ­£è¦åŒ–']?.json;\nconst fetchedOrders = $node['ðŸ“¥ å„è²©è·¯ã‹ã‚‰å—æ³¨å–å¾—']?.json?.orders || [];\nconst config = $node['ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼'].json;\n\nlet allOrders = [...fetchedOrders];\n\nif (directOrder && directOrder.order_id) {\n  allOrders.push(directOrder);\n}\n\nif (allOrders.length === 0) {\n  return [{ json: { no_orders: true, user_id: config.user_id } }];\n}\n\nreturn allOrders.map(order => ({ json: { ...order, user_id: config.user_id } }));"
      },
      "id": "merge-orders",
      "name": "ðŸ“‹ å—æ³¨ãƒžãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "no-orders",
              "leftValue": "={{ $json.no_orders }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-orders",
      "name": "å—æ³¨æœ‰ç„¡",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, message: 'æ–°è¦å—æ³¨ãªã—', orders_processed: 0 } }];"
      },
      "id": "no-orders",
      "name": "å—æ³¨ãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N3_API_URL || '{{$env.GATEWAY_URL}}' }}/api/ai/analyze",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'gemini-1.5-flash', prompt: 'ä»¥ä¸‹ã®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æžã—ã€JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚\\n1. priority: high/medium/lowï¼ˆé‡‘é¡ã‚„é…é€å…ˆã§åˆ¤å®šï¼‰\\n2. risk_flag: è©æ¬ºãƒªã‚¹ã‚¯ãŒã‚ã‚Œã°true\\n3. suggested_action: æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\\n4. auto_reply_draft: è‡ªå‹•è¿”ä¿¡ã®ä¸‹æ›¸ãï¼ˆæ—¥æœ¬èªžã€80æ–‡å­—ä»¥å†…ï¼‰\\nå½¢å¼: {\"priority\":\"medium\",\"risk_flag\":false,\"suggested_action\":\"normal_process\",\"auto_reply_draft\":\"...\"}\\n\\nå—æ³¨ID: ' + $json.order_id + '\\né‡‘é¡: ' + $json.total_amount + ' ' + $json.currency + '\\né…é€å…ˆå›½: ' + ($json.shipping_address?.country || 'unknown') + '\\nå•†å“æ•°: ' + ($json.items?.length || 0) }) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-analyze",
      "name": "ðŸ¤– Gemini: å—æ³¨åˆ†æž",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// AIçµæžœãƒ‘ãƒ¼ã‚¹\nlet ai = { priority: 'medium', risk_flag: false, suggested_action: 'normal_process', auto_reply_draft: '' };\ntry {\n  const text = $input.first().json.text || $input.first().json.response || '{}';\n  ai = JSON.parse(text.replace(/```json\\n?|```/g, ''));\n} catch (e) { /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨ */ }\n\nconst order = $node['ðŸ“‹ å—æ³¨ãƒžãƒ¼ã‚¸'].json;\n\nreturn [{ json: {\n  ...order,\n  ai_analysis: {\n    priority: ai.priority || 'medium',\n    risk_flag: ai.risk_flag || false,\n    suggested_action: ai.suggested_action || 'normal_process',\n    auto_reply_draft: ai.auto_reply_draft || ''\n  },\n  processed_at: new Date().toISOString()\n} }];"
      },
      "id": "parse-ai",
      "name": "AIçµæžœãƒ‘ãƒ¼ã‚¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO orders_unified (order_id, platform, buyer_id, buyer_name, buyer_email, total_amount, currency, items, shipping_address, ai_priority, ai_risk_flag, ai_suggested_action, ai_reply_draft, raw_data, status, user_id, created_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8::jsonb, $9::jsonb, $10, $11, $12, $13, $14::jsonb, 'pending', $15, NOW()) ON CONFLICT (order_id, platform) DO UPDATE SET ai_priority = EXCLUDED.ai_priority, ai_risk_flag = EXCLUDED.ai_risk_flag, updated_at = NOW() RETURNING id",
        "options": {
          "queryParams": "={{ [$json.order_id, $json.platform, $json.buyer_id, ($json.buyer_name || '').substring(0, 100), $json.buyer_email, $json.total_amount, $json.currency, JSON.stringify($json.items || []), JSON.stringify($json.shipping_address || {}), $json.ai_analysis.priority, $json.ai_analysis.risk_flag, $json.ai_analysis.suggested_action, ($json.ai_analysis.auto_reply_draft || '').substring(0, 500), JSON.stringify($json.raw_data || {}), $json.user_id] }}"
        }
      },
      "id": "save-order",
      "name": "ðŸ“ å—æ³¨ä¿å­˜",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO admin_tasks (user_id, task_type, priority, reference_id, reference_type, title, description, action_required, draft_content, status, created_at) VALUES ($1, 'order', $2, $3, 'order', $4, $5, true, $6, 'pending', NOW()) ON CONFLICT DO NOTHING",
        "options": {
          "queryParams": "={{ [$json.user_id, $json.ai_analysis.priority, $json.order_id, 'å—æ³¨: ' + $json.order_id + ' (' + $json.platform + ')', 'é‡‘é¡: ' + $json.total_amount + ' ' + $json.currency + ', é…é€å…ˆ: ' + ($json.shipping_address?.country || 'unknown'), $json.ai_analysis.auto_reply_draft] }}"
        }
      },
      "id": "create-task",
      "name": "ðŸ“‹ ã‚¿ã‚¹ã‚¯ç™»éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\nconst config = $node['ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼'].json;\n\nconst highPriority = results.filter(r => r.ai_analysis?.priority === 'high').length;\nconst riskOrders = results.filter(r => r.ai_analysis?.risk_flag).length;\n\nreturn [{ json: {\n  success: true,\n  orders_processed: results.length,\n  high_priority_count: highPriority,\n  risk_orders_count: riskOrders,\n  user_id: config.user_id,\n  processed_at: new Date().toISOString()\n} }];"
      },
      "id": "aggregate",
      "name": "ðŸ“Š çµæžœé›†è¨ˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[PYTHON_MIGRATION_CANDIDATE]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-high-priority",
              "leftValue": "={{ $json.high_priority_count + $json.risk_orders_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "larger"
              }
            }
          ]
        }
      },
      "id": "check-notify",
      "name": "ç·Šæ€¥ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ChatWorkToken",
              "value": "={{ $env.CHATWORK_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "=[info][title]ðŸ“¦ N3-09 å—æ³¨çµ±åˆãƒãƒ–[/title]å‡¦ç†: {{ $json.orders_processed }}ä»¶\\nðŸ”´ç·Šæ€¥: {{ $json.high_priority_count }}ä»¶\\nâš ï¸ãƒªã‚¹ã‚¯: {{ $json.risk_orders_count }}ä»¶[/info]"
            }
          ]
        }
      },
      "id": "notify",
      "name": "ChatWorké€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success",
      "name": "âœ… æˆåŠŸå¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” HMAC SHA256 ç½²åæ¤œè¨¼ (Empire OS v6)\nconst crypto = require('crypto');\n\nconst signature = $request.headers['x-n3-signature'] || $request.headers['X-N3-Signature'];\nconst timestamp = $request.headers['x-n3-timestamp'] || $request.headers['X-N3-Timestamp'];\nconst secret = $env.N8N_HMAC_SECRET;\n\nif (!secret) {\n  throw new Error('ðŸš« N8N_HMAC_SECRET ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™');\n}\n\nif (!signature || !timestamp) {\n  throw new Error('ðŸš« ç½²åã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ¬ è½ã—ã¦ã„ã¾ã™');\n}\n\n// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (5åˆ†)\nconst now = Date.now();\nconst tsAge = now - parseInt(timestamp);\nif (tsAge > 300000 || tsAge < -30000) {\n  throw new Error('ðŸš« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ä¸æ­£ã§ã™');\n}\n\n// HMACæ¤œè¨¼\nconst bodyString = JSON.stringify($json);\nconst computedHmac = crypto\n  .createHmac('sha256', secret)\n  .update(timestamp + '.' + bodyString)\n  .digest('hex');\n\nif (signature !== computedHmac) {\n  throw new Error('ðŸš« HMACç½²åæ¤œè¨¼å¤±æ•—: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ');\n}\n\n// æ¤œè¨¼æˆåŠŸ - å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™\nreturn [{ json: $json }];"
      },
      "name": "ðŸ” HMACç½²åæ¤œè¨¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "notes": "[EMPIRE_OS_V6] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åˆ¶æŒ¿å…¥"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/execution_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_id\": \"{{$workflow.id}}\",\n  \"workflow_name\": \"{{$workflow.name}}\",\n  \"status\": \"success\",\n  \"execution_time_ms\": {{Date.now() - $execution.startedAt.getTime()}},\n  \"error_message\": null,\n  \"executed_at\": \"{{new Date().toISOString()}}\",\n  \"node_count\": {{$workflow.nodes.length}},\n  \"metadata\": {}\n}"
      },
      "name": "ðŸ“Š å®Ÿè¡Œãƒ­ã‚°é€ä¿¡ (æˆåŠŸ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true,
      "notes": "[EMPIRE_OS_V6] ä¸­å¤®ç›£è¦–ãƒ‘ãƒ«ã‚¹"
    }
  ],
  "connections": {
    "Webhook: order-unified": {
      "main": [
        [
          {
            "node": "ðŸ” HMACç½²åæ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "15åˆ†ã”ã¨å—æ³¨ç¢ºèª": {
      "main": [
        [
          {
            "node": "ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯": {
      "main": [
        [
          {
            "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ç›´æŽ¥å—æ³¨ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç›´æŽ¥å—æ³¨ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ç›´æŽ¥å—æ³¨æ­£è¦åŒ–",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¦ è²©è·¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ç›´æŽ¥å—æ³¨æ­£è¦åŒ–": {
      "main": [
        [
          {
            "node": "ðŸ“‹ å—æ³¨ãƒžãƒ¼ã‚¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¦ è²©è·¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—": {
      "main": [
        [
          {
            "node": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰ç„¡": {
      "main": [
        [
          {
            "node": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¥ å„è²©è·¯ã‹ã‚‰å—æ³¨å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¥ å„è²©è·¯ã‹ã‚‰å—æ³¨å–å¾—": {
      "main": [
        [
          {
            "node": "ðŸ“‹ å—æ³¨ãƒžãƒ¼ã‚¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ å—æ³¨ãƒžãƒ¼ã‚¸": {
      "main": [
        [
          {
            "node": "å—æ³¨æœ‰ç„¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å—æ³¨æœ‰ç„¡": {
      "main": [
        [
          {
            "node": "å—æ³¨ãªã—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ¤– Gemini: å—æ³¨åˆ†æž",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å—æ³¨ãªã—": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– Gemini: å—æ³¨åˆ†æž": {
      "main": [
        [
          {
            "node": "AIçµæžœãƒ‘ãƒ¼ã‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIçµæžœãƒ‘ãƒ¼ã‚¹": {
      "main": [
        [
          {
            "node": "ðŸ“ å—æ³¨ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ å—æ³¨ä¿å­˜": {
      "main": [
        [
          {
            "node": "ðŸ“‹ ã‚¿ã‚¹ã‚¯ç™»éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ ã‚¿ã‚¹ã‚¯ç™»éŒ²": {
      "main": [
        [
          {
            "node": "ðŸ“Š çµæžœé›†è¨ˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š çµæžœé›†è¨ˆ": {
      "main": [
        [
          {
            "node": "ç·Šæ€¥ã‚ã‚Šï¼Ÿ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç·Šæ€¥ã‚ã‚Šï¼Ÿ": {
      "main": [
        [
          {
            "node": "ChatWorké€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatWorké€šçŸ¥": {
      "main": [
        [
          {
            "node": "âœ… æˆåŠŸå¿œç­”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” HMACç½²åæ¤œè¨¼": {
      "main": [
        [
          {
            "node": "ðŸ” åˆæœŸåŒ– + å†…éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {
      "name": "N3-Order",
      "color": "#228b22"
    },
    {
      "name": "V5-PRODUCTION",
      "color": "#00ff00"
    },
    {
      "name": "No-Crypto",
      "color": "#9932cc"
    },
    {
      "name": "SQL-Safe",
      "color": "#32cd32"
    },
    {
      "name": "AI-Powered",
      "color": "#ff1493"
    },
    {
      "name": "Multi-Platform",
      "color": "#00bfff"
    },
    {
      "name": "Empire-OS-V6",
      "color": "#ff4500"
    }
  ],
  "active": false
}