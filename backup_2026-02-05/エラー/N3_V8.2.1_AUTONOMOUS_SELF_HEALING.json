{
  "name": "ã€V8.2.1-AUTONOMOUSã€‘å†å¸°çš„ãƒ‡ãƒ¼ã‚¿è£œå®Œãƒ»Self-Healing",
  "description": "N3 Empire OS V8.2.1-Autonomous: ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã«å¤–éƒ¨API/ã‚«ã‚¿ãƒ­ã‚°ã‚’æœ€å¤§3å›å†å¸°æ¤œç´¢ã—ã¦è‡ªå‹•è£œå®Œ",
  "_version": "8.2.1-autonomous",
  "_27d_compliance": ["dim3_auth_gate", "dim13_decision_trace", "dim21_data_trust"],

  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "self-healing-enrich",
        "options": { "responseMode": "responseNode" }
      },
      "name": "Webhook: Self-Healing",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "self-healing-enrich"
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ” èªè¨¼ + è£œå®ŒçŠ¶æ…‹åˆæœŸåŒ–\n// ============================================================================\nconst crypto = require('crypto');\nconst body = $input.first().json.body || $input.first().json;\nconst headers = $input.first().json.headers || {};\n\n// å†…éƒ¨å‘¼ã³å‡ºã—ï¼ˆå†å¸°ï¼‰ã®å ´åˆã¯èªè¨¼ã‚¹ã‚­ãƒƒãƒ—\nconst isRecursive = body._recursive_call === true;\n\nif (!isRecursive) {\n  const signature = headers['x-n3-signature'] || headers['X-N3-Signature'];\n  const timestamp = headers['x-n3-timestamp'] || headers['X-N3-Timestamp'];\n  const secret = $env.N8N_HMAC_SECRET;\n\n  if (!secret) return [{ json: { error: true, code: 'CONFIG_ERROR', message: 'N8N_HMAC_SECRETæœªè¨­å®š' }}];\n  if (!signature || !timestamp) return [{ json: { error: true, code: 'AUTH_REQUIRED', message: 'èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼æ¬ è½' }}];\n  if (Math.abs(Date.now() - parseInt(timestamp)) > 300000) return [{ json: { error: true, code: 'TIMESTAMP_EXPIRED', message: 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æœŸé™åˆ‡ã‚Œ' }}];\n\n  const computedHmac = crypto.createHmac('sha256', secret).update(timestamp + '.' + JSON.stringify(body)).digest('hex');\n  if (signature !== computedHmac) return [{ json: { error: true, code: 'HMAC_INVALID', message: 'HMACæ¤œè¨¼å¤±æ•—' }}];\n}\n\n// è£œå®Œè¨­å®š\nconst CONFIDENCE_THRESHOLD = body.confidence_threshold || 75;\nconst MAX_DEPTH = 3;\n\n// ç¾åœ¨ã®è£œå®Œæ·±åº¦\nconst currentDepth = body._enrichment_depth || 0;\nconst triedSources = body._tried_sources || [];\nconst tenantId = body.user_id || body.tenant_id || 'default';\nconst productId = body.product_id;\n\nif (!productId) return [{ json: { error: true, code: 'MISSING_PARAM', message: 'product_idå¿…é ˆ' }}];\n\nreturn [{ json: {\n  product_id: productId,\n  tenant_id: tenantId,\n  current_depth: currentDepth,\n  max_depth: MAX_DEPTH,\n  tried_sources: triedSources,\n  confidence_threshold: CONFIDENCE_THRESHOLD,\n  product_data: body.product_data || null,\n  _auth_verified: true\n}}];"
      },
      "name": "ğŸ” èªè¨¼ + åˆæœŸåŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "error", "leftValue": "={{ $json.error }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" }}]
        }
      },
      "name": "ã‚¨ãƒ©ãƒ¼ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },

    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.message, code: $json.code }) }}",
        "options": { "responseCode": "={{ $json.code === 'AUTH_REQUIRED' || $json.code === 'HMAC_INVALID' ? 403 : 400 }}" }
      },
      "name": "ã‚¨ãƒ©ãƒ¼å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT pm.id, pm.sku, pm.title, pm.title_en, pm.description, pm.item_specifics, pm.hts_code, pm.origin_country, pm.ebay_category_id, pm.sm_confidence_score, im.weight_grams, im.dimension_cm_l, im.dimension_cm_w, im.dimension_cm_h FROM products_master pm LEFT JOIN inventory_master im ON im.product_master_id = pm.id WHERE pm.id = $1 LIMIT 1",
        "options": { "queryParams": "={{ [$json.product_id] }}" }
      },
      "name": "ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "postgres-supabase", "name": "Supabase Postgres" }}
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡ + æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç‰¹å®š\n// ============================================================================\nconst prevData = $node['ğŸ” èªè¨¼ + åˆæœŸåŒ–'].json;\nconst productArr = Array.isArray($input.first().json) ? $input.first().json : [$input.first().json];\nconst product = productArr[0] || prevData.product_data;\n\nif (!product || !product.id) {\n  return [{ json: { error: true, code: 'PRODUCT_NOT_FOUND', message: 'å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }}];\n}\n\n// æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯\nconst missingFields = [];\nconst fieldWeights = {\n  hts_code: 20,\n  weight_grams: 15,\n  origin_country: 10,\n  item_specifics: 15,\n  title_en: 10,\n  ebay_category_id: 10,\n  dimension_cm_l: 5,\n  dimension_cm_w: 5,\n  dimension_cm_h: 5\n};\n\nlet qualityScore = 100;\n\nif (!product.hts_code || product.hts_code === '9999.99.99') {\n  missingFields.push('hts_code');\n  qualityScore -= fieldWeights.hts_code;\n}\nif (!product.weight_grams || product.weight_grams === 500) {\n  missingFields.push('weight_grams');\n  qualityScore -= fieldWeights.weight_grams;\n}\nif (!product.origin_country) {\n  missingFields.push('origin_country');\n  qualityScore -= fieldWeights.origin_country;\n}\nif (!product.item_specifics || Object.keys(product.item_specifics || {}).length < 3) {\n  missingFields.push('item_specifics');\n  qualityScore -= fieldWeights.item_specifics;\n}\nif (!product.title_en) {\n  missingFields.push('title_en');\n  qualityScore -= fieldWeights.title_en;\n}\nif (!product.ebay_category_id) {\n  missingFields.push('ebay_category_id');\n  qualityScore -= fieldWeights.ebay_category_id;\n}\nif (!product.dimension_cm_l || !product.dimension_cm_w || !product.dimension_cm_h) {\n  missingFields.push('dimensions');\n  qualityScore -= (fieldWeights.dimension_cm_l + fieldWeights.dimension_cm_w + fieldWeights.dimension_cm_h);\n}\n\n// ä¿¡é ¼åº¦ = æ—¢å­˜SMä¿¡é ¼åº¦ Ã— ãƒ‡ãƒ¼ã‚¿å“è³ªä¿‚æ•°\nconst baseConfidence = product.sm_confidence_score || 50;\nconst adjustedConfidence = Math.round(baseConfidence * (qualityScore / 100));\n\nreturn [{ json: {\n  ...prevData,\n  product: product,\n  quality_score: qualityScore,\n  missing_fields: missingFields,\n  adjusted_confidence: adjustedConfidence,\n  needs_enrichment: missingFields.length > 0 && adjustedConfidence < prevData.confidence_threshold\n}}];"
      },
      "name": "ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "needs-enrich", "leftValue": "={{ $json.needs_enrichment }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" }}]
        }
      },
      "name": "è£œå®Œå¿…è¦ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// è£œå®Œä¸è¦ â†’ å®Œäº†å¿œç­”æº–å‚™\nconst data = $input.first().json;\nreturn [{ json: {\n  ...data,\n  enrichment_status: 'complete',\n  enrichment_message: `ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¹ã‚³ã‚¢ ${data.quality_score}ç‚¹ã€ä¿¡é ¼åº¦ ${data.adjusted_confidence}ç‚¹ã§åŸºæº–ã‚¯ãƒªã‚¢`\n}}];"
      },
      "name": "è£œå®Œä¸è¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "max-depth", "leftValue": "={{ $json.current_depth }}", "rightValue": "={{ $json.max_depth }}", "operator": { "type": "number", "operation": "gte" }}]
        }
      },
      "name": "æœ€å¤§æ·±åº¦åˆ°é”ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// æœ€å¤§æ·±åº¦åˆ°é” â†’ è­¦å‘Šä»˜ãã§å®Œäº†\nconst data = $input.first().json;\nreturn [{ json: {\n  ...data,\n  enrichment_status: 'max_depth_reached',\n  enrichment_message: `æœ€å¤§å†å¸°æ·±åº¦(${data.max_depth})åˆ°é”ã€‚å“è³ªã‚¹ã‚³ã‚¢ ${data.quality_score}ç‚¹ã§å‡¦ç†ç¶šè¡Œ`,\n  warning: `æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${data.missing_fields.join(', ')}`\n}}];"
      },
      "name": "æœ€å¤§æ·±åº¦åˆ°é”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ”„ æ¬¡ã®è£œå®Œã‚½ãƒ¼ã‚¹é¸æŠ\n// ============================================================================\nconst data = $input.first().json;\n\nconst SOURCES = [\n  { name: 'eBay Browse API', priority: 1, fields: ['item_specifics', 'ebay_category_id', 'title_en'] },\n  { name: 'Amazon Catalog', priority: 2, fields: ['weight_grams', 'dimensions', 'origin_country'] },\n  { name: 'Gemini AI Inference', priority: 3, fields: ['hts_code', 'item_specifics', 'origin_country'] }\n];\n\n// æœªè©¦è¡Œã‹ã¤æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚’é¸æŠ\nconst nextSource = SOURCES.find(s => \n  !data.tried_sources.includes(s.name) && \n  s.fields.some(f => data.missing_fields.includes(f))\n);\n\nif (!nextSource) {\n  return [{ json: {\n    ...data,\n    enrichment_status: 'all_sources_exhausted',\n    enrichment_message: 'å…¨ã‚½ãƒ¼ã‚¹è©¦è¡Œæ¸ˆã¿ã€‚å“è³ªã‚¹ã‚³ã‚¢ ' + data.quality_score + 'ç‚¹ã§å‡¦ç†ç¶šè¡Œ',\n    warning: 'æ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ' + data.missing_fields.join(', ')\n  }}];\n}\n\nreturn [{ json: {\n  ...data,\n  next_source: nextSource.name,\n  next_source_fields: nextSource.fields\n}}];"
      },
      "name": "ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.next_source }}",
        "rules": {
          "rules": [
            { "value2": "eBay Browse API", "output": 0 },
            { "value2": "Amazon Catalog", "output": 1 },
            { "value2": "Gemini AI Inference", "output": 2 }
          ]
        },
        "fallbackOutput": 3
      },
      "name": "ã‚½ãƒ¼ã‚¹åˆ†å²",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3
    },

    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.N3_API_URL }}/api/ebay/browse-search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            { "name": "q", "value": "={{ $json.product?.title || $json.product?.sku }}" },
            { "name": "limit", "value": "5" }
          ]
        },
        "options": { "timeout": 30000 }
      },
      "name": "ğŸ“¡ eBay Browse API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },

    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N3_API_URL }}/api/amazon/catalog-lookup",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ query: $json.product?.title || $json.product?.sku, marketplace: 'US' }) }}",
        "options": { "timeout": 30000 }
      },
      "name": "ğŸ“¡ Amazon Catalog API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },

    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" },
            { "name": "x-goog-api-key", "value": "={{ $env.GEMINI_API_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: '## å•†å“ãƒ‡ãƒ¼ã‚¿è£œå®Œã‚¿ã‚¹ã‚¯\\n\\nå•†å“æƒ…å ±:\\n- ã‚¿ã‚¤ãƒˆãƒ«: ' + ($json.product?.title || '') + '\\n- SKU: ' + ($json.product?.sku || '') + '\\n- æ—¢å­˜Item Specifics: ' + JSON.stringify($json.product?.item_specifics || {}) + '\\n\\næ¬ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ' + $json.missing_fields.join(', ') + '\\n\\nä»¥ä¸‹ã®JSONå½¢å¼ã§è£œå®Œãƒ‡ãƒ¼ã‚¿ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„:\\n```json\\n{\\n  \"hts_code\": \"HSã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 8471.30.00ï¼‰\",\\n  \"origin_country\": \"åŸç”£å›½ï¼ˆISO 2æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼‰\",\\n  \"weight_grams\": æ•°å€¤,\\n  \"item_specifics\": { \"Brand\": \"\", \"MPN\": \"\", \"Model\": \"\" },\\n  \"confidence\": 0-100,\\n  \"reasoning\": \"æ¨æ¸¬æ ¹æ‹ \"\\n}\\n```' }] }], generationConfig: { temperature: 0.3, maxOutputTokens: 1024 } }) }}",
        "options": { "timeout": 60000 }
      },
      "name": "ğŸ§  Gemini AIæ¨è«–",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },

    {
      "parameters": {
        "jsCode": "// ã‚½ãƒ¼ã‚¹ãªã— â†’ å®Œäº†\nconst data = $input.first().json;\nreturn [{ json: {\n  ...data,\n  enrichment_status: 'no_source_available',\n  enrichment_message: 'åˆ©ç”¨å¯èƒ½ãªè£œå®Œã‚½ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“'\n}}];"
      },
      "name": "ã‚½ãƒ¼ã‚¹ãªã—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ“Š eBayçµæœãƒãƒ¼ã‚¸\n// ============================================================================\nconst prevData = $node['ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ'].json;\nconst apiResult = $input.first().json;\n\nconst enriched = { ...prevData.product };\nlet enrichedFields = [];\n\ntry {\n  const items = apiResult.itemSummaries || apiResult.items || [];\n  const bestMatch = items[0];\n  \n  if (bestMatch) {\n    // Item Specificsè£œå®Œ\n    if (prevData.missing_fields.includes('item_specifics') && bestMatch.localizedAspects) {\n      const specs = bestMatch.localizedAspects.reduce((acc, asp) => {\n        acc[asp.name] = asp.value;\n        return acc;\n      }, {});\n      enriched.item_specifics = { ...(enriched.item_specifics || {}), ...specs };\n      enrichedFields.push('item_specifics');\n    }\n    \n    // ã‚«ãƒ†ã‚´ãƒªè£œå®Œ\n    if (prevData.missing_fields.includes('ebay_category_id') && bestMatch.categoryId) {\n      enriched.ebay_category_id = bestMatch.categoryId;\n      enrichedFields.push('ebay_category_id');\n    }\n    \n    // è‹±èªã‚¿ã‚¤ãƒˆãƒ«è£œå®Œ\n    if (prevData.missing_fields.includes('title_en') && bestMatch.title) {\n      enriched.title_en = bestMatch.title;\n      enrichedFields.push('title_en');\n    }\n  }\n} catch (e) {\n  // è£œå®Œå¤±æ•—ã¯è­¦å‘Šã®ã¿\n}\n\nreturn [{ json: {\n  ...prevData,\n  product: enriched,\n  enriched_by: 'eBay Browse API',\n  enriched_fields: enrichedFields,\n  _enrichment_depth: prevData.current_depth + 1,\n  _tried_sources: [...prevData.tried_sources, 'eBay Browse API']\n}}];"
      },
      "name": "ğŸ“Š eBayçµæœãƒãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ“Š Amazonçµæœãƒãƒ¼ã‚¸\n// ============================================================================\nconst prevData = $node['ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ'].json;\nconst apiResult = $input.first().json;\n\nconst enriched = { ...prevData.product };\nlet enrichedFields = [];\n\ntry {\n  const item = apiResult.items?.[0] || apiResult;\n  \n  if (item) {\n    // é‡é‡è£œå®Œ\n    if (prevData.missing_fields.includes('weight_grams') && item.packageWeight) {\n      const weightKg = parseFloat(item.packageWeight.value || item.packageWeight);\n      enriched.weight_grams = Math.round(weightKg * 1000);\n      enrichedFields.push('weight_grams');\n    }\n    \n    // å¯¸æ³•è£œå®Œ\n    if (prevData.missing_fields.includes('dimensions') && item.packageDimensions) {\n      enriched.dimension_cm_l = parseFloat(item.packageDimensions.length || 0);\n      enriched.dimension_cm_w = parseFloat(item.packageDimensions.width || 0);\n      enriched.dimension_cm_h = parseFloat(item.packageDimensions.height || 0);\n      enrichedFields.push('dimensions');\n    }\n    \n    // åŸç”£å›½è£œå®Œ\n    if (prevData.missing_fields.includes('origin_country') && item.countryOfOrigin) {\n      enriched.origin_country = item.countryOfOrigin;\n      enrichedFields.push('origin_country');\n    }\n  }\n} catch (e) {\n  // è£œå®Œå¤±æ•—ã¯è­¦å‘Šã®ã¿\n}\n\nreturn [{ json: {\n  ...prevData,\n  product: enriched,\n  enriched_by: 'Amazon Catalog',\n  enriched_fields: enrichedFields,\n  _enrichment_depth: prevData.current_depth + 1,\n  _tried_sources: [...prevData.tried_sources, 'Amazon Catalog']\n}}];"
      },
      "name": "ğŸ“Š Amazonçµæœãƒãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ“Š Gemini AIçµæœãƒãƒ¼ã‚¸ï¼ˆä¿¡é ¼ã‚¹ã‚³ã‚¢ä»˜ãï¼‰\n// ============================================================================\nconst prevData = $node['ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ'].json;\nconst apiResult = $input.first().json;\n\nconst enriched = { ...prevData.product };\nlet enrichedFields = [];\nlet aiConfidence = 50;\n\ntry {\n  const text = apiResult.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n  const match = text.match(/```json\\n?([\\s\\S]*?)\\n?```/) || text.match(/\\{[\\s\\S]*\\}/);\n  \n  if (match) {\n    const parsed = JSON.parse(match[1] || match[0]);\n    aiConfidence = parsed.confidence || 50;\n    \n    // 27æ¬¡å…ƒ-21: ãƒ‡ãƒ¼ã‚¿ä¿¡é ¼ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯\n    if (aiConfidence >= 60) {\n      // HSã‚³ãƒ¼ãƒ‰è£œå®Œ\n      if (prevData.missing_fields.includes('hts_code') && parsed.hts_code) {\n        enriched.hts_code = parsed.hts_code;\n        enrichedFields.push('hts_code');\n      }\n      \n      // åŸç”£å›½è£œå®Œ\n      if (prevData.missing_fields.includes('origin_country') && parsed.origin_country) {\n        enriched.origin_country = parsed.origin_country;\n        enrichedFields.push('origin_country');\n      }\n      \n      // é‡é‡è£œå®Œ\n      if (prevData.missing_fields.includes('weight_grams') && parsed.weight_grams) {\n        enriched.weight_grams = parsed.weight_grams;\n        enrichedFields.push('weight_grams');\n      }\n      \n      // Item Specificsè£œå®Œ\n      if (prevData.missing_fields.includes('item_specifics') && parsed.item_specifics) {\n        enriched.item_specifics = { ...(enriched.item_specifics || {}), ...parsed.item_specifics };\n        enrichedFields.push('item_specifics');\n      }\n    }\n  }\n} catch (e) {\n  // AIæ¨è«–å¤±æ•—ã¯è­¦å‘Šã®ã¿\n}\n\nreturn [{ json: {\n  ...prevData,\n  product: enriched,\n  enriched_by: 'Gemini AI Inference',\n  enriched_fields: enrichedFields,\n  ai_confidence: aiConfidence,\n  _enrichment_depth: prevData.current_depth + 1,\n  _tried_sources: [...prevData.tried_sources, 'Gemini AI Inference']\n}}];"
      },
      "name": "ğŸ“Š Geminiçµæœãƒãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ğŸ”„ å†å¸°å‘¼ã³å‡ºã—åˆ¤å®š\n// ============================================================================\nconst data = $input.first().json;\n\n// è£œå®Œã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯\nconst enrichedCount = data.enriched_fields?.length || 0;\nconst remainingMissing = data.missing_fields.filter(f => !data.enriched_fields?.includes(f));\n\n// ã¾ã æ¬ æãŒã‚ã‚Šã€æ·±åº¦ã«ä½™è£•ãŒã‚ã‚Œã°å†å¸°\nif (remainingMissing.length > 0 && data._enrichment_depth < data.max_depth) {\n  return [{ json: {\n    ...data,\n    _needs_recursion: true,\n    missing_fields: remainingMissing\n  }}];\n}\n\nreturn [{ json: {\n  ...data,\n  _needs_recursion: false,\n  enrichment_status: enrichedCount > 0 ? 'enriched' : 'unchanged',\n  enrichment_message: enrichedCount > 0 ? \n    `${data.enriched_by}ã‹ã‚‰${enrichedCount}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è£œå®Œå®Œäº†` : \n    'è£œå®Œãƒ‡ãƒ¼ã‚¿ãªã—'\n}}];"
      },
      "name": "ğŸ”„ å†å¸°åˆ¤å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "needs-recursion", "leftValue": "={{ $json._needs_recursion }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" }}]
        }
      },
      "name": "å†å¸°å¿…è¦ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2
    },

    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || $env.N8N_WEBHOOK_URL }}/webhook/self-healing-enrich",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ product_id: $json.product_id, user_id: $json.tenant_id, product_data: $json.product, _enrichment_depth: $json._enrichment_depth, _tried_sources: $json._tried_sources, _recursive_call: true, confidence_threshold: $json.confidence_threshold }) }}",
        "options": { "timeout": 120000 }
      },
      "name": "ğŸ”„ å†å¸°å‘¼ã³å‡ºã—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "continueOnFail": true
    },

    {
      "parameters": {
        "jsCode": "// å†å¸°çµæœã‚’æœ€çµ‚çµæœã¨ã—ã¦è¿”ã™\nconst recursiveResult = $input.first().json;\nreturn [{ json: recursiveResult }];"
      },
      "name": "å†å¸°çµæœãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE products_master SET item_specifics = COALESCE($1::jsonb, item_specifics), hts_code = COALESCE($2, hts_code), origin_country = COALESCE($3, origin_country), title_en = COALESCE($4, title_en), ebay_category_id = COALESCE($5, ebay_category_id), enrichment_depth = $6, enrichment_source = $7, updated_at = NOW() WHERE id = $8",
        "options": { "queryParams": "={{ [JSON.stringify($json.product?.item_specifics || null), $json.product?.hts_code, $json.product?.origin_country, $json.product?.title_en, $json.product?.ebay_category_id, $json._enrichment_depth || 0, $json.enriched_by || 'none', $json.product_id] }}" }
      },
      "name": "ğŸ’¾ products_masteræ›´æ–°",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "postgres-supabase", "name": "Supabase Postgres" }},
      "continueOnFail": true
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO enrichment_tracking (tenant_id, product_id, enrichment_depth, sources_tried, final_source, initial_confidence, final_confidence, missing_fields_before, missing_fields_after, status, completed_at, execution_time_ms) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, NOW(), $11)",
        "options": { "queryParams": "={{ [$json.tenant_id, $json.product_id, $json._enrichment_depth || 0, $json._tried_sources || [], $json.enriched_by, $json.adjusted_confidence || 50, $json.quality_score || 50, $json.missing_fields || [], $json.missing_fields?.filter(f => !($json.enriched_fields || []).includes(f)) || [], $json.enrichment_status || 'complete', Date.now() - $execution.startedAt.getTime()] }}" }
      },
      "name": "ğŸ“Š è£œå®Œå±¥æ­´è¨˜éŒ²",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "credentials": { "postgres": { "id": "postgres-supabase", "name": "Supabase Postgres" }},
      "continueOnFail": true
    },

    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, product_id: $json.product_id, status: $json.enrichment_status, message: $json.enrichment_message, warning: $json.warning, enriched_fields: $json.enriched_fields || [], enriched_by: $json.enriched_by, depth: $json._enrichment_depth || 0, quality_score: $json.quality_score, final_confidence: $json.adjusted_confidence }) }}",
        "options": { "responseCode": 200 }
      },
      "name": "âœ… æœ€çµ‚å¿œç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1
    }
  ],

  "connections": {
    "Webhook: Self-Healing": { "main": [[{ "node": "ğŸ” èªè¨¼ + åˆæœŸåŒ–", "type": "main", "index": 0 }]] },
    "ğŸ” èªè¨¼ + åˆæœŸåŒ–": { "main": [[{ "node": "ã‚¨ãƒ©ãƒ¼ï¼Ÿ", "type": "main", "index": 0 }]] },
    "ã‚¨ãƒ©ãƒ¼ï¼Ÿ": { "main": [[{ "node": "ã‚¨ãƒ©ãƒ¼å¿œç­”", "type": "main", "index": 0 }], [{ "node": "ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—", "type": "main", "index": 0 }]] },
    "ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—": { "main": [[{ "node": "ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡", "type": "main", "index": 0 }]] },
    "ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡": { "main": [[{ "node": "è£œå®Œå¿…è¦ï¼Ÿ", "type": "main", "index": 0 }]] },
    "è£œå®Œå¿…è¦ï¼Ÿ": { "main": [[{ "node": "æœ€å¤§æ·±åº¦åˆ°é”ï¼Ÿ", "type": "main", "index": 0 }], [{ "node": "è£œå®Œä¸è¦", "type": "main", "index": 0 }]] },
    "è£œå®Œä¸è¦": { "main": [[{ "node": "ğŸ’¾ products_masteræ›´æ–°", "type": "main", "index": 0 }]] },
    "æœ€å¤§æ·±åº¦åˆ°é”ï¼Ÿ": { "main": [[{ "node": "æœ€å¤§æ·±åº¦åˆ°é”", "type": "main", "index": 0 }], [{ "node": "ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ", "type": "main", "index": 0 }]] },
    "æœ€å¤§æ·±åº¦åˆ°é”": { "main": [[{ "node": "ğŸ’¾ products_masteræ›´æ–°", "type": "main", "index": 0 }]] },
    "ğŸ”„ ã‚½ãƒ¼ã‚¹é¸æŠ": { "main": [[{ "node": "ã‚½ãƒ¼ã‚¹åˆ†å²", "type": "main", "index": 0 }]] },
    "ã‚½ãƒ¼ã‚¹åˆ†å²": { "main": [[{ "node": "ğŸ“¡ eBay Browse API", "type": "main", "index": 0 }], [{ "node": "ğŸ“¡ Amazon Catalog API", "type": "main", "index": 0 }], [{ "node": "ğŸ§  Gemini AIæ¨è«–", "type": "main", "index": 0 }], [{ "node": "ã‚½ãƒ¼ã‚¹ãªã—", "type": "main", "index": 0 }]] },
    "ğŸ“¡ eBay Browse API": { "main": [[{ "node": "ğŸ“Š eBayçµæœãƒãƒ¼ã‚¸", "type": "main", "index": 0 }]] },
    "ğŸ“¡ Amazon Catalog API": { "main": [[{ "node": "ğŸ“Š Amazonçµæœãƒãƒ¼ã‚¸", "type": "main", "index": 0 }]] },
    "ğŸ§  Gemini AIæ¨è«–": { "main": [[{ "node": "ğŸ“Š Geminiçµæœãƒãƒ¼ã‚¸", "type": "main", "index": 0 }]] },
    "ã‚½ãƒ¼ã‚¹ãªã—": { "main": [[{ "node": "ğŸ’¾ products_masteræ›´æ–°", "type": "main", "index": 0 }]] },
    "ğŸ“Š eBayçµæœãƒãƒ¼ã‚¸": { "main": [[{ "node": "ğŸ”„ å†å¸°åˆ¤å®š", "type": "main", "index": 0 }]] },
    "ğŸ“Š Amazonçµæœãƒãƒ¼ã‚¸": { "main": [[{ "node": "ğŸ”„ å†å¸°åˆ¤å®š", "type": "main", "index": 0 }]] },
    "ğŸ“Š Geminiçµæœãƒãƒ¼ã‚¸": { "main": [[{ "node": "ğŸ”„ å†å¸°åˆ¤å®š", "type": "main", "index": 0 }]] },
    "ğŸ”„ å†å¸°åˆ¤å®š": { "main": [[{ "node": "å†å¸°å¿…è¦ï¼Ÿ", "type": "main", "index": 0 }]] },
    "å†å¸°å¿…è¦ï¼Ÿ": { "main": [[{ "node": "ğŸ”„ å†å¸°å‘¼ã³å‡ºã—", "type": "main", "index": 0 }], [{ "node": "ğŸ’¾ products_masteræ›´æ–°", "type": "main", "index": 0 }]] },
    "ğŸ”„ å†å¸°å‘¼ã³å‡ºã—": { "main": [[{ "node": "å†å¸°çµæœãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼", "type": "main", "index": 0 }]] },
    "å†å¸°çµæœãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼": { "main": [[{ "node": "âœ… æœ€çµ‚å¿œç­”", "type": "main", "index": 0 }]] },
    "ğŸ’¾ products_masteræ›´æ–°": { "main": [[{ "node": "ğŸ“Š è£œå®Œå±¥æ­´è¨˜éŒ²", "type": "main", "index": 0 }]] },
    "ğŸ“Š è£œå®Œå±¥æ­´è¨˜éŒ²": { "main": [[{ "node": "âœ… æœ€çµ‚å¿œç­”", "type": "main", "index": 0 }]] }
  },

  "settings": {
    "executionTimeout": 300,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },

  "tags": [
    { "name": "V8.2.1-Autonomous", "color": "#dc143c" },
    { "name": "Self-Healing", "color": "#27ae60" },
    { "name": "Recursive", "color": "#e74c3c" },
    { "name": "Data-Quality", "color": "#9b59b6" }
  ],

  "active": false
}
