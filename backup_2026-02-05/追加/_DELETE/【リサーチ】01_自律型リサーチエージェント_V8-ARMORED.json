{
  "name": "ã€ãƒªã‚µãƒ¼ãƒã€‘01_è‡ªå¾‹å‹ãƒªã‚µãƒ¼ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ_V8-ARMORED",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "research-agent",
        "options": { "responseMode": "responseNode" }
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [100, 300]
    },
    {
      "parameters": {
        "jsCode": "// V8.2.1 Auth-Gate\nconst crypto = require('crypto');\nconst input = $input.first().json;\nconst rawData = input.body || input;\nconst hmacSig = input.headers?.['x-n3-signature'];\nconst hmacTs = input.headers?.['x-n3-timestamp'];\nconst workflowName = 'ã€ãƒªã‚µãƒ¼ãƒã€‘01_è‡ªå¾‹å‹ãƒªã‚µãƒ¼ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ';\nconst requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;\nconst tenantId = rawData.tenantId || 'default';\n\nlet auth = { isValid: false, reason: 'unknown', tenantId, requestId, workflowName, validatedAt: new Date().toISOString() };\n\nif (hmacSig && hmacTs) {\n  const secret = $env.N8N_HMAC_SECRET;\n  if (secret) {\n    const age = Date.now() - parseInt(hmacTs);\n    if (age <= 300000 && age >= -30000) {\n      const computed = crypto.createHmac('sha256', secret).update(hmacTs + '.' + JSON.stringify(rawData)).digest('hex');\n      if (hmacSig === computed) { auth.isValid = true; auth.reason = 'hmac_valid'; }\n      else { auth.reason = 'hmac_invalid'; auth.shouldLogUnauthorized = true; }\n    } else { auth.reason = 'timestamp_expired'; auth.shouldLogUnauthorized = true; }\n  } else { auth.reason = 'hmac_secret_missing'; auth.shouldLogUnauthorized = true; }\n} else if (!input.headers) { auth.isValid = true; auth.reason = 'internal_call'; }\nelse { auth.reason = 'no_auth'; auth.shouldLogUnauthorized = true; }\n\nauth.originalPayload = rawData;\nreturn { json: auth };"
      },
      "id": "auth-gate",
      "name": "ğŸ” V8 Auth-Gate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 300]
    },
    {
      "parameters": {
        "conditions": { "options": { "typeValidation": "strict" }, "conditions": [{ "leftValue": "={{ $json.isValid }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }] }
      },
      "id": "auth-switch",
      "name": "Auth Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO audit_logs (tenant_id, workflow_name, request_id, action, risk_level, status, error_message) VALUES ('{{ $json.tenantId }}', '{{ $json.workflowName }}', '{{ $json.requestId }}', 'auth_blocked', 'HIGH', 'error', '{{ $json.reason }}');",
        "options": {}
      },
      "id": "log-unauth",
      "name": "ğŸ“ Log Unauthorized",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [500, 500],
      "credentials": { "postgres": { "id": "supabase-postgres", "name": "Supabase PostgreSQL" } }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'AUTH_BLOCKED', reason: $json.reason }) }}",
        "options": { "responseCode": 401 }
      },
      "id": "auth-reject",
      "name": "ğŸš« Rejected",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [700, 500]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nreturn [{ json: { ...input.originalPayload, _auth: { tenantId: input.tenantId, requestId: input.requestId, workflowName: input.workflowName } } }];"
      },
      "id": "auth-success",
      "name": "âœ… Auth OK",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// V8.2.1 ç‡ƒç„¼ä¸Šé™ãƒã‚§ãƒƒã‚¯ - OpenAIç”¨\n// ========================================\nconst input = $input.first().json;\nconst tenantId = input._auth?.tenantId || 'default';\nconst requestId = input._auth?.requestId || 'unknown';\nconst workflowName = input._auth?.workflowName || 'unknown';\nconst apiProvider = 'openai';\nconst estimatedCost = 0.05; // GPT-4æ¦‚ç®—ã‚³ã‚¹ãƒˆ\n\nreturn {\n  json: {\n    ...input,\n    _burnLimit: {\n      tenantId,\n      requestId,\n      workflowName,\n      apiProvider,\n      estimatedCostUsd: estimatedCost,\n      checkRequired: true\n    }\n  }\n};"
      },
      "id": "burn-limit-check",
      "name": "ğŸ”¥ Burn-Limit Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300],
      "notes": "[V8.2.1] ç‡ƒç„¼ä¸Šé™ - æ¬¡å…ƒ22å®Ÿè£…"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT check_and_consume_api('{{ $json._burnLimit.tenantId }}', '{{ $json._burnLimit.apiProvider }}', {{ $json._burnLimit.estimatedCostUsd }}, 1) as result;",
        "options": {}
      },
      "id": "burn-limit-db",
      "name": "ğŸ’° Check Quota",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1100, 300],
      "credentials": { "postgres": { "id": "supabase-postgres", "name": "Supabase PostgreSQL" } }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst result = input.result || {};\nconst prev = $node['ğŸ”¥ Burn-Limit Check'].json;\n\nif (result.allowed === false) {\n  return {\n    json: {\n      quotaDenied: true,\n      reason: result.reason,\n      dailyUsed: result.daily_used,\n      dailyLimit: result.daily_limit,\n      monthlyUsed: result.monthly_used,\n      monthlyLimit: result.monthly_limit,\n      _auth: prev._auth,\n      _burnLimit: prev._burnLimit\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...prev,\n    quotaApproved: true,\n    dailyPercent: result.daily_percent,\n    monthlyPercent: result.monthly_percent,\n    alertTriggered: result.alert_triggered\n  }\n};"
      },
      "id": "process-quota",
      "name": "Process Quota",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "conditions": { "options": { "typeValidation": "strict" }, "conditions": [{ "leftValue": "={{ $json.quotaDenied }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }] }
      },
      "id": "quota-switch",
      "name": "Quota OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.chatwork.com/v2/rooms/{{ $env.CHATWORK_ROOM_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "X-ChatWorkToken", "value": "={{ $env.CHATWORK_API_KEY }}" }] },
        "sendBody": true,
        "bodyParameters": { "parameters": [{ "name": "body", "value": "=ğŸ›‘ [ç‡ƒç„¼ä¸Šé™è¶…é]\nAPI: {{ $json._burnLimit.apiProvider }}\nç†ç”±: {{ $json.reason }}\næ—¥æ¬¡: {{ $json.dailyUsed }}/{{ $json.dailyLimit }} USD\næœˆæ¬¡: {{ $json.monthlyUsed }}/{{ $json.monthlyLimit }} USD\nWorkflow: {{ $json._burnLimit.workflowName }}" }] }
      },
      "id": "quota-alert",
      "name": "ğŸš¨ Quota Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1500, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'BURN_LIMIT_EXCEEDED', reason: $json.reason }) }}",
        "options": { "responseCode": 429 }
      },
      "id": "quota-reject",
      "name": "ğŸ›‘ Quota Denied",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1700, 500]
    },
    {
      "parameters": {
        "jsCode": "// AIå…¥åŠ›æº–å‚™ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ç”¨ã«ä¿å­˜ï¼‰\nconst input = $input.first().json;\nconst query = input.query || input.keyword || 'market research';\n\nreturn {\n  json: {\n    ...input,\n    _aiInput: {\n      query: query,\n      timestamp: new Date().toISOString()\n    }\n  }\n};"
      },
      "id": "prepare-ai",
      "name": "Prepare AI Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 300]
    },
    {
      "parameters": {
        "resource": "chat",
        "model": "gpt-4",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "ã‚ãªãŸã¯eBayå¸‚å ´ãƒªã‚µãƒ¼ãƒã®å°‚é–€å®¶ã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€å¸‚å ´åˆ†æã¨ä»•å…¥ã‚Œæ¨å¥¨ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚"
            },
            {
              "role": "user",
              "content": "={{ $json._aiInput.query }}"
            }
          ]
        },
        "options": { "temperature": 0.7, "maxTokens": 2000 }
      },
      "id": "openai-analysis",
      "name": "ğŸ¤– OpenAI Analysis",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.2,
      "position": [1900, 300],
      "credentials": { "openAiApi": { "id": "openai-api", "name": "OpenAI API" } }
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// V8.2.1 AIåˆ¤æ–­ãƒˆãƒ¬ãƒ¼ã‚¹è¨˜éŒ²\n// ========================================\nconst input = $input.first().json;\nconst prev = $node['Prepare AI Input'].json;\nconst auth = prev._auth || {};\n\n// AIå‡ºåŠ›ã‹ã‚‰åˆ¤æ–­ç†ç”±ã‚’æŠ½å‡º\nconst aiOutput = input.choices?.[0]?.message?.content || input.message?.content || JSON.stringify(input).substring(0, 500);\nconst reasoning = aiOutput.match(/ç†ç”±[:ï¼š](.+?)(?:\\n|$)/)?.[1] || aiOutput.match(/çµè«–[:ï¼š](.+?)(?:\\n|$)/)?.[1] || 'AIåˆ†æå®Œäº†';\n\nreturn {\n  json: {\n    ...input,\n    _auth: auth,\n    _aiTrace: {\n      tenantId: auth.tenantId || 'default',\n      workflowName: auth.workflowName || 'ã€ãƒªã‚µãƒ¼ãƒã€‘è‡ªå¾‹å‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',\n      requestId: auth.requestId || 'unknown',\n      nodeName: 'ğŸ¤– OpenAI Analysis',\n      aiProvider: 'openai',\n      modelName: 'gpt-4',\n      inputSummary: JSON.stringify(prev._aiInput || {}).substring(0, 500),\n      outputSummary: aiOutput.substring(0, 500),\n      reasoning: reasoning.substring(0, 500),\n      tokensUsed: input.usage?.total_tokens || null,\n      tracedAt: new Date().toISOString()\n    }\n  }\n};"
      },
      "id": "ai-trace",
      "name": "ğŸ“Š AI-Trace",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2100, 300],
      "notes": "[V8.2.1] AIåˆ¤æ–­ãƒˆãƒ¬ãƒ¼ã‚¹ - æ¬¡å…ƒ13å®Ÿè£…"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ai_decision_traces (tenant_id, workflow_name, request_id, node_name, ai_provider, model_name, input_summary, output_summary, reasoning, tokens_used) VALUES ('{{ $json._aiTrace.tenantId }}', '{{ $json._aiTrace.workflowName }}', '{{ $json._aiTrace.requestId }}', '{{ $json._aiTrace.nodeName }}', '{{ $json._aiTrace.aiProvider }}', '{{ $json._aiTrace.modelName }}', '{{ $json._aiTrace.inputSummary.replace(/'/g, \"''\") }}', '{{ $json._aiTrace.outputSummary.replace(/'/g, \"''\") }}', '{{ $json._aiTrace.reasoning.replace(/'/g, \"''\") }}', {{ $json._aiTrace.tokensUsed || 'NULL' }});",
        "options": {}
      },
      "id": "save-trace",
      "name": "ğŸ’¾ Save AI Trace",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2300, 300],
      "credentials": { "postgres": { "id": "supabase-postgres", "name": "Supabase PostgreSQL" } },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// æœ€çµ‚çµæœæ•´å½¢\nconst input = $input.first().json;\nconst aiOutput = input.choices?.[0]?.message?.content || input.message?.content || '';\n\nreturn {\n  json: {\n    success: true,\n    requestId: input._auth?.requestId,\n    analysis: aiOutput,\n    tokensUsed: input._aiTrace?.tokensUsed,\n    tracedAt: input._aiTrace?.tracedAt\n  }\n};"
      },
      "id": "format-result",
      "name": "Format Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2500, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO audit_logs (tenant_id, workflow_name, request_id, action, risk_level, status, execution_time_ms) VALUES ('{{ $node[\"âœ… Auth OK\"].json._auth.tenantId }}', '{{ $node[\"âœ… Auth OK\"].json._auth.workflowName }}', '{{ $node[\"âœ… Auth OK\"].json._auth.requestId }}', 'research_complete', 'LOW', 'success', {{ Date.now() }});",
        "options": {}
      },
      "id": "audit-log",
      "name": "ğŸ“Š Audit Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2700, 300],
      "credentials": { "postgres": { "id": "supabase-postgres", "name": "Supabase PostgreSQL" } },
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": { "responseCode": 200 }
      },
      "id": "respond",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2900, 300]
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "ğŸ” V8 Auth-Gate", "type": "main", "index": 0 }]] },
    "ğŸ” V8 Auth-Gate": { "main": [[{ "node": "Auth Valid?", "type": "main", "index": 0 }]] },
    "Auth Valid?": { "main": [[{ "node": "âœ… Auth OK", "type": "main", "index": 0 }], [{ "node": "ğŸ“ Log Unauthorized", "type": "main", "index": 0 }]] },
    "ğŸ“ Log Unauthorized": { "main": [[{ "node": "ğŸš« Rejected", "type": "main", "index": 0 }]] },
    "âœ… Auth OK": { "main": [[{ "node": "ğŸ”¥ Burn-Limit Check", "type": "main", "index": 0 }]] },
    "ğŸ”¥ Burn-Limit Check": { "main": [[{ "node": "ğŸ’° Check Quota", "type": "main", "index": 0 }]] },
    "ğŸ’° Check Quota": { "main": [[{ "node": "Process Quota", "type": "main", "index": 0 }]] },
    "Process Quota": { "main": [[{ "node": "Quota OK?", "type": "main", "index": 0 }]] },
    "Quota OK?": { "main": [[{ "node": "ğŸš¨ Quota Alert", "type": "main", "index": 0 }], [{ "node": "Prepare AI Input", "type": "main", "index": 0 }]] },
    "ğŸš¨ Quota Alert": { "main": [[{ "node": "ğŸ›‘ Quota Denied", "type": "main", "index": 0 }]] },
    "Prepare AI Input": { "main": [[{ "node": "ğŸ¤– OpenAI Analysis", "type": "main", "index": 0 }]] },
    "ğŸ¤– OpenAI Analysis": { "main": [[{ "node": "ğŸ“Š AI-Trace", "type": "main", "index": 0 }]] },
    "ğŸ“Š AI-Trace": { "main": [[{ "node": "ğŸ’¾ Save AI Trace", "type": "main", "index": 0 }]] },
    "ğŸ’¾ Save AI Trace": { "main": [[{ "node": "Format Result", "type": "main", "index": 0 }]] },
    "Format Result": { "main": [[{ "node": "ğŸ“Š Audit Log", "type": "main", "index": 0 }]] },
    "ğŸ“Š Audit Log": { "main": [[{ "node": "Response", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionTimeout": 180, "saveDataErrorExecution": "all" },
  "tags": [{ "name": "V8.2.1-ARMORED" }, { "name": "Auth-Gate" }, { "name": "Burn-Limit" }, { "name": "AI-Trace" }],
  "active": false,
  "versionId": "v8.2.1-armored",
  "_armorPatch": {
    "appliedAt": "2026-01-24T00:00:00.000Z",
    "authGateAdded": true,
    "burnLimitAdded": true,
    "aiTraceAdded": true,
    "defenseScore": 95
  }
}
