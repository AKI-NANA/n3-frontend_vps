#!/bin/bash
# ============================================================
# ğŸ›ï¸ Imperial Pull Nightly - VPSæˆæœå›åãƒ—ãƒ­ãƒˆã‚³ãƒ«
# ============================================================
#
# ç”¨é€”: VPSä¸Šã§AIãŒå¤œé–“ã«ç”Ÿæˆã—ãŸæˆæœã‚’Macã«å®‰å…¨ã«å¼•ãè¾¼ã‚€
#
# ãƒ•ãƒ­ãƒ¼:
#   1. VPSã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
#   2. git fetch ã§ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—
#   3. git diff ã‚’å¼·åˆ¶è¡¨ç¤ºï¼ˆé™›ä¸‹ã«å·®åˆ†ã‚’è¦‹ã›ã‚‹ï¼‰
#   4. [y/N] ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸
#   5. ãƒ­ãƒƒã‚¯è§£é™¤
#
# ä½¿ã„æ–¹:
#   npm run pull-nightly
#   ã¾ãŸã¯
#   bash scripts/pull-nightly.sh
#
# âš ï¸ ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Macå´ã§ã®ã¿å®Ÿè¡Œã—ã¦ãã ã•ã„
# ============================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
LOCK_FILE="$PROJECT_DIR/governance/NIGHTLY_ACTIVE.lock"

# VPSæ¥ç¶šè¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
VPS_USER="${VPS_USER:-root}"
VPS_HOST="${VPS_HOST:-your-vps-ip}"
VPS_PROJECT_DIR="${VPS_PROJECT_DIR:-/root/n3-frontend_new}"
VPS_LOCK_PATH="${VPS_PROJECT_DIR}/governance/NIGHTLY_ACTIVE.lock"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ›ï¸  Imperial Pull Nightly - VPSæˆæœå›åãƒ—ãƒ­ãƒˆã‚³ãƒ«"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«: $PROJECT_DIR"
echo "ğŸ“ VPS:     $VPS_USER@$VPS_HOST:$VPS_PROJECT_DIR"
echo ""

# ============================================================
# Step 0: ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ­ãƒƒã‚¯ç¢ºèª
# ============================================================

if [ -f "$LOCK_FILE" ]; then
  echo "âš ï¸  ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ã€‚"
  echo "   å…ˆã« npm run unlock-force ã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi

# ============================================================
# Step 1: VPS ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
# ============================================================

echo "ğŸ“¡ Step 1: VPS ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
VPS_LOCK_EXISTS=$(ssh "$VPS_USER@$VPS_HOST" "test -f '$VPS_LOCK_PATH' && echo 'YES' || echo 'NO'" 2>/dev/null || echo "ERROR")

if [ "$VPS_LOCK_EXISTS" = "ERROR" ]; then
  echo "âŒ VPS ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚SSHè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
  echo "   VPS_USER=$VPS_USER, VPS_HOST=$VPS_HOST"
  exit 1
fi

if [ "$VPS_LOCK_EXISTS" = "YES" ]; then
  echo ""
  echo "ğŸ”’ VPS ã«ãƒ­ãƒƒã‚¯ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆAIãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒé€²è¡Œä¸­ or æ‰¿èªå¾…ã¡ï¼‰"
  echo ""
  echo "ãƒ­ãƒƒã‚¯å†…å®¹:"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  ssh "$VPS_USER@$VPS_HOST" "cat '$VPS_LOCK_PATH'" 2>/dev/null
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo ""
  echo "âš ï¸  é¸æŠã—ã¦ãã ã•ã„:"
  echo "   1) ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦æˆæœã‚’å›åã™ã‚‹ï¼ˆæ‰¿èªæ¸ˆã¿ã®å ´åˆï¼‰"
  echo "   2) ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆAIã«ã¾ã ä½œæ¥­ã•ã›ã‚‹å ´åˆï¼‰"
  echo ""
  read -p "   é¸æŠ [1/2]: " choice
  
  if [ "$choice" = "1" ]; then
    echo ""
    echo "ğŸ”“ VPS ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ã„ã¾ã™..."
    ssh "$VPS_USER@$VPS_HOST" "rm -f '$VPS_LOCK_PATH'"
    echo "âœ… VPS ãƒ­ãƒƒã‚¯è§£é™¤å®Œäº†"
  else
    echo "âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
    exit 0
  fi
fi

echo "âœ… ãƒ­ãƒƒã‚¯çŠ¶æ…‹: ã‚¯ãƒªã‚¢"
echo ""

# ============================================================
# Step 2: git fetch
# ============================================================

echo "ğŸ“¡ Step 2: ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—ä¸­..."
cd "$PROJECT_DIR"
git fetch origin 2>&1 | head -20
echo "âœ… fetch å®Œäº†"
echo ""

# ============================================================
# Step 3: git diff ã‚’å¼·åˆ¶è¡¨ç¤º
# ============================================================

echo "ğŸ“ Step 3: å·®åˆ†ã‚’è¡¨ç¤ºã—ã¾ã™"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ãƒªãƒ¢ãƒ¼ãƒˆã¨ãƒ­ãƒ¼ã‚«ãƒ«ã®å·®åˆ†
DIFF_OUTPUT=$(git diff HEAD..origin/main --stat 2>/dev/null || echo "")

if [ -z "$DIFF_OUTPUT" ]; then
  echo "â„¹ï¸  ãƒªãƒ¢ãƒ¼ãƒˆã«æ–°ã—ã„å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  exit 0
fi

# ã‚µãƒãƒªãƒ¼è¡¨ç¤º
echo "ğŸ“Š å¤‰æ›´ã‚µãƒãƒªãƒ¼:"
echo "$DIFF_OUTPUT"
echo ""

# è©³ç´°å·®åˆ†
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“‹ è©³ç´°å·®åˆ† (å…ˆé ­200è¡Œ):"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
git diff HEAD..origin/main 2>/dev/null | head -200
echo ""
echo "... (å…¨ä½“ã‚’è¦‹ã‚‹ã«ã¯: git diff HEAD..origin/main)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================================
# Step 4: ãƒãƒ¼ã‚¸æ‰¿èªã‚’å¾…ã¤
# ============================================================

echo "âš ï¸  ã“ã®ä¿®æ­£ã‚’å—ã‘å…¥ã‚Œã¾ã™ã‹ï¼Ÿ"
echo "   [y] ãƒãƒ¼ã‚¸ã—ã¦æœ¬ç•ªã«åæ˜ "
echo "   [n] ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå¤‰æ›´ã¯å–ã‚Šè¾¼ã¾ãªã„ï¼‰"
echo "   [d] è©³ç´°å·®åˆ†ã‚’å…¨ã¦è¡¨ç¤º"
echo ""
read -p "   æ‰¿èª [y/N/d]: " merge_confirm

if [ "$merge_confirm" = "d" ] || [ "$merge_confirm" = "D" ]; then
  echo ""
  git diff HEAD..origin/main 2>/dev/null | less
  echo ""
  read -p "   ã“ã®ä¿®æ­£ã‚’å—ã‘å…¥ã‚Œã¾ã™ã‹ï¼Ÿ [y/N]: " merge_confirm
fi

if [[ "$merge_confirm" =~ ^[Yy]$ ]]; then
  echo ""
  echo "ğŸ”€ ãƒãƒ¼ã‚¸å®Ÿè¡Œä¸­..."
  git merge origin/main --no-edit
  echo ""
  echo "âœ… ãƒãƒ¼ã‚¸å®Œäº†ï¼"
  echo ""
  echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
  echo "   1. npm run dev ã§ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œç¢ºèª"
  echo "   2. å•é¡Œãªã‘ã‚Œã° npm run build ã§ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ"
  echo "   3. æœ¬ç•ªåæ˜ : git push origin main"
else
  echo ""
  echo "âŒ ãƒãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
  echo "   å¤‰æ›´ã¯ origin/main ã«æ®‹ã£ã¦ã„ã¾ã™ã€‚"
  echo "   å¾Œã§å†å®Ÿè¡Œ: npm run pull-nightly"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
