# 🏛️ N3 EMPIRE DIRECTIVE v1.0

**制定日**: 2026-02-05  
**発効日**: 即時  
**適用範囲**: 全夜間自律スクリプト、AI執行官  
**上位法**: MASTER_LAW.md v2.1

---

## 🎯 本法の目的

本法は、MASTER_LAW.md（憲法）の運用指針として制定される。  
夜間自律開発スクリプトおよび AI 執行官が「何をスキャンし、何を修正し、何を避けるべきか」を物理的に定義する。

---

## 📂 第1章: 公認ディレクトリ（ホワイトリスト）

以下のディレクトリは **帝国公認** であり、task_index.json 未登録でも野良ファイルとして扱わない。

### 第1条（プロダクション聖域）

```
01_PRODUCT/           # プロダクション専用エリア（完全除外）
```

**理由**: 本番環境のコードは、夜間自律修正の対象外とする。

### 第2条（開発中枢ディレクトリ）

以下のディレクトリは、開発の中核であり、task_index.json への登録は不要。

```
app/                  # Next.js アプリケーションルート
lib/                  # 共通ライブラリ・サービス
components/           # React コンポーネント
hooks/                # カスタムフック
contexts/             # React Context
types/                # TypeScript 型定義
```

### 第3条（インフラストラクチャ）

以下のディレクトリは、システムインフラであり、スキャン対象外とする。

```
node_modules/         # npm パッケージ
.next/                # Next.js ビルド出力
.git/                 # Git リポジトリ
.n3-docs/             # ドキュメント
.mcp-venv/            # MCP 仮想環境
__pycache__/          # Python キャッシュ
```

### 第4条（統治機構）

以下のディレクトリは、帝国の統治機構であり、野良スキャンの対象外とする。

```
governance/           # 帝国統治ファイル（本法を含む）
supabase/             # データベース管理
scripts/              # ユーティリティスクリプト
migrations/           # DB マイグレーション
```

### 第5条（静的リソース）

以下のディレクトリは、静的リソースであり、コード監査の対象外とする。

```
public/               # 公開静的ファイル
remotion/             # 動画生成リソース
docs/                 # ドキュメント
```

### 第6条（バックアップ・アーカイブ聖域）

以下のディレクトリは、手動管理領域であり、夜間自律スクリプトは一切触れてはならない。

```
02_CURRENT_BACKUP/    # 現在のバックアップ
02_DEV_LAB/           # 開発実験室
03_ARCHIVE_STORAGE/   # アーカイブストレージ
03_VAULT/             # 金庫（重要ファイル保管）
03_WORKING_BACKUP/    # 作業用バックアップ
```

---

## 🚫 第2章: 禁止パターン

以下のパターンに該当するファイル・ディレクトリは **野良** として検出・処理する。

### 第7条（バックアップファイルの禁止）

以下の拡張子を持つファイルは、`03_ARCHIVE_STORAGE/` へ自動移動する。

```
.bak                  # バックアップファイル
.backup               # バックアップファイル
.old                  # 旧バージョン
.tmp                  # 一時ファイル
.orig                 # オリジナル（マージ競合残骸）
.swp, .swo            # Vim スワップファイル
```

### 第8条（一時ディレクトリの禁止）

以下のパターンに該当するディレクトリは、`03_ARCHIVE_STORAGE/` へ自動移動する。

```
temp_*                # 一時ディレクトリ
tmp_*                 # 一時ディレクトリ
*_backup_*            # バックアップディレクトリ
*_bak                 # バックアップディレクトリ
*.bak                 # バックアップディレクトリ
*.backup              # バックアップディレクトリ
```

### 第9条（疑わしいルートファイルパターン）

プロジェクトルート直下に、以下のパターンに該当するファイルが存在する場合、手動確認を促す。

```
test_*.{ts,tsx,js,jsx}        # テストファイル（test/ 配下が正規）
debug_*.{ts,tsx,js,jsx}       # デバッグファイル
*.current_backup              # 不適切なバックアップ
*(1).*, *(2).*                # 重複ファイル（Finder等の自動生成）
*.CONFLICT.*                  # マージ競合残骸
```

---

## 🛡️ 第3章: 修正許可範囲（AI執行官への指令）

AI執行官が夜間自律修正で **許可される** 修正範囲を以下に限定する。

### 第10条（安全な機械的修正のみ）

以下の修正は **安全** であり、自動実行を許可する。

1. **console.log の削除**  
   - 本番コードに含まれる `console.log()` を削除する。

2. **process.env → fetchSecret() への置換**  
   - 固定マッピング（nightly-safe-fix.js に定義）に従い、環境変数参照をシークレット取得に置き換える。
   - **重要**: マッピングに存在しない環境変数は絶対に修正しない。

3. **生 fetch() → imperialSafeDispatch() への置換**  
   - 外部 API 呼び出しを、統一された安全なディスパッチャーに置き換える。

4. **空 catch ブロックの修正**  
   - `catch (e) {}` を `catch (e) { console.error(e); }` に修正する。

### 第11条（絶対禁止事項）

AI執行官は、以下の行為を **絶対に** 行ってはならない。

1. **設計変更**  
   - 新しい機能の追加、アーキテクチャ変更、DB構造変更は禁止。

2. **ルール解釈**  
   - MASTER_LAW の「解釈」や「例外適用」は禁止。法は明示的に定義されたもののみ適用する。

3. **未実装の補完**  
   - コード中の `TODO`, `FIXME`, `未実装` は「現時点での正」であり、勝手に実装してはならない。

4. **指示外ファイルの修正**  
   - 監査結果またはタスク指示書に明示されていないファイルは、一切修正してはならない。

5. **新しいキー名の生成**  
   - `process.env.XXX` の置換において、AIが新しいキー名を生成することは禁止。固定マッピングのみ使用。

---

## 🔄 第4章: 夜間サイクル実行ルール

### 第12条（実行フロー）

夜間自律開発サイクル（`nightly-cycle.js`）は、以下の順序で実行する。

```
Phase 0: 法典チェック
  ↓
Phase 1: 野良ファイルスキャン
  ↓
Phase 2: 監査実行
  ↓
Phase 3: 安全な修正
  ↓
Phase 4: 再監査・検証
  ↓
Phase 5: Git コミット
  ↓
Phase 6: 通知
```

### 第13条（Phase 0: 法典チェック）

サイクル開始時、以下を確認する。

1. **MASTER_LAW.md** の存在と読み込み可能性
2. **EMPIRE_DIRECTIVE.md** の存在と読み込み可能性
3. 両法典のバージョン番号とSHA256ハッシュを記録

**異常検知時の動作**: 即座にサイクルを中断し、エラーログを出力する。

### 第14条（法典ロードのタイミング）

各スクリプトは、**起動時に毎回** 最新の法典をロードする。

理由: キャッシュによる古い法の適用を防ぎ、常に「最新の法」を現場に適用するため。

### 第15条（法典のバージョン管理）

スクリプトのログには、以下を記録する。

1. 使用した法典のファイル名
2. 法典内のバージョン番号（例: `v2.1`）
3. 法典の SHA256 ハッシュ（改ざん防止）
4. 法典の最終更新日時

---

## 📊 第5章: トークン・ガード（予算防衛）

### 第16条（一晩の修正上限）

夜間自律修正は、以下の上限を超えてはならない。

```
最大修正ファイル数: 50ファイル/晩
最大リトライ回数: 3回/サイクル
最大実行時間: 30分/サイクル
概算トークン上限: 100,000トークン/晩
```

### 第17条（上限超過時の動作）

上限に達した場合、以下の動作をとる。

1. **修正を即座に停止**
2. **現在までの修正結果を保存**
3. **警告ログを出力**
4. **翌晩に残りを持ち越し**

---

## 🔐 第6章: task_index.json の運用方針

### 第18条（タスク制限の活用）

`task_index.json` は、夜間 AI が「どのタスクを担当しているか」を限定し、リソース消費を抑えるために使用する。

**活用方法**:

1. タスクごとに修正対象ファイルを明示
2. AI は、task_index に登録されたファイルのみ修正可能
3. 未登録ファイルへの修正は禁止

---

## 🎖️ 第7章: 帝国への報告義務

### 第19条（レポート生成義務）

各スクリプトは、実行後に以下のレポートを生成する。

```
STRAY_FILE_REPORT.md          # 野良ファイル検出結果
NIGHTLY_SAFE_FIX_REPORT.md    # 夜間修正結果
NIGHTLY_CYCLE_REPORT.md       # サイクル全体の結果
```

### 第20条（ログ保存義務）

各スクリプトは、実行ログを JSON 形式で保存する。

```
stray_scan_log.json           # 野良スキャンログ
nightly_fix_log.json          # 夜間修正ログ
nightly_cycle_log.json        # サイクルログ
```

---

## 📜 第8章: 法典の改正手続き

### 第21条（改正権限）

本法（EMPIRE_DIRECTIVE.md）の改正は、以下の権限者のみが行える。

- **皇帝（ユーザー）**: あらゆる改正が可能
- **AI執行官**: 改正不可（報告のみ）

### 第22条（改正の発効）

本法の改正は、以下の手順で発効する。

1. 皇帝が EMPIRE_DIRECTIVE.md を編集
2. Git コミット・プッシュ
3. 次回の夜間サイクル実行時に自動反映

**重要**: VPS 上の夜間サイクルは、Git Pull 後に法典をロードするため、ローカルでの編集が即座に反映される。

---

## 🏛️ 附則

### 第23条（施行日）

本法は、制定日（2026-02-05）より即時発効する。

### 第24条（MASTER_LAW との関係）

本法は、MASTER_LAW.md の運用指針として位置づけられる。  
両法が矛盾する場合、MASTER_LAW.md が優先する。

### 第25条（レガシーファイルへの遡及適用）

本法は、既存のすべてのソースコードに遡及適用する。

---

**N3 Empire - 統治の透明性と自律性の両立を目指して**
